<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8">
  <title>Conferma email - Casa del Gelato</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
</head>
<body style="font-family:system-ui;text-align:center;padding:40px">

<h2 id="msg">‚è≥ Verifica in corso‚Ä¶</h2>

<script type="module">
import { supabase } from "./supabase.js";

// 1Ô∏è‚É£ prendo token dall'URL
const params = new URLSearchParams(window.location.search);
const token = params.get("token");

const msg = document.getElementById("msg");

if (!token) {
  msg.textContent = "‚ùå Link non valido";
  throw new Error("Token mancante");
}

// 2Ô∏è‚É£ cerco utente con quel token
const { data, error } = await supabase
  .from("utenti")
  .select("id, email_confermata")
  .eq("conferma_token", token)
  .maybeSingle();

if (error || !data) {
  msg.textContent = "‚ùå Link scaduto o non valido";
  throw new Error("Token non trovato");
}

// 3Ô∏è‚É£ confermo email
await supabase
  .from("utenti")
  .update({
    email_confermata: true,
    conferma_token: null
  })
  .eq("id", data.id);

msg.textContent = "‚úÖ Email confermata con successo! Ora puoi accedere üéâ";

setTimeout(() => {
  window.location.href = "/login.html";
}, 2500);
</script>

</body>
</html>