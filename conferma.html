<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Conferma Email</title>

<script type="module">
  import { supabase } from "./supabase.js";

  async function confermaEmail() {
    const params = new URLSearchParams(window.location.search);
    const token = params.get("token");

    const box = document.getElementById("box");

    if (!token) {
      box.innerHTML = "❌ Link non valido.";
      return;
    }

    // 1️⃣ cerca utente con token
    const { data, error } = await supabase
      .from("utenti")
      .select("*")
      .eq("conferma_token", token)
      .single();

    if (error || !data) {
      box.innerHTML = "❌ Link scaduto o non valido.";
      return;
    }

    // 2️⃣ conferma email
    const { error: updErr } = await supabase
      .from("utenti")
      .update({
        email_confermata: true,
        conferma_token: null
      })
      .eq("id", data.id);

    if (updErr) {
      box.innerHTML = "❌ Errore durante la conferma.";
      return;
    }

    // 3️⃣ successo
    box.innerHTML = `
      <h2>✅ Email confermata!</h2>
      <p>Ora puoi accedere al tuo account.</p>
      <a href="login.html">Vai al login</a>
    `;
  }

  window.addEventListener("DOMContentLoaded", confermaEmail);
</script>

<style>
  body{
    font-family: system-ui, -apple-system, sans-serif;
    background:#f6f6f7;
    display:flex;
    align-items:center;
    justify-content:center;
    min-height:100vh;
    margin:0;
  }
  #box{
    background:#fff;
    padding:24px;
    border-radius:16px;
    box-shadow:0 10px 30px rgba(0,0,0,.12);
    text-align:center;
    max-width:360px;
  }
  a{
    display:inline-block;
    margin-top:16px;
    text-decoration:none;
    font-weight:700;
    color:#007aff;
  }
</style>
</head>

<body>
  <div id="box">
    ⏳ Conferma in corso…
  </div>
</body>
</html>