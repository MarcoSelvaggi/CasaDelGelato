<!DOCTYPE html>
<html lang="it">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <title>Crea la tua Coppa</title>

  <link rel="stylesheet" href="style.css">
<script type="module" src="global.js"></script>


<style>
  /* ‚úÖ blocco totale: anche se JS/CSS dopo prova a riaprirlo */
  .no-coppa-popup #popup-coppa {
    display: none !important;
    visibility: hidden !important;
    pointer-events: none !important;
  }
</style>

  <!-- LIBRERIE -->
  <script defer src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>

  <!-- Supabase -->
  <script type="module" src="supabase.js"></script>

  <!-- Script app -->
  <script defer src="carrello.js"></script>
  <script defer src="crea-coppa.js"></script>
</head>

<script>
document.addEventListener("DOMContentLoaded", function () {
    if (typeof updateCarrelloBadge === "function") {
        updateCarrelloBadge();
    }
});
</script>

<script>
document.addEventListener("DOMContentLoaded", function () {
    if (typeof updateCarrelloBadge === "function") {
        updateCarrelloBadge();
    }
});
</script>


<body>

<!-- ‚ö†Ô∏è TASTO ALLERGIE ‚Äì ora visibile -->
<a href="allergie.html" 
   style="
        position: fixed;
        top: 12px;
        right: 12px;
        background: #ff3b30;
        color: white;
        padding: 8px 14px;
        border-radius: 10px;
        font-size: 14px;
        font-weight: 600;
        text-decoration: none;
        z-index: 9999;
        box-shadow: 0 2px 6px rgba(0,0,0,0.15);
   ">
   ‚ö†Ô∏è Allergie
</a>
<div id="app-blur-zone"></div>

<!-- solo UNO spacer -->
<div style="height:30px;"></div>

<div id="top-fixed-bar">
    <a href="home.html" class="home-btn" aria-label="Home">
        <img src="tastohome.png" alt="home">
    </a>



</div>

<div id="top-fixed-spacer"></div>

<!-- MINI RIEPILOGO: SOLO UNO (niente doppio id) -->
<div id="riepilogo-mini"></div>

<!-- üçè DYNAMIC ISLAND -->
<div id="dynamic-island">
    <div id="island-title">Gusti (0/0)</div>
    <div id="island-added">Aggiunto!</div>
    <div id="island-progress"><div id="island-bar"></div></div>
</div>


<!-- ü™ë SELEZIONE TAVOLO -->
<section id="step-tavolo" style="text-align:center; padding:20px;">

  <div class="tavolo-logo-box">
  <img src="img/scoopy-ice.png" alt="Scoopy Ice">
</div>

  <h2>Seleziona il tavolo</h2>

  <div class="tavolo-zona">
    <button
      id="btn-dentro"
      class="tavolo-zona-btn"
      data-zona="D"
      onclick="scegliZona('D')">
      Dentro
    </button>

    <button
      id="btn-fuori"
      class="tavolo-zona-btn"
      data-zona="F"
      onclick="scegliZona('F')">
      Fuori
    </button>
  </div>

  <div class="tavolo-help">
<button id="info-tavolo-btn">
  Come funziona? Clicca qui
</button>
  </div>

  <div id="numeri-tavolo" class="tavolo-grid"></div>

  <button
    id="btn-conferma-tavolo"
    onclick="confermaTavolo()"
    class="tavolo-zona-btn conferma-btn"
    style="display:none; margin-top:20px;">
    Conferma tavolo
  </button>

</section>



<!-- üç® STEP FORMATO -->
<section id="step-size" style="text-align:center; display:none;">

  <div class="icecream-hero">
    <h1 class="icecream-title">
      Benvenuto in <span class="brand">Scoopy ice</span><span class="copyright">¬©</span>
    </h1>

    <p class="icecream-subtitle">
      Crea la tua coppa perfetta e goditi ogni momento
    </p>
  </div>

  <div class="allergie-card">
    <div class="allergie-text">
      <strong>Allergie o intolleranze?</strong>
      <span>Imposta i filtri prima di creare la tua coppa.</span>
    </div>

    <a href="allergie.html" class="allergie-btn">
      Seleziona allergeni
    </a>
  </div>

  <div class="formati-wrapper">

    <h2>Scegli il Formato</h2>

    <p class="format-note">
      Crea la tua coppa quando vuoi, anche da casa.<br>
      <span>Cos√¨ quando arrivi, ordini in un attimo.</span>
    </p>

    <div class="menu-item" onclick="selectSize('PICCOLA', 2,1,1,1)">
      <div class="formato-titolo">PICCOLA ‚Ä¢ ‚Ç¨7,50</div>
      <div class="formato-dettagli">
        2 gusti ¬∑ 1 granella ¬∑ 1 topping ¬∑ 1 decorazione
      </div>
    </div>

    <div class="menu-item" onclick="selectSize('MEDIA', 3,2,2,1)">
      <div class="formato-titolo">MEDIA ‚Ä¢ ‚Ç¨9,00</div>
      <div class="formato-dettagli">
        3 gusti ¬∑ 2 granelle ¬∑ 2 topping ¬∑ 1 decorazione
      </div>
    </div>

    <div class="menu-item" onclick="selectSize('GRANDE', 4,2,2,2)">
      <div class="formato-titolo">GRANDE ‚Ä¢ ‚Ç¨12,00</div>
      <div class="formato-dettagli">
        4 gusti ¬∑ 2 granelle ¬∑ 2 topping ¬∑ 2 decorazioni
      </div>
    </div>

  </div>

</section>



<!-- üîÑ STEP DINAMICO (gusti ecc.) -->
<h2 id="step-title" class="step-title hidden" style="text-align:center; margin-top:10px;"></h2>

<section id="step-container" style="display:none;"></section>

<!-- POPUP -->
<div id="popup-coppa" style="display:none;">
  <div class="popup-content">
    <h2>Come funziona</h2>

    <p class="popup-text">
      Scegli il formato della coppa, poi personalizzala con gusti, granelle,
      topping, decorazioni ed extra.<br>
      Alla fine conferma e mostra la coppa al cameriere.<br>
      <span style="opacity:.7">(Panna montata inclusa nel prezzo)</span>
    </p>

    <!-- üîò NON MOSTRARE PI√ô -->
    <label class="popup-hide">
      <input type="checkbox" id="popup-hide-forever">
      Non mostrare pi√π
    </label>

    <button id="popup-ok">Ho capito</button>
  </div>
</div>

<script>
document.addEventListener("DOMContentLoaded", () => {

  const popup = document.getElementById("popup-coppa");
  if (!popup) return;

  const skipOnce = localStorage.getItem("skip_popup_coppa") === "1";
  const hideForever = localStorage.getItem("hide_popup_coppa") === "1";

  // üî• Se arrivo da cronologia ‚Üí salto una volta
  if (skipOnce) {
    localStorage.removeItem("skip_popup_coppa"); // importante
    popup.remove();
    return;
  }

  if (hideForever) {
    popup.remove();
    return;
  }

  popup.style.display = "flex";

  const btnOk = document.getElementById("popup-ok");
  const hideCheckbox = document.getElementById("popup-hide-forever");

  if (btnOk) {
    btnOk.onclick = () => {
      if (hideCheckbox?.checked) {
        localStorage.setItem("hide_popup_coppa", "1");
      }
      popup.style.display = "none";
    };
  }

});
</script>

<script>
// Nasconde SEMPRE il mini riepilogo quando entri nella pagina
document.getElementById("riepilogo-mini").style.display = "none";
</script>



<!-- EXPORT COPPA (invisibile) -->
<div id="coppa-export" style="
  position: fixed;
  left: -9999px;
  top: 0;
  width: 900px;
  height: auto;
  background: #fff;
">
</div>

<!-- üõí OVERLAY CARRELLO -->
<div id="carrello-overlay">
  <div id="carrello-box">
    <div id="carrello-header">
      <div>
        <h3 style="margin:0">Carrello</h3>

        <!-- ‚ÑπÔ∏è NOTA CARRELLO -->
        <div class="carrello-note">
          (il carrello serve solo per comunicare pi√π coppe insieme) 
        </div>

        <!-- ‚è±Ô∏è TIMER SVUOTAMENTO -->
        <div id="carrello-timer"
             style="font-size:12px; opacity:.6; margin-top:4px; display:none;">
          Svuotamento automatico in:
          <span id="carrello-countdown">--:--</span>
        </div>
      </div>

    <span id="chiudi-carrello" onclick="chiudiCarrello()">‚úñ</span>
</div>

<div id="carrello-scroll">
  <div id="carrello-contenuto">
    <p style="text-align:center; opacity:0.6;">Carrello vuoto</p>
  </div>
</div>

        <div id="carrello-footer">
            <button id="carrello-svuota" onclick="svuotaCarrello()">
    Svuota carrello
</button>
            <button id="btn-cronologia" onclick="apriCronologia()" style="display:none;">
                Coppe create
            </button>
        </div>
    </div>
</div>

<!-- ‚úÖ POPUP RIMOZIONE COPPA (QUI, NON DENTRO IL CARRELLO) -->
<div id="popup-rimuovi-coppa" class="popup-overlay">
  <div class="popup-box">
    <h3>Rimuovere la coppa?</h3>
    <p>La coppa verr√† eliminata dal carrello.</p>

    <div class="popup-actions">
      <button class="btn-secondary" onclick="chiudiPopupRimuovi()">Annulla</button>
      <button class="btn-danger" id="popup-conferma-rimuovi">Rimuovi</button>
    </div>
  </div>
</div>

<!-- üç® POPUP INSTAGRAM -->
<div id="popup-instagram" style="
  position: fixed;
  inset: 0;
  background: rgba(0,0,0,0.45);
  display: none;
  align-items: center;
  justify-content: center;
  z-index: 999999;
">
  <div style="
    background: #fff;
    padding: 22px;
    border-radius: 16px;
    max-width: 320px;
    width: 90%;
    text-align: center;
    box-shadow: 0 10px 30px rgba(0,0,0,0.3);
  ">
    <h3 style="margin-bottom:10px;">üì∏ Condividi su Instagram</h3>

    <p style="font-size:14px; line-height:1.4;">
      Seleziona Instagram dal menu che si aprir√† di seguito e tagga  
      <b>@casadelgelato.it</b> üç®
    </p>

    <div style="margin-top:18px; display:flex; gap:10px;">
      <button onclick="chiudiPopupInstagram()"
        style="flex:1; padding:10px; border-radius:10px; border:1px solid #ccc;">
        Annulla
      </button>

<button onclick="chiudiPopupInstagram(); _eseguiCondivisioneInstagram();"
  style="flex:1; padding:10px; border-radius:10px; border:none;
         background:#ff2d55; color:#fff; font-weight:700;">
  Apri Instagram
</button>
    </div>
  </div>
</div>


<!-- ‚≠ê BOTTOM NAV BAR -->
<div id="bottom-nav">

<a href="crea-coppa.html" class="nav-item">
  <img src="img/scoopy-ice.png" class="nav-icon-img" alt="Crea">
  <span>Scoopy ice</span>
</a>


<div class="nav-item" onclick="apriCarrello()">
  <div class="cart-wrapper">
    
    <!-- üõí ICONA CARRELLO SVG -->
    <svg class="cart-icon" viewBox="0 0 24 24" aria-hidden="true">
      <path d="M3 3h2l2.4 11.2a2 2 0 0 0 2 1.6h7.7a2 2 0 0 0 2-1.6L21 7H6"
        fill="none"
        stroke="currentColor"
        stroke-width="2"
        stroke-linecap="round"
        stroke-linejoin="round"/>
      <circle cx="10" cy="20" r="1.5"/>
      <circle cx="18" cy="20" r="1.5"/>
    </svg>

    <!-- üî¥ BADGE SEMPRE VISIBILE -->
<span id="badge-nav" class="cart-badge"></span>

  </div>
  <span>Carrello</span>
</div>


<a href="profilo.html" class="nav-item">
  <div class="profile-wrapper">
    <svg class="profile-icon" viewBox="0 0 24 24" aria-hidden="true">
      <path d="M12 12c2.761 0 5-2.239 5-5S14.761 2 12 2 7 4.239 7 7s2.239 5 5 5zm0 2c-4.418 0-8 2.239-8 5v1h16v-1c0-2.761-3.582-5-8-5z"/>
    </svg>
  </div>
  <span>Profilo</span>
</a>
<a href="menu.html" class="nav-item">
  <svg class="menu-icon" viewBox="0 0 24 24" aria-hidden="true">
    <rect x="6" y="4" width="12" height="16" rx="2"
          fill="none" stroke="currentColor" stroke-width="2"/>
    <line x1="9" y1="9" x2="15" y2="9" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
    <line x1="9" y1="13" x2="15" y2="13" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
    <line x1="9" y1="17" x2="13" y2="17" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
  </svg>
  <span>Menu</span>
</a>

</div>





<script>
const riepilogo = document.getElementById("riepilogo-mini");
if (riepilogo) {
    riepilogo.innerHTML = `
        <div style="
            position:absolute;
            top:20px;
            left:20px;
            font-size:20px;
            font-weight:700;">
            Riepilogo Coppa (TEST OK)
        </div>
    `;
}
</script>

<script>
let tavoloSelezionato = null;
let zonaSelezionata = null;

function scegliZona(zona) {

  // üî¥ RESET STATO TAVOLO
  tavoloSelezionato = null;
  document.getElementById("btn-conferma-tavolo").style.display = "none";

  zonaSelezionata = zona;

  // üîµ RESET VISIVO ZONA
  document.getElementById("btn-dentro").classList.remove("active");
  document.getElementById("btn-fuori").classList.remove("active");

  if (zona === "D") {
    document.getElementById("btn-dentro").classList.add("active");
  } else {
    document.getElementById("btn-fuori").classList.add("active");
  }

  const container = document.getElementById("numeri-tavolo");
  container.innerHTML = "";
  container.className = "tavolo-grid";

  const max = zona === "D" ? 16 : 23;

  for (let i = 1; i <= max; i++) {
    const num = String(i).padStart(2, "0");
    const codice = num + zona;

    const btn = document.createElement("button");
    btn.textContent = codice;
    btn.className = "tavolo-btn";
    btn.onclick = () => scegliTavolo(codice, btn);

    container.appendChild(btn);
  }
}

function scegliTavolo(codice, btn) {
  tavoloSelezionato = codice;

  document
    .querySelectorAll("#numeri-tavolo button")
    .forEach(b => b.classList.remove("active"));

  btn.classList.add("active");

  document.getElementById("btn-conferma-tavolo").style.display = "block";
}

function confermaTavolo() {

  console.log("Tavolo selezionato:", tavoloSelezionato);

  if (!tavoloSelezionato) {
    mostraToast("Seleziona un tavolo");
    return;
  }

  document.getElementById("step-tavolo").style.display = "none";
  document.getElementById("step-size").style.display = "block";

  // üî• Scrolla in alto PRIMA di mostrare la bottom nav
  window.scrollTo(0, 0);

  mostraBottomNav();
}




</script>
<script type="module">
import { supabase } from "./supabase.js";

let waitInterval = null;
let collapseTimeout = null;

/* ===============================
   WAIT BAR UI
=============================== */

function expandWaitBar() {
  const full = document.getElementById("wait-full");
  const compact = document.getElementById("wait-compact");
  if (!full || !compact) return;

  full.style.display = "inline";
  compact.style.display = "none";

  clearTimeout(collapseTimeout);
  collapseTimeout = setTimeout(collapseWaitBar, 5000);
}

function collapseWaitBar() {
  const full = document.getElementById("wait-full");
  const compact = document.getElementById("wait-compact");
  if (!full || !compact) return;

  full.style.display = "none";
  compact.style.display = "inline";
}

/* ===============================
   LOAD WAIT TIME
=============================== */

async function loadWaitTime() {

  const { data, error } = await supabase
    .from("wait_time")
    .select("*")
    .eq("id", 1)
    .single();

  if (error || !data) return;

  const bar = document.getElementById("wait-bar");
  const txt = document.getElementById("wait-time");

  if (!bar || !txt) return;

  if (waitInterval) {
    clearInterval(waitInterval);
    waitInterval = null;
  }

  if (!data.active || data.minutes <= 0) {
    bar.style.display = "none";
    return;
  }

  const startTime = new Date(data.updated_at).getTime();
  const totalSeconds = data.minutes * 60;

  const activatedEl = document.getElementById("wait-activated");
  if (activatedEl && data.updated_at) {
    const activatedDate = new Date(data.updated_at);
    const hh = activatedDate.getHours().toString().padStart(2,"0");
    const mm = activatedDate.getMinutes().toString().padStart(2,"0");
    activatedEl.textContent = `(attivata alle ${hh}:${mm})`;
  }

  function tick() {

    const now = Date.now();
    const elapsed = Math.floor((now - startTime) / 1000);
    const remaining = totalSeconds - elapsed;

    if (remaining <= 0) {
      bar.style.display = "none";
      clearInterval(waitInterval);
      waitInterval = null;
      return;
    }

    const min = Math.floor(remaining / 60);
    const sec = remaining % 60;
    const timeStr = `${min}:${sec.toString().padStart(2, "0")}`;

    txt.textContent = timeStr;
    document.getElementById("wait-mmss").textContent = timeStr;

    bar.style.display = "flex";

    if (sec === 59) expandWaitBar();
  }

  tick();
  waitInterval = setInterval(tick, 1000);
}

/* ===============================
   AUTO GESTIONE DINAMICA
=============================== */

async function autoGestioneWaitTime() {

  const { data: users } = await supabase
    .from("online_users")
    .select("session_id")
    .gt("last_seen", new Date(Date.now() - 30000).toISOString());

  const count = users?.length || 0;
  console.log("üë• UTENTI CREA COPPA:", count);

  let newMinutes = 0;

  if (count >= 20) newMinutes = 30;
  else if (count >= 15) newMinutes = 25;
  else if (count >= 10) newMinutes = 20;
  else if (count >= 5) newMinutes = 15;

  const { data: current } = await supabase
    .from("wait_time")
    .select("*")
    .eq("id", 1)
    .single();

  if (!current) return;

  if (
    current.active === (newMinutes > 0) &&
    current.minutes === newMinutes
  ) {
    return;
  }

  await supabase
    .from("wait_time")
    .update({
      active: newMinutes > 0,
      minutes: newMinutes,
      updated_at: new Date().toISOString()
    })
    .eq("id", 1);

  console.log("‚è± WAIT AUTO AGGIORNATA:", newMinutes);
}

/* ===============================
   REALTIME
=============================== */

supabase
  .channel("wait-time-live")
  .on(
    "postgres_changes",
    { event: "*", schema: "public", table: "wait_time" },
    () => loadWaitTime()
  )
  .subscribe();

/* ===============================
   START
=============================== */

document.addEventListener("DOMContentLoaded", () => {
  loadWaitTime();
  autoGestioneWaitTime();              // parte subito
  setInterval(autoGestioneWaitTime, 20000); // poi ogni 20 sec
});
</script>

<!-- ‚è±Ô∏è WAIT TIME BAR -->
<div id="wait-bar" style="
  position: fixed;
  bottom: 90px;
  left: 12px;
  background: #111;
  color: white;
  padding: 10px 16px;
  border-radius: 14px;
  font-size: 15px;
  font-weight: 600;
  display: none;
  z-index: 9999;
  box-shadow: 0 6px 20px rgba(0,0,0,0.25);
">

  <!-- üî• VERSIONE COMPLETA -->
  <span id="wait-full" style="display:flex; flex-direction:column; line-height:1.2;">
    
    <span>
      Attesa stimata: <span id="wait-time">0</span>
    </span>

    <span id="wait-activated" style="
      font-size:12px;
      opacity:.7;
      font-weight:500;
      margin-top:2px;
    ">
    </span>

  </span>

  <!-- üî• VERSIONE COMPATTA -->
  <span id="wait-compact" style="display:none">
    <span id="wait-mmss">0:00</span>
  </span>

</div>
<script>

function mostraBottomNav() {
  const nav = document.getElementById("bottom-nav");
  if (nav) nav.style.display = "flex";
}

function nascondiBottomNav() {
  const nav = document.getElementById("bottom-nav");
  if (nav) nav.style.display = "none";
}
</script>

<!-- ‚úÖ POPUP PRE-RIEPILOGO (mettilo prima di </body>) -->
<div id="popup-pre-riepilogo" class="popup-overlay" style="display:none;">
  <div class="popup-box">
    <h3>üëÄ Ci siamo quasi!</h3>

    <p style="line-height:1.5">
      A breve potrai vedere la tua coppa.<br><br>
      üëâ Ricordati di <b>dettarla al cameriere</b><br>
      üëâ <b>Condividila sui social</b> e taggaci üì∏<br>
      üëâ Se necessario, <b>aggiungila al carrello</b> per ordinarne pi√π di una insieme
    </p>

    <label class="popup-check">
   <input type="checkbox" id="popup-pre-no-more">
      Non mostrare pi√π
    </label>

<button class="popup-btn primary popup-continua">
  Continua ‚Üí
</button>
  </div>
</div>

<div id="loading-riepilogo" style="
  display:none;
  position:fixed;
  inset:0;
  background:#fff;
  z-index:9999;
  align-items:center;
  justify-content:center;
  flex-direction:column;
">
  <div style="font-size:22px;font-weight:700;margin-bottom:12px">
    Stiamo preparando la tua coppa
  </div>

  <div id="loading-text" style="opacity:.6;font-size:14px;margin-bottom:18px">
    Caricamento coppa‚Ä¶
  </div>

  <div id="loading-percent" class="loading-percent">0%</div>

  <!-- üî• BARRA -->
  <div style="
    width:220px;
    height:6px;
    background:#eee;
    border-radius:999px;
    overflow:hidden;
  ">
<div id="loading-bar" style="
  height:100%;
  width:0%;
  background:#34c759; /* üçè verde Apple */
  transition:width .25s ease;
  border-radius:999px;
"></div>
  </div>

  <!-- üëá QUI DENTRO, SUBITO DOPO LA BARRA -->
<div id="slow-network-hint" class="slow-hint" style="display:none;">
  <div class="slow-sub">

<div id="slow-wait-text">
  Ci sta mettendo un po‚Äô pi√π del previsto?
  <br><br>
  Potrebbe essere solo un rallentamento di rete üõú
  <br><br>
  ‚ö†Ô∏è <b>Non ricaricare la pagina mentre stiamo salvando la tua coppa.</b>
  <br>
  ‚ùóÔ∏è Se ricarichi adesso, la coppa non verr√† salvata e devi ricominciare da capo ‚ùóÔ∏è
</div>

<div id="slow-safe-text" style="display:none;">
  Ci sta mettendo un po‚Äô pi√π del previsto?
  <br><br>
  Potrebbe essere solo un rallentamento di rete üòÑ
  <br><br>
  üç®‚ú® <b>La tua coppa √® al sicuro.</b>
  <br>
   üöÄ √à gi√† stata salvata correttamente e la trovi nel tuo profilo,
  nella sezione <b>Coppe create</b>.
  <br><br>
  ‚ùóÔ∏è Attendi ancora qualche istante prima di ricaricare la pagina,
  per evitare possibili problemi di sincronizzazione.‚ùóÔ∏è
</div>

  </div>
</div>

</div>
<div id="blur-overlay"></div>

<!-- üöß BLOCCO CREA COPPA ‚Äì COMING SOON -->
<div id="popup-coming-soon" class="popup-overlay" style="display:none;">
  <div class="popup-box">

<h3 id="coming-soon-title">üç® Crea la tua coppa</h3>

<p id="coming-soon-message">
  Funzione in arrivo a breve.<br><br>
  Stiamo preparando un‚Äôesperienza speciale
  per creare la tua coppa personalizzata ‚ú®
</p>

    <!-- CASA DEL GELATO -->
    <div style="margin-top:12px; font-weight:600;">
      Casa del Gelato
    </div>

    <button
      class="popup-btn secondary"
      onclick="tornaAllaHome()"
      style="margin-top:10px;"
    >
      ‚Üê Torna alla Home
    </button>

  </div>
</div>

<script type="module">
import { supabase } from "./supabase.js";

document.addEventListener("DOMContentLoaded", async () => {

  const popup = document.getElementById("popup-coming-soon");
  if (!popup) return;

  const { data, error } = await supabase
    .from("site_settings")
    .select("crea_coppa_enabled, crea_coppa_title, crea_coppa_message")
    .eq("id", 1)
    .single();

  if (error || !data) {
    console.error("Errore Supabase:", error);
    return;
  }

  console.log("üì• DB:", data);

  // üöß SE DISABILITATO ‚Üí mostra popup
  if (data.crea_coppa_enabled === false) {

    const titleEl = document.getElementById("coming-soon-title");
    const msgEl   = document.getElementById("coming-soon-message");

    if (titleEl && data.crea_coppa_title)
      titleEl.innerHTML = data.crea_coppa_title;

    if (msgEl && data.crea_coppa_message)
      msgEl.innerHTML = data.crea_coppa_message.replace(/\n/g,"<br>");

    popup.style.display = "flex";
    document.body.style.overflow = "hidden";
  }

});
</script>

<script>
function tornaAllaHome() {
  window.location.href = "home.html";
}

</script>

<script>
function vaiARegistrazione() {
  window.location.href = "login.html?mode=register";
}
</script>
<div id="toast" class="toast"></div>

<!-- üîµ POPUP COME FUNZIONA ‚Äì CREA COPPA -->
<div id="info-tavolo-overlay" class="bottom-overlay">
  <div class="bottom-sheet">

    <div class="sheet-handle"></div>

    <h3>Come funziona</h3>

    <!-- BODY SCROLLABILE -->
<div class="sheet-body">

<p>
  üëÄ <b>Guarda il numero del tuo tavolo</b> e selezionalo dall‚Äôelenco.<br><br>
  üè† Se stai creando la coppa <b>da casa</b>, clicca il pulsante dedicato
  nella schermata iniziale per proseguire direttamente.
</p>
      <p>
        ‚ö†Ô∏è Se necessario consulta gli <b>allergeni</b>.  
        In ogni caso ti consigliamo sempre di <b>chiedere al personale di sala</b>.
      </p>

      <hr>

      <p>
        üç® Scegli il <b>formato</b> e completa la tua coppa selezionando:
      </p>

      <ul style="padding-left:18px; margin-top:6px;">
        <li><b>Gusti</b></li>
        <li><b>Granelle</b></li>
        <li><b>Topping</b></li>
        <li><b>Decorazioni</b></li>
        <li><b>Extra</b> (facoltativi)</li>
      </ul>

  <p>
    üí° Se non utilizzi tutte le opzioni disponibili per il formato scelto,
    le quantit√† selezionate verranno <b>abbondanti</b> per valorizzare al meglio la tua coppa.
  </p>

      <hr>

      <p>
        üì≤ Una volta completata, scorri fino alla fine del <b>riepilogo finale</b>
        e comunica la coppa al cameriere.
      </p>

      <p>
        üì∏ Non dimenticare di <b>condividerla sui social</b> e <b>taggarci</b> ‚ú®
      </p>

      <p>
        üéÅ Ricorda di chiedere la <b>conferma della coppa</b> per i coupon.
      </p>

      <p>
        üîì Registrati per attivare la <b>Cronologia</b> e sbloccare i vantaggi.
      </p>

    </div>

    <!-- FOOTER STICKY CON SFUMATURA -->
    <div class="sheet-footer">

     <div class="popup-scroll-hint" id="info-scroll-hint">
  ‚Üì Scorri per leggere tutto ‚Üì
</div>

      <button id="chiudi-info-tavolo" class="sheet-close-btn">
        Chiudi
      </button>

    </div>

  </div>
</div>

<div id="toast-avviso" class="toast-avviso"></div>



<div id="coppa-origin-overlay" class="coppa-origin-overlay">
  <div class="coppa-origin-card">

    <!-- üîµ LOGO TONDO -->
    <div class="coppa-origin-logo">
      <img src="img/scoopy-ice.png" alt="Scoopy Ice">
    </div>

    <h2>Da dove stai creando la tua coppa?</h2>

    <button class="coppa-origin-btn home" onclick="creaDaCasa()">
      Da casa
    </button>

    <button class="coppa-origin-btn locale" onclick="creaInLocale()">
      In locale
    </button>

<button class="info-dup-btn" onclick="apriInfoTavolo()">
  Come funziona? Clicca qui
</button>

  </div>
</div>

<script>
function apriInfoTavolo() {

  const originOverlay = document.getElementById("coppa-origin-overlay");
  const infoBtn = document.getElementById("info-tavolo-btn");
  const closeBtn = document.getElementById("chiudi-info-tavolo");

  if (!originOverlay || !infoBtn || !closeBtn) return;

  // Nasconde popup iniziale
  originOverlay.style.display = "none";

  // Apre lo sheet usando il bottone originale
  infoBtn.click();

  // Quando chiudi lo sheet ‚Üí riapri popup iniziale
  closeBtn.addEventListener("click", function riapri() {
    originOverlay.style.display = "flex";
    closeBtn.removeEventListener("click", riapri);
  });
}
</script>



</body>
</html>