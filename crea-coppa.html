<!DOCTYPE html>
<html lang="it">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Crea la tua Coppa</title>

  <link rel="stylesheet" href="style.css">
  <script defer src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
  <!-- Supabase: modulo che attacca le funzioni su window -->
  <script type="module" src="supabase.js"></script>

<!-- Logica Crea Coppa (una sola volta) -->
 <script defer src="carrello.js"></script>
<script defer src="crea-coppa.js"></script>

<script>
document.addEventListener("DOMContentLoaded", function () {
    if (typeof updateCarrelloBadge === "function") {
        updateCarrelloBadge();
    }
});
</script>
<body>

<!-- ‚ö†Ô∏è TASTO ALLERGIE ‚Äì ora visibile -->
<a href="allergie.html" 
   style="
        position: fixed;
        top: 12px;
        right: 12px;
        background: #ff3b30;
        color: white;
        padding: 8px 14px;
        border-radius: 10px;
        font-size: 14px;
        font-weight: 600;
        text-decoration: none;
        z-index: 9999;
        box-shadow: 0 2px 6px rgba(0,0,0,0.15);
   ">
   ‚ö†Ô∏è Allergie
</a>

<!-- solo UNO spacer -->
<div style="height:60px;"></div>

<div id="top-fixed-bar">
    <a href="index.html" class="home-btn">
        <img src="tastohome.png" alt="home">
        <span>Home</span>
    </a>
</div>

<div id="top-fixed-spacer"></div>

<!-- MINI RIEPILOGO: SOLO UNO (niente doppio id) -->
<div id="riepilogo-mini"></div>

<!-- üçè DYNAMIC ISLAND -->
<div id="dynamic-island">
    <div id="island-title">Gusti (0/0)</div>
    <div id="island-added">Aggiunto!</div>
    <div id="island-progress"><div id="island-bar"></div></div>
</div>

<header style="text-align:center; padding:26px;">
  <h1>Crea la tua Coppa Gelato</h1>
</header>

<section id="step-size" style="text-align:center;">
  <h2>Scegli il Formato</h2>
  <p style="margin-top:6px; font-size:15px; color:#444; font-weight:500;">
    Panna inclusa
  </p>

  <p style="margin-top:2px; font-size:13px; color:#666; line-height:1.3;">
    ‚ö†Ô∏èPer eventuali allergie o intolleranze consultare la lista 
    e avvisare il cameriere‚ö†Ô∏è

    (Selezionando gli allergeni i prodotti verranno gi√† filtrati durante la creazione della coppa)
  </p>

  <!-- üî∂ Tasto Allergie direttamente sotto il testo -->
  <div style="margin-top:10px; margin-bottom:20px;">
      <a href="allergie.html"
         style="
              display:inline-block;
              background:#ff3b30;
              color:white;
              padding:10px 16px;
              border-radius:10px;
              font-size:14px;
              font-weight:600;
              text-decoration:none;
              box-shadow:0 2px 5px rgba(0,0,0,0.20);
         ">
          ‚ö†Ô∏è Apri lista allergeni
      </a>
  </div>

  <!-- SCELTA FORMATO (onclick usa funzioni globali di crea-coppa.js) -->
 <div class="menu-item" onclick="selectSize('PICCOLA', 2,1,1,1)">
  <div class="formato-titolo">PICCOLA ‚Ä¢ ‚Ç¨7,50</div>
  <div class="formato-dettagli">
    2 gusti ¬∑ 1 granella ¬∑ 1 topping ¬∑ 1 ingrediente
  </div>
</div>

<div class="menu-item" onclick="selectSize('MEDIA', 3,2,2,1)">
  <div class="formato-titolo">MEDIA ‚Ä¢ ‚Ç¨9,00</div>
  <div class="formato-dettagli">
    3 gusti ¬∑ 2 granelle ¬∑ 2 topping ¬∑ 1 ingrediente
  </div>
</div>

<div class="menu-item" onclick="selectSize('GRANDE', 4,2,2,2)">
  <div class="formato-titolo">GRANDE ‚Ä¢ ‚Ç¨12,00</div>
  <div class="formato-dettagli">
    4 gusti ¬∑ 2 granelle ¬∑ 2 topping ¬∑ 2 ingredient1
  </div>
</div>
</section>

<h2 id="step-title" class="step-title" style="display:none; text-align:center; margin-top:10px;"></h2>

<section id="step-container" style="display:none;">
</section>

<!-- FORM REGISTRAZIONE -->
<div id="reg-box" style="display:none; padding:20px; text-align:center;">
  <h2>Registrazione</h2>
  <p>Compila i dati per salvare le tue coppe e sbloccare la cronologia.</p>

  <input id="reg-nome" type="text" placeholder="Nome"
    style="padding:12px; width:80%; max-width:260px; border-radius:10px; border:1px solid #ccc; margin-bottom:10px;">

  <input id="reg-cognome" type="text" placeholder="Cognome"
    style="padding:12px; width:80%; max-width:260px; border-radius:10px; border:1px solid #ccc; margin-bottom:10px;">

  <input id="reg-email" type="email" placeholder="Email"
    style="padding:12px; width:80%; max-width:260px; border-radius:10px; border:1px solid #ccc; margin-bottom:14px;">

  <div style="margin-top:10px;">
    <button class="next-btn" onclick="salvaRegistrazione()">Registrati</button>
    <br><br>
    <button class="back-btn" onclick="chiudiRegistrazione()">‚¨Ö Torna indietro</button>
  </div>
</div>

<!-- POPUP -->
<div id="popup-coppa">
  <div class="popup-content">
    <h2>üç® Come funziona</h2>
    <p>Seleziona prima il formato. Poi scegli gusti, granelle, topping ed ingredienti. Infine conferma e detta la tua coppa al cameriere! ‚úÖ 
      (Panna montata inclusa nel prezzo)</p>
    <button id="popup-ok">Ho capito</button>
  </div>
</div>

<script>
// NON mostrare il popup se arrivo da "usa questa coppa"
const fromCrono = window.location.search.includes("from=cronologia");

if (!fromCrono) {
    document.getElementById("popup-coppa").style.display = "flex";
    document.getElementById("popup-ok").onclick = () => {
        document.getElementById("popup-coppa").style.display = "none";
    };
} else {
    document.getElementById("popup-coppa").style.display = "none";
}
</script>

<script>
// Nasconde SEMPRE il mini riepilogo quando entri nella pagina
document.getElementById("riepilogo-mini").style.display = "none";
</script>

<script>
// APRI MODULO
function apriRegistrazione() {
    document.getElementById("step-size").style.display = "none";
    document.getElementById("step-container").style.display = "none";
    document.getElementById("step-title").style.display = "none";

    document.getElementById("reg-box").style.display = "block";
}

// CHIUDI MODULO
function chiudiRegistrazione() {
    document.getElementById("reg-box").style.display = "none";
    document.getElementById("step-container").style.display = "block";
    document.getElementById("step-title").style.display = "block";
}

// SALVA REGISTRAZIONE (usa Supabase globale)
async function salvaRegistrazione() {
    const nome = document.getElementById("reg-nome").value.trim();
    const cognome = document.getElementById("reg-cognome").value.trim();
    const email = document.getElementById("reg-email").value.trim().toLowerCase();

    if (!nome || !cognome || !email) {
        alert("‚ö†Ô∏è Compila tutti i campi: Nome, Cognome, Email.");
        return;
    }

    // 1Ô∏è‚É£ Manda i dati a Supabase
    let res = await window.salvaRegistrazioneSupabase(nome, cognome, email);

    if (!res.success) {
        alert("Errore durante la registrazione: " + res.error);
        return;
    }

// 2Ô∏è‚É£ Salva localmente che l'utente √® registrato
localStorage.setItem("userLogged", "1");
localStorage.setItem("user_email", email);

// üî• 3Ô∏è‚É£ Collega le coppe anonime a questa email
const guest_id = localStorage.getItem("guest_id");

if (guest_id) {
    await supabase
        .from("coppe")
        .update({ email: email })
        .eq("guest_id", guest_id)
        .is("email", null);
}
    alert("üéâ Registrazione completata! Cronologia coppe sbloccata.");
    window.location.href = "index.html";
}
</script>

<!-- üõí OVERLAY CARRELLO -->
<div id="carrello-overlay">
    <div id="carrello-box">
        <div id="carrello-header">
            <h3>Carrello</h3>
            <span id="chiudi-carrello" onclick="chiudiCarrello()">‚úñ</span>
        </div>

        <div id="carrello-contenuto">
            <p style="text-align:center; opacity:0.6;">Carrello vuoto</p>
        </div>

        <div id="carrello-footer">
            <button id="carrello-svuota" onclick="svuotaCarrello()">
    Svuota carrello
</button>
            <button id="btn-cronologia" onclick="apriCronologia()" style="display:none;">
                Cronologia coppe
            </button>
        </div>
    </div>
</div>

<!-- ‚≠ê BOTTOM NAV BAR -->
<div id="bottom-nav">
   <div class="nav-item" onclick="apriCarrello()">
        <div style="position:relative;">
            <img src="icone/cart.png" alt="">
            <span id="badge-nav" class="nav-badge">0</span>
        </div>
        <span>Carrello</span>
    </div>

    <a href="profilo.html" class="nav-item">
        <img src="icone/user.png" alt="">
        <span>Profilo</span>
    </a>

    <a href="menu.html" class="nav-item">
        <img src="icone/menu.png" alt="">
        <span>Menu</span>
    </a>

    <a href="lavora-con-noi.html" class="nav-item">
        <img src="icone/job.png" alt="">
        <span>Lavora Con Noi</span>
    </a>
</div>

</body>
</html>