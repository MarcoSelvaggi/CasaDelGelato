<!DOCTYPE html>
<html lang="it">
<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-auth-compat.js"></script>

<script>
  const firebaseConfig = {
    apiKey: "AIzaSyAEO7AonQeZ9SsgXd1Ymw2NZW-Pg4mI8E8",
    authDomain: "casadelgelato-db282.firebaseapp.com",
    projectId: "casadelgelato-db282",
  };

  firebase.initializeApp(firebaseConfig);
  const auth = firebase.auth();
</script>

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Crea la tua Coppa</title>

  <link rel="stylesheet" href="style.css">
  <script defer src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
  <script defer src="crea-coppa.js"></script>
</head>

<body>

<!-- ‚ö†Ô∏è TASTO ALLERGIE ‚Äì ora visibile -->
<a href="allergie.html" 
   style="
        position: fixed;
        top: 12px;
        right: 12px;
        background: #ff3b30;
        color: white;
        padding: 8px 14px;
        border-radius: 10px;
        font-size: 14px;
        font-weight: 600;
        text-decoration: none;
        z-index: 9999;
        box-shadow: 0 2px 6px rgba(0,0,0,0.15);
   ">
   ‚ö†Ô∏è Allergie
</a>

<!-- solo UNO spacer -->
<div style="height:60px;"></div>

<div id="top-fixed-bar">
    <a href="index.html" class="home-btn">
        <img src="tastohome.png" alt="home">
        <span>Home</span>
    </a>
</div>

<div id="top-fixed-spacer"></div>

<!-- MINI RIEPILOGO: DEVE ESSERE VUOTO E SENZA CLASSI -->
<div id="riepilogo-mini"></div>
<div id="riepilogo-mini" style="display:none;"></div>

<!-- üçè DYNAMIC ISLAND -->
<div id="dynamic-island">
    <div id="island-title">Gusti (0/0)</div>
    <div id="island-added">Aggiunto!</div>
    <div id="island-progress"><div id="island-bar"></div></div>
</div>

<header style="text-align:center; padding:26px;">
  <h1>Crea la tua Coppa Gelato</h1>
</header>

<section id="step-size" style="text-align:center;">
  <h2>Scegli il Formato</h2>
  <p style="margin-top:6px; font-size:15px; color:#444; font-weight:500;">
    Panna inclusa
</p>

<p style="margin-top:2px; font-size:13px; color:#666; line-height:1.3;">
    ‚ö†Ô∏èPer eventuali allergie e intolleranze consultare la lista qui in alto 
    e avvisare il cameriere‚ö†Ô∏è
</p>
<!-- üî∂ Tasto Allergie direttamente sotto il testo -->
<div style="margin-top:10px; margin-bottom:20px;">
    <a href="allergie.html"
       style="
            display:inline-block;
            background:#ff3b30;
            color:white;
            padding:10px 16px;
            border-radius:10px;
            font-size:14px;
            font-weight:600;
            text-decoration:none;
            box-shadow:0 2px 5px rgba(0,0,0,0.20);
       ">
        ‚ö†Ô∏è Apri lista allergie
    </a>
</div>

<div class="menu-item" onclick="selectSize('PICCOLA', 2,1,1,1)">
  <b>PICCOLLA ‚Ä¢ ‚Ç¨7,50</b><br>
  2 gusti ¬∑ 1 granella ¬∑ 1 topping ¬∑ 1 ingrediente
</div>

<div class="menu-item" onclick="selectSize('MEDIA', 3,2,2,1)">
  <b>MEDIA ‚Ä¢ ‚Ç¨9,00</b><br>
  3 gusti ¬∑ 2 granelle ¬∑ 2 topping ¬∑ 1 ingrediente
</div>

<div class="menu-item" onclick="selectSize('GRANDE', 4,2,2,2)">
  <b>GRANDE ‚Ä¢ ‚Ç¨12,00</b><br>
  4 gusti ¬∑ 2 granelle ¬∑ 2 topping ¬∑ 2 ingredienti
</div>
</section>

<h2 id="step-title" class="step-title" style="display:none; text-align:center; margin-top:10px;"></h2>

<section id="step-container" style="display:none;">
</section>

<!-- POPUP -->
<div id="popup-coppa">
  <div class="popup-content">
    <h2>üç® Come funziona</h2>
    <p>Seleziona prima il formato. Poi scegli gusti, granelle, topping ed ingredienti. Infine conferma ‚úÖ</p>
    <button id="popup-ok">Ho capito</button>
  </div>
</div>

<script>

 // NON mostrare il popup se arrivo da "usa questa coppa"
const fromCrono = window.location.search.includes("from=cronologia");

if (!fromCrono) {
    document.getElementById("popup-coppa").style.display = "flex";
    document.getElementById("popup-ok").onclick = () => {
        document.getElementById("popup-coppa").style.display = "none";
    };
} else {
    // assicura che il popup sia nascosto
    document.getElementById("popup-coppa").style.display = "none";
}
</script>
<!-- FORM REGISTRAZIONE -->
<div id="reg-box" style="display:none; padding:20px; text-align:center;">
  <h2>Registrazione</h2>
  <p>Inserisci la tua email per salvare le tue coppe.</p>

  <input id="reg-email" type="email" placeholder="La tua email"
    style="padding:12px; width:80%; max-width:260px; border-radius:10px; border:1px solid #ccc; margin-bottom:14px;">

  <div>
    <button class="next-btn" onclick="inviaRegistrazione()">Invia conferma</button>
    <br><br>
    <button class="back-btn" onclick="chiudiRegistrazione()">‚¨Ö Torna indietro</button>
  </div>
</div>
<script>
function apriRegistrazione() {
    document.getElementById("step-container").style.display = "none";
    document.getElementById("step-title").style.display = "none";
    document.getElementById("reg-box").style.display = "block";
}

function chiudiRegistrazione() {
    document.getElementById("reg-box").style.display = "none";
    document.getElementById("step-container").style.display = "block";
    document.getElementById("step-title").style.display = "block";
}

async function inviaRegistrazione() {
    const email = document.getElementById("reg-email").value.trim();
    if (!email) {
        alert("Inserisci una email valida.");
        return;
    }

    try {
        await auth.sendSignInLinkToEmail(email, {
            url: window.location.origin + "/crea-coppa.html",
            handleCodeInApp: true
        });

        window.localStorage.setItem("emailForSignIn", email);

        alert("üì¨ Ti abbiamo inviato un link di conferma.\nApri la mail per completare la registrazione!");
    } catch (err) {
        console.error(err);
        alert("Errore: " + err.message);
    }
}
</script>
<script>
document.addEventListener("DOMContentLoaded", async () => {
    if (auth.isSignInWithEmailLink(window.location.href)) {

        let email = window.localStorage.getItem("emailForSignIn");
        if (!email) email = prompt("Inserisci la tua email per completare il login:");

        try {
            await auth.signInWithEmailLink(email, window.location.href);
            window.localStorage.removeItem("emailForSignIn");

            alert("üéâ Registrazione completata! Hai sbloccato la cronologia.");
            localStorage.setItem("userLogged", "1");

            window.location.href = "index.html";
        } catch (err) {
            console.error(err);
            alert("Errore: " + err.message);
        }
    }
});
</script>
<script>
if ("serviceWorker" in navigator) {
    navigator.serviceWorker
        .register("service-worker.js")
        .then(() => console.log("Service Worker registrato"))
        .catch(err => console.error("Errore Service Worker:", err));
}
</script>
<script>
// Nasconde SEMPRE il mini riepilogo quando entri nella pagina
document.getElementById("riepilogo-mini").style.display = "none";
</script>
</body>
</html>