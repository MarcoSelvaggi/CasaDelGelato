<!DOCTYPE html>
<html lang="it">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <title>Crea la tua Coppa</title>

  <link rel="stylesheet" href="style.css">

  <!-- LIBRERIE -->
  <script defer src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>

  <!-- Supabase -->
  <script type="module" src="supabase.js"></script>

  <!-- Script app -->
  <script defer src="carrello.js"></script>
  <script defer src="crea-coppa.js"></script>
</head>

<script>
document.addEventListener("DOMContentLoaded", function () {
    if (typeof updateCarrelloBadge === "function") {
        updateCarrelloBadge();
    }
});
</script>
<body>

<!-- ‚ö†Ô∏è TASTO ALLERGIE ‚Äì ora visibile -->
<a href="allergie.html" 
   style="
        position: fixed;
        top: 12px;
        right: 12px;
        background: #ff3b30;
        color: white;
        padding: 8px 14px;
        border-radius: 10px;
        font-size: 14px;
        font-weight: 600;
        text-decoration: none;
        z-index: 9999;
        box-shadow: 0 2px 6px rgba(0,0,0,0.15);
   ">
   ‚ö†Ô∏è Allergie
</a>
<div id="app-blur-zone"></div>

<!-- solo UNO spacer -->
<div style="height:60px;"></div>

<div id="top-fixed-bar">
    <a href="home.html" class="home-btn" aria-label="Home">
        <img src="tastohome.png" alt="home">
    </a>
</div>

<div id="top-fixed-spacer"></div>

<!-- MINI RIEPILOGO: SOLO UNO (niente doppio id) -->
<div id="riepilogo-mini"></div>

<!-- üçè DYNAMIC ISLAND -->
<div id="dynamic-island">
    <div id="island-title">Gusti (0/0)</div>
    <div id="island-added">Aggiunto!</div>
    <div id="island-progress"><div id="island-bar"></div></div>
</div>


<!-- ü™ë SELEZIONE TAVOLO -->
<section id="step-tavolo" style="text-align:center; padding:20px;">

  <h2>Seleziona il tavolo</h2>

<div class="tavolo-zona">
  <button
    id="btn-dentro"
    class="tavolo-zona-btn"
    data-zona="D"
    onclick="scegliZona('D')">
    Dentro
  </button>

  <button
    id="btn-fuori"
    class="tavolo-zona-btn"
    data-zona="F"
    onclick="scegliZona('F')">
    Fuori
  </button>
</div>

<div id="numeri-tavolo" class="tavolo-grid"></div>
<!-- Bottone conferma tavolo -->
<button
  id="btn-conferma-tavolo"
  onclick="confermaTavolo()"
  class="tavolo-zona-btn conferma-btn"
  style="display:none; margin-top:20px;">
  Conferma tavolo
</button>

</section>
  <section id="step-size" style="text-align:center; display:none;">
  

  
<p style="margin-top:2px; font-size:13px; color:#666; line-height:1.3;">
  <span style="font-weight:600; color:#333;">
    Hai allergie o intolleranze?
  </span><br>
  Seleziona gli allergeni: gli ingredienti verranno filtrati automaticamente.
</p>
  <!-- üî∂ Tasto Allergie direttamente sotto il testo -->
  <div style="margin-top:10px; margin-bottom:20px;">
      <a href="allergie.html"
         style="
              display:inline-block;
              background:#ff3b30;
              color:white;
              padding:10px 16px;
              border-radius:10px;
              font-size:14px;
              font-weight:600;
              text-decoration:none;
              box-shadow:0 2px 5px rgba(0,0,0,0.20);
         ">
          Seleziona allergeni
      </a>
  </div>

<h2>Scegli il Formato</h2>
  <!-- SCELTA FORMATO (onclick usa funzioni globali di crea-coppa.js) -->
 <div class="menu-item" onclick="selectSize('PICCOLA', 2,1,1,1)">
  <div class="formato-titolo">PICCOLA ‚Ä¢ ‚Ç¨7,50</div>
  <div class="formato-dettagli">
    2 gusti ¬∑ 1 granella ¬∑ 1 topping ¬∑ 1 ingrediente
  </div>
</div>

<div class="menu-item" onclick="selectSize('MEDIA', 3,2,2,1)">
  <div class="formato-titolo">MEDIA ‚Ä¢ ‚Ç¨9,00</div>
  <div class="formato-dettagli">
    3 gusti ¬∑ 2 granelle ¬∑ 2 topping ¬∑ 1 ingrediente
  </div>
</div>

<div class="menu-item" onclick="selectSize('GRANDE', 4,2,2,2)">
  <div class="formato-titolo">GRANDE ‚Ä¢ ‚Ç¨12,00</div>
  <div class="formato-dettagli">
    4 gusti ¬∑ 2 granelle ¬∑ 2 topping ¬∑ 2 ingredienti
  </div>
</div>
</section>

<h2 id="step-title" class="step-title" style="text-align:center; margin-top:10px;"></h2>

<section id="step-container" style="display:none;">
</section>


</div> <!-- üî¥ CHIUSURA app-blur-zone -->

<!-- POPUP -->
<div id="popup-coppa">
  <div class="popup-content">
    <h2>üç® Come funziona</h2>

    <p class="popup-text">
      Scegli il formato della coppa, poi personalizzala con gusti, granelle,
      topping ed extra.<br>
      Alla fine conferma e mostra la coppa al cameriere.<br>
      <span style="opacity:.7">(Panna montata inclusa nel prezzo)</span>
    </p>

    <!-- üîò NON MOSTRARE PI√ô -->
    <label class="popup-hide">
      <input type="checkbox" id="popup-hide-forever">
      Non mostrare pi√π
    </label>

    <button id="popup-ok">Ho capito</button>
  </div>
</div>

<script>
  const params = new URLSearchParams(window.location.search);

  const fromCrono    = params.get("from") === "cronologia";
  const fromAllergie = params.get("step") === "size";

  const popup = document.getElementById("popup-coppa");
  const btnOk = document.getElementById("popup-ok");
  const hideCheckbox = document.getElementById("popup-hide-forever");

  const hideForever = localStorage.getItem("hide_popup_coppa") === "1";

  // ‚ùå condizioni per NON mostrarlo
  if (fromCrono || fromAllergie || hideForever) {
    popup.style.display = "none";
  } else {
    popup.style.display = "flex";
  }

  btnOk.onclick = () => {
    if (hideCheckbox.checked) {
      localStorage.setItem("hide_popup_coppa", "1");
    }
    popup.style.display = "none";
  };
</script>

<script>
// Nasconde SEMPRE il mini riepilogo quando entri nella pagina
document.getElementById("riepilogo-mini").style.display = "none";
</script>



<!-- EXPORT COPPA (invisibile) -->
<div id="coppa-export" style="
  position: fixed;
  left: -9999px;
  top: 0;
  width: 900px;
  height: auto;
  background: #fff;
">
</div>

<!-- üõí OVERLAY CARRELLO -->
<div id="carrello-overlay">
  <div id="carrello-box">
    <div id="carrello-header">
      <div>
        <h3 style="margin:0">Carrello</h3>

        <!-- ‚ÑπÔ∏è NOTA CARRELLO -->
        <div class="carrello-note">
          (il carrello serve solo per comunicare pi√π coppe insieme) 
        </div>

        <!-- ‚è±Ô∏è TIMER SVUOTAMENTO -->
        <div id="carrello-timer"
             style="font-size:12px; opacity:.6; margin-top:4px; display:none;">
          Svuotamento automatico in:
          <span id="carrello-countdown">--:--</span>
        </div>
      </div>

    <span id="chiudi-carrello" onclick="chiudiCarrello()">‚úñ</span>
</div>

        <div id="carrello-contenuto">
            <p style="text-align:center; opacity:0.6;">Carrello vuoto</p>
        </div>

        <div id="carrello-footer">
            <button id="carrello-svuota" onclick="svuotaCarrello()">
    Svuota carrello
</button>
            <button id="btn-cronologia" onclick="apriCronologia()" style="display:none;">
                Cronologia coppe
            </button>
        </div>
    </div>
</div>

<!-- ‚úÖ POPUP RIMOZIONE COPPA (QUI, NON DENTRO IL CARRELLO) -->
<div id="popup-rimuovi-coppa" class="popup-overlay">
  <div class="popup-box">
    <h3>Rimuovere la coppa?</h3>
    <p>La coppa verr√† eliminata dal carrello.</p>

    <div class="popup-actions">
      <button class="btn-secondary" onclick="chiudiPopupRimuovi()">Annulla</button>
      <button class="btn-danger" id="popup-conferma-rimuovi">Rimuovi</button>
    </div>
  </div>
</div>

<!-- üç® POPUP INSTAGRAM -->
<div id="popup-instagram" style="
  position: fixed;
  inset: 0;
  background: rgba(0,0,0,0.45);
  display: none;
  align-items: center;
  justify-content: center;
  z-index: 999999;
">
  <div style="
    background: #fff;
    padding: 22px;
    border-radius: 16px;
    max-width: 320px;
    width: 90%;
    text-align: center;
    box-shadow: 0 10px 30px rgba(0,0,0,0.3);
  ">
    <h3 style="margin-bottom:10px;">üì∏ Condividi su Instagram</h3>

    <p style="font-size:14px; line-height:1.4;">
      Condividi la tua coppa su Instagram e tagga  
      <b>@casadelgelato.it</b> üç®
    </p>

    <div style="margin-top:18px; display:flex; gap:10px;">
      <button onclick="chiudiPopupInstagram()"
        style="flex:1; padding:10px; border-radius:10px; border:1px solid #ccc;">
        Annulla
      </button>

<button onclick="chiudiPopupInstagram(); _eseguiCondivisioneInstagram();"
  style="flex:1; padding:10px; border-radius:10px; border:none;
         background:#ff2d55; color:#fff; font-weight:700;">
  Apri Instagram
</button>
    </div>
  </div>
</div>


<!-- ‚≠ê BOTTOM NAV BAR -->
<div id="bottom-nav">
<div class="nav-item" onclick="apriCarrello()">
  <div class="cart-wrapper">
    
    <!-- üõí ICONA CARRELLO SVG -->
    <svg class="cart-icon" viewBox="0 0 24 24" aria-hidden="true">
      <path d="M3 3h2l2.4 11.2a2 2 0 0 0 2 1.6h7.7a2 2 0 0 0 2-1.6L21 7H6"
        fill="none"
        stroke="currentColor"
        stroke-width="2"
        stroke-linecap="round"
        stroke-linejoin="round"/>
      <circle cx="10" cy="20" r="1.5"/>
      <circle cx="18" cy="20" r="1.5"/>
    </svg>

    <!-- üî¥ BADGE SEMPRE VISIBILE -->
<span id="badge-nav" class="cart-badge"></span>

  </div>
  <span>Carrello</span>
</div>

<a href="profilo.html" class="nav-item">
  <div class="profile-wrapper">
    <svg class="profile-icon" viewBox="0 0 24 24" aria-hidden="true">
      <path d="M12 12c2.761 0 5-2.239 5-5S14.761 2 12 2 7 4.239 7 7s2.239 5 5 5zm0 2c-4.418 0-8 2.239-8 5v1h16v-1c0-2.761-3.582-5-8-5z"/>
    </svg>
  </div>
  <span>Profilo</span>
</a>
<a href="menu.html" class="nav-item">
  <svg class="menu-icon" viewBox="0 0 24 24" aria-hidden="true">
    <rect x="6" y="4" width="12" height="16" rx="2"
          fill="none" stroke="currentColor" stroke-width="2"/>
    <line x1="9" y1="9" x2="15" y2="9" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
    <line x1="9" y1="13" x2="15" y2="13" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
    <line x1="9" y1="17" x2="13" y2="17" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
  </svg>
  <span>Menu</span>
</a>

</div>





<script>
  const riepilogo = document.getElementById("riepilogo-coppa");

  riepilogo.innerHTML = `
    <div style="
      position:absolute;
      top:20px;
      left:20px;
      font-size:20px;
      font-weight:700;
    ">
      Riepilogo Coppa (TEST OK)
    </div>
  `;
</script>

<script>
let tavoloSelezionato = null;
let zonaSelezionata = null;

function scegliZona(zona) {
  zonaSelezionata = zona;

  // üîµ RESET VISIVO
  document.getElementById("btn-dentro").classList.remove("active");
  document.getElementById("btn-fuori").classList.remove("active");

  // üîµ ATTIVA ZONA SELEZIONATA
  if (zona === "D") {
    document.getElementById("btn-dentro").classList.add("active");
  } else {
    document.getElementById("btn-fuori").classList.add("active");
  }

  // ===== CODICE ESISTENTE (NON TOCCATO) =====
  const container = document.getElementById("numeri-tavolo");
  container.innerHTML = "";
  container.className = "tavolo-grid";

  const max = zona === "D" ? 16 : 23;

  for (let i = 1; i <= max; i++) {
    const num = String(i).padStart(2, "0");
    const codice = num + zona;

    const btn = document.createElement("button");
    btn.textContent = codice;
    btn.className = "tavolo-btn";
    btn.onclick = () => scegliTavolo(codice, btn);

    container.appendChild(btn);
  }
}

function scegliTavolo(codice, btn) {
  tavoloSelezionato = codice;

  document
    .querySelectorAll("#numeri-tavolo button")
    .forEach(b => b.classList.remove("active"));

  btn.classList.add("active");

  document.getElementById("btn-conferma-tavolo").style.display = "block";
}

function confermaTavolo() {
  if (!tavoloSelezionato) {
    alert("Seleziona un tavolo");
    return;
  }

  document.getElementById("step-tavolo").style.display = "none";
  document.getElementById("step-size").style.display = "block";
  mostraBottomNav();
}




</script>
<script type="module">
import { supabase } from "./supabase.js";

let waitInterval = null;
let collapseTimeout = null;

function expandWaitBar() {
  const full = document.getElementById("wait-full");
  const compact = document.getElementById("wait-compact");

  if (!full || !compact) return;

  full.style.display = "inline";
  compact.style.display = "none";

  clearTimeout(collapseTimeout);
  collapseTimeout = setTimeout(collapseWaitBar, 5000);
}

function collapseWaitBar() {
  const full = document.getElementById("wait-full");
  const compact = document.getElementById("wait-compact");

  if (!full || !compact) return;

  full.style.display = "none";
  compact.style.display = "inline";
}

async function loadWaitTime() {
  const { data, error } = await supabase
    .from("wait_time")
    .select("*")
    .eq("id", 1)
    .single();

  if (error || !data) return;

  const bar = document.getElementById("wait-bar");
  const txt = document.getElementById("wait-time");

  if (!bar || !txt) return;

  // stop eventuale timer precedente
  if (waitInterval) {
    clearInterval(waitInterval);
    waitInterval = null;
  }

  if (!data.active || data.minutes <= 0) {
    bar.style.display = "none";
    return;
  }

  const startTime = new Date(data.updated_at).getTime();
  const totalSeconds = data.minutes * 60;

function tick() {
  const now = Date.now();
  const elapsed = Math.floor((now - startTime) / 1000);
  const remaining = totalSeconds - elapsed;

  if (remaining <= 0) {
    bar.style.display = "none";
    clearInterval(waitInterval);
    waitInterval = null;
    return;
  }

  const min = Math.floor(remaining / 60);
  const sec = remaining % 60;
  const timeStr = `${min}:${sec.toString().padStart(2, "0")}`;

  // üî¢ aggiorna entrambi i testi
  txt.textContent = timeStr;
  document.getElementById("wait-mmss").textContent = timeStr;

  bar.style.display = "flex";

// ‚è±Ô∏è quando inizia un nuovo minuto ‚Üí riapre la barra
if (sec === 59) {
  expandWaitBar();
}
}
  tick(); // ‚è±Ô∏è avvio immediato
  waitInterval = setInterval(tick, 1000);
}

// üî¥ REALTIME WAIT TIME
supabase
  .channel("wait-time-live")
  .on(
    "postgres_changes",
    {
      event: "*",
      schema: "public",
      table: "wait_time"
    },
    payload => {
      console.log("üîÅ wait_time aggiornato realtime:", payload);
      loadWaitTime();
    }
  )
  .subscribe();

document.addEventListener("DOMContentLoaded", loadWaitTime);
</script>

<!-- ‚è±Ô∏è WAIT TIME BAR -->
<div id="wait-bar" style="
  position: fixed;
  bottom: 90px;
  left: 12px;
  transform: none;
  background: #111;
  color: white;
  padding: 10px 16px;
  border-radius: 14px;
  font-size: 15px;
  font-weight: 600;
  display: none;
  z-index: 9999;
  box-shadow: 0 6px 20px rgba(0,0,0,0.25);
">
  <span id="wait-full">
  Attesa stimata: <span id="wait-time">0</span>
</span>
<span id="wait-compact" style="display:none">
  <span id="wait-mmss">0:00</span>
</span>
</div>
<script>

function mostraBottomNav() {
  const nav = document.getElementById("bottom-nav");
  if (nav) nav.style.display = "flex";
}

function nascondiBottomNav() {
  const nav = document.getElementById("bottom-nav");
  if (nav) nav.style.display = "none";
}
</script>

<!-- ‚úÖ POPUP PRE-RIEPILOGO (mettilo prima di </body>) -->
<div id="popup-pre-riepilogo" class="popup-overlay" style="display:none;">
  <div class="popup-box">
    <h3>üëÄ Ci siamo quasi!</h3>

    <p style="line-height:1.5">
      A breve potrai vedere la tua coppa.<br><br>
      üëâ Ricordati di <b>dettarla al cameriere</b><br>
      üëâ <b>Condividila sui social</b> e taggaci üì∏<br>
      üëâ Se necessario, <b>aggiungila al carrello</b> per ordinarne pi√π di una insieme
    </p>

    <label class="popup-check">
   <input type="checkbox" id="popup-pre-no-more">
      Non mostrare pi√π
    </label>

<button class="popup-btn primary popup-continua">
  Continua ‚Üí
</button>
  </div>
</div>

<div id="loading-riepilogo" style="
  display:none;
  position:fixed;
  inset:0;
  background:#fff;
  z-index:9999;
  align-items:center;
  justify-content:center;
  flex-direction:column;
">
  <div style="font-size:22px;font-weight:700;margin-bottom:12px">
    üç® Stiamo preparando la tua coppa
  </div>

  <div id="loading-text" style="opacity:.6;font-size:14px;margin-bottom:18px">
    Caricamento coppa‚Ä¶
  </div>

  <!-- üî• BARRA -->
  <div style="
    width:220px;
    height:6px;
    background:#eee;
    border-radius:999px;
    overflow:hidden;
  ">
<div id="loading-bar" style="
  height:100%;
  width:0%;
  background:#34c759; /* üçè verde Apple */
  transition:width .25s ease;
  border-radius:999px;
"></div>
  </div>
</div>
<div id="blur-overlay"></div>

<!-- üöß BLOCCO CREA COPPA ‚Äì COMING SOON -->
<div id="popup-coming-soon" class="popup-overlay" style="display:none;">
  <div class="popup-box">
    <h3>üç® Crea la tua coppa</h3>

    <p>
      Funzione in arrivo a breve.<br><br>
      Stiamo preparando un‚Äôesperienza speciale
      per creare la tua coppa personalizzata ‚ú®
    </p>

    <!-- ‚úÖ BOTTONE TORNA ALLA HOME -->
<div style="margin-top:12px; font-weight:600;">
  Casa del Gelato
</div>

<button
  class="popup-btn secondary"
  onclick="tornaAllaHome()"
  style="margin-top:10px;"
>
  ‚Üê Torna alla Home
</button>
  </div>
</div>

<script type="module">
import { supabase } from "./supabase.js";

document.addEventListener("DOMContentLoaded", async () => {
  console.log("üß™ check CREA COPPA");

  const popup = document.getElementById("popup-coming-soon");
  if (!popup) {
    console.warn("‚ùå popup-coming-soon non trovato");
    return;
  }

  const { data, error } = await supabase
    .from("site_settings")
    .select("crea_coppa_enabled")
    .eq("id", 1)
    .single();

  if (error) {
    console.error("Errore Supabase:", error);
    return;
  }

  console.log("üì• valore DB:", data.crea_coppa_enabled);

  // üî¥ LOGICA CORRETTA
  if (data.crea_coppa_enabled === false) {
    console.log("üöß CREA COPPA BLOCCATA");

    popup.style.display = "flex";
    document.body.style.overflow = "hidden";
  } else {
    console.log("‚úÖ CREA COPPA ATTIVA");
  }
});
</script>

<script>
function tornaAllaHome() {
  window.location.href = "home.html";
}
</script>

<script>
function vaiARegistrazione() {
  window.location.href = "login.html?mode=register";
}
</script>
<div id="toast" class="toast"></div>

<div id="coppa-render-isolata" style="
  position: fixed;
  left: -9999px;
  top: 0;
  width: 1080px;
  pointer-events: none;
  opacity: 0;
  z-index: -1;
"></div>

</body>
</html>