<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
<title>Profilo</title>

<link rel="stylesheet" href="bottom-nav.css">
<script type="module" src="global.js"></script>
<script src="https://cdn.jsdelivr.net/npm/qrcodejs/qrcode.min.js"></script>

<style>
html, body{
  height: 100%;
}

body{
  margin: 0;
  background:#f6f6f7;
  font-family: system-ui, -apple-system, sans-serif;
  color:#111;

  display: flex;
  flex-direction: column;
}
:root{
  --topbar-h: 56px;
}
  /* üîù Barra fissa */
#top-fixed-bar{
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;

  height: var(--topbar-h);
  box-sizing: border-box;

  display: flex;
  align-items: center;
  justify-content: center;

  padding: 0 12px;
  background: #fff;
  border-bottom: 1px solid #ddd;
  z-index: 9999;
}

.top-left{ justify-self: start; }
.top-center{ justify-self: center; }
.top-right{ justify-self: end; }

.home-btn{
  position: absolute;
  left: 50%;
  top: 50%;
  transform: translate(-50%, -50%);

  display: flex;
  align-items: center;
  gap: 6px;

  font-size: 17px;
  font-weight: 700;
  color: #444;
  text-decoration: none;
}

  .home-btn img{
    width:28px; height:28px;
  }

  #top-fixed-spacer{ height:55px; }

  /* Contenuto */
.container{
  max-width: 480px;
  width: 100%;
  margin: 0 auto;

  padding: 16px;
  padding-top: calc(16px + 55px); /* top bar */

  box-sizing: border-box;

  flex: 1; /* ‚úÖ SPINGE IL FOOTER IN BASSO */
}

  /* Sezioni profilo */
  .profile-section{
    margin-top: 18px;
  }

  .section-title{
    font-size: 16px;
    font-weight: 800;
    margin: 10px 4px;
    color:#111;
  }

  /* Riga azione stile ‚ÄúiOS‚Äù ma chiara come il tuo sito */
  .profile-action{
    display:flex;
    align-items:center;
    justify-content:space-between;

    background:#fff;
    padding: 14px 16px;
    border-radius: 14px;
    box-shadow: 0 2px 6px rgba(0,0,0,0.08);

    text-decoration:none;
    color:#111;
    font-size: 15px;
    font-weight: 700;

    cursor:pointer;
    -webkit-tap-highlight-color: transparent;

    transition: transform .12s ease, background .12s ease;
    margin-bottom: 10px;
  }

  .profile-action:active{
    transform: scale(0.98);
    background:#f2f2f7;
  }

  .profile-action-left{
    display:flex;
    align-items:center;
    gap:10px;
  }

  .profile-action-right{
    display:flex;
    align-items:center;
    gap:8px;
  }

  .badge{
    background:#007aff;
    color:#fff;
    font-size: 12px;
    font-weight: 800;
    padding: 4px 10px;
    border-radius: 999px;
    min-width: 24px;
    text-align:center;
  }

  .chevron{
    font-size: 20px;
    color:#bbb;
    line-height: 1;
  }

/* AZIONI PROFILO in alto a destra */
.profile-actions{
  display: flex;
  align-items: center;
  gap: 8px;

  justify-self: end;     /* ‚Üê va nella colonna destra */
  margin-right: 16px;     /* ‚Üê rientro elegante stile iOS */
}

  .profile-action-btn{
    width:34px;
    height:34px;
    border-radius: 50%;
    border:none;
    background:#f2f2f7;
    color:#333;
    font-size:16px;
    cursor:pointer;
    display:flex;
    align-items:center;
    justify-content:center;
    transition: transform .12s ease, background .12s ease;
  }

  .profile-action-btn:active{
    transform: scale(0.92);
    background:#e5e5ea;
  }

  .profile-action-btn.danger{
    background:#ffecec;
    color:#ff3b30;
  }
  .profile-action-btn.danger:active{
    background:#ffd6d6;
  }

  /* Email chip (piccolo, coerente, non invasivo) */
  .email-chip{
    display:none;
    margin: 0 0 12px;
    padding: 10px 12px;
    border-radius: 14px;
    background:#fff;
    box-shadow: 0 2px 6px rgba(0,0,0,0.06);
    font-size: 13px;
    color:#555;
  }
  .email-chip b{ color:#111; }

/* COUPON LIST */
#coupon-list {
  display: flex;
  flex-direction: column;
  gap: 18px;        /* ‚¨ÖÔ∏è spazio tra le card */
  margin-top: 18px; /* ‚¨ÖÔ∏è stacca dalla sezione sopra */
}

.coupon{
  background: #fff;
  border-radius: 20px;                 /* leggermente pi√π morbido */
  padding: 18px 18px;                  /* ‚¨ÖÔ∏è pi√π aria interna */
  display: flex;
  justify-content: space-between;
  align-items: flex-start;
  gap: 16px;                           /* ‚¨ÖÔ∏è pi√π spazio tra testo e bottone */

  box-shadow: 
    0 6px 18px rgba(0,0,0,0.06);       /* ombra pi√π ‚Äúalta‚Äù */

  border: 1px solid rgba(0,0,0,0.04);  /* separazione soft */
}
  /* üéüÔ∏è COUPON USATO ‚Äì STATO DISABILITATO */
.coupon.used{
  opacity: .6;
  filter: grayscale(0.5);

  background: linear-gradient(135deg,#fafafa,#f1f1f1);

  box-shadow:
    0 2px 8px rgba(0,0,0,0.04);
}

.coupon.used .coupon-title,
.coupon.used .coupon-desc,
.coupon.used .coupon-expiry,
.coupon.used .coupon-used-at{
  color:#9a9a9a;
}

.coupon.used button{
  background:#d1d1d6;
  color:#555;
}

  .coupon-title{
    font-weight: 800;
    font-size: 15px;
  }
  .coupon-desc{
    font-size: 13px;
    color:#666;
    margin-top: 4px;
  }
 .coupon-expiry{
  font-size: 12px;
  color:#999;
  margin-top: 6px;
  margin-bottom: 12px; /* ‚¨ÖÔ∏è spazio prima del QR */
}

  .coupon button{
    background:#111;
    color:#fff;
    border:none;
    border-radius: 14px;
    padding: 8px 12px;
    font-size: 12px;
    font-weight: 800;
    cursor:pointer;
    white-space: nowrap;
  }

  .coupon.used button{
    background:#ccc;
    color:#444;
    cursor: default;
  }


  /* üì¶ QR CONTAINER */
.coupon-qr{
  overflow: hidden;
  max-height: 0;
  opacity: 0;

  transform: translateY(-6px) scale(0.96);
  transform-origin: top center;

  transition:
    max-height .6s cubic-bezier(.22,.61,.36,1),
    opacity .35s ease,
    transform .45s cubic-bezier(.22,.61,.36,1);
}

/* ‚úÖ QR VISIBILE */
.coupon-qr.open{
  max-height: 260px; /* spazio QR */
  opacity: 1;
  transform: translateY(0) scale(1);
}

/* üéûÔ∏è QR interno (canvas / img) */
.coupon-qr.open canvas,
.coupon-qr.open img{
  animation: qrPop .45s cubic-bezier(.16,1,.3,1);
}

@keyframes qrPop{
  from{
    opacity: 0;
    transform: scale(0.9);
  }
  to{
    opacity: 1;
    transform: scale(1);
  }
}

  /* Messaggio vuoto */
  .empty-msg{
    margin-top: 18px;
    text-align:center;
    font-size: 14px;
    color:#666;
    font-weight: 700;
  }



.avatar-btn{
  width: 48px;
  height: 48px;

  position: fixed;
  top: 2px;
  right: 14px;
  z-index: 10050;

  border-radius: 50%;
  border: 1px solid rgba(0,0,0,0.08);
  background: rgba(255,255,255,0.75);

  backdrop-filter: blur(12px);
  -webkit-backdrop-filter: blur(12px);

  box-shadow: 0 10px 28px rgba(0,0,0,0.18);

  padding: 0;
  overflow: visible; /* üî¥ FONDAMENTALE */
  cursor: pointer;
}

.avatar-btn:active{ transform: scale(0.95); }

.avatar-btn img{
  width: 100%;
  height: 100%;
  object-fit: cover;
  display:block;
}

/* ===== Liquid glass menu ===== */
.glass-backdrop{
  position: fixed;
  inset: 0;
  background: rgba(0,0,0,0.18);
  backdrop-filter: blur(6px);
  -webkit-backdrop-filter: blur(6px);
  z-index: 9998;
}

.glass-menu{
  position: fixed;
  top: 62px;
  right: 12px;
  width: 230px;

  background: rgba(255,255,255,0.72);
  border: 1px solid rgba(255,255,255,0.55);
  border-radius: 16px;

  box-shadow: 0 18px 45px rgba(0,0,0,0.22);
  backdrop-filter: blur(16px);
  -webkit-backdrop-filter: blur(16px);

  padding: 8px;
  z-index: 9999;

  opacity: 0;
  transform:
    translateY(-14px)
    scale(0.94);

  transform-origin: top right;
  pointer-events: none;

  /* üßä TRANSIZIONE LENTA */
  transition:
    opacity .45s ease,
    transform .75s cubic-bezier(.16,1,.3,1);
}

.glass-menu.show{
  opacity: 1;
  transform:
    translateY(0)
    scale(1);

  pointer-events: auto;
}

.glass-item{
  width: 100%;
  border: none;
  background: transparent;
  padding: 10px 10px;
  border-radius: 12px;

  font-size: 14px;
  font-weight: 700;
  color: #111;

  display:flex;
  align-items:center;
  gap: 8px;

  cursor: pointer;

  /* ‚úÖ AGGIUNGI QUESTE */
  text-decoration: none;
  outline: none;
}
.glass-item:visited{
  color: #111;
  text-decoration: none;
}
.glass-item:hover{ background: rgba(0,0,0,0.06); }
.glass-item:active{ background: rgba(0,0,0,0.10); transform: scale(0.99); }

.glass-item.danger{
  color: #ff3b30;
}
@keyframes glassIn{
  from{ transform: scale(0.96); opacity: 0; }
  to  { transform: scale(1);    opacity: 1; }
}

/* Hint login */
.login-hint{
  margin-top: 8px;
  padding-left: 6px;
  font-size: 13px;
  font-weight: 600;
  color: #777;
}

/* Card disabilitata */
.profile-action.disabled{
  opacity: 0.45;
  pointer-events: none;
}
/* üîò iOS style switch */
.switch {
  position: relative;
  display: inline-block;
  width: 44px;
  height: 26px;
}

.switch input {
  opacity: 0;
  width: 0;
  height: 0;
}

.slider {
  position: absolute;
  inset: 0;
  background-color: #ccc;
  border-radius: 999px;
  transition: .2s;
}

.slider:before {
  position: absolute;
  content: "";
  height: 22px;
  width: 22px;
  left: 2px;
  top: 2px;
  background-color: white;
  border-radius: 50%;
  transition: .2s;
}

.switch input:checked + .slider {
  background-color: #34c759;
}

.switch input:checked + .slider:before {
  transform: translateX(18px);
}
/* üì© Popup consensi animato */
/* üì© Popup consensi animato (FLUIDO) */
#consensi-backdrop {
  opacity: 0;
  pointer-events: none;
  transition: opacity .32s ease;
}

#consensi-backdrop.show {
  opacity: 1;
  pointer-events: auto;
}

#consensi-popup {
  position: fixed;
  top: 40%;
  left: 50%;
  right: auto;

  opacity: 0;
  pointer-events: none;

  transform: translate(-50%, -50%) scale(0.94);
  transition: opacity .32s ease, transform .32s ease;
}

#consensi-popup.show {
  opacity: 1;
  pointer-events: auto;
  transform: translate(-50%, -50%) scale(1);
}
.consensi-title{
  text-align: center;
  font-size: 16px;
  font-weight: 800;
  margin-bottom: 12px; /* pi√π aria sotto */
}

.consensi-desc{
  text-align: center;
  font-size: 14px;
  color: #555;
  margin-bottom: 18px; /* separa bene dallo switch */
  line-height: 1.4;
}
#consensi-popup > div {
  padding: 16px 18px 18px; /* prima era troppo stretto */
}
#consensi-popup .switch-row,
#consensi-popup > div > div[style*="display:flex"] {
  padding: 14px 14px;   /* prima troppo stretto */
  margin-bottom: 18px; /* aria prima del bottone */
}
#chiudi-consensi{
  margin-top: 6px;  /* prima era troppo attaccato */
}
/* üì© Popup consensi centrato */
#consensi-popup{
  top: 40% !important;
  left: 50% !important;
  right: auto !important;

  transform: translate(-50%, -50%) scale(0.96);
}

/* üîî Popup notifiche ‚Äì FLUIDO */
#notifiche-backdrop{
  opacity: 0;
  pointer-events: none;
  transition: opacity .32s ease;
}

#notifiche-backdrop.show{
  opacity: 1;
  pointer-events: auto;
}

#notifiche-popup{
  position: fixed;
  top: 40%;
  left: 50%;
  transform: translate(-50%, -50%) scale(0.94);

  width: 320px;
  max-height: 70vh;          /* üî• LIMITE ALTEZZA */
  display: flex;             /* üî• layout verticale */
  flex-direction: column;

  overflow: hidden;          /* üîí niente overflow esterno */

  background: rgba(255,255,255,0.72);
  border-radius: 16px;
  box-shadow: 0 18px 45px rgba(0,0,0,0.22);
  backdrop-filter: blur(16px);
  -webkit-backdrop-filter: blur(16px);

  opacity: 0;
  pointer-events: none;
  transition: opacity .32s ease, transform .32s ease;
}

#notifiche-popup.show{
  opacity: 1;
  pointer-events: auto;
  transform: translate(-50%, -50%) scale(1);
}

/* singola notifica */
.notification-item{
  background: rgba(0,0,0,0.05);
  padding: 12px 14px;
  border-radius: 12px;
  font-size: 14px;
  font-weight: 600;
}
.notif-badge{
  background:#ff3b30;
  color:#fff;
  font-size:12px;
  font-weight:800;
  padding: 2px 8px;
  border-radius:999px;
  min-width: 22px;
  text-align:center;
  line-height: 18px;
}
.notification-item{
  position: relative;
  padding: 12px 34px 12px 14px; /* spazio a destra per pallino */
  border-radius: 12px;
  font-size: 14px;
  font-weight: 600;
}

/* üîµ pallino non letta */
.notification-item.unread::after{
  content: "";
  position: absolute;
  right: 12px;
  top: 50%;
  transform: translateY(-50%);
  width: 8px;
  height: 8px;
  border-radius: 50%;
  background: #007aff; /* Apple blue */
}

/* ===== iOS SWIPE NOTIFICA ===== */
/* wrapper = riferimento unico */
.notification-swipe{
  position: relative;
  border-radius: 16px;
  overflow: hidden;
  margin-bottom: 10px;
}

/* üî¥ CARD ROSSA (SOTTO) */
.notification-swipe .notif-delete{
  position: absolute;
  inset: 1.5px;                     /* üî• IDENTICA */
  background: #ff3b30;
  color: #fff;

  border: none;
  font-weight: 700;
  font-size: 14px;

  display: flex;
  align-items: center;
  justify-content: flex-end;
  padding-right: 18px;

  border-radius: 14px;
  z-index: 1;
}

/* ‚ö™ CARD NOTIFICA (SOPRA) */
.notification-swipe .notification-item{
  position: relative;
  z-index: 2;

  background: #f4f4f6;
  padding: 12px 14px;
  border-radius: 16px;

  /* üî• micro overdraw */
  margin: -1px;
  transition: transform .25s ease;
}

/* stato swipe */
.notification-swipe.swiped .notification-item{
  transform: translateX(-90px);
}
/* üñ•Ô∏è Desktop: mostra Elimina solo su hover */
@media (hover: hover) and (pointer: fine) {
  .notification-swipe:hover .notification-item {
    transform: translateX(-90px);
  }
}
#notifiche-list{
  overflow-y: auto;          /* üî• scroll interno */
  max-height: 40vh;          /* üî• altezza area scroll */
  padding-right: 4px;        /* evita taglio scrollbar */
}
.notifiche-header {
  display: flex;
  align-items: center;
  justify-content: space-between;
  gap: 8px;
}

.notifiche-title {
  font-weight: 700;
  font-size: 15px;
}

.menu-item{
  display:block;
  padding:10px 12px;
  border-radius:10px;
  font-weight:600;
  font-size:14px;
  color:#111;
  text-decoration:none;
}
.menu-item:hover{
  background:#f2f2f7;
}
.menu-item {
  display: flex !important;
  flex-direction: row !important;
  align-items: center !important;
  gap: 12px;
}

.menu-item svg.menu-icon {
  width: 18px;
  height: 18px;
  flex-shrink: 0;
  stroke: #111;
  stroke-width: 1.8;
  fill: none;
  display: block; 

}
.icon-wrapper{
  position: relative;
  display: inline-flex;
  align-items: center;
}

.menu-new-only{
  display: flex;
  align-items: center;
  gap: 12px;
}

.badge-new-left{
  background:#ff3b30;
  color:#fff;
  font-size:9px;
  font-weight:700;
  padding:3px 6px;
  border-radius:999px;
}
/* =========================
   üë§ PROFILE HEADER CARD
========================= */
.profile-card{
  display:flex;
  align-items:center;
  gap:14px;

  background:#fff;
  border-radius:18px;
  padding:16px 18px;
  margin:4px 0 22px;

  box-shadow:
    0 8px 24px rgba(0,0,0,0.06);
}

/* avatar tondo ‚Äì definitivo */
.profile-avatar{
  width:56px;
  height:56px;
  border-radius:50%;

  background-color:#fff;                 /* ‚úÖ niente nero */
  background-position:center;
  background-repeat:no-repeat;
  background-size:cover;               /* ‚úÖ non taglia mai */

  color:#111;                            /* lettera visibile se no immagine */

  display:flex;
  align-items:center;
  justify-content:center;

  font-weight:800;
  font-size:22px;
  text-transform:uppercase;

  overflow:hidden;                       /* üîí blocca sbordi */
  border:1px solid rgba(0,0,0,0.08);     /* üíÖ look pulito */
}
/* testo */
.profile-info{
  display:flex;
  flex-direction:column;
  line-height:1.25;
}

.profile-name{
  font-size:16px;
  font-weight:700;
  color:#111;
}

.profile-email{
  font-size:13px;
  color:#666;
  margin-top:2px;
}
/* Avatar piccolo TOP RIGHT */
#profile-avatar{
  width: 32px;
  height: 32px;
  border-radius: 50%;

  background-size: cover;
  background-position: center;
  background-repeat: no-repeat;

  display: flex;
  align-items: center;
  justify-content: center;

  font-size: 14px;
  font-weight: 700;
}
/* üç® CARD COPPE CREATE ‚Äì Apple style */
.coppe-card{
  display:flex;
  align-items:center;
  justify-content:space-between;

  background: #fff;
  border-radius: 18px;
  padding: 16px 18px;

  text-decoration: none;
  color:#111;

  box-shadow:
    0 10px 30px rgba(0,0,0,0.08);

  transition: transform .15s ease, box-shadow .15s ease;
}

.coppe-card:active{
  transform: scale(0.98);
  box-shadow:
    0 6px 18px rgba(0,0,0,0.06);
}

.coppe-left{
  display:flex;
  align-items:center;
  gap:14px;
}

.coppe-icon{
  width:42px;
  height:42px;

  border-radius:50%;
  overflow:hidden;

  display:flex;
  align-items:center;
  justify-content:center;

  background:#fff; /* üî• bianco */
  box-shadow: 0 6px 14px rgba(0,0,0,0.18);
}

.coppe-icon img{
  width: 100%;
  height: 100%;
  object-fit: cover;
  display: block;
}

.coppe-text{
  display:flex;
  flex-direction:column;
}

.coppe-title{
  font-size:15px;
  font-weight:800;
}

.coppe-sub{
  font-size:13px;
  color:#666;
  margin-top:2px;
}

.coppe-right{
  display:flex;
  align-items:center;
  gap:10px;
}

.coppe-badge{
  background:#007aff;
  color:#fff;
  font-size:12px;
  font-weight:800;
  padding: 4px 10px;
  border-radius:999px;
  min-width:26px;
  text-align:center;
}

.coppe-chevron{
  font-size:20px;
  color:#bbb;
  line-height:1;
}
/* üéüÔ∏è CARD COUPON ‚Äì Apple reward style */
.coupon-card{
  display:flex;
  align-items:center;
  justify-content:space-between;

  background: linear-gradient(135deg,#ffffff,#f7f7f9);
  border-radius: 18px;
  padding: 16px 18px;

  color:#111;
  cursor:pointer;

  box-shadow:
    0 10px 28px rgba(0,0,0,0.08);

  transition: transform .15s ease, box-shadow .15s ease;
}

.coupon-card:active{
  transform: scale(0.98);
  box-shadow:
    0 6px 18px rgba(0,0,0,0.06);
}

.coupon-left{
  display:flex;
  align-items:center;
  gap:14px;
}

.coupon-icon{
  width:42px;
  height:42px;
  border-radius:50%;   /* üî• ora √® cerchio */

  display:flex;
  align-items:center;
  justify-content:center;

  font-size:22px;

  background: linear-gradient(135deg,#8e2de2,#4a00e0);
  color:#fff;

  box-shadow: 0 6px 14px rgba(0,0,0,0.22);
}

.coupon-text{
  display:flex;
  flex-direction:column;
}

.coupon-title{
  font-size:15px;
  font-weight:800;
}

.coupon-sub{
  font-size:13px;
  color:#666;
  margin-top:2px;
}

.coupon-right{
  display:flex;
  align-items:center;
  gap:10px;
}

.coupon-badge{
  background:#34c759; /* Apple green */
  color:#fff;
  font-size:12px;
  font-weight:800;
  padding: 4px 10px;
  border-radius:999px;
  min-width:26px;
  text-align:center;
}

.coupon-chevron{
  font-size:20px;
  color:#bbb;
  line-height:1;
}

/* ‚úÖ MOSTRA POPUP */
.glass-menu.show,
.glass-backdrop.show,
#consensi-popup.show,
#consensi-backdrop.show,
#notifiche-popup.show,
#notifiche-backdrop.show,
#profile-menu.show,
#profile-menu-backdrop.show {
  display: block;
}
.glass-backdrop{
  pointer-events: none;
}

.glass-backdrop.show{
  pointer-events: auto;
}
/* üîí STATO INIZIALE ‚Äì INVISIBILE (anti flash) */
#profile-menu,
#profile-menu-backdrop,
#consensi-popup,
#consensi-backdrop,
#notifiche-popup,
#notifiche-backdrop {
  visibility: hidden;
  opacity: 0;
  pointer-events: none;
}

/* ‚úÖ STATO VISIBILE */
#profile-menu.show,
#profile-menu-backdrop.show,
#consensi-popup.show,
#consensi-backdrop.show,
#notifiche-popup.show,
#notifiche-backdrop.show {
  visibility: visible;
  opacity: 1;
  pointer-events: auto;
}
/* ===== HEADER POPUP NOTIFICHE ===== */
.notifiche-header{
  display: flex;
  align-items: center;
  justify-content: space-between;
  gap: 12px;
  margin-bottom: 12px;
}

.notifiche-title{
  font-size: 15px;
  font-weight: 800;
  white-space: nowrap;
}

/* bottone piccolo, non rompe layout */
.btn-clear-notifications{
  background: #ff3b30;
  color: #fff;
  border: none;
  border-radius: 999px;
  padding: 4px 8px;
  font-size: 11px;
  font-weight: 700;
  line-height: 1;
  white-space: nowrap;     /* üî• BLOCCA IL WRAP */
  cursor: pointer;
}

.btn-clear-notifications:active{
  transform: scale(0.94);
}
/* üéÅ ICONA GIFT CARD */
.coupon-icon.gift{
  background: linear-gradient(135deg,#ff5f6d,#ff8f3f);
  box-shadow: 0 8px 18px rgba(255,95,109,0.35);
}

.coupon-icon.gift svg{
  width:22px;
  height:22px;
  stroke:#fff;
  stroke-width:1.8;
  fill:none;
}
/* üë§ Account card layout */
.account-card{
  display: flex;
  align-items: center;
  justify-content: space-between;
  gap: 14px;
}

/* lato sinistro */
.account-left{
  display: flex;
  align-items: center;
  gap: 14px;
  min-width: 0;
}

/* stats (desktop ‚Üí a destra) */
.account-stats{
  display: flex;
  flex-direction: column;
  align-items: flex-end;
  gap: 8px; /* pi√π respiro */
}

/* üìä pill stats */
.stat-chip{
  display: inline-flex;
  align-items: center;
  gap: 3px;

  padding: 3px 7px;        /* ‚¨ÖÔ∏è ancora pi√π piccole */
  border-radius: 999px;

  font-size: 9.5px;        /* ‚¨ÖÔ∏è mini ma leggibile */
  font-weight: 700;
  line-height: 1;

  letter-spacing: .1px;
  white-space: nowrap;

  box-shadow: 0 1px 2px rgba(0,0,0,0.08);

  backdrop-filter: blur(4px);
  -webkit-backdrop-filter: blur(4px);
}

/* üéÅ coupon disponibili */
.stat-chip.coupon-ok{
  background: linear-gradient(135deg, #ff5f6d, #ff8f3f);
  color: #fff;
}

/* ‚úÖ coupon utilizzati */
.stat-chip.coupon-used{
  background: #e5e5ea;
  color: #444;
}

/* üîî notifiche */
.stat-chip.notif{
  background: #007aff;
  color: #fff;
}
@media (max-width: 600px){
  .account-card{
    flex-direction: column;
    align-items: flex-start;
  }

  .account-stats{
    flex-direction: row;
    align-items: center;
    gap: 10px;
    margin-top: 8px;
  }
}

/* üë§ AVATAR PROFILO FLOATING ‚Äì SOLO DIMENSIONE */
#profile-avatar-btn{
  width: 48px;
  height: 48px;
}
/* centra e scala correttamente il contenuto avatar */
#profile-avatar-btn > .profile-avatar{
  width: 100%;
  height: 100%;

  display: flex;
  align-items: center;
  justify-content: center;

  border-radius: 50%;
}

/* üë§ AVATAR PROFILO FLOATING ‚Äì FUORI DALLA TOP BAR */
#profile-avatar-btn{
  position: fixed;

  top: 2px;     /* distanza dall‚Äôalto */
  right: 14px;   /* distanza dal bordo destro */

  z-index: 10050; /* sopra top bar e contenuti */
}
#profile-avatar-btn{
  background: rgba(255,255,255,0.75);
  backdrop-filter: blur(12px);
  -webkit-backdrop-filter: blur(12px);

  box-shadow: 0 10px 28px rgba(0,0,0,0.18);
}

.avatar-btn{
  position: relative; /* üî• fondamentale */
}
#profile-notif-badge{
  position: absolute;

  bottom: -2px;   /* ‚¨ÖÔ∏è basso */
  left: -4px;     /* ‚¨ÖÔ∏è sinistra */

width: 18px;
height: 18px;
padding: 0;

  display: none;
  align-items: center;
  justify-content: center;

  background: #ff3b30;
  color: #fff;

  font-size: 10px;
  font-weight: 800;
  line-height: 18px;

  border-radius: 999px;
  border: none;

  box-shadow: 0 2px 6px rgba(0,0,0,0.25);
  z-index: 2;
  pointer-events: none;
}
/* üîí blocca scroll pagina quando popup aperto */
body.no-scroll{
  overflow: hidden;
  touch-action: none;
}
.profile-footer{
  padding: 10px 12px 14px;
  text-align: center;
  font-size: 12px;
  color: #8e8e93;
}
.profile-footer a{
  color:#8e8e93;
  text-decoration:none;
  font-weight:500;
}

.profile-footer a:hover{
  text-decoration:underline;
}

.footer-links{
  margin-bottom:8px;
}

.footer-copy{
  margin-bottom:4px;
}

.footer-version{
  opacity:.6;
}

/* üéüÔ∏è ANIMAZIONE APERTURA COUPON */
#coupon-list{
  overflow: hidden;
  max-height: 0;
  opacity: 0;
  transform: translateY(-8px);

  transition:
    max-height .75s cubic-bezier(.22,.61,.36,1), /* ‚¨ÖÔ∏è pi√π lenta */
    opacity .35s ease,
    transform .35s ease;
}

/* stato aperto */
#coupon-list.open{
  max-height: 2000px;
  opacity: 1;
  transform: translateY(0);
}

/* entrata singole card */
#coupon-list.open .coupon{
  animation: couponIn .45s cubic-bezier(.22,.61,.36,1) forwards;
}

@keyframes couponIn{
  from{
    opacity: 0;
    transform: translateY(-6px);
  }
  to{
    opacity: 1;
    transform: translateY(0);
  }
}
/* ‚ò∞ MENU BUTTON ‚Äì PROFILO (identico a HOME) */
#menu-btn{
  position: absolute;
  left: 14px;
  top: 14px;              /* üîí BLOCCATO */
  height: 27px;           /* met√† top bar */
  display: flex;
  align-items: center;

  background: transparent;
  border: none;
  box-shadow: none;
  padding: 0;
  margin: 0;

  font-size: 22px;
  line-height: 1;
  color: #111;

  cursor: pointer;
  z-index: 10001;
}

#menu-btn:active{
  opacity: .6;
}
#menu-btn{
  position: absolute;
  left: 14px;
  top: 50%;
  transform: translateY(-50%);
}

/* =========================
   üîî POPUP AVVISO UNIVERSALE
========================= */

#ui-alert-backdrop{
  position: fixed;
  inset: 0;
  background: rgba(0,0,0,.25);
  backdrop-filter: blur(6px);
  -webkit-backdrop-filter: blur(6px);
  opacity: 0;
  pointer-events: none;
  transition: opacity .25s ease;
  z-index: 10050;
}

#ui-alert{
  position: fixed;
  top: 40%;
  left: 50%;
  transform: translate(-50%,-50%) scale(.94);
  width: 320px;

  background: rgba(255,255,255,.78);
  border-radius: 18px;
  padding: 18px;

  box-shadow: 0 18px 45px rgba(0,0,0,.25);
  backdrop-filter: blur(18px);
  -webkit-backdrop-filter: blur(18px);

  opacity: 0;
  pointer-events: none;
  transition: opacity .25s ease, transform .25s ease;
  z-index: 10051;
}

#ui-alert.show{
  opacity: 1;
  pointer-events: auto;
  transform: translate(-50%,-50%) scale(1);
}

#ui-alert-backdrop.show{
  opacity: 1;
  pointer-events: auto;
}

#ui-alert-title{
  font-size: 16px;
  font-weight: 800;
  text-align: center;
  margin-bottom: 10px;
}

#ui-alert-message{
  font-size: 14px;
  color: #555;
  text-align: center;
  line-height: 1.4;
}

#ui-alert-btn{
  margin-top: 16px;
  width: 100%;
  padding: 10px;
  border-radius: 12px;
  border: none;

  background: #007aff;      /* üîµ BLU iOS */
  color: #fff;
  font-weight: 700;
  cursor: pointer;

  transition: background .2s ease, transform .08s ease;
}

#ui-alert-btn:active{
  background: #005fcc;      /* üîµ blu pi√π scuro */
  transform: scale(0.97);
}
#chiudi-consensi,
#chiudi-notifiche{
  background: #007aff;
  color: #fff;
  border: none;
  font-weight: 700;
}

#chiudi-consensi:active,
#chiudi-notifiche:active{
  background: #005fcc;
  transform: scale(0.97);
}

.glass-backdrop,
#profile-menu-backdrop,
#consensi-backdrop,
#notifiche-backdrop,
#unsubscribe-backdrop,
#ui-alert-backdrop {
  opacity: 0;
  visibility: hidden;
  pointer-events: none;
  transition: opacity .25s ease;
}
.glass-backdrop.show,
#profile-menu-backdrop.show,
#consensi-backdrop.show,
#notifiche-backdrop.show,
#unsubscribe-backdrop.show,
#ui-alert-backdrop.show {
  opacity: 1;
  visibility: visible;
  pointer-events: auto;
}
.login-hint {
  text-align: center;
  width: 100%;
  margin-top: 12px;
  font-size: 12px;
  font-weight: 500;
  color: #666;
}


/* ‚ú® Animazione Scoopy Ice */
.menu-new-only {
  animation: scoopyVibe 5s ease-in-out infinite;
}

@keyframes scoopyVibe {
  0%, 85%, 100% { transform: translateX(0); }

  88%  { transform: translateX(-2px); }
  91%  { transform: translateX(2px); }
  94%  { transform: translateX(-2px); }
  97%  { transform: translateX(2px); }
}

/* üì© Link feedback sotto coupon */
.profile-feedback-link{
  margin-top: 22px;
  text-align: center;
}

.profile-feedback-link a{
  font-size: 13px;
  color: #007aff; /* blu iOS */
  font-weight: 600;
  text-decoration: underline;
  text-underline-offset: 3px;
  transition: opacity .15s ease;
}

.profile-feedback-link a:active{
  opacity: .6;
}

</style>
</head>

<body>

<!-- üîù Barra -->
<div id="top-fixed-bar">

  <!-- ‚ò∞ MENU -->
  <button id="menu-btn" aria-label="Menu">‚ò∞</button>

  <!-- HOME -->
  <a href="home.html" class="home-btn top-center">
    <img src="tastohome.png" alt="home">
  </a>

  <!-- AVATAR -->
  <div class="profile-actions top-right">
    <button id="profile-avatar-btn" class="avatar-btn" aria-label="Menu profilo">
      <div class="profile-avatar" id="profile-avatar">
        <span id="profile-avatar-text">?</span>
      </div>
      <span id="profile-notif-badge" style="display:none;">0</span>
    </button>
  </div>

</div>

<!-- MENU LIQUID GLASS -->
<div id="profile-menu" class="glass-menu">
  <button class="glass-item" id="menu-change-photo">Cambia immagine</button>
  <button class="glass-item" id="menu-edit-profile">
  Modifica profilo
</button>
  <button class="glass-item" id="menu-register">Registrati</button>
  <a href="login.html" class="glass-item">Accedi</a>
  <button class="glass-item" id="menu-logout">Logout</button>
<button class="glass-item" id="menu-notifiche">
  Notifiche üîî 
  <span id="notifiche-count" class="badge" style="display:none;">0</span>
</button>
  <button class="glass-item" id="menu-consensi">
  Consensi comunicazioni üì©
</button>
<a href="privacy.html" class="glass-item" id="menu-privacy">Privacy &amp; Dati personali</a>
  <button class="glass-item danger" id="menu-unsubscribe">Disiscriviti ‚úï</button>
</div>


<div id="profile-menu-backdrop" class="glass-backdrop"></div>


<div class="container">
  <!-- serve al JS per non rompersi, ma resta invisibile -->
  <div id="profile-info" style="display:none;"></div>

<!-- üë§ HEADER PROFILO -->
<div class="profile-card account-card">

  <!-- SINISTRA -->
  <div class="account-left">
    <div class="profile-avatar" id="profile-card-avatar">
      <span id="profile-card-avatar-text">?</span>
    </div>

    <div class="profile-info">
      <div class="profile-name" id="profile-card-name">
        Il tuo profilo
      </div>
      <div class="profile-email" id="profile-card-email">
        ‚Äî
      </div>
    </div>
  </div>

  <!-- DESTRA -->
  <div class="account-stats">
    <div class="stat-chip coupon-ok" title="Coupon disponibili">
      Coupon Disponibili <span id="stat-coupon-ok">0</span>
    </div>

    <div class="stat-chip coupon-used" title="Coupon utilizzati">
      Coupon Utilizzati <span id="stat-coupon-used">0</span>
    </div>

    <div class="stat-chip notif" title="Notifiche non lette">
      Notifiche <span id="stat-notif">0</span>
    </div>
  </div>

</div>


  <!-- üç® COPPE -->
  <section class="profile-section">


<a href="cronologia.html" id="coppe-card" class="coppe-card">
  <div class="coppe-left">
    <div class="coppe-icon">
  <img src="img/scoopy-ice.png" alt="Scoopy Ice">
</div>

    <div class="coppe-text">
      <div class="coppe-title">Coppe create</div>
      <div class="coppe-sub">Visualizza lo storico delle tue coppe</div>
    </div>
  </div>

  <div class="coppe-right">
    <span id="coppe-count" class="coppe-badge">0</span>
    <span class="coppe-chevron">‚Ä∫</span>
  </div>
</a>
    <div id="login-hint" class="login-hint" style="display:none;">
  Accedi o registrati per usufruire di tutte le funzionalit√†
</div>
  </section>



<!-- üéüÔ∏è COUPON -->
<section id="coupon-section" class="profile-section" style="display:none;">

  <div class="coupon-card" id="open-coupon-list">

    <div class="coupon-left">

      <!-- üéÅ ICONA GIFT -->
      <div class="coupon-icon gift">
        <svg viewBox="0 0 24 24" aria-hidden="true">
          <rect x="3" y="6" width="18" height="12" rx="2"/>
          <path d="M3 10h18"/>
          <path d="M8 6V4a2 2 0 0 1 4 0v2"/>
          <path d="M12 6V4a2 2 0 0 1 4 0v2"/>
        </svg>
      </div>

      <div class="coupon-text">
        <div class="coupon-title">Coupon disponibili</div>
        <div class="coupon-sub">Premi e coppe omaggio</div>
      </div>

    </div>

    <div class="coupon-right">
      <span id="coupon-count" class="coupon-badge">0</span>
      <span class="coupon-chevron">‚Ä∫</span>
    </div>

  </div>

 <div id="coupon-list" class="coupon-list"></div>
</section>
  <div id="no-login" class="empty-msg" style="display:none;">
    Nessun accesso effetuato.
  </div>

  <div class="profile-feedback-link">
  <a href="feedback.html">
    Hai riscontrato qualche problema? Descrivicelo cos√¨ possiamo migliorare.
  </a>
</div>
</div>



<!-- üì© POPUP CONSENSI -->
<div id="consensi-backdrop" class="glass-backdrop"></div>

<div id="consensi-popup" class="glass-menu"
  style="right:auto; left:50%; width:300px;">

<div class="consensi-title">
  üì© Consensi comunicazioni
</div>

<div class="consensi-desc">
  Puoi decidere se ricevere promozioni e comunicazioni da Casa del Gelato.
</div>

    <div style="
      display:flex;
      align-items:center;
      justify-content:space-between;
      background:rgba(0,0,0,0.05);
      padding:10px 12px;
      border-radius:12px;
    ">
      <span style="font-weight:700;font-size:14px;">
        Ricevi comunicazioni
      </span>

      <label class="switch">
        <input type="checkbox" id="consenso-switch">
        <span class="slider"></span>
      </label>
    </div>

    <button id="chiudi-consensi"
      style="
        margin-top:14px;
        width:100%;
        padding:10px;
        border-radius:12px;
        border:none;
        color:#fff;
        font-weight:700;
        cursor:pointer;
      ">
      Chiudi
    </button>

  </div>
</div>

<!-- üîî POPUP NOTIFICHE -->
<div id="notifiche-backdrop" class="glass-backdrop"></div>

<div id="notifiche-popup" class="glass-menu"
  style="right:auto; left:50%; width:320px;">

<div class="notifiche-header">
  <div class="notifiche-title">Notifiche</div>

  <button
    class="btn-clear-notifications"
    onclick="eliminaTutteNotifiche()">
    Svuota tutto
  </button>
</div>



<div id="notifiche-list"></div>

  <button id="chiudi-notifiche"
    style="
      margin-top:16px;
      width:100%;
      padding:10px;
      border-radius:12px;
      border:none;
      color:#fff;
      font-weight:700;
      cursor:pointer;
    ">
    Chiudi
  </button>
</div>



<script type="module">
import { supabase } from "./supabase.js";



/* ===============================
   UTILS
================================ */


window.apriPopupDisiscrizione = function(){
  document.body.classList.add("no-scroll");
  document.getElementById("unsubscribe-backdrop")?.classList.add("show");
  document.getElementById("unsubscribe-popup")?.classList.add("show");
};

window.chiudiPopupDisiscrizione = function(){
  document.body.classList.remove("no-scroll");
  document.getElementById("unsubscribe-backdrop")?.classList.remove("show");
  document.getElementById("unsubscribe-popup")?.classList.remove("show");
};

window.eliminaTutteNotifiche = async function () {
  const ok = confirm("Vuoi eliminare TUTTE le notifiche?");
  if (!ok) return;

  const email = localStorage.getItem("user_email");
  if (!email) {
    alert("Utente non loggato");
    return;
  }

  console.log("üóë Elimino notifiche per:", email);

  const { error } = await supabase
    .from("notifiche")
    .delete()
    .eq("email", email);

  if (error) {
    console.error("‚ùå Errore eliminazione notifiche:", error);
    alert("Errore eliminazione notifiche");
    return;
  }

  // ‚úÖ svuota UI
  const list = document.getElementById("notifiche-list");
  if (list) {
    list.innerHTML = `
      <div class="notification-item">
        üîï Nessuna notifica al momento
      </div>
    `;
  }

  // ‚úÖ nasconde badge
  const badge = document.getElementById("notifiche-count");
  if (badge) badge.style.display = "none";

  console.log("‚úÖ Notifiche eliminate correttamente");
};

function abilitaSwipeNotifiche() {
  document.querySelectorAll(".notification-swipe").forEach(wrapper => {
    const item = wrapper.querySelector(".notification-item");

    let startX = 0;
    let currentX = 0;
    let dragging = false;

    item.addEventListener("touchstart", e => {
      startX = e.touches[0].clientX;
      dragging = true;
      item.style.transition = "none";
    });

    item.addEventListener("touchmove", e => {
      if (!dragging) return;

      currentX = e.touches[0].clientX;
      const diff = currentX - startX;

      // solo swipe verso sinistra
      if (diff < 0) {
        item.style.transform = `translateX(${Math.max(diff, -110)}px)`;
      }
    });

    item.addEventListener("touchend", () => {
      dragging = false;
      item.style.transition = "transform .25s ease";

      // soglia swipe
      if (currentX - startX < -60) {
        wrapper.classList.add("swiped");
        item.style.transform = "translateX(-90px)";
      } else {
        wrapper.classList.remove("swiped");
        item.style.transform = "translateX(0)";
      }
    });
  });
}

async function aggiornaStatNotificheProfilo() {
  const email = localStorage.getItem("user_email");
  const logged = localStorage.getItem("userLogged") === "1";

  const stat = document.getElementById("stat-notif");
  if (!stat) return;

  if (!logged || !email) {
    stat.textContent = "0";
    return;
  }

  const { data, error } = await supabase
    .from("notifiche")
    .select("id")
    .eq("email", email)
    .eq("letta", false);

  if (error) return;

  stat.textContent = data.length;
}

async function aggiornaBadgeNotifiche(){
  const email  = localStorage.getItem("user_email");
  const logged = localStorage.getItem("userLogged") === "1";

  const badge       = document.getElementById("notifiche-count");
  const avatarBadge = document.getElementById("profile-notif-badge");
  const statNotif   = document.getElementById("stat-notif");

  // üîí se non loggato ‚Üí nascondi tutto
  if (!logged || !email){
    if (badge) badge.style.display = "none";
    if (avatarBadge) avatarBadge.style.display = "none";
    if (statNotif) statNotif.style.display = "none";
    return;
  }

  const { data, error } = await supabase
    .from("notifiche")
    .select("id")
    .eq("email", email)
    .eq("letta", false);

  if (error){
    console.error("Errore badge notifiche:", error);
    if (badge) badge.style.display = "none";
    if (avatarBadge) avatarBadge.style.display = "none";
    if (statNotif) statNotif.style.display = "none";
    return;
  }

  const n = data.length;

  /* üîî badge menu profilo */
  if (badge){
    badge.textContent = n > 99 ? "99+" : n;
    badge.style.display = n > 0 ? "inline-block" : "none";
  }

  /* üìä stat nella card profilo */
  if (statNotif){
    statNotif.textContent = n;
    statNotif.style.display = n > 0 ? "flex" : "none";
  }

  /* üî¥ badge sull‚Äôavatar */
  if (avatarBadge){
    avatarBadge.textContent = n > 99 ? "99+" : n;
    avatarBadge.style.display = n > 0 ? "flex" : "none";
  }
}

/* üîÅ QUI, SUBITO SOTTO */
aggiornaBadgeNotifiche();

setInterval(() => {
  aggiornaBadgeNotifiche();
}, 8000);


async function caricaNotificheUtente() {
  const email = localStorage.getItem("user_email");
  if (!email) return;

  const list = document.getElementById("notifiche-list");
  if (!list) return;

  list.innerHTML = "‚è≥ Caricamento‚Ä¶";

  const { data, error } = await supabase
    .from("notifiche")
    .select("*")
    .eq("email", email)
    .order("created_at", { ascending: false });

  if (error) {
    list.innerHTML = "‚ùå Errore caricamento notifiche";
    console.error(error);
    return;
  }

  if (!data || data.length === 0) {
    list.innerHTML = `
      <div class="notification-item">
        üîï Nessuna notifica al momento
      </div>`;
    return;
  }

  list.innerHTML = "";

data.forEach(n => {
  const wrapper = document.createElement("div");
  wrapper.className = "notification-swipe";
  wrapper.dataset.id = n.id;

  const content = document.createElement("div");
  content.className = "notification-item";
  if (n.letta === false) content.classList.add("unread");

  const dataNotifica = new Date(n.created_at).toLocaleString("it-IT", {
    day: "2-digit",
    month: "2-digit",
    year: "numeric",
    hour: "2-digit",
    minute: "2-digit"
  });

  content.innerHTML = `
    <div style="font-size:14px;">${n.messaggio}</div>
    <div style="font-size:11px; opacity:.6; margin-top:4px;">
      ${dataNotifica}
    </div>
  `;

  const deleteBtn = document.createElement("button");
  deleteBtn.className = "notif-delete";
  deleteBtn.textContent = "Elimina";

wrapper.appendChild(deleteBtn); // üî¥ SOTTO (nascosto)
wrapper.appendChild(content);   // ‚ö™ SOPRA (scorre)
  list.appendChild(wrapper);
  abilitaSwipeNotifiche();
});
}

// ===============================
// AVATAR PROFILO (local + leggero)
// ===============================


function setAvatarBackground(src) {
  const topAvatar  = document.getElementById("profile-avatar");
  const cardAvatar = document.getElementById("profile-card-avatar");
  const topText    = document.getElementById("profile-avatar-text");
  const cardText   = document.getElementById("profile-card-avatar-text");

[topAvatar, cardAvatar].forEach(el => {
  if (!el) return;

  el.style.backgroundImage = `url(${src})`;
  el.style.backgroundSize = "contain";        // ‚úÖ non taglia mai
  el.style.backgroundPosition = "center";
  el.style.backgroundRepeat = "no-repeat";
  el.style.backgroundColor = "#fff";          // ‚úÖ niente nero
});

  if (topText) topText.style.display = "none";
  if (cardText) cardText.style.display = "none";
}


// Riduce e comprime l‚Äôimmagine prima di salvarla (evita quota localStorage)
async function compressImageToDataURL(file, maxSize = 256, quality = 0.82) {
  const bitmap = await createImageBitmap(file);

  let w = bitmap.width;
  let h = bitmap.height;

  const scale = Math.min(maxSize / w, maxSize / h, 1);
  w = Math.round(w * scale);
  h = Math.round(h * scale);

  const canvas = document.createElement("canvas");
  canvas.width = w;
  canvas.height = h;
  const ctx = canvas.getContext("2d");
  ctx.drawImage(bitmap, 0, 0, w, h);

  // jpeg = molto pi√π leggero del png
  return canvas.toDataURL("image/jpeg", quality);
}

function dataUrlToBlob(dataUrl) {
  const parts = dataUrl.split(',');
  const mime = parts[0].match(/:(.*?);/)[1];
  const binary = atob(parts[1]);
  const len = binary.length;
  const array = new Uint8Array(len);
  for (let i = 0; i < len; i++) {
    array[i] = binary.charCodeAt(i);
  }
  return new Blob([array], { type: mime });
}

async function aggiornaAvatarProfilo() {

  const email = localStorage.getItem("user_email");
  const logged = localStorage.getItem("userLogged") === "1";

  const topAvatar  = document.getElementById("profile-avatar");
  const topText    = document.getElementById("profile-avatar-text");
  const cardAvatar = document.getElementById("profile-card-avatar");
  const cardText   = document.getElementById("profile-card-avatar-text");

  // reset vero (shorthand)
  [topAvatar, cardAvatar].forEach(a => {
    if (!a) return;
    a.style.background = "#fff";
    a.style.backgroundImage = "";
  });

  [topText, cardText].forEach(t => {
    if (t) t.style.display = "block";
  });

// üîê se NON loggato ‚Üí niente avatar remoto
if (!logged || !email) {
  return;
}
// üîπ carica avatar da Supabase
const { data, error } = await supabase
  .from("utenti")
  .select("avatar_url")
  .eq("email", email)
  .single();

if (!error && data?.avatar_url) {
  setAvatarBackground(data.avatar_url);
  return;
}
// 1Ô∏è‚É£ carica avatar da Supabase
supabase
  .from("utenti")
  .select("avatar_url")
  .eq("email", email)
  .single()
  .then(({ data }) => {
    if (data?.avatar_url) {
      setAvatarBackground(data.avatar_url);
    }
  });

// 2Ô∏è‚É£ sfondo BIANCO se non c'√® immagine
[topAvatar, cardAvatar].forEach(a => {
  if (!a) return;
  a.style.background = "#fff";
  a.style.border = "1px solid rgba(0,0,0,0.08)"; // ‚¨ÖÔ∏è opzionale ma consigliato
});
  // 3Ô∏è‚É£ iniziale
  if (email) {
    const lettera = email.charAt(0).toUpperCase();
    if (topText) topText.textContent = lettera;
    if (cardText) cardText.textContent = lettera;
    return;
  }

  // fallback
  if (topText) topText.textContent = "üë§";
  if (cardText) cardText.textContent = "üë§";
}

function aggiornaProfileCard() {
  const email = localStorage.getItem("user_email");
  const logged = localStorage.getItem("userLogged") === "1";

  const nameEl  = document.getElementById("profile-card-name");
  const emailEl = document.getElementById("profile-card-email");

  if (!nameEl || !emailEl) return;

  if (!logged || !email) {
    nameEl.textContent  = "Il tuo profilo";
    emailEl.textContent = "Accedi o registrati";
    return;
  }

  nameEl.textContent  = "Account";
  emailEl.textContent = email;
}

function setupAvatarChange() {
  const btn   = document.getElementById("menu-change-photo");
  const input = document.getElementById("profile-avatar-input");

  if (!btn || !input) {
    console.warn("Avatar change: elementi mancanti");
    return;
  }

btn.addEventListener("click", (e) => {
  e.preventDefault();
  e.stopPropagation();

  // chiudi menu profilo
  if (typeof closeMenu === "function") closeMenu();

  const email  = localStorage.getItem("user_email");
  const logged = localStorage.getItem("userLogged") === "1";

  // ‚ùå NON LOGGATO
  if (!logged || !email) {
    mostraPopup(
      "Accesso richiesto",
      "Accedi o registrati per modificare o inserire l‚Äôimmagine profilo.",
      "login.html"
    );
    return;
  }

  // ‚úÖ LOGGATO ‚Üí apri picker immagine
  setTimeout(() => {
    input.click();
  }, 50);
});

input.addEventListener("change", async () => {
  const email  = localStorage.getItem("user_email");
  const logged = localStorage.getItem("userLogged") === "1";

  // ‚ùå BLOCCO TOTALE SE NON LOGGATO
  if (!logged || !email) {
    input.value = ""; // reset input
    mostraPopup(
      "Accesso richiesto",
      "Accedi o registrati per modificare o inserire l‚Äôimmagine profilo.",
      "login.html"
    );
    return;
  }

  const file = input.files && input.files[0];
  if (!file) return;

  try {
    const dataUrl = await compressImageToDataURL(file, 256, 0.82);
const email = localStorage.getItem("user_email");

// nome file unico
const fileName = `avatar_${email.replace(/[@.]/g,"_")}.jpg`;

// upload su storage
const { error: uploadError } = await supabase
  .storage
  .from("avatars")
  .upload(fileName, dataUrlToBlob(dataUrl), {
    upsert: true,
    contentType: "image/jpeg"
  });

if (uploadError) {
  console.error(uploadError);
  mostraPopup("Errore", "Errore nel caricamento immagine");
  return;
}

// url pubblico
const { data } = supabase
  .storage
  .from("avatars")
  .getPublicUrl(fileName);

const avatarUrl = data.publicUrl + "?t=" + Date.now();

// salva url nel profilo
await supabase
  .from("utenti")
  .update({ avatar_url: avatarUrl })
  .eq("email", email);

// aggiorna UI
setAvatarBackground(avatarUrl);
  } catch (err) {
    console.error("Errore avatar:", err);
    mostraPopup(
      "Errore",
      "Si √® verificato un problema nel caricamento dell‚Äôimmagine."
    );
  }
});
}


function scadenzaDaCreazione(created_at){
  const d = new Date(created_at);
  return new Date(d.getFullYear(), 11, 31, 23, 59, 59, 999);
}

// ===== POPUP CONSENSI =====
document.addEventListener("DOMContentLoaded", () => {
  const btn = document.getElementById("menu-consensi");
  const popup = document.getElementById("consensi-popup");
  const backdrop = document.getElementById("consensi-backdrop");
  const toggle = document.getElementById("consenso-switch");
  const closeBtn = document.getElementById("chiudi-consensi");

  if (!btn || !popup || !toggle || !backdrop) return;

btn.addEventListener("click", async () => {
  // chiudi menu profilo
  closeMenu();

  const email = localStorage.getItem("user_email");
  if (!email) {
  mostraPopup(
    "Accesso richiesto",
    "Devi effettuare l‚Äôaccesso per gestire i consensi.",
    "login.html"
  );
  return;
}

  const { data, error } = await supabase
    .from("utenti")
    .select("consenso_promozioni")
    .eq("email", email)
    .single();

  if (error) return alert("Errore caricamento consensi");

  toggle.checked = data.consenso_promozioni === true;

  // üî• BLOCCA SCROLL
  document.body.classList.add("no-scroll");
  backdrop.classList.add("show");
  popup.classList.add("show");
});

  toggle.addEventListener("change", async () => {
    const email = localStorage.getItem("user_email");
    if (!email) return;

    await supabase
      .from("utenti")
      .update({ consenso_promozioni: toggle.checked })
      .eq("email", email);
  });

  function closeConsensi() {
    backdrop.classList.remove("show");
    popup.classList.remove("show");

  // üîì SBLOCCA SCROLL
  document.body.classList.remove("no-scroll");
  }

  closeBtn.addEventListener("click", closeConsensi);
  backdrop.addEventListener("click", closeConsensi);
}); 
// ===== POPUP NOTIFICHE =====
document.addEventListener("DOMContentLoaded", () => {
  const btn = document.getElementById("menu-notifiche");
  const popup = document.getElementById("notifiche-popup");
  const backdrop = document.getElementById("notifiche-backdrop");
  const closeBtn = document.getElementById("chiudi-notifiche");

  if (!btn || !popup || !backdrop || !closeBtn) return;

// üü¢ APRI: solo carica e mostra (NON segna lette)
async function apriNotifiche() {
  if (typeof window.closeMenu === "function") closeMenu();

  const email = localStorage.getItem("user_email");
 if (!email) {
  mostraPopup(
    "Accesso richiesto",
    "Accedi o registrati per visualizzare le notifiche.",
    "login.html"
  );
  return;
}

  await caricaNotificheUtente();
document.body.classList.add("no-scroll");
  // mostra popup
  popup.classList.remove("show");
  backdrop.classList.remove("show");
  requestAnimationFrame(() => {
    backdrop.classList.add("show");
    popup.classList.add("show");
  });
}

  // üî¥ CHIUDI: segna lette + badge + pallini
  async function closeNotifiche(){
    console.log("CHIUDI NOTIFICHE");
    popup.classList.remove("show");
    backdrop.classList.remove("show");
  // ‚úÖ SBLOCCA SCROLL QUI
  document.body.classList.remove("no-scroll");
    const email = localStorage.getItem("user_email");
    if (!email) return;

    await supabase
      .from("notifiche")
      .update({ letta: true })
      .eq("email", email)
      .eq("letta", false);

    await aggiornaBadgeNotifiche();

    document
      .querySelectorAll(".notification-item.unread")
      .forEach(el => el.classList.remove("unread"));
  }

  btn.addEventListener("click", apriNotifiche);
  closeBtn.addEventListener("click", closeNotifiche);
  backdrop.addEventListener("click", closeNotifiche);
});

// ===== DELETE NOTIFICA (SWIPE) =====
document.addEventListener("click", async e => {
  const btn = e.target.closest(".notif-delete");
  if (!btn) return;

  const wrapper = btn.closest(".notification-swipe");
  if (!wrapper) return;

  const id = wrapper.dataset.id;

  // elimina dal DB
  if (id){
    await supabase
      .from("notifiche")
      .delete()
      .eq("id", id);
  }

  // animazione uscita
  wrapper.style.transition = "height .25s ease, opacity .25s ease";
  wrapper.style.opacity = "0";
  wrapper.style.height = wrapper.offsetHeight + "px";

  requestAnimationFrame(() => {
    wrapper.style.height = "0";
    wrapper.style.margin = "0";
  });

  setTimeout(() => wrapper.remove(), 250);

  // aggiorna badge
  aggiornaBadgeNotifiche();
});

/* ===============================
   CONTEGGI
================================ */


function bloccaScrollPagina() {
  document.body.classList.add("no-scroll");
}

function sbloccaScrollPagina() {
  document.body.classList.remove("no-scroll");
}



/* ===============================
   COUPON
================================ */


function subscribeConfermeRealtime(email){
  supabase
    .channel("conferme-coppe-realtime")
    .on(
      "postgres_changes",
      {
        event: "INSERT",
        schema: "public",
        table: "conferme_coppe",
        filter: `email=eq.${email}`
      },
      async () => {
        console.log("üîÅ Nuova conferma ‚Üí ricarico dati profilo");

        const { data } = await supabase.functions.invoke(
          "get-profile-data",
          { body: { email } }
        );

        if (data?.ok) {
          renderCoupons(data.coupon_list);
          document.getElementById("coupon-count").textContent = data.coupon_disponibili;
          document.getElementById("stat-coupon-ok").textContent = data.coupon_disponibili;
          document.getElementById("stat-coupon-used").textContent = data.coupon_usati;
        }
      }
    )
    .subscribe();
}

function renderCoupons(coupons){
  const list = document.getElementById("coupon-list");
  list.innerHTML = "";

  if (!coupons || coupons.length === 0){
    list.innerHTML = `<div class="empty-msg">Nessun coupon disponibile</div>`;
    return;
  }
  // üîÄ ORDINA: prima utilizzabili, poi usati
coupons.sort((a, b) => {
  if (a.redento === b.redento) {
    // stesso stato ‚Üí pi√π recenti sopra
    return new Date(b.created_at) - new Date(a.created_at);
  }
  // non redento (false) prima di redento (true)
  return a.redento ? 1 : -1;
});

  coupons.forEach(c => {
    const scadenza = scadenzaDaCreazione(c.created_at);

const oggi = new Date();
const scaduto = oggi.getTime() > scadenza.getTime();

    const div = document.createElement("div");
    div.id = `coupon-${c.codice}`;
    div.className = "coupon" 
  + (c.redento ? " used" : "") 
  + (scaduto ? " used" : "");

div.innerHTML = `
  <div style="flex:1">
    <div class="coupon-title">${c.titolo}</div>
    <div class="coupon-desc">Coppa ${c.tipo} omaggio</div>

    ${
      !c.redento
        ? `<div class="coupon-unlocked" style="font-size:12px;color:#666;margin-top:4px">
             Sbloccato il ${new Date(c.created_at).toLocaleDateString("it-IT")}
           </div>`
        : ``
    }

    <div class="coupon-expiry">
      Scade il ${scadenza.toLocaleDateString("it-IT")}
    </div>

    ${
      c.redento && c.used_at
        ? `<div class="coupon-used-at" style="font-size:12px;color:#888;margin-top:6px">
             Usato il ${new Date(c.used_at).toLocaleDateString("it-IT")}
           </div>`
        : ``
    }

    <div id="qr-${c.codice}" class="coupon-qr"></div>
  </div>

  ${
    (c.redento || scaduto)
  ? `<button disabled>${scaduto ? "Scaduto" : "Usato"}</button>`
  : `<button onclick="toggleQR('${c.codice}')">Mostra QR</button>`
  }
`;

    list.appendChild(div);
  });
}

window.toggleQR = function(codice){
  const card = document.getElementById(`coupon-${codice}`);
  if (!card || card.classList.contains("used")) return;

  const box = document.getElementById(`qr-${codice}`);
  if (!box) return;

  const isOpen = box.classList.contains("open");

  // chiudi
  if (isOpen){
    box.classList.remove("open");
    return;
  }

  // apri
  box.innerHTML = "";
  box.classList.add("open");

  const qrDiv = document.createElement("div");
  box.appendChild(qrDiv);

  new QRCode(qrDiv, {
    text: `${location.origin}/admin-scan.html?coupon=${codice}`,
    width: 160,
    height: 160,
    correctLevel: QRCode.CorrectLevel.M
  });

  const note = document.createElement("div");
  note.style = "font-size:12px;color:#666;margin-top:8px;text-align:center";
  note.innerText = "Mostra questo QR in cassa (valido una sola volta)";
  box.appendChild(note);
};

function aggiornaCouponUI(coupon){
  const card = document.getElementById(`coupon-${coupon.codice}`);
  if (!card) return;

  card.classList.add("used");

  const btn = card.querySelector("button");
  if (btn){
    btn.innerText = "Usato";
    btn.disabled = true;
  }

  const qrBox = document.getElementById(`qr-${coupon.codice}`);
  if (qrBox){
    qrBox.innerHTML = "";
    qrBox.style.display = "none";
  }

  if (coupon.used_at){
    let usedBox = card.querySelector(".coupon-used-at");
    if (!usedBox){
      usedBox = document.createElement("div");
      usedBox.className = "coupon-used-at";
      usedBox.style = "font-size:12px;color:#888;margin-top:6px";
      card.querySelector(".coupon-expiry").after(usedBox);
    }
    usedBox.innerText = `Usato il ${new Date(coupon.used_at).toLocaleDateString()}`;
  }
}

window.debugScadenza = function(dataFinta){
  window.DATA_TEST = dataFinta;
  caricaCoupon(localStorage.getItem("user_email"));
};

/* ===============================
   REALTIME
================================ */

let couponChannel = null;

function subscribeCouponRealtime(email) {

  console.log("üü¢ Subscribing coupon realtime per:", email);

  if (couponChannel) {
    supabase.removeChannel(couponChannel);
  }

  couponChannel = supabase
    .channel("coupon-realtime-test")
    .on(
      "postgres_changes",
      {
        event: "*",
        schema: "public",
        table: "coupon"
      },
      async payload => {

       const row = payload.new || payload.old;
if (!row || row.email !== email) return;

        console.log("üî• REALTIME EVENT:", payload);

        // üî• RICARICO DATI SICURI
        const { data } = await supabase.functions.invoke(
          "get-profile-data",
          { body: { email } }
        );

        if (data?.ok) {
          renderCoupons(data.coupon_list);

          document.getElementById("coupon-count").textContent =
            data.coupon_disponibili;

          document.getElementById("stat-coupon-ok").textContent =
            data.coupon_disponibili;

          document.getElementById("stat-coupon-used").textContent =
            data.coupon_usati;
        }

      }
    )
    .subscribe(status => {
      console.log("üì° Channel status:", status);
    });
} 

function subscribeNotificheRealtime(email){
  console.log("üöÄ Avvio realtime notifiche per:", email);

  supabase
    .channel("notifiche-realtime")
    .on(
      "postgres_changes",
      {
        event: "*",
        schema: "public",
        table: "notifiche",
        filter: `email=eq.${email}`
      },
      async () => {
        console.log("üîî Nuova notifica realtime");

        await aggiornaBadgeNotifiche();
      }
    )
    .subscribe();
}






/* ===============================
   PROFILO BOOT
================================ */
document.addEventListener("DOMContentLoaded", async () => {
  const email = localStorage.getItem("user_email");
  const logged = localStorage.getItem("userLogged") === "1";

  // üîí BLOCCA INPUT AVATAR SE NON LOGGATO
  const avatarInput = document.getElementById("profile-avatar-input");
  if (avatarInput) {
    avatarInput.disabled = !logged;
  }

  /* ===============================
     üë§ AVATAR ‚Üí RESET SOLO SE CAMBIA EMAIL
  =============================== */
if (logged && email) {
  const lastEmail = localStorage.getItem("cdg_avatar_email");
  if (lastEmail && lastEmail !== email) {
    // qui NON tocchiamo pi√π cdg_profile_avatar_v1 (non esiste pi√π)
    // se vuoi, in futuro possiamo anche cancellare l‚Äôavatar su storage
  }
  localStorage.setItem("cdg_avatar_email", email);
}

  // üî• SEMPRE, sia loggato che no
  aggiornaProfileCard();
  aggiornaAvatarProfilo();
  setupAvatarChange();
const coppeCard = document.getElementById("coppe-card");
const loginHint = document.getElementById("login-hint");

if (!logged && coppeCard) {
  coppeCard.classList.add("disabled");

coppeCard.addEventListener("click", (e) => {
  e.preventDefault();
  e.stopPropagation();

  mostraPopup(
    "Accesso richiesto",
    "Accedi o registrati per visualizzare lo storico delle tue coppe.",
    "login.html"
  );
});

  if (loginHint) loginHint.style.display = "block";
}
  const couponSection = document.getElementById("coupon-section");
  const noLogin = document.getElementById("no-login");
  const couponList = document.getElementById("coupon-list");
  const openCoupon = document.getElementById("open-coupon-list");


// toggle lista coupon (animato)
if (openCoupon && couponList){
  openCoupon.onclick = () => {
    couponList.classList.toggle("open");
  };
}
if (!logged || !email){
  noLogin.style.display = "block";
  couponSection.style.display = "none";

  // ‚úÖ aggiorna comunque la card
  aggiornaProfileCard();
  aggiornaAvatarProfilo();

  return;
}

await aggiornaBadgeNotifiche();
await aggiornaStatNotificheProfilo();

// üîê DATI SICURI DA EDGE
// üî• prima verifica se creare coupon
const { data } = await supabase.functions.invoke(
  "get-profile-data",
  { body: { email } }
);

if (data?.ok) {
  document.getElementById("coppe-count").textContent = data.coppe_count;
  document.getElementById("stat-coupon-ok").textContent = data.coupon_disponibili;
  document.getElementById("stat-coupon-used").textContent = data.coupon_usati;
  document.getElementById("stat-notif").textContent = data.notifiche_non_lette;
}

  renderCoupons(data.coupon_list); // üî• importantissimo
  document.getElementById("coupon-count").textContent = data.coupon_disponibili;



// mostra sezione coupon sempre (anche se 0, ma con badge 0)
couponSection.style.display = "block";

// üî• avatar sincronizzato con login/logout
aggiornaAvatarProfilo();
subscribeCouponRealtime(email);
subscribeConfermeRealtime(email);
subscribeNotificheRealtime(email);
});

/* ===============================
   AZIONI TOP
================================ */
window.gestisciLoginLogout = function(){
  const email = localStorage.getItem("user_email");
  if (!email){
    location.href = "login.html";
    return;
  }

  if (confirm(`Sei loggato come:\n${email}\n\nVuoi cambiare profilo?`)){
    localStorage.removeItem("user_email");
    localStorage.setItem("userLogged", "0");
    location.href = "login.html";
  }
};


</script>

<script type="module">
import { supabase } from "./supabase.js";

let waitInterval = null;
let collapseTimeout = null;

function expandWaitBar(){
  const full = document.getElementById("wait-full");
  const compact = document.getElementById("wait-compact");
  if (!full || !compact) return;

  full.style.display = "inline";
  compact.style.display = "none";

  clearTimeout(collapseTimeout);
  collapseTimeout = setTimeout(collapseWaitBar, 5000);
}



function collapseWaitBar(){
  const full = document.getElementById("wait-full");
  const compact = document.getElementById("wait-compact");
  if (!full || !compact) return;

  full.style.display = "none";
  compact.style.display = "inline";
}

async function loadWaitTime(){
  const { data, error } = await supabase
    .from("wait_time")
    .select("*")
    .eq("id", 1)
    .single();

  if (error || !data) return;

  const bar = document.getElementById("wait-bar");
  const txt = document.getElementById("wait-time");
  if (!bar || !txt) return;

  if (waitInterval){
    clearInterval(waitInterval);
    waitInterval = null;
  }

  if (!data.active || data.minutes <= 0){
    bar.style.display = "none";
    return;
  }

  const startTime = new Date(data.updated_at).getTime();
  const totalSeconds = data.minutes * 60;

  function tick(){
    const now = Date.now();
    const elapsed = Math.floor((now - startTime) / 1000);
    const remaining = totalSeconds - elapsed;

    if (remaining <= 0){
      bar.style.display = "none";
      clearInterval(waitInterval);
      waitInterval = null;
      return;
    }

    const min = Math.floor(remaining / 60);
    const sec = remaining % 60;
    const timeStr = `${min}:${sec.toString().padStart(2,"0")}`;

    txt.textContent = timeStr;
    const mmss = document.getElementById("wait-mmss");
    if (mmss) mmss.textContent = timeStr;

    bar.style.display = "flex";

    if (sec === 59) expandWaitBar();
  }

  tick();
  waitInterval = setInterval(tick, 1000);
}

supabase
  .channel("wait-time-live")
  .on("postgres_changes", { event:"*", schema:"public", table:"wait_time" }, () => loadWaitTime())
  .subscribe();

document.addEventListener("DOMContentLoaded", loadWaitTime);

// ===== Menu profilo (apri/chiudi) =====
const avatarBtn = document.getElementById("profile-avatar-btn");
const menu = document.getElementById("profile-menu");
const backdrop = document.getElementById("profile-menu-backdrop");
// ‚úÖ click fuori = chiudi menu
if (backdrop) {
  backdrop.addEventListener("click", () => {
    closeMenu();
  });
}
// ===== REGISTRATI =====
const btnRegister = document.getElementById("menu-register");

if (btnRegister) {
btnRegister.addEventListener("click", () => {
  closeMenu();
  window.location.href = "login.html#register";
});
}
// ===== MODIFICA PROFILO =====
const editProfileBtn = document.getElementById("menu-edit-profile");

if (editProfileBtn) {
  editProfileBtn.addEventListener("click", () => {
    closeMenu();
    window.location.href = "modifica-profilo.html";
  });
}

function openMenu(){
  if (!menu || !backdrop) return;
 menu.classList.add("show");
backdrop.classList.add("show");
}

window.closeMenu = function closeMenu(){
  const menu = document.getElementById("profile-menu");
  const menuBackdrop = document.getElementById("profile-menu-backdrop");

  if (menu) menu.classList.remove("show");
  if (menuBackdrop) menuBackdrop.classList.remove("show");
};
const privacyBtn = document.getElementById("menu-privacy");
if (privacyBtn) {
  privacyBtn.addEventListener("click", () => {
    closeMenu();
  });
}
if (avatarBtn){
  avatarBtn.addEventListener("click", (e) => {
    e.stopPropagation();
    const isOpen = menu && menu.classList.contains("show");
    if (isOpen) closeMenu();
    else openMenu();
  });
}

// ===== Logout =====
document.addEventListener("DOMContentLoaded", () => {
  const logoutBtn = document.getElementById("menu-logout");

  if (!logoutBtn) {
    console.warn("‚ùå Bottone logout non trovato");
    return;
  }

  logoutBtn.addEventListener("click", () => {
    console.log("üö™ Logout cliccato");

    // chiudi menu se aperto
    if (typeof closeMenu === "function") {
      closeMenu();
    }

    // reset login
    localStorage.removeItem("user_email");
    localStorage.removeItem("user_name");
    localStorage.removeItem("user_surname");
    localStorage.setItem("userLogged", "0");
  const avatarInput = document.getElementById("profile-avatar-input");
  if (avatarInput) {
    avatarInput.disabled = true;
  }
mostraPopup(
  "Logout effettuato",
  "Sei uscito correttamente dal tuo profilo.",
  "profilo.html"
);
  });
});

// chiudi con ESC (desktop)
window.addEventListener("keydown", (e) => {
  if (e.key === "Escape") closeMenu();
});

// evita chiusura immediata cliccando nel menu
if (menu){
  menu.addEventListener("click", (e) => e.stopPropagation());
}
// ===== Disiscriviti dal menu profilo =====
const unsubscribeBtn = document.getElementById("menu-unsubscribe");

if (unsubscribeBtn) {
unsubscribeBtn.addEventListener("click", () => {
  closeMenu();

  const email = localStorage.getItem("user_email");
  const logged = localStorage.getItem("userLogged") === "1";

  // ‚ùå NON LOGGATO
  if (!logged || !email) {
    mostraPopup(
      "Nessun accesso effettuato",
      "Accedi o registrati per gestire il tuo account."
    );
    return;
  }

  // ‚úÖ LOGGATO
  apriPopupDisiscrizione();
});
}
</script>



<div id="menu-overlay" style="
  position:fixed;
  inset:0;
  background:rgba(0,0,0,0.35);
  opacity:0;
  pointer-events:none;
  transition:.25s;
  z-index:10000;
"></div>

<div id="menu-dropdown" style="
  position:fixed;
  top:60px;
  left:14px;
  width:220px;
  background:#fff;
  border-radius:14px;
  box-shadow:0 12px 30px rgba(0,0,0,0.25);
  padding:10px;
  opacity:0;
  pointer-events:none;
  transform:translateY(-10px);
  transition:.25s;
  z-index:10002;
">
<a href="crea-coppa.html" class="menu-item menu-new-only">
  <span class="badge-new-left">NEW</span>
  <span>Scoopy ice</span>
</a>
<a href="home.html" class="menu-item">
  <svg class="menu-icon" viewBox="0 0 24 24" aria-hidden="true">
    <path d="M3 11.5L12 4l9 7.5" />
    <path d="M5 10.5V20a1 1 0 0 0 1 1h4v-6h4v6h4a1 1 0 0 0 1-1v-9.5" />
  </svg>
  <span>Home</span>
</a>
  <a href="menu.html" class="menu-item">
  <svg class="menu-icon" viewBox="0 0 24 24" aria-hidden="true">
    <rect x="6" y="4" width="12" height="16" rx="2"
          fill="none" stroke="currentColor" stroke-width="2"/>
    <line x1="9" y1="9" x2="15" y2="9"
          stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
    <line x1="9" y1="13" x2="15" y2="13"
          stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
    <line x1="9" y1="17" x2="13" y2="17"
          stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
  </svg>
  <span>Menu</span>
</a>
<a href="profilo.html" class="menu-item">
  <svg class="menu-icon" viewBox="0 0 24 24" aria-hidden="true">
    <path d="M12 12c2.761 0 5-2.239 5-5S14.761 2 12 2 7 4.239 7 7s2.239 5 5 5zm0 2c-4.418 0-8 2.239-8 5v1h16v-1c0-2.761-3.582-5-8-5z"/>
  </svg>
  <span>Profilo</span>
</a>
<a href="info-contatti.html" class="menu-item">
  <svg class="menu-icon" viewBox="0 0 24 24" aria-hidden="true">
    <!-- CERCHIO -->
    <circle
      cx="12"
      cy="12"
      r="9"
      fill="none"
      stroke="currentColor"
      stroke-width="2"
    />

    <!-- PALLINO DELLA i -->
    <circle
      cx="12"
      cy="8"
      r="0.5"
      fill="currentColor"
    />

    <!-- STELO DELLA i -->
    <line
      x1="12"
      y1="11"
      x2="12"
      y2="17"
      stroke="currentColor"
      stroke-width="2.2"
      stroke-linecap="round"
    />
  </svg>
  <span>Info &amp; Contatti</span>
</a>
<a href="lavora-con-noi.html" class="menu-item">
  <svg class="menu-icon" viewBox="0 0 24 24" aria-hidden="true">
    <!-- corpo valigetta -->
    <rect x="3" y="7" width="18" height="13" rx="2"
          fill="none" stroke="currentColor" stroke-width="2"/>
    <!-- manico -->
    <path d="M9 7V5a3 3 0 0 1 6 0v2"
          fill="none" stroke="currentColor" stroke-width="2"
          stroke-linecap="round"/>
  </svg>
  <span>Lavora con noi</span>
</a>
</div>

<script>
document.addEventListener("DOMContentLoaded", () => {

  /* ===== MENU HAMBURGER TOP SINISTRA ===== */

  const burgerBtn   = document.getElementById("menu-btn");
  const burgerMenu  = document.getElementById("menu-dropdown");
  const burgerOv    = document.getElementById("menu-overlay");

  if (!burgerBtn || !burgerMenu || !burgerOv) return;

  function openBurgerMenu() {
    burgerMenu.style.opacity = "1";
    burgerMenu.style.pointerEvents = "auto";
    burgerMenu.style.transform = "translateY(0)";
    burgerOv.style.opacity = "1";
    burgerOv.style.pointerEvents = "auto";
  }

  function closeBurgerMenu() {
    burgerMenu.style.opacity = "0";
    burgerMenu.style.pointerEvents = "none";
    burgerMenu.style.transform = "translateY(-10px)";
    burgerOv.style.opacity = "0";
    burgerOv.style.pointerEvents = "none";
  }

  burgerBtn.addEventListener("click", (e) => {
    e.stopPropagation();
    const open = burgerMenu.style.pointerEvents === "auto";
    open ? closeBurgerMenu() : openBurgerMenu();
  });

  burgerOv.addEventListener("click", closeBurgerMenu);

  burgerMenu.querySelectorAll("a").forEach(a =>
    a.addEventListener("click", closeBurgerMenu)
  );

  document.addEventListener("keydown", e => {
    if (e.key === "Escape") closeBurgerMenu();
  });

});


</script>

<input
  id="profile-avatar-input"
  type="file"
  accept="image/*"
  style="
    position: fixed;
    left: -9999px;
    opacity: 0;
    pointer-events: none;
  "
>

<footer class="profile-footer">
  <div class="footer-links">
    <a href="privacy.html">Privacy</a>
    <span>‚Ä¢</span>
    <a href="termini.html">Termini</a>
    <span>‚Ä¢</span>
    <a href="cookie.html">Cookie</a>
  </div>

  <div class="footer-copy">
    ¬© 2026 Casa del Gelato
  </div>

  <div class="footer-version">
    Versione 1.0.0
  </div>
</footer>


<script>
window.mostraPopup = function(titolo, messaggio, redirect = null){
  const backdrop = document.getElementById("ui-alert-backdrop");
  const popup    = document.getElementById("ui-alert");
  const titleEl  = document.getElementById("ui-alert-title");
  const msgEl    = document.getElementById("ui-alert-message");
  const btn      = document.getElementById("ui-alert-btn");

  titleEl.textContent = titolo;
  msgEl.innerHTML = messaggio;

  document.body.classList.add("no-scroll");
  backdrop.classList.add("show");
  popup.classList.add("show");

  btn.onclick = () => {
    popup.classList.remove("show");
    backdrop.classList.remove("show");
    document.body.classList.remove("no-scroll");

    if (redirect) {
      setTimeout(() => window.location.href = redirect, 150);
    }
  };
};
</script>

<script>
window.disiscriviti = async function(){
  const email = localStorage.getItem("user_email");
  if (!email) return;

await supabase
  .from("utenti")
  .update({
    disiscritto: true,
    data_disiscrizione: new Date().toISOString()
  })
  .eq("email", email);

  localStorage.removeItem("user_email");
  localStorage.setItem("userLogged", "0");

  mostraPopup(
    "Account disiscritto",
    "Il tuo account √® stato rimosso correttamente."
  );

  setTimeout(() => {
    window.location.href = "home.html";
  }, 2000);
};
</script>

<!-- üîî POPUP AVVISO UNIVERSALE -->
<div id="ui-alert-backdrop"></div>

<div id="ui-alert">
  <div id="ui-alert-title">Titolo</div>
  <div id="ui-alert-message">Messaggio</div>
  <button id="ui-alert-btn">OK</button>
</div>

<!-- üî¥ POPUP DISISCRIZIONE -->
<div id="unsubscribe-backdrop" class="glass-backdrop"></div>

<div id="unsubscribe-popup" class="glass-menu" style="
  right:auto;
  left:50%;
  top:40%;
  width:320px;
  transform:translate(-50%,-50%) scale(0.94);
">
  <div style="
    font-size:16px;
    font-weight:800;
    text-align:center;
    margin-bottom:10px;
    color:#ff3b30;
  ">
    Disiscrizione account
  </div>

  <div style="
    font-size:14px;
    color:#555;
    text-align:center;
    line-height:1.4;
    margin-bottom:18px;
  ">
    Sei sicuro di voler disiscriverti?<br>
    <b>Perderai coupon, storico e vantaggi.</b>
  </div>

  <div style="display:flex; gap:10px;">
    <button id="unsubscribe-cancel" style="
      flex:1;
      padding:10px;
      border-radius:12px;
      border:none;
      background:#e5e5ea;
      color:#111;
      font-weight:700;
      cursor:pointer;
    ">
      Annulla
    </button>

    <button id="unsubscribe-confirm" style="
      flex:1;
      padding:10px;
      border-radius:12px;
      border:none;
      background:#ff3b30;
      color:#fff;
      font-weight:800;
      cursor:pointer;
    ">
      Disiscriviti
    </button>
  </div>
</div>

<script>
document.addEventListener("DOMContentLoaded", () => {

  document.getElementById("unsubscribe-cancel")
    ?.addEventListener("click", chiudiPopupDisiscrizione);

  document.getElementById("unsubscribe-backdrop")
    ?.addEventListener("click", chiudiPopupDisiscrizione);

  document.getElementById("unsubscribe-confirm")
    ?.addEventListener("click", async () => {
      chiudiPopupDisiscrizione();
      await disiscriviti();
    });

});
</script>


</body>
</html>