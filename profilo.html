<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
<title>Profilo</title>

<link rel="stylesheet" href="bottom-nav.css">
<script src="global.js"></script>
<script src="https://cdn.jsdelivr.net/npm/qrcodejs/qrcode.min.js"></script>

<style>
  body{
    margin:0;
    background:#f6f6f7;
    font-family: system-ui, -apple-system, sans-serif;
    padding-bottom: 110px; /* spazio bottom-nav + waitbar */
    color:#111;
  }

  /* üîù Barra fissa */
#top-fixed-bar{
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 55px;

  display: grid;
  grid-template-columns: 1fr auto 1fr;
  align-items: center;

  padding: 0 12px;
  background: #fff;
  border-bottom: 1px solid #ddd;
  z-index: 9999;
}


.top-left{ justify-self: start; }
.top-center{ justify-self: center; }
.top-right{ justify-self: end; }

  .home-btn{
    display:flex;
    align-items:center;
    gap:6px;
    font-size:17px;
    font-weight:700;
    color:#444;
    text-decoration:none;
  }

  .home-btn img{
    width:28px; height:28px;
  }

  #top-fixed-spacer{ height:55px; }

  /* Contenuto */
.container{
  max-width: 480px;
  width: 100%;
  margin: 0 auto;
  padding: 16px;
  box-sizing: border-box;
}
  /* Sezioni profilo */
  .profile-section{
    margin-top: 18px;
  }

  .section-title{
    font-size: 16px;
    font-weight: 800;
    margin: 10px 4px;
    color:#111;
  }

  /* Riga azione stile ‚ÄúiOS‚Äù ma chiara come il tuo sito */
  .profile-action{
    display:flex;
    align-items:center;
    justify-content:space-between;

    background:#fff;
    padding: 14px 16px;
    border-radius: 14px;
    box-shadow: 0 2px 6px rgba(0,0,0,0.08);

    text-decoration:none;
    color:#111;
    font-size: 15px;
    font-weight: 700;

    cursor:pointer;
    -webkit-tap-highlight-color: transparent;

    transition: transform .12s ease, background .12s ease;
    margin-bottom: 10px;
  }

  .profile-action:active{
    transform: scale(0.98);
    background:#f2f2f7;
  }

  .profile-action-left{
    display:flex;
    align-items:center;
    gap:10px;
  }

  .profile-action-right{
    display:flex;
    align-items:center;
    gap:8px;
  }

  .badge{
    background:#007aff;
    color:#fff;
    font-size: 12px;
    font-weight: 800;
    padding: 4px 10px;
    border-radius: 999px;
    min-width: 24px;
    text-align:center;
  }

  .chevron{
    font-size: 20px;
    color:#bbb;
    line-height: 1;
  }

/* AZIONI PROFILO in alto a destra */
.profile-actions{
  display: flex;
  align-items: center;
  gap: 8px;

  justify-self: end;     /* ‚Üê va nella colonna destra */
  margin-right: 16px;     /* ‚Üê rientro elegante stile iOS */
}

  .profile-action-btn{
    width:34px;
    height:34px;
    border-radius: 50%;
    border:none;
    background:#f2f2f7;
    color:#333;
    font-size:16px;
    cursor:pointer;
    display:flex;
    align-items:center;
    justify-content:center;
    transition: transform .12s ease, background .12s ease;
  }

  .profile-action-btn:active{
    transform: scale(0.92);
    background:#e5e5ea;
  }

  .profile-action-btn.danger{
    background:#ffecec;
    color:#ff3b30;
  }
  .profile-action-btn.danger:active{
    background:#ffd6d6;
  }

  /* Email chip (piccolo, coerente, non invasivo) */
  .email-chip{
    display:none;
    margin: 0 0 12px;
    padding: 10px 12px;
    border-radius: 14px;
    background:#fff;
    box-shadow: 0 2px 6px rgba(0,0,0,0.06);
    font-size: 13px;
    color:#555;
  }
  .email-chip b{ color:#111; }

  /* COUPON LIST */
  .coupon-list{
    display:flex;
    flex-direction:column;
    gap: 12px;
    margin-top: 10px;
  }

  .coupon{
    background:#fff;
    border-radius: 18px;
    padding: 16px;
    box-shadow: 0 4px 12px rgba(0,0,0,0.06);
    display:flex;
    justify-content:space-between;
    align-items:flex-start;
    gap: 12px;
  }

  .coupon.used{ opacity: .5; }

  .coupon-title{
    font-weight: 800;
    font-size: 15px;
  }
  .coupon-desc{
    font-size: 13px;
    color:#666;
    margin-top: 4px;
  }
  .coupon-expiry{
    font-size: 12px;
    color:#999;
    margin-top: 6px;
  }

  .coupon button{
    background:#111;
    color:#fff;
    border:none;
    border-radius: 14px;
    padding: 8px 12px;
    font-size: 12px;
    font-weight: 800;
    cursor:pointer;
    white-space: nowrap;
  }

  .coupon.used button{
    background:#ccc;
    color:#444;
    cursor: default;
  }

  /* QR box dentro coupon */
  .coupon-qr{
    display:none;
    margin-top: 10px;
    text-align:center;
  }

  /* Messaggio vuoto */
  .empty-msg{
    margin-top: 18px;
    text-align:center;
    font-size: 14px;
    color:#666;
    font-weight: 700;
  }



.avatar-btn{
  width: 36px;
  height: 36px;
  border-radius: 50%;
  border: 1px solid rgba(0,0,0,0.08);
  background: rgba(255,255,255,0.65);
  backdrop-filter: blur(10px);
  -webkit-backdrop-filter: blur(10px);
  box-shadow: 0 6px 16px rgba(0,0,0,0.10);
  padding: 0;
  overflow: hidden;
  cursor: pointer;
}

.avatar-btn:active{ transform: scale(0.95); }

.avatar-btn img{
  width: 100%;
  height: 100%;
  object-fit: cover;
  display:block;
}

/* ===== Liquid glass menu ===== */
.glass-backdrop{
  position: fixed;
  inset: 0;
  background: rgba(0,0,0,0.18);
  backdrop-filter: blur(6px);
  -webkit-backdrop-filter: blur(6px);
  z-index: 9998;
}

.glass-menu{
  position: fixed;
  top: 62px;          /* sotto la top bar */
  right: 12px;
  width: 230px;

  background: rgba(255,255,255,0.72);
  border: 1px solid rgba(255,255,255,0.55);
  border-radius: 16px;

  box-shadow: 0 18px 45px rgba(0,0,0,0.22);
  backdrop-filter: blur(16px);
  -webkit-backdrop-filter: blur(16px);

  padding: 8px;
  z-index: 9999;

  transform-origin: top right;
  animation: glassIn .14s ease-out;
}

@keyframes glassIn{
  from{ transform: scale(0.96); opacity: 0; }
  to  { transform: scale(1);    opacity: 1; }
}

.glass-item{
  width: 100%;
  border: none;
  background: transparent;
  padding: 10px 10px;
  border-radius: 12px;

  font-size: 14px;
  font-weight: 700;
  color: #111;

  display:flex;
  align-items:center;
  gap: 8px;

  cursor: pointer;

  /* ‚úÖ AGGIUNGI QUESTE */
  text-decoration: none;
  outline: none;
}
.glass-item:visited{
  color: #111;
  text-decoration: none;
}
.glass-item:hover{ background: rgba(0,0,0,0.06); }
.glass-item:active{ background: rgba(0,0,0,0.10); transform: scale(0.99); }

.glass-item.danger{
  color: #ff3b30;
}

/* Hint login */
.login-hint{
  margin-top: 8px;
  padding-left: 6px;
  font-size: 13px;
  font-weight: 600;
  color: #777;
}

/* Card disabilitata */
.profile-action.disabled{
  opacity: 0.45;
  pointer-events: none;
}
/* üîò iOS style switch */
.switch {
  position: relative;
  display: inline-block;
  width: 44px;
  height: 26px;
}

.switch input {
  opacity: 0;
  width: 0;
  height: 0;
}

.slider {
  position: absolute;
  inset: 0;
  background-color: #ccc;
  border-radius: 999px;
  transition: .2s;
}

.slider:before {
  position: absolute;
  content: "";
  height: 22px;
  width: 22px;
  left: 2px;
  top: 2px;
  background-color: white;
  border-radius: 50%;
  transition: .2s;
}

.switch input:checked + .slider {
  background-color: #34c759;
}

.switch input:checked + .slider:before {
  transform: translateX(18px);
}
/* üì© Popup consensi animato */
/* üì© Popup consensi animato (FLUIDO) */
#consensi-backdrop {
  opacity: 0;
  pointer-events: none;
  transition: opacity .32s ease;
}

#consensi-backdrop.show {
  opacity: 1;
  pointer-events: auto;
}

#consensi-popup {
  position: fixed;
  top: 40%;
  left: 50%;
  right: auto;

  opacity: 0;
  pointer-events: none;

  transform: translate(-50%, -50%) scale(0.94);
  transition: opacity .32s ease, transform .32s ease;
}

#consensi-popup.show {
  opacity: 1;
  pointer-events: auto;
  transform: translate(-50%, -50%) scale(1);
}
.consensi-title{
  text-align: center;
  font-size: 16px;
  font-weight: 800;
  margin-bottom: 12px; /* pi√π aria sotto */
}

.consensi-desc{
  text-align: center;
  font-size: 14px;
  color: #555;
  margin-bottom: 18px; /* separa bene dallo switch */
  line-height: 1.4;
}
#consensi-popup > div {
  padding: 16px 18px 18px; /* prima era troppo stretto */
}
#consensi-popup .switch-row,
#consensi-popup > div > div[style*="display:flex"] {
  padding: 14px 14px;   /* prima troppo stretto */
  margin-bottom: 18px; /* aria prima del bottone */
}
#chiudi-consensi{
  margin-top: 6px;  /* prima era troppo attaccato */
}
/* üì© Popup consensi centrato */
#consensi-popup{
  top: 40% !important;
  left: 50% !important;
  right: auto !important;

  transform: translate(-50%, -50%) scale(0.96);
}

/* üîî Popup notifiche ‚Äì FLUIDO */
#notifiche-backdrop{
  opacity: 0;
  pointer-events: none;
  transition: opacity .32s ease;
}

#notifiche-backdrop.show{
  opacity: 1;
  pointer-events: auto;
}

#notifiche-popup{
  position: fixed;
  top: 40%;
  left: 50%;
  right: auto;

  opacity: 0;
  pointer-events: none;

  transform: translate(-50%, -50%) scale(0.94);
  transition: opacity .32s ease, transform .32s ease;
}

#notifiche-popup.show{
  opacity: 1;
  pointer-events: auto;
  transform: translate(-50%, -50%) scale(1);
}

/* singola notifica */
.notification-item{
  background: rgba(0,0,0,0.05);
  padding: 12px 14px;
  border-radius: 12px;
  font-size: 14px;
  font-weight: 600;
}
.notif-badge{
  background:#ff3b30;
  color:#fff;
  font-size:12px;
  font-weight:800;
  padding: 2px 8px;
  border-radius:999px;
  min-width: 22px;
  text-align:center;
  line-height: 18px;
}
.notification-item{
  position: relative;
  padding: 12px 34px 12px 14px; /* spazio a destra per pallino */
  border-radius: 12px;
  font-size: 14px;
  font-weight: 600;
}

/* üîµ pallino non letta */
.notification-item.unread::after{
  content: "";
  position: absolute;
  right: 12px;
  top: 50%;
  transform: translateY(-50%);
  width: 8px;
  height: 8px;
  border-radius: 50%;
  background: #007aff; /* Apple blue */
}

/* ===== iOS SWIPE NOTIFICA ===== */
/* wrapper = riferimento unico */
.notification-swipe{
  position: relative;
  border-radius: 16px;
  overflow: hidden;
  margin-bottom: 10px;
}

/* üî¥ CARD ROSSA (SOTTO) */
.notification-swipe .notif-delete{
  position: absolute;
  inset: 1.5px;                     /* üî• IDENTICA */
  background: #ff3b30;
  color: #fff;

  border: none;
  font-weight: 700;
  font-size: 14px;

  display: flex;
  align-items: center;
  justify-content: flex-end;
  padding-right: 18px;

  border-radius: 14px;
  z-index: 1;
}

/* ‚ö™ CARD NOTIFICA (SOPRA) */
.notification-swipe .notification-item{
  position: relative;
  z-index: 2;

  background: #f4f4f6;
  padding: 12px 14px;
  border-radius: 16px;

  /* üî• micro overdraw */
  margin: -1px;
  transition: transform .25s ease;
}

/* stato swipe */
.notification-swipe.swiped .notification-item{
  transform: translateX(-90px);
}
/* üñ•Ô∏è Desktop: mostra Elimina solo su hover */
@media (hover: hover) and (pointer: fine) {
  .notification-swipe:hover .notification-item {
    transform: translateX(-90px);
  }
}
</style>
</head>

<body>

<!-- üîù Barra -->
<div id="top-fixed-bar">
  <div class="top-left"></div>

  <a href="index.html" class="home-btn top-center">
    <img src="tastohome.png" alt="home">
    <span>Home</span>
  </a>

  <div class="profile-actions top-right">
    <button id="profile-avatar-btn" class="avatar-btn" aria-label="Menu profilo">
      <img id="profile-avatar-img" src="icone/user.png" alt="">
    </button>
  </div>
</div>

<!-- MENU LIQUID GLASS -->
<div id="profile-menu" class="glass-menu" style="display:none;">
  <button class="glass-item" id="menu-change-photo">Cambia immagine</button>
  <button class="glass-item" id="menu-register">Registrati</button>
  <a href="login.html" class="glass-item">Accedi</a>
  <button class="glass-item" id="menu-logout">Logout</button>
  <button class="glass-item danger" id="menu-unsubscribe">‚úï Disiscriviti</button>
<button class="glass-item" id="menu-notifiche">
  üîî Notifiche
  <span id="notifiche-count" class="badge" style="display:none;">0</span>
</button>
  <button class="glass-item" id="menu-consensi">
  Consensi comunicazioni üì©
</button>
</div>

<input
  id="profile-avatar-input"
  type="file"
  accept="image/*"
  style="display:none"
/>

<div id="profile-menu-backdrop" class="glass-backdrop" style="display:none;"></div>

<div id="top-fixed-spacer"></div>

<div class="container">
  <!-- serve al JS per non rompersi, ma resta invisibile -->
  <div id="profile-info" style="display:none;"></div>

  <div id="email-chip" class="email-chip"></div>

  <!-- üç® COPPE -->
  <section class="profile-section">
    <div class="section-title">üç® Le mie coppe</div>

    <a href="cronologia.html" id="coppe-card" class="profile-action">
      <div class="profile-action-left">
        <span>Coppe create</span>
      </div>
      <div class="profile-action-right">
        <span id="coppe-count" class="badge">0</span>
        <span class="chevron">‚Ä∫</span>
      </div>
    </a>
    <div id="login-hint" class="login-hint" style="display:none;">
  Accedi o registrati per usufruire di tutte le funzionalit√†
</div>
  </section>

  <!-- üéüÔ∏è COUPON -->
  <section id="coupon-section" class="profile-section" style="display:none;">
    <div class="section-title">üéüÔ∏è I miei coupon</div>

    <div class="profile-action" id="open-coupon-list">
      <div class="profile-action-left">
        <span>Coupon disponibili</span>
      </div>
      <div class="profile-action-right">
        <span id="coupon-count" class="badge">0</span>
        <span class="chevron">‚Ä∫</span>
      </div>
    </div>

    <div id="coupon-list" class="coupon-list" style="display:none;"></div>
  </section>

  <div id="no-login" class="empty-msg" style="display:none;">
    Nessun accesso effetuato.
  </div>
</div>

<!-- üì© POPUP CONSENSI -->
<div id="consensi-backdrop" class="glass-backdrop"></div>

<div id="consensi-popup" class="glass-menu"
  style="right:auto; left:50%; width:300px;">

<div class="consensi-title">
  üì© Consensi comunicazioni
</div>

<div class="consensi-desc">
  Puoi decidere se ricevere promozioni e comunicazioni da Casa del Gelato.
</div>

    <div style="
      display:flex;
      align-items:center;
      justify-content:space-between;
      background:rgba(0,0,0,0.05);
      padding:10px 12px;
      border-radius:12px;
    ">
      <span style="font-weight:700;font-size:14px;">
        Ricevi comunicazioni
      </span>

      <label class="switch">
        <input type="checkbox" id="consenso-switch">
        <span class="slider"></span>
      </label>
    </div>

    <button id="chiudi-consensi"
      style="
        margin-top:14px;
        width:100%;
        padding:10px;
        border-radius:12px;
        border:none;
        background:#111;
        color:#fff;
        font-weight:700;
        cursor:pointer;
      ">
      Chiudi
    </button>

  </div>
</div>

<!-- üîî POPUP NOTIFICHE -->
<div id="notifiche-backdrop" class="glass-backdrop"></div>

<div id="notifiche-popup" class="glass-menu"
  style="right:auto; left:50%; width:320px;">

  <div class="consensi-title">
    üîî Notifiche
  </div>

  <div class="consensi-desc">
    Qui trovi gli aggiornamenti sui tuoi coupon e premi.
  </div>

<div id="notifiche-list"></div>

  <button id="chiudi-notifiche"
    style="
      margin-top:16px;
      width:100%;
      padding:10px;
      border-radius:12px;
      border:none;
      background:#111;
      color:#fff;
      font-weight:700;
      cursor:pointer;
    ">
    Chiudi
  </button>
</div>

<!-- ‚≠ê Bottom bar -->
<div id="bottom-nav">
  <a href="crea-coppa.html" class="nav-item">
    <img src="icone/crea.png" alt="">
    <span>Crea</span>
  </a>
  <a href="profilo.html" class="nav-item">
    <img src="icone/user.png" alt="">
    <span>Profilo</span>
  </a>
  <a href="menu.html" class="nav-item">
    <img src="icone/menu.png" alt="">
    <span>Menu</span>
  </a>
</div>

<script type="module">
import { supabase } from "./supabase.js";



/* ===============================
   UTILS
================================ */

function abilitaSwipeNotifiche() {
  document.querySelectorAll(".notification-swipe").forEach(wrapper => {
    const item = wrapper.querySelector(".notification-item");

    let startX = 0;
    let currentX = 0;
    let dragging = false;

    item.addEventListener("touchstart", e => {
      startX = e.touches[0].clientX;
      dragging = true;
      item.style.transition = "none";
    });

    item.addEventListener("touchmove", e => {
      if (!dragging) return;

      currentX = e.touches[0].clientX;
      const diff = currentX - startX;

      // solo swipe verso sinistra
      if (diff < 0) {
        item.style.transform = `translateX(${Math.max(diff, -110)}px)`;
      }
    });

    item.addEventListener("touchend", () => {
      dragging = false;
      item.style.transition = "transform .25s ease";

      // soglia swipe
      if (currentX - startX < -60) {
        wrapper.classList.add("swiped");
        item.style.transform = "translateX(-90px)";
      } else {
        wrapper.classList.remove("swiped");
        item.style.transform = "translateX(0)";
      }
    });
  });
}

async function aggiornaBadgeNotifiche(){
  const email = localStorage.getItem("user_email");
  const logged = localStorage.getItem("userLogged") === "1";
  const badge = document.getElementById("notifiche-count");

  if (!badge || !logged || !email){
    if (badge) badge.style.display = "none";
    return;
  }

  const { data, error } = await supabase
    .from("notifiche")
    .select("id")
    .eq("email", email)
    .eq("letta", false);

    console.log("BADGE QUERY RESULT:", data);

  if (error){
    console.error(error);
    badge.style.display = "none";
    return;
  }

  const n = data.length;

  if (n > 0){
    badge.textContent = n > 99 ? "99+" : n;
    badge.style.display = "inline-block";
  } else {
    badge.style.display = "none";
  }
}


async function caricaNotificheUtente() {
  const email = localStorage.getItem("user_email");
  if (!email) return;

  const list = document.getElementById("notifiche-list");
  if (!list) return;

  list.innerHTML = "‚è≥ Caricamento‚Ä¶";

  const { data, error } = await supabase
    .from("notifiche")
    .select("*")
    .eq("email", email)
    .order("created_at", { ascending: false });

  if (error) {
    list.innerHTML = "‚ùå Errore caricamento notifiche";
    console.error(error);
    return;
  }

  if (!data || data.length === 0) {
    list.innerHTML = `
      <div class="notification-item">
        üîï Nessuna notifica al momento
      </div>`;
    return;
  }

  list.innerHTML = "";

data.forEach(n => {
  const wrapper = document.createElement("div");
  wrapper.className = "notification-swipe";
  wrapper.dataset.id = n.id;

  const content = document.createElement("div");
  content.className = "notification-item";
  if (n.letta === false) content.classList.add("unread");
  content.textContent = n.messaggio;

  const deleteBtn = document.createElement("button");
  deleteBtn.className = "notif-delete";
  deleteBtn.textContent = "Elimina";

wrapper.appendChild(deleteBtn); // üî¥ SOTTO (nascosto)
wrapper.appendChild(content);   // ‚ö™ SOPRA (scorre)
  list.appendChild(wrapper);
  abilitaSwipeNotifiche();
});
}

// ===============================
// AVATAR PROFILO (local + leggero)
// ===============================
const AVATAR_KEY = "cdg_profile_avatar_v1";

function setAvatarSrc(src) {
  const img = document.getElementById("profile-avatar-img");
  if (img) img.src = src;
}

function loadSavedAvatar() {
  const saved = localStorage.getItem(AVATAR_KEY);
  if (saved) setAvatarSrc(saved);
}

// Riduce e comprime l‚Äôimmagine prima di salvarla (evita quota localStorage)
async function compressImageToDataURL(file, maxSize = 256, quality = 0.82) {
  const bitmap = await createImageBitmap(file);

  let w = bitmap.width;
  let h = bitmap.height;

  const scale = Math.min(maxSize / w, maxSize / h, 1);
  w = Math.round(w * scale);
  h = Math.round(h * scale);

  const canvas = document.createElement("canvas");
  canvas.width = w;
  canvas.height = h;
  const ctx = canvas.getContext("2d");
  ctx.drawImage(bitmap, 0, 0, w, h);

  // jpeg = molto pi√π leggero del png
  return canvas.toDataURL("image/jpeg", quality);
}

function setupAvatarChange() {
  const btn = document.getElementById("menu-change-photo");
  const input = document.getElementById("profile-avatar-input");

  if (!btn || !input) return;

  // click su ‚ÄúCambia immagine‚Äù
  btn.addEventListener("click", () => {
    input.value = ""; // reset per permettere la stessa foto due volte
    input.click();
  });

  // quando scegli una foto
  input.addEventListener("change", async () => {
    const file = input.files?.[0];
    if (!file) return;

    try {
      const dataUrl = await compressImageToDataURL(file, 256, 0.82);

      // aggiorna UI subito
      setAvatarSrc(dataUrl);

      // salva
      localStorage.setItem(AVATAR_KEY, dataUrl);

      // opzionale: chiudi menu se vuoi
      if (typeof closeMenu === "function") closeMenu();
    } catch (e) {
      console.error("Errore avatar:", e);
      alert("Errore nel caricamento immagine.");
    }
  });
}

// Avvio
document.addEventListener("DOMContentLoaded", () => {
  loadSavedAvatar();
  setupAvatarChange();
});

function scadenzaDaCreazione(created_at){
  const d = new Date(created_at);
  return new Date(d.getFullYear(), 11, 31);
}

// ===== POPUP CONSENSI =====
document.addEventListener("DOMContentLoaded", () => {
  const btn = document.getElementById("menu-consensi");
  const popup = document.getElementById("consensi-popup");
  const backdrop = document.getElementById("consensi-backdrop");
  const toggle = document.getElementById("consenso-switch");
  const closeBtn = document.getElementById("chiudi-consensi");

  if (!btn || !popup || !toggle || !backdrop) return;

btn.addEventListener("click", async () => {
  // ‚úÖ CHIUDI FORZATAMENTE MENU PROFILO (anche tra moduli)
  const pm = document.getElementById("profile-menu");
  const pmb = document.getElementById("profile-menu-backdrop");
  if (pm) pm.style.display = "none";
  if (pmb) pmb.style.display = "none";

  const email = localStorage.getItem("user_email");
  if (!email) return alert("Devi essere loggato.");

  const { data, error } = await supabase
    .from("utenti")
    .select("consenso_promozioni")
    .eq("email", email)
    .single();

  if (error) return alert("Errore caricamento consensi");

  toggle.checked = data.consenso_promozioni === true;

  backdrop.style.display = "block";
  popup.style.display = "block";

  requestAnimationFrame(() => {
    backdrop.classList.add("show");
    popup.classList.add("show");
  });
});

  toggle.addEventListener("change", async () => {
    const email = localStorage.getItem("user_email");
    if (!email) return;

    await supabase
      .from("utenti")
      .update({ consenso_promozioni: toggle.checked })
      .eq("email", email);
  });

  function closeConsensi() {
    backdrop.classList.remove("show");
    popup.classList.remove("show");
  }

  closeBtn.addEventListener("click", closeConsensi);
  backdrop.addEventListener("click", closeConsensi);
});


// ===== POPUP NOTIFICHE =====
document.addEventListener("DOMContentLoaded", () => {
  const btn = document.getElementById("menu-notifiche");
  const popup = document.getElementById("notifiche-popup");
  const backdrop = document.getElementById("notifiche-backdrop");
  const closeBtn = document.getElementById("chiudi-notifiche");

  if (!btn || !popup || !backdrop || !closeBtn) return;

  // üü¢ APRI: solo carica e mostra (NON segna lette)
  async function apriNotifiche(){
    console.log("APRI NOTIFICHE");
    if (typeof window.closeMenu === "function") window.closeMenu();

    const email = localStorage.getItem("user_email");
    if (!email) return;

    await caricaNotificheUtente();

    // mostra popup
    popup.classList.remove("show");
    backdrop.classList.remove("show");
    requestAnimationFrame(() => {
      backdrop.classList.add("show");
      popup.classList.add("show");
    });
  }

  // üî¥ CHIUDI: segna lette + badge + pallini
  async function closeNotifiche(){
    console.log("CHIUDI NOTIFICHE");
    popup.classList.remove("show");
    backdrop.classList.remove("show");

    const email = localStorage.getItem("user_email");
    if (!email) return;

    await supabase
      .from("notifiche")
      .update({ letta: true })
      .eq("email", email)
      .eq("letta", false);

    await aggiornaBadgeNotifiche();

    document
      .querySelectorAll(".notification-item.unread")
      .forEach(el => el.classList.remove("unread"));
  }

  btn.addEventListener("click", apriNotifiche);
  closeBtn.addEventListener("click", closeNotifiche);
  backdrop.addEventListener("click", closeNotifiche);
});

// ===== DELETE NOTIFICA (SWIPE) =====
document.addEventListener("click", async e => {
  const btn = e.target.closest(".notif-delete");
  if (!btn) return;

  const wrapper = btn.closest(".notification-swipe");
  if (!wrapper) return;

  const id = wrapper.dataset.id;

  // elimina dal DB
  if (id){
    await supabase
      .from("notifiche")
      .delete()
      .eq("id", id);
  }

  // animazione uscita
  wrapper.style.transition = "height .25s ease, opacity .25s ease";
  wrapper.style.opacity = "0";
  wrapper.style.height = wrapper.offsetHeight + "px";

  requestAnimationFrame(() => {
    wrapper.style.height = "0";
    wrapper.style.margin = "0";
  });

  setTimeout(() => wrapper.remove(), 250);

  // aggiorna badge
  aggiornaBadgeNotifiche();
});

/* ===============================
   CONTEGGI
================================ */
async function aggiornaNumeroCoppe(email){
  const { data, error } = await supabase
    .from("coppe")
    .select("id")
    .eq("email", email)
    .or("eliminata.is.null,eliminata.eq.false");

  if (error){
    console.error("Errore conteggio coppe:", error);
    return;
  }

  const count = data ? data.length : 0;
  const badge = document.getElementById("coppe-count");
  if (badge) badge.textContent = count;
}



async function aggiornaNumeroCoupon(email){
  const { data, error } = await supabase
    .from("coupon")
    .select("id, redento")
    .eq("email", email)
    .eq("redento", false);

  if (error){
    console.error("Errore conteggio coupon:", error);
    return;
  }

  const count = data ? data.length : 0;
  const badge = document.getElementById("coupon-count");
  if (badge) badge.textContent = count;
}

/* ===============================
   COUPON
================================ */
async function caricaCoupon(email){
  const { data: coupons, error } = await supabase
    .from("coupon")
    .select("*")
    .eq("email", email)
    .order("created_at", { ascending: false });

  console.log("Coupon caricati:", coupons, error);
  renderCoupons(coupons || []);
}

async function creaNotificaSeNonEsiste(email, tipo, messaggio){
  const { data } = await supabase
    .from("notifiche")
    .select("id")
    .eq("email", email)
    .eq("tipo", tipo)
    .limit(1);

  if (data && data.length > 0) return;

  await supabase.from("notifiche").insert({
    email,
    tipo,
    messaggio,
    letta: false
  });
}

async function verificaECreaCoupon(email) {
  console.log("üö® verificaECreaCoupon", email);

  // 1Ô∏è‚É£ conferme gi√† consumate
  const { data: utente } = await supabase
    .from("utenti")
    .select("conferme_consumate")
    .eq("email", email)
    .single();

  const confermeUsate = utente?.conferme_consumate || 0;

  // 2Ô∏è‚É£ tutte le conferme reali
  const { data: conferme } = await supabase
    .from("conferme_coppe")
    .select("formato")
    .eq("email", email)
    .order("created_at", { ascending: true });

  if (!conferme || conferme.length < confermeUsate + 10) {
    console.log("‚õî Non abbastanza conferme");
    return;
  }

  // 3Ô∏è‚É£ estrai BLOCCO da 10
  const blocco = conferme
    .slice(confermeUsate, confermeUsate + 10)
    .map(c => c.formato.toLowerCase());

  console.log("üì¶ BLOCCO 10:", blocco);

  // 4Ô∏è‚É£ conta formati
  const count = { piccola: 0, media: 0, grande: 0 };
  blocco.forEach(f => count[f]++);

  let formatoVincente = null;
  let max = -1;

  for (const f in count) {
    if (count[f] > max) {
      max = count[f];
      formatoVincente = f;
    }
  }

  console.log("üèÜ FORMATO VINCENTE:", formatoVincente);

  // 5Ô∏è‚É£ crea coupon
  await supabase.from("coupon").insert({
    email,
    codice: "cp_" + crypto.randomUUID(),
    tipo: formatoVincente,
    titolo: `Coppa ${formatoVincente} omaggio`,
    redento: false
  });

  // 6Ô∏è‚É£ segna conferme come consumate
  await supabase
    .from("utenti")
    .update({ conferme_consumate: confermeUsate + 10 })
    .eq("email", email);

  // 7Ô∏è‚É£ notifica
  await supabase.from("notifiche").insert({
    email,
    tipo: "coupon_sbloccato",
    messaggio: `üéâ Hai sbloccato un coupon: Coppa ${formatoVincente.toUpperCase()} omaggio`,
    letta: false
  });

  console.log("üéâ COUPON CREATO");
}

function renderCoupons(coupons){
  const list = document.getElementById("coupon-list");
  list.innerHTML = "";

  if (!coupons || coupons.length === 0){
    list.innerHTML = `<div class="empty-msg">Nessun coupon disponibile</div>`;
    return;
  }

  coupons.forEach(c => {
    const scadenza = scadenzaDaCreazione(c.created_at);

    const div = document.createElement("div");
    div.id = `coupon-${c.codice}`;
    div.className = "coupon" + (c.redento ? " used" : "");

    div.innerHTML = `
      <div style="flex:1">
        <div class="coupon-title">${c.titolo}</div>
        <div class="coupon-desc">Coppa ${c.tipo} omaggio</div>
        <div class="coupon-expiry">Scade il ${scadenza.toLocaleDateString()}</div>
        ${
          c.redento && c.used_at
            ? `<div class="coupon-used-at" style="font-size:12px;color:#888;margin-top:6px">
                 Usato il ${new Date(c.used_at).toLocaleDateString()}
               </div>`
            : ``
        }
        <div id="qr-${c.codice}" class="coupon-qr"></div>
      </div>

      ${
        c.redento
          ? `<button disabled>Usato</button>`
          : `<button onclick="toggleQR('${c.codice}')">Mostra QR</button>`
      }
    `;

    list.appendChild(div);
  });
}

window.toggleQR = function(codice){
  const card = document.getElementById(`coupon-${codice}`);
  if (!card || card.classList.contains("used")) return;

  const box = document.getElementById(`qr-${codice}`);
  if (!box) return;

  const isOpen = box.style.display === "block";
  box.innerHTML = "";
  box.style.display = isOpen ? "none" : "block";

  if (isOpen) return;

  const qrDiv = document.createElement("div");
  box.appendChild(qrDiv);

  new QRCode(qrDiv, {
    text: `${location.origin}/admin-scan.html?coupon=${codice}`,
    width: 160,
    height: 160,
    correctLevel: QRCode.CorrectLevel.M
  });

  const note = document.createElement("div");
  note.style = "font-size:12px;color:#666;margin-top:6px";
  note.innerText = "Mostra questo QR in cassa (valido una sola volta)";
  box.appendChild(note);
};

function aggiornaCouponUI(coupon){
  const card = document.getElementById(`coupon-${coupon.codice}`);
  if (!card) return;

  card.classList.add("used");

  const btn = card.querySelector("button");
  if (btn){
    btn.innerText = "Usato";
    btn.disabled = true;
  }

  const qrBox = document.getElementById(`qr-${coupon.codice}`);
  if (qrBox){
    qrBox.innerHTML = "";
    qrBox.style.display = "none";
  }

  if (coupon.used_at){
    let usedBox = card.querySelector(".coupon-used-at");
    if (!usedBox){
      usedBox = document.createElement("div");
      usedBox.className = "coupon-used-at";
      usedBox.style = "font-size:12px;color:#888;margin-top:6px";
      card.querySelector(".coupon-expiry").after(usedBox);
    }
    usedBox.innerText = `Usato il ${new Date(coupon.used_at).toLocaleDateString()}`;
  }
}

/* ===============================
   REALTIME
================================ */

let couponChannel = null;

function subscribeCouponRealtime(email) {
  if (couponChannel) supabase.removeChannel(couponChannel);

  couponChannel = supabase
    .channel("coupon-realtime")
    .on(
      "postgres_changes",
      {
        event: "UPDATE",
        schema: "public",
        table: "coupon"
      },
      payload => {
        // sicurezza: solo coupon dell'utente
        if (payload?.new?.email !== email) return;

        console.log("üîÅ Coupon aggiornato realtime:", payload.new);

        // ‚úÖ QUI DEVONO STARE
        aggiornaCouponUI(payload.new);
        aggiornaNumeroCoupon(email);
      }
    )
    .subscribe();
}
/* ===============================
   PROFILO BOOT
================================ */
document.addEventListener("DOMContentLoaded", async () => {
  const email = localStorage.getItem("user_email");
  const logged = localStorage.getItem("userLogged") === "1";
const coppeCard = document.getElementById("coppe-card");
const loginHint = document.getElementById("login-hint");

if (!logged && coppeCard) {
  coppeCard.classList.add("disabled");

  coppeCard.addEventListener("click", (e) => {
    e.preventDefault();
    e.stopPropagation();
  });

  if (loginHint) loginHint.style.display = "block";
}
  const couponSection = document.getElementById("coupon-section");
  const emailChip = document.getElementById("email-chip");
  const noLogin = document.getElementById("no-login");
  const couponList = document.getElementById("coupon-list");
  const openCoupon = document.getElementById("open-coupon-list");

  // toggle lista coupon
  if (openCoupon && couponList){
    openCoupon.onclick = () => {
      couponList.style.display = (couponList.style.display === "block") ? "none" : "block";
    };
  }

  if (!logged || !email){
    noLogin.style.display = "block";
    couponSection.style.display = "none";
    return;
  }

  // mostra email soft
  emailChip.style.display = "block";
  emailChip.innerHTML = `<b>Account:</b> ${email}`;
  await aggiornaBadgeNotifiche();
  await aggiornaNumeroCoppe(email);
  await verificaECreaCoupon(email);
  await aggiornaNumeroCoupon(email);
  await caricaCoupon(email);

  // mostra sezione coupon sempre (anche se 0, ma con badge 0)
  couponSection.style.display = "block";

  subscribeCouponRealtime(email);
  subscribeCoppeRealtime(email);
});

/* ===============================
   AZIONI TOP
================================ */
window.gestisciLoginLogout = function(){
  const email = localStorage.getItem("user_email");
  if (!email){
    location.href = "login.html";
    return;
  }

  if (confirm(`Sei loggato come:\n${email}\n\nVuoi cambiare profilo?`)){
    localStorage.removeItem("user_email");
    localStorage.setItem("userLogged", "0");
    location.href = "login.html";
  }
};

window.disiscriviti = async function(){
  const email = localStorage.getItem("user_email");
  if (!email) return alert("Errore");

  const ok = confirm("Sei sicuro di voler disiscriverti?\n\nNon avrai pi√π accesso a coupon e storico.");
  if (!ok) return;

  await supabase
    .from("utenti")
    .update({ disiscritto: true })
    .eq("email", email);

  localStorage.removeItem("user_email");
  localStorage.setItem("userLogged", "0");
  location.href = "index.html";
};
</script>

<script type="module">
import { supabase } from "./supabase.js";

let waitInterval = null;
let collapseTimeout = null;

function expandWaitBar(){
  const full = document.getElementById("wait-full");
  const compact = document.getElementById("wait-compact");
  if (!full || !compact) return;

  full.style.display = "inline";
  compact.style.display = "none";

  clearTimeout(collapseTimeout);
  collapseTimeout = setTimeout(collapseWaitBar, 5000);
}

function collapseWaitBar(){
  const full = document.getElementById("wait-full");
  const compact = document.getElementById("wait-compact");
  if (!full || !compact) return;

  full.style.display = "none";
  compact.style.display = "inline";
}

async function loadWaitTime(){
  const { data, error } = await supabase
    .from("wait_time")
    .select("*")
    .eq("id", 1)
    .single();

  if (error || !data) return;

  const bar = document.getElementById("wait-bar");
  const txt = document.getElementById("wait-time");
  if (!bar || !txt) return;

  if (waitInterval){
    clearInterval(waitInterval);
    waitInterval = null;
  }

  if (!data.active || data.minutes <= 0){
    bar.style.display = "none";
    return;
  }

  const startTime = new Date(data.updated_at).getTime();
  const totalSeconds = data.minutes * 60;

  function tick(){
    const now = Date.now();
    const elapsed = Math.floor((now - startTime) / 1000);
    const remaining = totalSeconds - elapsed;

    if (remaining <= 0){
      bar.style.display = "none";
      clearInterval(waitInterval);
      waitInterval = null;
      return;
    }

    const min = Math.floor(remaining / 60);
    const sec = remaining % 60;
    const timeStr = `${min}:${sec.toString().padStart(2,"0")}`;

    txt.textContent = timeStr;
    const mmss = document.getElementById("wait-mmss");
    if (mmss) mmss.textContent = timeStr;

    bar.style.display = "flex";

    if (sec === 59) expandWaitBar();
  }

  tick();
  waitInterval = setInterval(tick, 1000);
}

supabase
  .channel("wait-time-live")
  .on("postgres_changes", { event:"*", schema:"public", table:"wait_time" }, () => loadWaitTime())
  .subscribe();

document.addEventListener("DOMContentLoaded", loadWaitTime);

// ===== Menu profilo (apri/chiudi) =====
const avatarBtn = document.getElementById("profile-avatar-btn");
const menu = document.getElementById("profile-menu");
const backdrop = document.getElementById("profile-menu-backdrop");
// ‚úÖ click fuori = chiudi menu
if (backdrop) {
  backdrop.addEventListener("click", () => {
    closeMenu();
  });
}
// ===== REGISTRATI =====
const btnRegister = document.getElementById("menu-register");

if (btnRegister) {
  btnRegister.addEventListener("click", () => {
    // chiudi menu
    closeMenu();

    // vai alla registrazione
    window.location.href = "login.html?mode=register";
  });
}

function openMenu(){
  if (!menu || !backdrop) return;
  menu.style.display = "block";
  backdrop.style.display = "block";
}

window.closeMenu = function closeMenu(){
  const menu = document.getElementById("profile-menu");
  const menuBackdrop = document.getElementById("profile-menu-backdrop");
  if (menu) menu.style.display = "none";
  if (menuBackdrop) menuBackdrop.style.display = "none";
}

if (avatarBtn){
  avatarBtn.addEventListener("click", (e) => {
    e.stopPropagation();
    const isOpen = menu && menu.style.display === "block";
    if (isOpen) closeMenu();
    else openMenu();
  });
}


// ===== Logout =====
document.addEventListener("DOMContentLoaded", () => {
  const logoutBtn = document.getElementById("menu-logout");

  if (!logoutBtn) {
    console.warn("‚ùå Bottone logout non trovato");
    return;
  }

  logoutBtn.addEventListener("click", () => {
    console.log("üö™ Logout cliccato");

    // chiudi menu se aperto
    if (typeof closeMenu === "function") {
      closeMenu();
    }

    // reset login
    localStorage.removeItem("user_email");
    localStorage.removeItem("user_name");
    localStorage.removeItem("user_surname");
    localStorage.setItem("userLogged", "0");

    alert("Sei uscito dal tuo profilo");
    window.location.href = "profilo.html";
  });
});

// chiudi con ESC (desktop)
window.addEventListener("keydown", (e) => {
  if (e.key === "Escape") closeMenu();
});

// evita chiusura immediata cliccando nel menu
if (menu){
  menu.addEventListener("click", (e) => e.stopPropagation());
}
// ===== Disiscriviti dal menu profilo =====
const unsubscribeBtn = document.getElementById("menu-unsubscribe");

if (unsubscribeBtn) {
  unsubscribeBtn.addEventListener("click", () => {
    closeMenu();       // chiude il menu glass
    disiscriviti();    // usa la funzione ESISTENTE
  });
}
</script>

<!-- ‚è±Ô∏è WAIT TIME BAR -->
<div id="wait-bar" style="
  position: fixed;
  bottom: 90px;
  left: 12px;
  transform: none;
  background: #111;
  color: white;
  padding: 10px 16px;
  border-radius: 14px;
  font-size: 15px;
  font-weight: 600;
  display: none;
  z-index: 9999;
  box-shadow: 0 6px 20px rgba(0,0,0,0.25);
">
  <span id="wait-full">
    Attesa stimata: <span id="wait-time">0</span>
  </span>
  <span id="wait-compact" style="display:none">
    <span id="wait-mmss">0:00</span>
  </span>
</div>

</body>
</html>