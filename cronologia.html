<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport"
      content="width=device-width, initial-scale=1, maximum-scale=1">
    <title>Cronologia Coppe</title>
    <link rel="stylesheet" href="bottom-nav.css">
    <script src="global.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>

    <style>
        body {
            font-family: system-ui, -apple-system, sans-serif;
            background: #f6f6f7;
            margin: 0;
        }

/* üîù BARRA FISSA + HOME centrato */
#top-fixed-bar {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 55px;
    display: flex;
    justify-content: center; /* CENTRA il contenuto */
    align-items: center;
    background: white;
    z-index: 9999;
    border-bottom: 1px solid #ddd;
}

/* Tasto Home */
.home-btn {
    display: flex;
    align-items: center;
    gap: 6px;
    color: #444;
    text-decoration: none;
    font-size: 16px;
    font-weight: 600;

    /* RIMOSSA la posizione assoluta */
}

.home-btn img {
    width: 28px;
    height: 28px;
}

/* Spazio sotto la barra */
#top-fixed-spacer {
    height: 65px;
}

        /* === CONTENUTO ORIGINALE === */
        h1 {
            text-align: center;
            margin: 10px 0;
        }

        .controls {
            max-width: 600px;
            margin: 0 auto 16px;
            padding: 0 20px;
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        #search {
            width: 100%;
            padding: 10px;
            border-radius: 12px;
            border: 1px solid #ccc;
            font-size: 16px;
        }

        #toggle-preferiti,
        #ordine-select {
            padding: 8px 12px;
            border-radius: 10px;
            border: none;
            font-size: 14px;
        }

        #toggle-preferiti { background: #ffd700; }
        #ordine-select { background: #fff; border: 1px solid #ccc; }

 .cup-card {
    background: white;
    padding: 16px;
    border-radius: 14px;
    margin-bottom: 12px;
    box-shadow: 0 2px 6px rgba(0,0,0,0.08);
    max-width: 600px;
    margin-left: auto;
    margin-right: auto;

    position: relative; /* ‚úÖ NECESSARIO */
}

        .cup-title { display: flex; justify-content: space-between; align-items: center; }
        .cup-title b { font-size: 18px; }
        


        .edit-btn, .delete-btn, .fav-btn {
            background: none;
            border: none;
            cursor: pointer;
            font-size: 20px;
        }

        .small { font-size: 14px; color: #555; margin-top: 6px; }

        .btn {
            display: block;
            width: 200px;
            text-align: center;
            padding: 10px 14px;
            margin: 20px auto;
            background: #ff7a00;
            color: white;
            border-radius: 12px;
            font-size: 17px;
            text-decoration: none;
        }

        .copy-btn, .use-btn {
            margin-top: 10px;
            padding: 8px 12px;
            background: #007aff;
            color: white;
            border-radius: 8px;
            border: none;
            cursor: pointer;
            font-size: 14px;
        }
        .use-btn { background: #34c759; margin-left: 8px; }

        mark {
            background: #ffeb3b;
            padding: 0 2px;
            border-radius: 3px;
        }
        .coppa-thumb-wrapper {
  display: flex;
  justify-content: flex-end;
  margin-top: 34px; 
}

.coppa-thumb {
  width: 80px; /* ‚¨ÖÔ∏è qui la grandezza */
  border-radius: 10px;
  box-shadow: 0 4px 10px rgba(0,0,0,0.15);
  cursor: pointer;
}
.coppa-thumb-wrapper {
    position: absolute;
    top: 56px;        /* ‚¨ÖÔ∏è regola qui l‚Äôaltezza */
    right: 16px;
}
    </style>
</head>

<body>


<!-- üîù BARRA FISSA -->
<div id="top-fixed-bar">
    <a href="index.html" class="home-btn">
        <img src="tastohome.png" alt="home">
        <span>Home</span>
    </a>
</div>

<div id="top-fixed-spacer"></div>

<!-- ‚≠ê TITOLO ORIGINALE (fuori dalla barra) -->
<h1>üìö Cronologia Coppe</h1>

<!-- üéÅ FEDELTA' / COUNTER COPPE CONFERMATE -->
<div id="fedelta-box" style="
  max-width:600px;
  margin: 10px auto 14px;
  padding: 14px 16px;
  background: white;
  border-radius: 14px;
  box-shadow: 0 2px 6px rgba(0,0,0,0.08);
">
  <div style="display:flex; justify-content:space-between; align-items:center;">
    <b>Coppe confermate</b>
    <span id="fedelta-count" style="font-weight:800;">0/10</span>
  </div>

  <div style="height:10px; background:#eee; border-radius:999px; overflow:hidden; margin-top:10px;">
    <div id="fedelta-bar" style="height:10px; width:0%; background:#34c759;"></div>
  </div>

  <div id="fedelta-msg" style="margin-top:10px; font-size:14px; color:#444;">
    Caricamento...
  </div>
  <button id="btn-vedi-coupon" style="
  display:none;
  margin-top:10px;
  width:100%;
  padding:10px 12px;
  border:none;
  border-radius:12px;
  background:#007aff;
  color:white;
  font-weight:700;
  cursor:pointer;
">
  üéÅ Vedi coupon
</button>
</div>

<!-- ‚≠ê CONTROLLI -->
<div class="controls">
    <input id="search" type="text" placeholder="Cerca per nome, data, gusto..." autocomplete="off">

    <button id="toggle-preferiti">‚≠ê Mostra solo preferiti</button>

    <select id="ordine-select">
        <option value="data_desc">Ordina: pi√π recenti prima</option>
        <option value="data_asc">Ordina: pi√π vecchie prima</option>
        <option value="nome_az">Ordina: nome A‚ÜíZ</option>
        <option value="nome_za">Ordina: nome Z‚ÜíA</option>
    </select>
</div>

<div id="lista-coppe"></div>

<a href="index.html" class="btn">‚¨Ö Torna alla Home</a>

<!-- ‚≠ê TUTTO IL TUO JS ORIGINALE (INTATTO) -->
<script>
    /* ----------- TUTTO IL TUO JAVASCRIPT ORIGINALE QUI ----------- */
    /* (lo ricopio completamente) */

    let coppe = JSON.parse(localStorage.getItem("cronologiaCoppe") || "[]");

function dedupCoppe(lista) {
    const map = new Map();

    for (let c of lista) {
        if (!c.data) continue;

        // Usa timestamp per avere uniformit√†
        const timestamp = new Date(c.data).getTime();

        // guest_id identifica UNIVOCAMENTE il dispositivo
        const guest = c.guest_id || "";

        const key = guest + "|" + timestamp;

        // Se stessa coppa ma una ha ID e l‚Äôaltra no ‚Üí tieni quella con ID
        if (map.has(key)) {
            const existing = map.get(key);

            if (!existing.id && c.id) {
                map.set(key, c); // preferisci versione Supabase
            }

        } else {
            map.set(key, c);
        }
    }

    return Array.from(map.values());
}

    // üî• Prezzi EXTRA (uguali alla webapp)
const prezziExtra = {
    "COCCO (3pz)": 0.50,
    "MIX KINDER": 2.50,
    "PANNA EXTRA": 1.80
};
    const lista = document.getElementById("lista-coppe");

    let mostraSoloPreferiti = false;
    let termineRicerca = "";
    let criterioOrdine = "data_desc";

    function salva() { localStorage.setItem("cronologiaCoppe", JSON.stringify(coppe)); }

    function mostraGustiCompatti(arr) {
        if (!arr || arr.length === 0) return "-";
        const grouped = {};
        arr.forEach(g => grouped[g] = (grouped[g] || 0) + 1);
        return Object.entries(grouped)
            .map(([nome, qty]) => qty === 1 ? nome : `${nome} x${qty}`)
            .join(", ");
    }

    function testoRicercaPerCoppa(c) {
        return [
            c.nome || "",
            c.data || "",
            c.formato || "",
            ...(c.gusti || []),
            ...(c.granelle || []),
            ...(c.topping || []),
            ...(c.ingredienti || []),
            ...(c.extra || [])
        ].join(" ").toLowerCase();
    }

    function copiaTesto(testo) {
        if (navigator.clipboard) {
            navigator.clipboard.writeText(testo)
                .then(() => alert("Copiato negli appunti!"))
                .catch(() => fallbackCopy(testo));
        } else {
            fallbackCopy(testo);
        }
    }

    function fallbackCopy(testo) {
        const win = window.open("", "_blank");
        win.document.write("<pre>" + testo + "</pre>");
        win.document.close();
        alert("Copia manualmente il testo üëç");
    }

    function evidenzia(testo) {
        const q = termineRicerca.trim();
        if (!q) return testo;
        const regex = new RegExp("(" + q.replace(/[.*+?^${}()|[\]\\]/g, "\\$&") + ")", "gi");
        return String(testo).replace(regex, "<mark>$1</mark>");
    }

async function eliminaCoppa(idx) {
    const c = coppe[idx];
    if (!c) return;

    if (!confirm("Vuoi eliminare questa coppa?")) return;

    // üî• Se la coppa √® su Supabase ‚Üí soft delete
    if (c.id && window.supabase) {
        try {
            await window.supabase
                .from("coppe")
                .update({
                    eliminata: true,
                    data_eliminazione: new Date().toISOString()
                })
                .eq("id", c.id);
        } catch (err) {
            console.error("Errore durante eliminazione su Supabase:", err);
        }
    }

    // üî• Soft delete ANCHE in locale (IMPORTANTE!)
    coppe[idx].eliminata = true;
    coppe[idx].data_eliminazione = new Date().toISOString();

    // üî• NON usare pi√π splice!
    // coppe.splice(idx, 1);  ‚õî ELIMINA DAVVERO ‚Äî non vogliamo questo

    salva();
    renderLista();
}

async function rinominaCoppa(idx) {
    const c = coppe[idx];
    if (!c) return;

    const nuovoNome = prompt("Nuovo nome per questa coppa:", c.nome || "");
    if (!nuovoNome || !nuovoNome.trim()) return;

    const nomePulito = nuovoNome.trim();

    // 1Ô∏è‚É£ Aggiorna subito in memoria (lista corrente)
    c.nome = nomePulito;
    salva();
    renderLista();

    // 2Ô∏è‚É£ Aggiorna anche nella cronologia salvata in localStorage
    let cronologia = JSON.parse(localStorage.getItem("cronologiaCoppe") || "[]");

    cronologia = cronologia.map(item => {
        // caso ideale: abbiamo l'id sia in item che in c
        if (item.id && c.id && item.id === c.id) {
            item.nome = nomePulito;
            return item;
        }

        // fallback vecchie coppe senza id:
        // uso data + formato + email/guest_id per riconoscerla
        if (!item.id && !c.id &&
            item.data === c.data &&
            item.formato === c.formato &&
            (item.email || null) === (c.email || null) &&
            (item.guest_id || null) === (c.guest_id || null)
        ) {
            item.nome = nomePulito;
        }

        return item;
    });

    localStorage.setItem("cronologiaCoppe", JSON.stringify(cronologia));

// 3Ô∏è‚É£ Aggiorna anche su Supabase (cos√¨ admin vede il nome nuovo)
if (window.supabase) {
    try {
        let error = null;

        if (c.id) {
            // Caso coppe nuove ‚Üí identificazione certa tramite ID
            ({ error } = await supabase
                .from("coppe")
                .update({ nome: nomePulito })
                .eq("id", c.id));
        } else {
            // Coppe vecchie senza id ‚Üí identifico tramite guest_id + data
            ({ error } = await supabase
                .from("coppe")
                .update({ nome: nomePulito })
                .eq("guest_id", c.guest_id || null)
                .eq("data", c.data));
        }

        if (error) {
            console.error("Errore Supabase rename:", error);
            alert("‚ö†Ô∏è Nome aggiornato solo localmente. Errore Supabase.");
        }
    } catch (err) {
        console.error(err);
        alert("‚ö†Ô∏è Errore di rete durante la rinomina (Supabase).");
    }
}

    alert("Nome coppa aggiornato!");
}

    function togglePreferito(idx) {
        coppe[idx].preferito = !coppe[idx].preferito;
        salva();
        renderLista();
    }

    function usaQuestaCoppa(idx) {
        const c = coppe[idx];
        if (!c) return alert("Errore");
        localStorage.setItem("coppaDaUsare", JSON.stringify(c));
        window.location.href = "crea-coppa.html?from=cronologia";
    }

    function getCoppeFiltrateEOrdinate() {
        let arr = coppe.slice();
        if (mostraSoloPreferiti) arr = arr.filter(c => c.preferito);
        if (termineRicerca.trim() !== "") {
            const q = termineRicerca.toLowerCase();
            arr = arr.filter(c => testoRicercaPerCoppa(c).includes(q));
        }

        arr.sort((a, b) => {
            const dataA = a.data || "";
            const dataB = b.data || "";
            const nomeA = (a.nome || "").toLowerCase();
            const nomeB = (b.nome || "").toLowerCase();

            if (criterioOrdine === "data_desc") return dataA < dataB ? 1 : -1;
            if (criterioOrdine === "data_asc") return dataA > dataB ? 1 : -1;
            if (criterioOrdine === "nome_az") return nomeA > nomeB ? 1 : -1;
            if (criterioOrdine === "nome_za") return nomeA < nomeB ? 1 : -1;
            return 0;
        });

        return arr;
    }

    // üî• FORMATO BELLO DATE
function formattaDataBella(iso) {
    if (!iso) return "-";
    const d = new Date(iso);
    return d.toLocaleString("it-IT", {
        day: "2-digit",
        month: "short",
        year: "numeric",
        hour: "2-digit",
        minute: "2-digit"
    }).replace(".", "");
}

function aggiornaFedelta() {
  // conta SOLO coppe dell‚Äôutente gi√† filtrate (coppe array) e NON eliminate
  const confermateTot = coppe
  .filter(c => c && !c.eliminata)
  .reduce((tot, c) => tot + (c.confermate || 0), 0);

  // quante volte ho completato 10
  const couponSbloccati = Math.floor(confermateTot / 10);

  // progress attuale (0..9)
  const progress = confermateTot % 10;

  const countEl = document.getElementById("fedelta-count");
  const barEl   = document.getElementById("fedelta-bar");
  const msgEl   = document.getElementById("fedelta-msg");
  const btnEl   = document.getElementById("btn-vedi-coupon");

  if (!countEl || !barEl || !msgEl) return;

  // ‚úÖ REGOLA: quando arrivo a 10 ‚Üí reset visivo a 0/10
  // ma messaggio "coupon sbloccato" resta FINCH√â non arriva un'altra conferma:
  // Questo succede naturalmente perch√©:
  // - a 10,20,30... => progress=0 e confermateTot>0 => sbloccato
  // - a 11 => progress=1 => torna normale
  const justUnlocked = (confermateTot >= 10 && progress === 0);

  // aggiorno contatore e barra
  countEl.textContent = `${progress}/10`;
  barEl.style.width = ((progress / 10) * 100) + "%";

  if (justUnlocked) {
    msgEl.innerHTML = `üéâ <b>Coupon sbloccato!</b><br>Rivolgiti alla cassa üíö`;
  } else {
    msgEl.textContent = couponSbloccati > 0
      ? `Hai gi√† sbloccato ${couponSbloccati} coupon üéÅ Continua per il prossimo!`
      : `Continua a creare coppe per sbloccare il coupon üéÅ`;
  }

  // bottone: lo mostro se ho almeno 1 coupon sbloccato
  if (btnEl) {
    btnEl.style.display = couponSbloccati > 0 ? "block" : "none";
    btnEl.onclick = () => {
      window.location.href = "profilo.html#coupon";
    };
  }
}

function apriCoppaFullscreen(src) {
  const overlay = document.getElementById("coppa-overlay");
  const img = document.getElementById("coppa-overlay-img");

  if (!overlay || !img) return;

  img.src = src;
  overlay.style.display = "flex";
}

function chiudiCoppaFullscreen() {
  const overlay = document.getElementById("coppa-overlay");
  const img = document.getElementById("coppa-overlay-img");

  if (!overlay || !img) return;

  overlay.style.display = "none";
  img.src = "";
}

document.addEventListener("DOMContentLoaded", () => {
  const overlay = document.getElementById("coppa-overlay");
  const closeBtn = document.getElementById("coppa-overlay-close");

  if (closeBtn) {
    closeBtn.addEventListener("click", (e) => {
      e.stopPropagation(); // üî• FONDAMENTALE
      chiudiCoppaFullscreen();
    });
  }

  if (overlay) {
    overlay.addEventListener("click", (e) => {
      if (e.target === overlay) {
        chiudiCoppaFullscreen();
      }
    });
  }
});

function renderLista() {
    const arr = getCoppeFiltrateEOrdinate()
                  .filter(c => !c.eliminata);   // ‚úÖ NASCONDE LE ELIMINATE

                      aggiornaFedelta(); // üî• aggiorna box fedelt√† in alto


    lista.innerHTML = "";

    if (arr.length === 0) {
        lista.innerHTML = `<p class="empty-msg">Nessuna coppa trovata üò¢</p>`;
        return;
    }

    arr.forEach(c => {
        const idx = coppe.indexOf(c);
        const nome = c.nome || `Coppa #${idx + 1}`;
        const stellina = c.preferito ? "‚≠ê" : "‚òÜ";

        const gustiText = mostraGustiCompatti(c.gusti || []);
        const granelleText = (c.granelle || []).join(", ");
        const toppingText = (c.topping || []).join(", ");
        const ingredientiText = (c.ingredienti || []).join(", ");

        // üî• EXTRA con prezzo corretto
        function formatExtra(lista) {
            if (!lista || lista.length === 0) return "-";

            return lista.map(nome => {
                const prezzo = prezziExtra[nome] || 0;
                const prezzoTxt = prezzo > 0 ? ` (+‚Ç¨${prezzo.toFixed(2)})` : "";
                return `${nome}${prezzoTxt}`;
            }).join(", ");
        }

const extraText = formatExtra(c.extra);

            const testoDaCopiare = [
                `Formato: ${c.formato || "-"}`,
                `Gusti: ${gustiText}`,
                `Granelle: ${granelleText || "-"}`,
                `Topping: ${toppingText || "-"}`,
                `Ingredienti: ${ingredientiText || "-"}`
            ].join("\n");

            const div = document.createElement("div");
            div.className = "cup-card";
div.innerHTML = `
<div class="cup-title">
    <b>${evidenzia(nome)}</b>
    <div>
${c.confermate && c.confermate > 0 ? `
    <span style="
        background:#34c759;
        color:white;
        padding:3px 8px;
        border-radius:8px;
        font-size:12px;
        font-weight:600;
        margin-right:6px;
    ">
        ‚úî Confermata${c.confermate > 1 ? ` x${c.confermate}` : ``}
    </span>
` : ``}
        <button class="fav-btn">${stellina}</button>
        <button class="edit-btn">‚úèÔ∏è</button>
        <button class="delete-btn">üóë</button>
    </div>
</div>
${c.coppa_img ? `
  <div class="coppa-thumb-wrapper">
    <img 
  src="${c.coppa_img}" 
  class="coppa-thumb"
  onclick="apriCoppaFullscreen('${c.coppa_img}')"
>
  </div>
` : ``}
    <div class="small">${formattaDataBella(c.data)}</div>
    <div class="small"><b>Formato:</b> ${evidenzia(c.formato || "")}</div>
    <div class="small"><b>Gusti:</b> ${evidenzia(gustiText)}</div>
    <div class="small"><b>Granelle:</b> ${evidenzia(granelleText)}</div>
    <div class="small"><b>Topping:</b> ${evidenzia(toppingText)}</div>
    <div class="small"><b>Ingredienti:</b> ${evidenzia(ingredientiText)}</div>
    <div class="small"><b>Extra:</b> ${evidenzia(extraText || "-")}</div>

    <div class="small" style="text-align:right; font-weight:bold;">
        Prezzo: ‚Ç¨${(c.prezzo || 0).toFixed(2)}
    </div>

    <button class="show-qr-btn">üì± Mostra QR</button>

    <div class="qr-box" id="qr-${idx}" style="
        display:none;
        margin-top:12px;
        text-align:center;
    "></div>

    <div class="buttons-row">
        <button class="copy-btn">üìã Copia</button>
        <button class="use-btn">‚ö° Usa questa coppa</button>
    </div>
`;

            div.querySelector(".fav-btn").onclick = () => togglePreferito(idx);
            div.querySelector(".edit-btn").onclick = () => rinominaCoppa(idx);
            div.querySelector(".delete-btn").onclick = () => eliminaCoppa(idx);
            div.querySelector(".copy-btn").onclick = () => copiaTesto(testoDaCopiare);
            div.querySelector(".use-btn").onclick = () => usaQuestaCoppa(idx);
            div.querySelector(".show-qr-btn").onclick = () => {
    const box = document.getElementById(`qr-${idx}`);

    // toggle
    box.style.display = box.style.display === "none" ? "block" : "none";

    // se QR gi√† generato ‚Üí non rigenerare
    if (box.dataset.generated === "1") return;

    if (window.QRCode && c.qr_token) {
        new QRCode(box, {
            text: c.qr_token,
            width: 160,
            height: 160
        });
        box.dataset.generated = "1";
    } else {
        box.innerHTML = "<p style='color:red;'>QR non disponibile</p>";
    }
};

            lista.appendChild(div);
            // === QR CODE nella cronologia ===
const btn = div.querySelector(".toggle-qr");
const box = div.querySelector(".qr-wrapper");
const qrDiv = div.querySelector(`.qr-code`);

if (btn) {
    btn.onclick = () => {
        const visible = box.style.display === "block";

        if (visible) {
            box.style.display = "none";
            btn.textContent = "Mostra QR";
        } else {
            box.style.display = "block";
            btn.textContent = "Nascondi QR";

            // genera QR SOLO quando aperto
            if (window.QRCode && qrDiv && !qrDiv.dataset.generated) {
                new QRCode(qrDiv, {
                    text: c.qr_token,
                    width: 140,
                    height: 140
                });
                qrDiv.dataset.generated = "1";
            }
        }
    };
}
        });
    }

    document.getElementById("search").addEventListener("input", e => {
        termineRicerca = e.target.value;
        renderLista();
    });

    document.getElementById("toggle-preferiti").addEventListener("click", () => {
        mostraSoloPreferiti = !mostraSoloPreferiti;
        document.getElementById("toggle-preferiti").textContent =
            mostraSoloPreferiti ? "‚≠ê Mostra tutti" : "‚≠ê Mostra solo preferiti";
        renderLista();
    });

    document.getElementById("ordine-select").addEventListener("change", e => {
        criterioOrdine = e.target.value;
        renderLista();
    });

    renderLista();
</script>
<script type="module">
import { supabase } from "./supabase.js";

/* ------------------------------------------
   üî• 1) LEGGE COPPE UTENTE da SUPABASE
---------------------------------------------*/
async function getCoppeSupabaseUtente(email) {
    const guest_id = localStorage.getItem("guest_id");

    let query = supabase
        .from("coppe")
        .select("*")
        .order("id", { ascending: false });

    // (per ora manteniamo la tua or, poi la sistemiamo nel punto 2)
if (email) {
    // üî• Mostra SOLO coppe dell‚Äôemail loggata
    query = query.eq("email", email);
} else {
    // Nessuna email loggata ‚Üí nessuna coppa
    return [];
}

    // üî• filtro: mostra solo coppe NON eliminate
    query = query.or("eliminata.is.null,eliminata.eq.false");

    const { data, error } = await query;

    if (error) {
        console.error("Errore caricamento coppe da Supabase:", error);
        return [];
    }

    return data || [];
}

/* ------------------------------------------
   üî• 2) UNISCE le coppe locali con quelle Supabase
---------------------------------------------*/
async function caricaCoppeComplete() {
    const email = localStorage.getItem("user_email") || null;

    let coppeLocali = JSON.parse(localStorage.getItem("cronologiaCoppe") || "[]");

// üî• FILTRA ANCHE LE COPPE LOCALI per email
coppeLocali = coppeLocali.filter(c => c.email === email);
    let coppeSupabase = [];

    if (email) {
        coppeSupabase = await getCoppeSupabaseUtente(email);
    }

    // FUSIONE locale + remoto
    let unite = [...coppeSupabase, ...coppeLocali];

    // DEDUPLICA CORRETTA
    let finali = dedupCoppe(unite);

    return finali;
}

/* ------------------------------------------
   üî• 3) SOVRASCRIVE l'array ‚Äúcoppe‚Äù DEL TUO JS
---------------------------------------------*/
caricaCoppeComplete().then(all => {
    coppe = all;
    renderLista();
    aggiornaFedelta(); // üî• QUI, SUBITO DOPO renderLista
});

// üî¥ REALTIME: aggiorna cronologia e fedelt√† senza refresh
const emailUtente = localStorage.getItem("user_email");

if (emailUtente) {
    supabase
        .channel("coppe-realtime-cronologia")
        .on(
            "postgres_changes",
            {
                event: "*",
                schema: "public",
                table: "coppe",
                filter: `email=eq.${emailUtente}`
            },
            payload => {
                console.log("üîÑ Coppa aggiornata in realtime:", payload);

                // ricarica dati utente
                caricaCoppeComplete().then(all => {
                    coppe = all;
                    renderLista();
                    aggiornaFedelta();
                });
            }
        )
        .subscribe();
}

function vaiAiCoupon() {
    window.location.href = "profilo.html#coupon";
}

</script>

<!-- ‚≠ê BOTTOM NAV BAR -->
<div id="bottom-nav">
    <a href="crea-coppa.html" class="nav-item">
        <img src="icone/crea.png" alt="">
        <span>Crea Coppa</span>
    </a>

    <a href="profilo.html" class="nav-item">
        <img src="icone/user.png" alt="">
        <span>Profilo</span>
    </a>

    <a href="menu.html" class="nav-item">
        <img src="icone/menu.png" alt="">
        <span>Menu</span>
    </a>

    <a href="lavora-con-noi.html" class="nav-item">
        <img src="icone/job.png" alt="">
        <span>Lavora Con Noi</span>
    </a>
</div>

<script>
document.addEventListener("DOMContentLoaded", () => {
    if (typeof aggiornaCarrelloUI === "function") {
        aggiornaCarrelloUI(); // üî• AGGIORNA ORA il carrello nella pagina cronologia
    }
});
</script>
<script type="module">
import { supabase } from "./supabase.js";

let waitInterval = null;
let collapseTimeout = null;

function expandWaitBar() {
  const full = document.getElementById("wait-full");
  const compact = document.getElementById("wait-compact");

  if (!full || !compact) return;

  full.style.display = "inline";
  compact.style.display = "none";

  clearTimeout(collapseTimeout);
  collapseTimeout = setTimeout(collapseWaitBar, 5000);
}

function collapseWaitBar() {
  const full = document.getElementById("wait-full");
  const compact = document.getElementById("wait-compact");

  if (!full || !compact) return;

  full.style.display = "none";
  compact.style.display = "inline";
}

async function loadWaitTime() {
  const { data, error } = await supabase
    .from("wait_time")
    .select("*")
    .eq("id", 1)
    .single();

  if (error || !data) return;

  const bar = document.getElementById("wait-bar");
  const txt = document.getElementById("wait-time");

  if (!bar || !txt) return;

  // stop eventuale timer precedente
  if (waitInterval) {
    clearInterval(waitInterval);
    waitInterval = null;
  }

  if (!data.active || data.minutes <= 0) {
    bar.style.display = "none";
    return;
  }

  const startTime = new Date(data.updated_at).getTime();
  const totalSeconds = data.minutes * 60;

function tick() {
  const now = Date.now();
  const elapsed = Math.floor((now - startTime) / 1000);
  const remaining = totalSeconds - elapsed;

  if (remaining <= 0) {
    bar.style.display = "none";
    clearInterval(waitInterval);
    waitInterval = null;
    return;
  }

  const min = Math.floor(remaining / 60);
  const sec = remaining % 60;
  const timeStr = `${min}:${sec.toString().padStart(2, "0")}`;

  // üî¢ aggiorna entrambi i testi
  txt.textContent = timeStr;
  document.getElementById("wait-mmss").textContent = timeStr;

  bar.style.display = "flex";

// ‚è±Ô∏è quando inizia un nuovo minuto ‚Üí riapre la barra
if (sec === 59) {
  expandWaitBar();
}
}
  tick(); // ‚è±Ô∏è avvio immediato
  waitInterval = setInterval(tick, 1000);
}

// üî¥ REALTIME WAIT TIME
supabase
  .channel("wait-time-live")
  .on(
    "postgres_changes",
    {
      event: "*",
      schema: "public",
      table: "wait_time"
    },
    payload => {
      console.log("üîÅ wait_time aggiornato realtime:", payload);
      loadWaitTime();
    }
  )
  .subscribe();

document.addEventListener("DOMContentLoaded", loadWaitTime);
</script>

<!-- ‚è±Ô∏è WAIT TIME BAR -->
<div id="wait-bar" style="
  position: fixed;
  bottom: 90px;
  left: 12px;
  transform: none;
  background: #111;
  color: white;
  padding: 10px 16px;
  border-radius: 14px;
  font-size: 15px;
  font-weight: 600;
  display: none;
  z-index: 9999;
  box-shadow: 0 6px 20px rgba(0,0,0,0.25);
">
  <span id="wait-full">
  Attesa stimata: <span id="wait-time">0</span>
</span>
<span id="wait-compact" style="display:none">
  <span id="wait-mmss">0:00</span>
</span>
</div>

<div id="coppa-overlay" style="
  position: fixed;
  inset: 0;
  background: rgba(0,0,0,0.85);
  display: none;
  align-items: center;
  justify-content: center;
  z-index: 99999;
">
  <img id="coppa-overlay-img" style="
    max-width: 90%;
    max-height: 90%;
    border-radius: 14px;
    box-shadow: 0 10px 40px rgba(0,0,0,0.5);
  ">

  <button id="coppa-overlay-close" style="
    position: absolute;
    top: 20px;
    right: 20px;
    background: rgba(255,255,255,0.15);
    color: white;
    border: none;
    font-size: 22px;
    padding: 8px 14px;
    border-radius: 999px;
    cursor: pointer;
  ">
    ‚úï
  </button>
</div>


</body>
</html>
