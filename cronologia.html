<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cronologia Coppe</title>

    <style>
        body {
            font-family: system-ui, -apple-system, sans-serif;
            background: #f6f6f7;
            margin: 0;
        }

/* üîù BARRA FISSA + HOME centrato */
#top-fixed-bar {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 55px;
    display: flex;
    justify-content: center; /* CENTRA il contenuto */
    align-items: center;
    background: white;
    z-index: 9999;
    border-bottom: 1px solid #ddd;
}

/* Tasto Home */
.home-btn {
    display: flex;
    align-items: center;
    gap: 6px;
    color: #444;
    text-decoration: none;
    font-size: 16px;
    font-weight: 600;

    /* RIMOSSA la posizione assoluta */
}

.home-btn img {
    width: 28px;
    height: 28px;
}

/* Spazio sotto la barra */
#top-fixed-spacer {
    height: 65px;
}

        /* === CONTENUTO ORIGINALE === */
        h1 {
            text-align: center;
            margin: 10px 0;
        }

        .controls {
            max-width: 600px;
            margin: 0 auto 16px;
            padding: 0 20px;
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        #search {
            width: 100%;
            padding: 10px;
            border-radius: 12px;
            border: 1px solid #ccc;
            font-size: 16px;
        }

        #toggle-preferiti,
        #ordine-select {
            padding: 8px 12px;
            border-radius: 10px;
            border: none;
            font-size: 14px;
        }

        #toggle-preferiti { background: #ffd700; }
        #ordine-select { background: #fff; border: 1px solid #ccc; }

        .cup-card {
            background: white;
            padding: 16px;
            border-radius: 14px;
            margin-bottom: 12px;
            box-shadow: 0 2px 6px rgba(0,0,0,0.08);
            max-width: 600px;
            margin-left: auto;
            margin-right: auto;
        }

        .cup-title { display: flex; justify-content: space-between; align-items: center; }
        .cup-title b { font-size: 18px; }

        .edit-btn, .delete-btn, .fav-btn {
            background: none;
            border: none;
            cursor: pointer;
            font-size: 20px;
        }

        .small { font-size: 14px; color: #555; margin-top: 6px; }

        .btn {
            display: block;
            width: 200px;
            text-align: center;
            padding: 10px 14px;
            margin: 20px auto;
            background: #ff7a00;
            color: white;
            border-radius: 12px;
            font-size: 17px;
            text-decoration: none;
        }

        .copy-btn, .use-btn {
            margin-top: 10px;
            padding: 8px 12px;
            background: #007aff;
            color: white;
            border-radius: 8px;
            border: none;
            cursor: pointer;
            font-size: 14px;
        }
        .use-btn { background: #34c759; margin-left: 8px; }

        mark {
            background: #ffeb3b;
            padding: 0 2px;
            border-radius: 3px;
        }
    </style>
</head>

<body>

<!-- üîù BARRA FISSA -->
<div id="top-fixed-bar">
    <a href="index.html" class="home-btn">
        <img src="tastohome.png" alt="home">
        <span>Home</span>
    </a>
</div>

<div id="top-fixed-spacer"></div>

<!-- ‚≠ê TITOLO ORIGINALE (fuori dalla barra) -->
<h1>üìö Cronologia Coppe</h1>

<!-- ‚≠ê CONTROLLI -->
<div class="controls">
    <input id="search" type="text" placeholder="Cerca per nome, data, gusto..." autocomplete="off">

    <button id="toggle-preferiti">‚≠ê Mostra solo preferiti</button>

    <select id="ordine-select">
        <option value="data_desc">Ordina: pi√π recenti prima</option>
        <option value="data_asc">Ordina: pi√π vecchie prima</option>
        <option value="nome_az">Ordina: nome A‚ÜíZ</option>
        <option value="nome_za">Ordina: nome Z‚ÜíA</option>
    </select>
</div>

<div id="lista-coppe"></div>

<a href="index.html" class="btn">‚¨Ö Torna alla Home</a>

<!-- ‚≠ê TUTTO IL TUO JS ORIGINALE (INTATTO) -->
<script>
    /* ----------- TUTTO IL TUO JAVASCRIPT ORIGINALE QUI ----------- */
    /* (lo ricopio completamente) */

    let coppe = JSON.parse(localStorage.getItem("cronologiaCoppe") || "[]");
    const lista = document.getElementById("lista-coppe");

    let mostraSoloPreferiti = false;
    let termineRicerca = "";
    let criterioOrdine = "data_desc";

    function salva() { localStorage.setItem("cronologiaCoppe", JSON.stringify(coppe)); }

    function mostraGustiCompatti(arr) {
        if (!arr || arr.length === 0) return "-";
        const grouped = {};
        arr.forEach(g => grouped[g] = (grouped[g] || 0) + 1);
        return Object.entries(grouped)
            .map(([nome, qty]) => qty === 1 ? nome : `${nome} x${qty}`)
            .join(", ");
    }

    function testoRicercaPerCoppa(c) {
        return [
            c.nome || "",
            c.data || "",
            c.formato || "",
            ...(c.gusti || []),
            ...(c.granelle || []),
            ...(c.topping || []),
            ...(c.ingredienti || []),
            ...(c.extra || [])
        ].join(" ").toLowerCase();
    }

    function copiaTesto(testo) {
        if (navigator.clipboard) {
            navigator.clipboard.writeText(testo)
                .then(() => alert("Copiato negli appunti!"))
                .catch(() => fallbackCopy(testo));
        } else {
            fallbackCopy(testo);
        }
    }

    function fallbackCopy(testo) {
        const win = window.open("", "_blank");
        win.document.write("<pre>" + testo + "</pre>");
        win.document.close();
        alert("Copia manualmente il testo üëç");
    }

    function evidenzia(testo) {
        const q = termineRicerca.trim();
        if (!q) return testo;
        const regex = new RegExp("(" + q.replace(/[.*+?^${}()|[\]\\]/g, "\\$&") + ")", "gi");
        return String(testo).replace(regex, "<mark>$1</mark>");
    }

    function eliminaCoppa(idx) {
        if (!confirm("Vuoi eliminare questa coppa?")) return;
        coppe.splice(idx, 1);
        salva();
        renderLista();
    }

    function rinominaCoppa(idx) {
        const nomeAttuale = coppe[idx].nome || `Coppa ${idx + 1}`;
        const nuovoNome = prompt("Nuovo nome:", nomeAttuale);
        if (!nuovoNome) return;
        coppe[idx].nome = nuovoNome;
        salva();
        renderLista();
    }

    function togglePreferito(idx) {
        coppe[idx].preferito = !coppe[idx].preferito;
        salva();
        renderLista();
    }

    function usaQuestaCoppa(idx) {
        const c = coppe[idx];
        if (!c) return alert("Errore");
        localStorage.setItem("coppaDaUsare", JSON.stringify(c));
        window.location.href = "crea-coppa.html?from=cronologia";
    }

    function getCoppeFiltrateEOrdinate() {
        let arr = coppe.slice();
        if (mostraSoloPreferiti) arr = arr.filter(c => c.preferito);
        if (termineRicerca.trim() !== "") {
            const q = termineRicerca.toLowerCase();
            arr = arr.filter(c => testoRicercaPerCoppa(c).includes(q));
        }

        arr.sort((a, b) => {
            const dataA = a.data || "";
            const dataB = b.data || "";
            const nomeA = (a.nome || "").toLowerCase();
            const nomeB = (b.nome || "").toLowerCase();

            if (criterioOrdine === "data_desc") return dataA < dataB ? 1 : -1;
            if (criterioOrdine === "data_asc") return dataA > dataB ? 1 : -1;
            if (criterioOrdine === "nome_az") return nomeA > nomeB ? 1 : -1;
            if (criterioOrdine === "nome_za") return nomeA < nomeB ? 1 : -1;
            return 0;
        });

        return arr;
    }

    function renderLista() {
        const arr = getCoppeFiltrateEOrdinate();
        lista.innerHTML = "";

        if (arr.length === 0) {
            lista.innerHTML = `<p class="empty-msg">Nessuna coppa trovata üò¢</p>`;
            return;
        }

        arr.forEach(c => {
            const idx = coppe.indexOf(c);
            const nome = c.nome || `Coppa #${idx + 1}`;
            const stellina = c.preferito ? "‚≠ê" : "‚òÜ";

            const gustiText = mostraGustiCompatti(c.gusti || []);
            const granelleText = (c.granelle || []).join(", ");
            const toppingText = (c.topping || []).join(", ");
            const ingredientiText = (c.ingredienti || []).join(", ");

            const testoDaCopiare = [
                `Formato: ${c.formato || "-"}`,
                `Gusti: ${gustiText}`,
                `Granelle: ${granelleText || "-"}`,
                `Topping: ${toppingText || "-"}`,
                `Ingredienti: ${ingredientiText || "-"}`
            ].join("\n");

            const div = document.createElement("div");
            div.className = "cup-card";
            div.innerHTML = `
                <div class="cup-title">
                    <b>${evidenzia(nome)}</b>
                    <div>
                        <button class="fav-btn">${stellina}</button>
                        <button class="edit-btn">‚úèÔ∏è</button>
                        <button class="delete-btn">üóë</button>
                    </div>
                </div>

                <div class="small">${evidenzia(c.data || "")}</div>
                <div class="small"><b>Formato:</b> ${evidenzia(c.formato || "")}</div>
                <div class="small"><b>Gusti:</b> ${evidenzia(gustiText)}</div>
                <div class="small"><b>Granelle:</b> ${evidenzia(granelleText)}</div>
                <div class="small"><b>Topping:</b> ${evidenzia(toppingText)}</div>
                <div class="small"><b>Ingredienti:</b> ${evidenzia(ingredientiText)}</div>

                <div class="small" style="text-align:right; font-weight:bold;">
                    Prezzo: ‚Ç¨${(c.prezzo || 0).toFixed(2)}
                </div>

                <div class="buttons-row">
                    <button class="copy-btn">üìã Copia</button>
                    <button class="use-btn">‚ö° Usa questa coppa</button>
                </div>
            `;

            div.querySelector(".fav-btn").onclick = () => togglePreferito(idx);
            div.querySelector(".edit-btn").onclick = () => rinominaCoppa(idx);
            div.querySelector(".delete-btn").onclick = () => eliminaCoppa(idx);
            div.querySelector(".copy-btn").onclick = () => copiaTesto(testoDaCopiare);
            div.querySelector(".use-btn").onclick = () => usaQuestaCoppa(idx);

            lista.appendChild(div);
        });
    }

    document.getElementById("search").addEventListener("input", e => {
        termineRicerca = e.target.value;
        renderLista();
    });

    document.getElementById("toggle-preferiti").addEventListener("click", () => {
        mostraSoloPreferiti = !mostraSoloPreferiti;
        document.getElementById("toggle-preferiti").textContent =
            mostraSoloPreferiti ? "‚≠ê Mostra tutti" : "‚≠ê Mostra solo preferiti";
        renderLista();
    });

    document.getElementById("ordine-select").addEventListener("change", e => {
        criterioOrdine = e.target.value;
        renderLista();
    });

    renderLista();
</script>

</body>
</html>