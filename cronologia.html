<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cronologia Coppe</title>

    <style>
        body {
            font-family: system-ui, -apple-system, sans-serif;
            background: #f6f6f7;
            margin: 0;
        }

/* üîù BARRA FISSA + HOME centrato */
#top-fixed-bar {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 55px;
    display: flex;
    justify-content: center; /* CENTRA il contenuto */
    align-items: center;
    background: white;
    z-index: 9999;
    border-bottom: 1px solid #ddd;
}

/* Tasto Home */
.home-btn {
    display: flex;
    align-items: center;
    gap: 6px;
    color: #444;
    text-decoration: none;
    font-size: 16px;
    font-weight: 600;

    /* RIMOSSA la posizione assoluta */
}

.home-btn img {
    width: 28px;
    height: 28px;
}

/* Spazio sotto la barra */
#top-fixed-spacer {
    height: 65px;
}

        /* === CONTENUTO ORIGINALE === */
        h1 {
            text-align: center;
            margin: 10px 0;
        }

        .controls {
            max-width: 600px;
            margin: 0 auto 16px;
            padding: 0 20px;
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        #search {
            width: 100%;
            padding: 10px;
            border-radius: 12px;
            border: 1px solid #ccc;
            font-size: 16px;
        }

        #toggle-preferiti,
        #ordine-select {
            padding: 8px 12px;
            border-radius: 10px;
            border: none;
            font-size: 14px;
        }

        #toggle-preferiti { background: #ffd700; }
        #ordine-select { background: #fff; border: 1px solid #ccc; }

        .cup-card {
            background: white;
            padding: 16px;
            border-radius: 14px;
            margin-bottom: 12px;
            box-shadow: 0 2px 6px rgba(0,0,0,0.08);
            max-width: 600px;
            margin-left: auto;
            margin-right: auto;
        }

        .cup-title { display: flex; justify-content: space-between; align-items: center; }
        .cup-title b { font-size: 18px; }

        .edit-btn, .delete-btn, .fav-btn {
            background: none;
            border: none;
            cursor: pointer;
            font-size: 20px;
        }

        .small { font-size: 14px; color: #555; margin-top: 6px; }

        .btn {
            display: block;
            width: 200px;
            text-align: center;
            padding: 10px 14px;
            margin: 20px auto;
            background: #ff7a00;
            color: white;
            border-radius: 12px;
            font-size: 17px;
            text-decoration: none;
        }

        .copy-btn, .use-btn {
            margin-top: 10px;
            padding: 8px 12px;
            background: #007aff;
            color: white;
            border-radius: 8px;
            border: none;
            cursor: pointer;
            font-size: 14px;
        }
        .use-btn { background: #34c759; margin-left: 8px; }

        mark {
            background: #ffeb3b;
            padding: 0 2px;
            border-radius: 3px;
        }
    </style>
</head>

<body>


<!-- üîù BARRA FISSA -->
<div id="top-fixed-bar">
    <a href="index.html" class="home-btn">
        <img src="tastohome.png" alt="home">
        <span>Home</span>
    </a>
</div>

<div id="top-fixed-spacer"></div>

<!-- ‚≠ê TITOLO ORIGINALE (fuori dalla barra) -->
<h1>üìö Cronologia Coppe</h1>

<!-- ‚≠ê CONTROLLI -->
<div class="controls">
    <input id="search" type="text" placeholder="Cerca per nome, data, gusto..." autocomplete="off">

    <button id="toggle-preferiti">‚≠ê Mostra solo preferiti</button>

    <select id="ordine-select">
        <option value="data_desc">Ordina: pi√π recenti prima</option>
        <option value="data_asc">Ordina: pi√π vecchie prima</option>
        <option value="nome_az">Ordina: nome A‚ÜíZ</option>
        <option value="nome_za">Ordina: nome Z‚ÜíA</option>
    </select>
</div>

<div id="lista-coppe"></div>

<a href="index.html" class="btn">‚¨Ö Torna alla Home</a>

<!-- ‚≠ê TUTTO IL TUO JS ORIGINALE (INTATTO) -->
<script>
    /* ----------- TUTTO IL TUO JAVASCRIPT ORIGINALE QUI ----------- */
    /* (lo ricopio completamente) */

    let coppe = JSON.parse(localStorage.getItem("cronologiaCoppe") || "[]");
    // üî• Prezzi EXTRA (uguali alla webapp)
const prezziExtra = {
    "COCCO (3pz)": 0.50,
    "MIX KINDER": 2.50,
    "PANNA EXTRA": 1.80
};
    const lista = document.getElementById("lista-coppe");

    let mostraSoloPreferiti = false;
    let termineRicerca = "";
    let criterioOrdine = "data_desc";

    function salva() { localStorage.setItem("cronologiaCoppe", JSON.stringify(coppe)); }

    function mostraGustiCompatti(arr) {
        if (!arr || arr.length === 0) return "-";
        const grouped = {};
        arr.forEach(g => grouped[g] = (grouped[g] || 0) + 1);
        return Object.entries(grouped)
            .map(([nome, qty]) => qty === 1 ? nome : `${nome} x${qty}`)
            .join(", ");
    }

    function testoRicercaPerCoppa(c) {
        return [
            c.nome || "",
            c.data || "",
            c.formato || "",
            ...(c.gusti || []),
            ...(c.granelle || []),
            ...(c.topping || []),
            ...(c.ingredienti || []),
            ...(c.extra || [])
        ].join(" ").toLowerCase();
    }

    function copiaTesto(testo) {
        if (navigator.clipboard) {
            navigator.clipboard.writeText(testo)
                .then(() => alert("Copiato negli appunti!"))
                .catch(() => fallbackCopy(testo));
        } else {
            fallbackCopy(testo);
        }
    }

    function fallbackCopy(testo) {
        const win = window.open("", "_blank");
        win.document.write("<pre>" + testo + "</pre>");
        win.document.close();
        alert("Copia manualmente il testo üëç");
    }

    function evidenzia(testo) {
        const q = termineRicerca.trim();
        if (!q) return testo;
        const regex = new RegExp("(" + q.replace(/[.*+?^${}()|[\]\\]/g, "\\$&") + ")", "gi");
        return String(testo).replace(regex, "<mark>$1</mark>");
    }

async function eliminaCoppa(idx) {
    const c = coppe[idx];
    if (!c) return;

    if (!confirm("Vuoi eliminare questa coppa?")) return;

    // üî• Se la coppa √® su Supabase ‚Üí soft delete
    if (c.id && window.supabase) {
        try {
            await window.supabase
                .from("coppe")
                .update({
                    eliminata: true,
                    data_eliminazione: new Date().toISOString()
                })
                .eq("id", c.id);
        } catch (err) {
            console.error("Errore durante eliminazione su Supabase:", err);
        }
    }

    // üî• Soft delete ANCHE in locale (IMPORTANTE!)
    coppe[idx].eliminata = true;
    coppe[idx].data_eliminazione = new Date().toISOString();

    // üî• NON usare pi√π splice!
    // coppe.splice(idx, 1);  ‚õî ELIMINA DAVVERO ‚Äî non vogliamo questo

    salva();
    renderLista();
}

async function rinominaCoppa(idx) {
    const c = coppe[idx];
    if (!c) return;

    const nuovoNome = prompt("Nuovo nome per questa coppa:", c.nome || "");
    if (!nuovoNome || !nuovoNome.trim()) return;

    const nomePulito = nuovoNome.trim();

    // --- 1. Aggiorna localmente ---
    c.nome = nomePulito;
    salva();
    renderLista();

    // --- 2. Aggiorna cronologia locale usando l'ID (non la data!) ---
    let cronologia = JSON.parse(localStorage.getItem("cronologiaCoppe") || "[]");

    cronologia = cronologia.map(x => {
        if (x.id && c.id && x.id === c.id) {
            x.nome = nomePulito;
        }
        return x;
    });

    localStorage.setItem("cronologiaCoppe", JSON.stringify(cronologia));

    // --- 3. Aggiorna Supabase ---
    if (c.id && window.supabase) {
        try {
            const { error } = await supabase
                .from("coppe")
                .update({ nome: nomePulito })
                .eq("id", c.id);

            if (error) {
                console.error("Errore Supabase rename:", error);
                alert("‚ö†Ô∏è Errore Supabase ‚Äî nome salvato solo in locale.");
            }
        } catch (err) {
            console.error("Errore rete:", err);
            alert("‚ö†Ô∏è Errore di rete durante la rinomina.");
        }
    }

    // üî• 4. Aggiorna admin se √® aperto
if (window.COPPE) {
    for (let i = 0; i < window.COPPE.length; i++) {
        if (window.COPPE[i].id === c.id) {
            window.COPPE[i].nome = nomePulito;
        }
    }

    if (window.render) {
        window.render(); // aggiorna admin live
    }
}

    alert("Nome coppa aggiornato!");
}

    function togglePreferito(idx) {
        coppe[idx].preferito = !coppe[idx].preferito;
        salva();
        renderLista();
    }

    function usaQuestaCoppa(idx) {
        const c = coppe[idx];
        if (!c) return alert("Errore");
        localStorage.setItem("coppaDaUsare", JSON.stringify(c));
        window.location.href = "crea-coppa.html?from=cronologia";
    }

    function getCoppeFiltrateEOrdinate() {
        let arr = coppe.slice();
        if (mostraSoloPreferiti) arr = arr.filter(c => c.preferito);
        if (termineRicerca.trim() !== "") {
            const q = termineRicerca.toLowerCase();
            arr = arr.filter(c => testoRicercaPerCoppa(c).includes(q));
        }

        arr.sort((a, b) => {
            const dataA = a.data || "";
            const dataB = b.data || "";
            const nomeA = (a.nome || "").toLowerCase();
            const nomeB = (b.nome || "").toLowerCase();

            if (criterioOrdine === "data_desc") return dataA < dataB ? 1 : -1;
            if (criterioOrdine === "data_asc") return dataA > dataB ? 1 : -1;
            if (criterioOrdine === "nome_az") return nomeA > nomeB ? 1 : -1;
            if (criterioOrdine === "nome_za") return nomeA < nomeB ? 1 : -1;
            return 0;
        });

        return arr;
    }

function renderLista() {
    const arr = getCoppeFiltrateEOrdinate()
                  .filter(c => !c.eliminata);   // ‚úÖ NASCONDE LE ELIMINATE

    lista.innerHTML = "";

    if (arr.length === 0) {
        lista.innerHTML = `<p class="empty-msg">Nessuna coppa trovata üò¢</p>`;
        return;
    }

    arr.forEach(c => {
        const idx = coppe.indexOf(c);
        const nome = c.nome || `Coppa #${idx + 1}`;
        const stellina = c.preferito ? "‚≠ê" : "‚òÜ";

        const gustiText = mostraGustiCompatti(c.gusti || []);
        const granelleText = (c.granelle || []).join(", ");
        const toppingText = (c.topping || []).join(", ");
        const ingredientiText = (c.ingredienti || []).join(", ");

        // üî• EXTRA con prezzo corretto
        function formatExtra(lista) {
            if (!lista || lista.length === 0) return "-";

            return lista.map(nome => {
                const prezzo = prezziExtra[nome] || 0;
                const prezzoTxt = prezzo > 0 ? ` (+‚Ç¨${prezzo.toFixed(2)})` : "";
                return `${nome}${prezzoTxt}`;
            }).join(", ");
        }

const extraText = formatExtra(c.extra);

            const testoDaCopiare = [
                `Formato: ${c.formato || "-"}`,
                `Gusti: ${gustiText}`,
                `Granelle: ${granelleText || "-"}`,
                `Topping: ${toppingText || "-"}`,
                `Ingredienti: ${ingredientiText || "-"}`
            ].join("\n");

            const div = document.createElement("div");
            div.className = "cup-card";
            div.innerHTML = `
                <div class="cup-title">
                    <b>${evidenzia(nome)}</b>
                    <div>
                        <button class="fav-btn">${stellina}</button>
                        <button class="edit-btn">‚úèÔ∏è</button>
                        <button class="delete-btn">üóë</button>
                    </div>
                </div>

                <div class="small">${evidenzia(c.data || "")}</div>
                <div class="small"><b>Formato:</b> ${evidenzia(c.formato || "")}</div>
                <div class="small"><b>Gusti:</b> ${evidenzia(gustiText)}</div>
                <div class="small"><b>Granelle:</b> ${evidenzia(granelleText)}</div>
                <div class="small"><b>Topping:</b> ${evidenzia(toppingText)}</div>
                <div class="small"><b>Ingredienti:</b> ${evidenzia(ingredientiText)}</div>
                <div class="small"><b>Extra:</b> ${evidenzia(extraText || "-")}</div>

                <div class="small" style="text-align:right; font-weight:bold;">
                    Prezzo: ‚Ç¨${(c.prezzo || 0).toFixed(2)}
                </div>

                <div class="buttons-row">
                    <button class="copy-btn">üìã Copia</button>
                    <button class="use-btn">‚ö° Usa questa coppa</button>
                </div>
            `;

            div.querySelector(".fav-btn").onclick = () => togglePreferito(idx);
            div.querySelector(".edit-btn").onclick = () => rinominaCoppa(idx);
            div.querySelector(".delete-btn").onclick = () => eliminaCoppa(idx);
            div.querySelector(".copy-btn").onclick = () => copiaTesto(testoDaCopiare);
            div.querySelector(".use-btn").onclick = () => usaQuestaCoppa(idx);

            lista.appendChild(div);
        });
    }

    document.getElementById("search").addEventListener("input", e => {
        termineRicerca = e.target.value;
        renderLista();
    });

    document.getElementById("toggle-preferiti").addEventListener("click", () => {
        mostraSoloPreferiti = !mostraSoloPreferiti;
        document.getElementById("toggle-preferiti").textContent =
            mostraSoloPreferiti ? "‚≠ê Mostra tutti" : "‚≠ê Mostra solo preferiti";
        renderLista();
    });

    document.getElementById("ordine-select").addEventListener("change", e => {
        criterioOrdine = e.target.value;
        renderLista();
    });

    renderLista();
</script>
<script type="module">
import { supabase } from "./supabase.js";

/* ------------------------------------------
   üî• 1) LEGGE COPPE UTENTE da SUPABASE
---------------------------------------------*/
async function getCoppeSupabaseUtente(email) {
    const guest_id = localStorage.getItem("guest_id");

    let query = supabase
        .from("coppe")
        .select("*")
        .order("id", { ascending: false });

    // (per ora manteniamo la tua or, poi la sistemiamo nel punto 2)
    if (email && guest_id) {
        query = query.or(`email.eq.${email},guest_id.eq.${guest_id}`);
    } else if (email) {
        query = query.eq("email", email);
    } else if (guest_id) {
        query = query.eq("guest_id", guest_id);
    }

    // üî• filtro: mostra solo coppe NON eliminate
    query = query.or("eliminata.is.null,eliminata.eq.false");

    const { data, error } = await query;

    if (error) {
        console.error("Errore caricamento coppe da Supabase:", error);
        return [];
    }

    return data || [];
}

/* ------------------------------------------
   üî• 2) UNISCE le coppe locali con quelle Supabase
---------------------------------------------*/
async function caricaCoppeComplete() {
    const email = localStorage.getItem("user_email") || null;

    let coppeLocali = JSON.parse(localStorage.getItem("cronologiaCoppe") || "[]");
    let coppeSupabase = [];

    if (email) {
        coppeSupabase = await getCoppeSupabaseUtente(email);
    }

    // üî• UNISCE localStorage + Supabase
    // Ma evita duplicati (stessa data e formato)
    const tutto = [...coppeSupabase, ...coppeLocali];

    // Rimuovi duplicati
    const unique = [];
    const seen = new Set();

    for (let c of tutto) {
        const key = (c.data || "") + (c.formato || "");
        if (!seen.has(key)) {
            seen.add(key);
            unique.push(c);
        }
    }

    return unique;
}

/* ------------------------------------------
   üî• 3) SOVRASCRIVE l'array ‚Äúcoppe‚Äù DEL TUO JS
---------------------------------------------*/
caricaCoppeComplete().then(all => {
    coppe = all;   // üî• sovrascrive l‚Äôarray locale del tuo script originale
    renderLista(); // üî• riusa la tua funzione originale senza toccarla
});

</script>
</body>
</html>
