<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport"
      content="width=device-width, initial-scale=1, maximum-scale=1">
    <title>Coppe Create</title>
    <link rel="stylesheet" href="bottom-nav.css">
<script type="module" src="global.js"></script>
    <script type="module">
import { startGlobalNotificheListener } from "./global.js";

document.addEventListener("DOMContentLoaded", () => {
  startGlobalNotificheListener();
});
</script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
    <style>
        body {
            font-family: system-ui, -apple-system, sans-serif;
            background: #f6f6f7;
            margin: 0;
        }

/* üîù BARRA FISSA + HOME centrato */
#top-fixed-bar {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 55px;
    display: flex;
    justify-content: center; /* CENTRA il contenuto */
    align-items: center;
    background: white;
    z-index: 9999;
    border-bottom: 1px solid #ddd;
}

/* Tasto Home */
.home-btn {
    display: flex;
    align-items: center;
    gap: 6px;
    color: #444;
    text-decoration: none;
    font-size: 16px;
    font-weight: 600;

    /* RIMOSSA la posizione assoluta */
}

.home-btn img {
    width: 28px;
    height: 28px;
}

/* Spazio sotto la barra */
#top-fixed-spacer {
    height: 65px;
}

        /* === CONTENUTO ORIGINALE === */
        h1 {
            text-align: center;
            margin: 10px 0;
        }

/* =========================
   CONTENITORE CONTROLLI
========================= */
.controls{
  max-width: 520px;        /* üî• stessa logica delle card */
  margin: 0 auto 16px;     /* üî• centro perfetto pagina */
  padding: 0 16px;

  display: flex;
  align-items: center;
  justify-content: center; /* üî• CENTRO REALE */
  gap: 8px;
}
/* =========================
   RIGA SUPERIORE
   (Preferiti + Ordine)
========================= */
.controls-top {
  display: flex;
  justify-content: center;
  gap: 10px;
}
/* =========================
   BOTTONE PREFERITI
========================= */
#toggle-preferiti {
  height: 34px;                 /* uguale al select */
  padding: 6px 14px;            /* stesso respiro */

  font-size: 13px;
  font-weight: 600;

  border-radius: 10px;          /* ‚¨ÖÔ∏è stessi bordi smussati */
  border: 1px solid #d1d1d6;

  background: #f2f2f7;
  color: #333;

  cursor: pointer;
}

/* stato attivo */
#toggle-preferiti.attivo {
  background: #ffd60a;
  border-color: #e6c200;
}

/* stato attivo */
#toggle-preferiti.attivo {
  background: #ffd60a;
  border-color: #e6c200;
}

/* =========================
   SELECT ORDINE
========================= */
#ordine-select {
  -webkit-appearance: none;
  appearance: none;

  height: 32px;                /* ‚¨ÖÔ∏è da 34px */
  padding: 5px 30px 5px 10px;  /* ‚¨ÖÔ∏è leggermente pi√π stretto */

  font-size: 12.5px;           /* ‚¨ÖÔ∏è micro riduzione */
  font-weight: 500;

  border-radius: 10px;
  border: 1px solid #d1d1d6;
  background-color: #fff;
  color: #333;

  cursor: pointer;
}
#ordine-select {
  background-image: url("data:image/svg+xml;utf8,\
<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24'>\
<path d='M7 10l5 5 5-5' fill='none' stroke='%23666' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'/>\
</svg>");
  background-repeat: no-repeat;
  background-position: right 10px center; /* ‚¨ÖÔ∏è posizione freccia */
  background-size: 14px;
}


.cup-card {
    background: white;
    padding: 16px;
    border-radius: 14px;
    margin-bottom: 28px;
box-shadow: 0 14px 34px rgba(0,0,0,0.14);
    max-width: 600px;
    margin-left: auto;
    margin-right: auto;

    position: relative;
    overflow: hidden;

    min-height: 140px; /* üî• RISERVA SPAZIO IMMAGINE */
}

.cup-title{
  position: relative;
  display: block;          /* ‚¨ÖÔ∏è NON flex */
  padding-right: 90px;     /* ‚¨ÖÔ∏è spazio per icone a destra */
}

.cup-title b{
  font-size: 18px;
  display: block;
}
        


        .edit-btn, .delete-btn, .fav-btn {
            background: none;
            border: none;
            cursor: pointer;
            font-size: 20px;
        }

        .small { font-size: 14px; color: #555; margin-top: 6px; }

        .btn {
            display: block;
            width: 200px;
            text-align: center;
            padding: 10px 14px;
            margin: 20px auto;
            background: #ff7a00;
            color: white;
            border-radius: 12px;
            font-size: 17px;
            text-decoration: none;
        }

        .copy-btn, .use-btn {
            margin-top: 10px;
            padding: 8px 12px;
            background: #007aff;
            color: white;
            border-radius: 8px;
            border: none;
            cursor: pointer;
            font-size: 14px;
        }
        .use-btn { background: #34c759; margin-left: 8px; }

        mark {
            background: #ffeb3b;
            padding: 0 2px;
            border-radius: 3px;
        }
        .coppa-thumb-wrapper {
  display: flex;
  justify-content: flex-end;
  margin-top: 34px; 
}

.coppa-thumb {
  width: 80px;
  border-radius: 10px;
  box-shadow: 0 4px 10px rgba(0,0,0,0.15);
  cursor: pointer;
}
.coppa-thumb-wrapper {
    position: absolute;
    top: 30px;
    right: 16px;
    pointer-events: auto;
    /* üîí ISOLAMENTO: solo cronologia */
#lista-coppe .coppa-thumb-wrapper {
    contain: layout paint;
}
}
/* ===== CONTROLLI COMPATTI ===== */
.controls {
  flex-direction: row;
  gap: 8px;
}
/* === POPUP OVERLAY === */
.popup-overlay{
  position: fixed;
  inset: 0;
  background: rgba(0,0,0,0.45);
  backdrop-filter: blur(6px);
  display: flex;
  align-items: center;
  justify-content: center;
  z-index: 99999;
}

/* === CARD === */
.popup-card{
  width: 280px;
  background: white;
  border-radius: 18px;
  padding: 18px;
  text-align: center;
  box-shadow: 0 20px 40px rgba(0,0,0,0.25);
  animation: popupIn 0.2s ease-out;
}

.popup-card h3{
  margin: 0 0 6px;
  font-size: 18px;
}

.popup-card p{
  margin: 0 0 14px;
  font-size: 14px;
  color: #555;
}

/* === BOTTONI === */
.popup-btn{
  width: 100%;
  padding: 12px;
  margin-top: 8px;
  border-radius: 12px;
  border: none;
  font-size: 15px;
  font-weight: 600;
  cursor: pointer;
}

.popup-btn.danger{
  background: #ff3b30;
  color: white;
}

.popup-btn.star{
  background: #ffd60a;
  color: #000;
}

.popup-btn.cancel{
  background: #f2f2f7;
  color: #333;
}

/* animazione */
@keyframes popupIn{
  from { transform: scale(0.9); opacity: 0; }
  to   { transform: scale(1);   opacity: 1; }
}
/* ===============================
   CRONOLOGIA COPPE ‚Äì TESTI COMPATTI (FINALE)
=============================== */

/* Titolo coppa (leggermente ridotto, ma leggibile) */
.cup-card .cup-title b{
  font-size: 15px;
}

/* Testi di dettaglio: gusti, topping, ingredienti, extra */
.cup-card .small,
.cup-card p{
  font-size: 12px;
  line-height: 1.35;
  color: #555;
  margin: 4px 0;
}

/* Bottoni nella card (compatti ma cliccabili) */
.cup-card .copy-btn,
.cup-card .use-btn{
  font-size: 13px;
  padding: 6px 10px;
}
/* ===============================
   CRONOLOGIA COPPE ‚Äì SPAZIO PER MINIATURA
=============================== */

/* Riserva spazio a destra per l'immagine */
.cup-card{
  padding-right: 95px; /* ‚¨ÖÔ∏è spazio dedicato alla coppa */
}
.cup-content{
  padding-right: 20px;   /* üî• spazio orizzontale per immagine */
  min-height: 180px;      /* üî• spazio verticale riservato */
}
/* ===============================
   CRONOLOGIA ‚Äì CESTINO ICONA
=============================== */
.delete-btn{
  background: none;        /* ‚ùå niente cerchio */
  border: none;
  padding: 6px;

  display: flex;
  align-items: center;
  justify-content: center;

  cursor: pointer;
}

/* SVG */
.delete-btn svg{
  width: 26px;             /* dimensione cestino */
  height: 26px;

  fill: none;
  stroke: #000;            /* nero */
  stroke-width: 1.6;       /* ‚¨ÖÔ∏è bordo esterno PI√ô FINE */
  stroke-linecap: round;
  stroke-linejoin: round;
}

/* hover leggero */
.delete-btn:hover svg{
  transform: scale(1.08);
}

/* tap */
.delete-btn:active svg{
  transform: scale(0.95);
}
.cup-actions{
  display: flex;
  align-items: center;   /* üî• allineamento perfetto */
  gap: 10px;

}
/* ===============================
   AZIONI CARD (stella, penna, cestino)
=============================== */

.cup-card{
  position: relative; /* üî• fondamentale */
}

.cup-actions{
  position: absolute;
  top: 12px;
  right: 12px;

  display: flex;
  align-items: center;
  gap: 10px;
}
/* contenitore titolo */
.cup-title{
  position: relative;
  padding-right: 90px;   /* spazio per icone a destra */
}

/* nome coppa */
.cup-title b{
  font-size: 18px;
  display: block;
}

/* azioni in alto a destra */
.cup-actions{
  position: absolute;
  top: -6px;

  right: 16px;          /* üî• riferimento al bordo card */
  transform: translateX(95px); /* üî• supera il padding */

  display: flex;
  align-items: center;
  gap: 10px;
}

/* ===============================
   CRONOLOGIA ‚Äì ICONA MODIFICA
=============================== */
.edit-btn{
  background: none;
  border: none;
  padding: 6px;

  display: flex;
  align-items: center;
  justify-content: center;

  cursor: pointer;
}

/* SVG icona */
.edit-btn svg{
  width: 26px;          /* ‚¨ÖÔ∏è leggermente pi√π leggibile */
  height: 26px;

  fill: none;
  stroke: #000;
  stroke-width: 1.6;    /* ‚¨ÖÔ∏è allineato a cestino */
  stroke-linecap: round;
  stroke-linejoin: round;

  transition: transform 0.15s ease, opacity 0.15s ease;
}

/* hover (desktop) */
.edit-btn:hover svg{
  transform: scale(1.06);
  opacity: 0.85;
}

/* tap (mobile) */
.edit-btn:active svg{
  transform: scale(0.94);
  opacity: 0.7;
}
/* ===============================
   CRONOLOGIA ‚Äì ICONA STELLA
=============================== */
.fav-btn{
  font-size: 26px;        /* ‚¨ÖÔ∏è aumenta la stella */
  line-height: 1;
  padding: 4px;           /* stesso respiro delle altre */
  display: flex;
  align-items: center;
  justify-content: center;
}

/* ===============================
   CRONOLOGIA ‚Äì STELLA SVG
=============================== */
.fav-btn{
  background: none;
  border: none;
  padding: 6px;
  cursor: pointer;

  display: flex;
  align-items: center;
  justify-content: center;
}

.fav-btn svg{
  width: 26px;
  height: 26px;

  fill: none;                 /* ‚≠ê vuota */
  stroke: #000;
  stroke-width: 1.6;
  stroke-linejoin: round;

  transition: fill 0.2s ease, stroke 0.2s ease, transform 0.15s ease;
}

/* ‚≠ê STATO ATTIVO */
.fav-btn.attiva svg{
  fill: #ffd60a;              /* giallo Apple */
  stroke: #e6b800;
}

/* feedback */
.fav-btn:active svg{
  transform: scale(0.92);
}
.cup-name.editing{
  outline: none;
  border-bottom: 2px solid #007aff;
  background: rgba(0,122,255,0.08);
}
.rename-wrapper{
  position: relative;
  display: inline-flex;
  align-items: center;
  max-width: 220px;   /* ‚¨ÖÔ∏è limita larghezza */
}

.rename-input{
  height: 28px;
  padding: 2px 26px 2px 6px;

  font-size: 15px;
  font-weight: 600;

  line-height: 24px;   /* ‚úÖ invece di 1 */
  box-sizing: border-box;

  border-radius: 6px;
  border: 1px solid #ccc;

  outline: none;       /* ‚úÖ stop bordo Safari */
}

.rename-save{
  position: absolute;
  right: 6px;
  top: 50%;
  transform: translateY(-50%);

  border: none;
  background: none;
  cursor: pointer;

  font-size: 14px;   /* ‚¨ÖÔ∏è pi√π piccola */
  line-height: 1;
  color: #34c759;
}
/* titolo coppa: pu√≤ andare a capo */
.cup-title b.cup-name{
  display: block;
  max-width: calc(100% - 100px);
  white-space: normal;
  word-break: break-word;
  overflow-wrap: anywhere;
  line-height: 1.2;
}

/* RINOMINA */
.rename-wrapper{
  max-width: calc(100% - 100px);
}

.rename-input{
  width: 100%;
  box-sizing: border-box;
  white-space: normal;
}

/* ===============================
   RINOMINA TITOLO COPPA
=============================== */

.rename-wrapper{
  display: flex;
  align-items: center;
  gap: 6px;

  max-width: calc(100% - 20px); /* spazio icone a destra */
}

.rename-input{
  flex: 1;
  min-width: 0;

  padding: 6px 34px 6px 8px; /* üî• spazio a DESTRA per ‚úîÔ∏è */

  font-size: 15px;
  border-radius: 8px;
  border: 1px solid #ccc;

  box-sizing: border-box; /* üî• fondamentale */
}

/* spunta */
.rename-save{
  flex-shrink: 0;
  width: 26px;
  height: 26px;

  display: flex;
  align-items: center;
  justify-content: center;

  border: none;
  background: none;
  font-size: 16px;
  cursor: pointer;
}
.price{
  text-align: right;
  font-weight: 700;
  font-size: 13px;

  margin-right: -80px;   /* ‚¨ÖÔ∏è spinge il prezzo pi√π a destra */
}
/* ===============================
   QR + CONFERMATA INLINE
=============================== */
.qr-row{
  display: flex;
  align-items: center;
  gap: 10px;
  margin-top: 10px;
}

.badge-confermata{
  background: #34c759;
  color: #fff;
  padding: 4px 10px;
  border-radius: 999px;
  font-size: 12px;
  font-weight: 600;
  white-space: nowrap;
}
/* ===============================
   OVERLAY ‚Äì PULSANTE INSTAGRAM
=============================== */
.overlay-instagram-btn{
  position: absolute;
  bottom: 24px;
  right: 24px;

  height: 32px;          /* ‚¨ÖÔ∏è da 22px ‚Üí 32px */
  padding: 0 14px;       /* ‚¨ÖÔ∏è pi√π respiro */

  font-size: 14px;       /* ‚¨ÖÔ∏è da 10px ‚Üí 14px */
  font-weight: 600;
  line-height: 1;

  border-radius: 12px;   /* ‚¨ÖÔ∏è pi√π Apple-style */
  border: none;

  background: #D6B28A;
  color: #fff;

  display: inline-flex;
  align-items: center;
  gap: 6px;              /* ‚¨ÖÔ∏è icona + testo pi√π separati */

  cursor: pointer;
  z-index: 100000;

  box-shadow: 0 4px 12px rgba(0,0,0,0.25); /* ‚¨ÖÔ∏è pi√π presenza */
  transition: transform 0.15s ease, box-shadow 0.15s ease;
}

/* hover / tap */
.overlay-instagram-btn:hover{
  transform: scale(1.05);
}

.overlay-instagram-btn:active{
  transform: scale(0.95);
}

/* ===============================
   iOS STYLE ‚Äì COPIA
=============================== */
.copy-btn{
  display: inline-flex;
  align-items: center;
  gap: 6px;

  height: 26px;
  padding: 0 10px;

  font-size: 13px;
  font-weight: 500;

  color: #444;
  background: rgba(0,0,0,0.06);

  border: none;
  border-radius: 999px;

  cursor: pointer;
  -webkit-tap-highlight-color: transparent;

  transition: background 0.15s ease, transform 0.1s ease;
}

/* icona */
.copy-btn svg{
  width: 14px;
  height: 14px;

  fill: none;
  stroke: #555;
  stroke-width: 1.6;
}

/* hover / tap */
.copy-btn:hover{
  background: rgba(0,0,0,0.09);
}

.copy-btn:active{
  transform: scale(0.96);
  background: rgba(0,0,0,0.12);
}
.use-btn{
  position: absolute;
  right: 14px;
  bottom: 14px;

  padding: 9px 14px;
  font-size: 13px;
  font-weight: 600;

  border-radius: 12px;
  border: none;

  background: #007aff;          /* üîµ blu iOS */
  color: #fff;

  box-shadow: 0 4px 12px rgba(0,122,255,0.35);
  cursor: pointer;

  transition: transform 0.15s ease, box-shadow 0.15s ease;
}

/* hover (desktop) */
.use-btn:hover{
  transform: scale(1.05);
  box-shadow: 0 6px 16px rgba(0,122,255,0.45);
}

/* tap (mobile) */
.use-btn:active{
  transform: scale(0.95);
  box-shadow: 0 2px 8px rgba(0,122,255,0.35);
}

.empty-msg{
  margin-top: 40px;
  text-align: center;

  font-size: 15px;
  font-weight: 600;
  color: #666;
}
/* üîé SEARCH BAR FISSA IN BASSO ‚Äì CENTRO PERFETTO (NO translate) */
#search-bar-fixed{
  position: fixed;
  bottom: 30px; /* sopra bottom nav */

  /* centratura reale */
  left: max(12px, env(safe-area-inset-left));
  right: max(12px, env(safe-area-inset-right));
  margin: 0 auto;

  max-width: 420px;
  z-index: 10000;
}

/* input */
#search-bar-fixed #search{
  width: 100%;
  box-sizing: border-box; /* üî• importantissimo */

  padding: 11px 14px;
  font-size: 14px;

  border-radius: 14px;
  border: 1px solid #d1d1d6;
  background: #fff;

  box-shadow: 0 6px 18px rgba(0,0,0,0.14);
}



#fedelta-box.compact .fedelta-bar-wrapper{
  margin: 0;
  padding: 0;
  line-height: 0;
}
/* ===============================
   CONTENUTO ‚Äì TRANSIZIONI SOFT
=============================== */
#fedelta-box b,
#fedelta-count,
#fedelta-msg,
#btn-vedi-coupon{
  transition:
    opacity 0.25s ease,
    transform 0.25s ease;
}

/* ===============================
   FEDELTA ‚Äì COMPACT: NASCONDI TITOLO + CONTATORE
=============================== */
#fedelta-box.compact .fedelta-header,
#fedelta-box.compact #fedelta-count{
  display: none !important;
}

#fedelta-box{
  max-width: 520px;
  width: 88%;
  margin: 12px auto 0;
  padding: 12px 14px;
  background: #fff;
  border-radius: 14px;
  box-shadow: 0 1px 4px rgba(0,0,0,0.08);
  position: relative;

  transition:
    transform 0.45s cubic-bezier(.22,.61,.36,1),
    padding 0.35s cubic-bezier(.22,.61,.36,1),
    border-radius 0.35s cubic-bezier(.22,.61,.36,1),
    box-shadow 0.35s cubic-bezier(.22,.61,.36,1),
    opacity 0.25s ease;

  will-change: transform;
}

#fedelta-box.compact{
  position: fixed;
  top: 64px;
  left: 12px;
  right: 12px;
  margin: 0 auto;

  max-width: 520px;
  padding: 6px 12px;

  border-radius: 999px;
  background: #fff;
  box-shadow: 0 6px 20px rgba(0,0,0,0.18);
  backdrop-filter: blur(8px);

  z-index: 9998;
}


/* NASCONDO DAVVERO IL CONTENUTO */
#fedelta-box.compact .fedelta-header,
#fedelta-box.compact #fedelta-msg,
#fedelta-box.compact #btn-vedi-coupon{
  display: none;
}

/* barra senza margini */
#fedelta-box.compact .fedelta-bar-wrapper{
  margin: 0;
  padding: 0;
}

/* ===============================
   BARRA ‚Äì SEMPRE VISIBILE
=============================== */
#fedelta-box .fedelta-bar-wrapper{
  margin-top: 10px;
}

#fedelta-box.compact .fedelta-bar-wrapper{
  margin-top: 0;
}

#fedelta-box.compact #fedelta-bar{
  height: 7px;
}
/* BARRA PI√ô SOTTILE IN MODALIT√Ä COMPATTA */
#fedelta-box.compact .fedelta-bar-wrapper > div{
  height: 4px;            /* prima 6px */
}

#fedelta-box.compact #fedelta-bar{
  height: 4px;
}
#fedelta-box.compact{
  padding: 6px 12px;      /* prima 10px 12px */
}
#fedelta-box.compact{
  backdrop-filter: blur(8px);
} 
/* ===============================
   FEDELTA ‚Äì BARRA (BASE)
=============================== */
/* wrapper barra */
.fedelta-bar-wrapper{
  height: 6px;                 /* altezza reale */
  background: #eee;
  border-radius: 999px;
  overflow: hidden;
  margin: 0;                   /* ‚¨ÖÔ∏è NIENTE SPAZIO */
}

/* barra verde */
#fedelta-bar{
  height: 100%;
  width: 0%;
  background: linear-gradient(90deg, #34c759, #30d158);
  border-radius: 999px;
  transition: width 0.4s ease;
}




/* in compatta nascondo header/messaggio/bottone (ma la barra resta) */
#fedelta-box.compact #fedelta-header,
#fedelta-box.compact #fedelta-msg,
#fedelta-box.compact #btn-vedi-coupon{
  display: none !important;
}

/* barra wrapper: nessun margine extra */
#fedelta-box.compact .fedelta-bar-wrapper{
  margin: 0 !important;
  padding: 0 !important;
}

/* ===============================
   FEDELTA ‚Äì STATO COMPLETO (pi√π aria)
=============================== */

/* spazio tra titolo e barra */
#fedelta-box:not(.compact) .fedelta-header{
  margin-bottom: 12px;
}

/* barra un filo pi√π spessa e respirata */
#fedelta-box:not(.compact) .fedelta-bar-wrapper{
  margin: 10px 0;
}

/* messaggio sotto con pi√π distacco */
#fedelta-box:not(.compact) #fedelta-msg{
  margin-top: 12px;
}

/* ===============================
   FEDELTA ‚Äì TESTI PI√ô PICCOLI (solo stato completo)
=============================== */

/* titolo */
#fedelta-box:not(.compact) .fedelta-header b{
  font-size: 13px;   /* prima 14px */
}

/* contatore 0/10 */
#fedelta-box:not(.compact) #fedelta-count{
  font-size: 12px;   /* prima 13px */
}

/* messaggio sotto la barra */
#fedelta-box:not(.compact) #fedelta-msg{
  font-size: 13px;   /* prima 14px */
  line-height: 1.3;
}

/* bottone coupon */
#fedelta-box:not(.compact) #btn-vedi-coupon{
  font-size: 13px;
  padding: 9px 12px;
}
/* ===============================
   FEDELTA ‚Äì SPACER ANTI-SCATTO
=============================== */
#fedelta-spacer{
  height: 0;
}




#fedelta-box.compact{
  animation: fedeltaFade 0.25s ease;
}

@keyframes fedeltaFade{
  from{
    opacity: 0;
  }
  to{
    opacity: 1;
  }
}
/* ===============================
   GESTISCI COPPE ‚Äì STILE ROSSO (NO CERCHIO)
=============================== */
#btn-gestisci-coppe{
  height: 32px;
  padding: 5px 10px;

  display: flex;
  align-items: center;
  justify-content: center;

  border-radius: 10px;          /* üî• come gli altri */
  border: 1.5px solid #ff3b30;

  background: #fff;
  cursor: pointer;

  transition: background 0.15s ease, transform 0.12s ease;
}

/* icona */
#btn-gestisci-coppe svg{
  width: 18px;
  height: 18px;

  fill: none;
  stroke: #ff3b30;
  stroke-width: 1.6;
}

/* hover */
#btn-gestisci-coppe:hover{
  background: #ffecec;
}

/* tap */
#btn-gestisci-coppe:active{
  transform: scale(0.95);
}

/* =========================
   BOTTONE PREFERITI (ICONA)
========================= */
#toggle-preferiti{
  display: inline-flex;
  align-items: center;
  gap: 6px;

  height: 32px;
  padding: 5px 12px;

  font-size: 12.5px;
  font-weight: 600;

  border-radius: 10px;
  border: 1px solid #d1d1d6;
  background: #f2f2f7;
  color: #333;

  cursor: pointer;
}

/* stella */
#toggle-preferiti svg{
  width: 18px;
  height: 18px;

  fill: none;                 /* ‚≠ê vuota */
  stroke: #000;
  stroke-width: 1.6;
  stroke-linejoin: round;

  transition: fill 0.2s ease, stroke 0.2s ease;
}

/* stato attivo = stessa logica delle card */
/* stella */
#toggle-preferiti svg{
  width: 18px;
  height: 18px;

  fill: #ffd60a;          /* ‚≠ê GIALLA SUBITO */
  stroke: #e6b800;
  stroke-width: 1.6;
  stroke-linejoin: round;
} 
  body{
  padding-bottom: 120px; /* üî• spazio per search + bottom nav */
}

/* ===============================
   CARICA ALTRE ‚Äì PULSANTE PAGINAZIONE
=============================== */
.load-more-btn{
  display: block;
  margin: 24px auto 12px;

  padding: 12px 20px;
  min-width: 180px;

  font-size: 15px;
  font-weight: 700;

  color: #fff;
  background: linear-gradient(180deg, #ff8a1f, #ff7a00);
  border: none;
  border-radius: 14px;

  cursor: pointer;
  -webkit-tap-highlight-color: transparent;

  box-shadow: 0 6px 16px rgba(255,122,0,0.35);
  transition:
    transform 0.15s ease,
    box-shadow 0.15s ease,
    opacity 0.15s ease;
}

/* hover (desktop) */
.load-more-btn:hover{
  transform: scale(1.04);
  box-shadow: 0 8px 20px rgba(255,122,0,0.45);
}

/* tap (mobile) */
.load-more-btn:active{
  transform: scale(0.96);
  box-shadow: 0 4px 12px rgba(255,122,0,0.3);
}

/* stato disabilitato (opzionale) */
.load-more-btn:disabled{
  opacity: 0.6;
  box-shadow: none;
  transform: none;
  cursor: default;
}

.menu-item{
  display:block;
  padding:10px 12px;
  border-radius:10px;
  font-weight:600;
  font-size:14px;
  color:#111;
  text-decoration:none;
}
.menu-item:hover{
  background:#f2f2f7;
}
  .menu-item {
  display: flex !important;
  flex-direction: row !important;
  align-items: center !important;
  gap: 12px;
}

.menu-item svg.menu-icon {
  width: 18px;
  height: 18px;
  flex-shrink: 0;
  stroke: #111;
  stroke-width: 1.8;
  fill: none;
  display: block; 
}
.icon-wrapper{
  position: relative;
  display: inline-flex;
  align-items: center;
}

.menu-new-only{
  display: flex;
  align-items: center;
  gap: 12px;
}

.badge-new-left{
  background:#ff3b30;
  color:#fff;
  font-size:9px;
  font-weight:700;
  padding:3px 6px;
  border-radius:999px;
}
  /* ‚ò∞ MENU */
#menu-btn{
  position: absolute;
  left: 14px;
  top: 50%;
  transform: translateY(-50%);

  background: transparent;
  border: none;
  box-shadow: none;
  padding: 0;
  margin: 0;

  font-size: 22px;
  line-height: 1;
  color: #111;

  cursor: pointer;
  z-index: 10001;
  -webkit-tap-highlight-color: transparent;
}

#menu-btn:active{
  opacity: .6;
}
  /* üîÑ Spinner caricamento */
.load-spinner {
  width: 28px;
  height: 28px;
  margin: 12px auto 0;

  border: 3px solid rgba(0,0,0,0.15);
  border-top-color: #ff7a00;
  border-radius: 50%;

  animation: spin 0.8s linear infinite;
}

@keyframes spin {
  to { transform: rotate(360deg); }
}

/* ===============================
   QR CODE ‚Äì ANIMAZIONE MORBIDA
=============================== */
.qr-box{
  overflow: hidden;
  max-height: 0;
  opacity: 0;
  transform: translateY(-6px);
  transition:
    max-height 0.35s cubic-bezier(.22,.61,.36,1),
    opacity 0.25s ease,
    transform 0.25s ease;
}

/* stato aperto */
.qr-box.open{
  max-height: 220px; /* abbastanza per QR */
  opacity: 1;
  transform: translateY(0);
}

/* ===============================
   ANIMAZIONE ENTRATA CARD COPPE
=============================== */
.cup-card{
  opacity: 0;
  transform: translateY(8px) scale(0.98);
  transition:
    opacity 0.35s ease,
    transform 0.35s cubic-bezier(.22,.61,.36,1);
}

/* stato visibile */
.cup-card.visible{
  opacity: 1;
  transform: translateY(0) scale(1);
}

body.lock-scrollbar {
  overflow-y: scroll; /* forza scrollbar sempre presente */
}

/* üçû TOAST NOTIFICA */
.toast{
  position: fixed;
  bottom: 90px; /* sopra bottom-nav */
  left: 50%;
  transform: translateX(-50%) translateY(10px);

  background: rgba(30,30,30,0.85);
  color: #fff;

  padding: 10px 14px;
  border-radius: 14px;

  font-size: 14px;
  font-weight: 600;

  opacity: 0;
  pointer-events: none;

  backdrop-filter: blur(8px);
  box-shadow: 0 8px 24px rgba(0,0,0,0.25);

  transition:
    opacity 0.25s ease,
    transform 0.25s ease;

  z-index: 999999;
}

/* stato visibile */
.toast.show{
  opacity: 1;
  transform: translateX(-50%) translateY(0);
}

/* üî• FIX DEFINITIVO BARRA FEDELTA */
#fedelta-box .fedelta-bar-wrapper {
  width: 100% !important;
  height: 6px !important;
  overflow: hidden !important;
}

#fedelta-box #fedelta-bar {
  display: block !important;
  height: 100% !important;
  min-width: 1px;
  background: linear-gradient(90deg, #34c759, #30d158);
}


#coppa-overlay{
  position: fixed;
  inset: 0;
  background: rgba(0,0,0,0.85);

  display: flex;
  align-items: center;
  justify-content: center;

  opacity: 0;
  pointer-events: none;

  transition: opacity 0.35s ease;
}

#coppa-overlay.open{
  opacity: 1;
  pointer-events: auto;
}

#coppa-overlay-img{
  max-width: 90%;
  max-height: 90%;
  border-radius: 14px;
  box-shadow: 0 10px 40px rgba(0,0,0,0.5);

  transform: scale(0.96) translateY(8px);
  opacity: 0;

  transition:
    transform 0.45s cubic-bezier(.22,.61,.36,1),
    opacity 0.35s ease;
}

#coppa-overlay.open #coppa-overlay-img{
  transform: scale(1) translateY(0);
  opacity: 1;
}
/* quando overlay aperto ‚Üí nascondo UI sotto */
body.overlay-open #search-bar-fixed,
body.overlay-open #fedelta-box,
body.overlay-open .controls,
body.overlay-open #lista-coppe {
  visibility: hidden;
}
#coppa-overlay-close{
  position: fixed;
  top: 80px;
  right: 30px;

  width: 38px;
  height: 38px;

  display: flex;
  align-items: center;
  justify-content: center;

  background: #ffffff;          /* ‚úÖ sfondo bianco */
  color: #000000;               /* ‚úÖ X nera */
  border: none;
  border-radius: 50%;

  font-size: 22px;
  font-weight: 700;
  line-height: 1;

  cursor: pointer;
  z-index: 100000;

  box-shadow: 0 6px 18px rgba(0,0,0,0.25); /* üëå visibile su tutto */
  transition: transform 0.15s ease, opacity 0.15s ease;
}

#coppa-overlay-close:hover{
  transform: scale(1.08);
}

#coppa-overlay-close:active{
  transform: scale(0.94);
}

body.no-scroll{
  overflow: hidden;
  height: 100vh;
  touch-action: none; /* üî• iOS */
}
body.no-scroll #fedelta-box.compact {
  opacity: 0;
  pointer-events: none;
}
  body.no-scroll #search-bar-fixed {
  opacity: 0;
  pointer-events: none;
  transition: opacity .25s ease;
}



#search-bar-fixed input{
  padding-right: 40px;   /* spazio per la X */
}

#clear-search{
  position: absolute;
  right: 14px;
  top: 50%;
  transform: translateY(-50%);
  display: none;

  width: 26px;
  height: 26px;
  border-radius: 50%;
  border: none;
  background: #e9e9e9;
  font-size: 14px;
  cursor: pointer;

  align-items: center;
  justify-content: center;
}

/* ‚ÑπÔ∏è info: cerchio SVG + testo i */
#info-btn{
  position: absolute;
  right: 16px;
  top: 50%;
  transform: translateY(-50%);

  width: 32px;
  height: 32px;

  display: flex;
  align-items: center;
  justify-content: center;

  background: none;
  border: none;
  cursor: pointer;
}

/* cerchio */
#info-btn .info-ring{
  position: absolute;
  width: 28px;
  height: 28px;

  fill: none;
  stroke: #000;
  stroke-width: 2;
}

/* lettera i */
#info-btn .info-i{
  position: relative;
  z-index: 2;

  font-family: system-ui, -apple-system, sans-serif;
  font-size: 16px;
  font-weight: 800;
  line-height: 1;
  color: #000;
}

/* ===============================
   POPUP INFO CRONOLOGIA
=============================== */

.info-overlay{
  position: fixed;
  inset: 0;
  background: rgba(0,0,0,0.35);
  backdrop-filter: blur(8px);

  display: flex;
  align-items: flex-end;
  justify-content: center;

  opacity: 0;
  pointer-events: none;
  transition: opacity .25s ease;

  z-index: 100000;
}

.info-overlay.open{
  opacity: 1;
  pointer-events: auto;
}


.info-card{
  width: 100%;
  max-width: 520px;

  height: 62vh;
  max-height: 62vh;

  background: #f9f9fb;
  border-radius: 20px 20px 0 0;

  display: flex;
  flex-direction: column;

  overflow: hidden; /* üî• fondamentale */
  
  transform: translateY(100%);
  transition: transform .35s cubic-bezier(.22,.61,.36,1);
  box-shadow: 0 -10px 40px rgba(0,0,0,0.25);
}

.info-overlay.open .info-card{
  transform: translateY(0);
}


.info-overlay.open .info-card{
  transform: translateY(0);
}
/* DRAG INDICATOR */
.info-card::before{
  content: "";
  width: 42px;
  height: 5px;
  border-radius: 999px;
  background: #d1d1d6;

  margin: 10px auto 8px;
}

/* HEADER */
.info-header{
  text-align: center;
  font-size: 16px;
  font-weight: 700;
  padding: 4px 20px 12px;
}


/* SEZIONI */
.info-section{
  padding: 12px 0;
  border-bottom: 1px solid #ececec;
}

.info-section:last-child{
  border-bottom: none;
}

/* IMPORTANTE */
.info-important{
  font-weight: 600;
  color: #111;
}

/* FOOTER */
.info-footer{
  padding: 14px 20px 24px;
}

.info-close-btn{
  width: 100%;
  padding: 14px;

  border-radius: 14px;
  border: none;

  font-weight: 600;
  font-size: 15px;

  background: #007aff;
  color: #fff;

  box-shadow: 0 6px 18px rgba(0,122,255,0.35);
  cursor: pointer;

  transition: transform .15s ease;
}

.info-close-btn:active{
  transform: scale(.96);
}

/* BLOCCO SCROLL */
body.info-open{
  overflow: hidden;
  height: 100vh;
}


.info-tip-title{
  text-align: center;
  font-size: 12px;
  font-weight: 700;
  letter-spacing: 1px;
  text-transform: uppercase;
  color: #ff7a00;
  margin-bottom: 8px;
}



.info-tip{
  background: rgba(255,122,0,0.08);   /* arancione molto leggero */
  border: 1px solid rgba(255,122,0,0.18);
  border-radius: 14px;

  padding: 14px;
  margin: 8px 0;
}

.info-tip-title{
  text-align: center;
  font-size: 12px;
  font-weight: 700;
  letter-spacing: 1px;
  text-transform: uppercase;
  color: #ff7a00;
  margin-bottom: 8px;
}




/* üîÑ Mini spinner fedelt√† */
.fedelta-loading{
  display: flex;
  align-items: center;
  gap: 8px;
}

.mini-spinner{
  width: 14px;
  height: 14px;

  border: 2px solid rgba(0,0,0,0.15);
  border-top-color: #34c759;   /* verde fedelt√† */
  border-radius: 50%;

  animation: spin 0.8s linear infinite;
}

@keyframes spin {
  to { transform: rotate(360deg); }
}


.popup-scroll-hint {
  text-align: center;
  font-size: 13px;
  color: #888;
  margin: 6px 0 16px 0; /* üëà pi√π spazio sotto */
  animation: bounceHint 1.5s infinite;
}

@keyframes bounceHint {
  0%,100% { transform: translateY(0); opacity: .6; }
  50% { transform: translateY(4px); opacity: 1; }
}

/* CORPO SCROLLABILE */
.info-body{
  flex: 1;
  overflow-y: auto;
  -webkit-overflow-scrolling: touch;

  padding: 0 20px 0;  /* üî• niente padding sotto */
}

.info-footer{
  position: sticky;
  bottom: 0;

  flex-shrink: 0;

  background: #f9f9fb;
  padding: 14px 20px 20px;
  z-index: 10;
}

.info-footer::before{
  content: "";
  position: absolute;
  top: -30px;
  left: 0;
  width: 100%;
  height: 30px;

  background: linear-gradient(
    to bottom,
    rgba(249,249,251,0),
    #f9f9fb
  );

  pointer-events: none;
}

/* ‚úÖ placeholder "Scarica immagine" (stesso box della miniatura) */
.coppa-thumb-btn{
  width: 80px;           /* ‚¨ÖÔ∏è identico a .coppa-thumb */
  height: 80px;          /* ‚¨ÖÔ∏è box uguale, cos√¨ non cambia layout */
  border-radius: 10px;
  border: 1px solid #d1d1d6;
  background: #f2f2f7;
  color: #111;
  font-size: 12px;
  font-weight: 700;
  line-height: 1.1;
  padding: 8px;
  cursor: pointer;
  box-shadow: 0 4px 10px rgba(0,0,0,0.15);
}

.coppa-thumb-btn:active{
  transform: scale(0.98);
}

.coppa-loading-spinner{
  width:18px;
  height:18px;
  border:2px solid rgba(0,0,0,0.2);
  border-top-color:#ff7a00;
  border-radius:50%;
  animation: spin .8s linear infinite;
  margin:auto;
}

.coppa-thumb-btn.loading{
  display:flex;
  align-items:center;
  justify-content:center;
}

.cronologia-intro{
  text-align: center;
  font-size: 12px;   /* üî• pi√π piccolo */
  color: #777;       /* leggermente pi√π soft */
  margin-top: 4px;
  margin-bottom: 18px;
  line-height: 1.4;
}
    </style>
</head>

<body>


<!-- üîù BARRA FISSA -->
<div id="top-fixed-bar">

  <!-- ‚ò∞ MENU -->
  <button id="menu-btn" aria-label="Menu">‚ò∞</button>

  <!-- üè† HOME CENTRATO -->
  <a href="home.html" class="home-btn">
    <img src="tastohome.png" alt="home">
  </a>

<button id="info-btn" aria-label="Informazioni">
  <svg viewBox="0 0 24 24" class="info-ring" aria-hidden="true">
    <circle cx="12" cy="12" r="9"></circle>
  </svg>
  <span class="info-i">i</span>
</button>



</div>


<div id="top-fixed-spacer"></div>

<!-- ‚≠ê TITOLO ORIGINALE (fuori dalla barra) -->
<h1>Coppe Create</h1>
<p class="cronologia-intro">
  Benvenuto nella tua cronologia.<br>
  Per capire come funziona clicca il tasto <b>Info</b> in alto a destra.
</p>


<!-- üéÅ FEDELTA' / COUNTER COPPE CONFERMATE -->
<div id="fedelta-box" style="
  max-width:520px;
  width: 88%;
  margin: 12px auto 16px;
  padding: 10px 12px;
  background: white;
  border-radius: 12px;
  box-shadow: 0 1px 4px rgba(0,0,0,0.08);
">

  <!-- üîΩ CONTENUTO COMPLETO -->
<div class="fedelta-full">

  <!-- titolo + counter -->
  <div class="fedelta-header" style="display:flex; justify-content:space-between; align-items:center;">
    <b style="font-size:14px;">Coppe confermate</b>
    <span id="fedelta-count" style="font-weight:700; font-size:13px;">0/10</span>
  </div>

<!-- üî• BARRA FEDELT√Ä ‚Äì STRUTTURA CORRETTA -->
<div class="fedelta-bar-wrapper">
  <div id="fedelta-bar"></div>
</div>

<div id="fedelta-msg" class="fedelta-loading">
  <div class="mini-spinner"></div>
  <span id="fedelta-text">Caricamento...</span>
</div>

    <button id="btn-vedi-coupon" style="
      display:none;
      margin-top:10px;
      width:100%;
      padding:10px 12px;
      border:none;
      border-radius:12px;
      background:#007aff;
      color:white;
      font-weight:700;
      cursor:pointer;
    ">
      üéÅ Vedi coupon
    </button>

  </div>
</div>
<div id="fedelta-spacer"></div>

<!-- üîé SEARCH BAR FISSA IN BASSO -->
<div id="search-bar-fixed" class="search-wrapper">
  <input
    id="search"
    type="text"
    placeholder="Cerca per nome, data, gusto..."
    autocomplete="off"
  >

  <button
    type="button"
    id="clear-search"
    class="clear-search-btn"
  >
    ‚úï
  </button>
</div>

<!-- ‚≠ê CONTROLLI (TUTTI SULLA STESSA RIGA) -->
<div class="controls">
<button id="toggle-preferiti" aria-label="Preferiti">
  <svg viewBox="0 0 24 24" aria-hidden="true">
    <path d="M12 3.5l2.9 5.9 6.6 1-4.8 4.6 1.2 6.6L12 18.8 6.1 21.6l1.2-6.6-4.8-4.6 6.6-1L12 3.5z"/>
  </svg>
  <span>Preferiti</span>
</button>

  <select id="ordine-select">
    <option value="data_desc">Ordina: pi√π recenti prima</option>
    <option value="data_asc">Ordina: pi√π vecchie prima</option>
    <option value="nome_az">Ordina: nome A‚ÜíZ</option>
    <option value="nome_za">Ordina: nome Z‚ÜíA</option>
  </select>

  <!-- üóë GESTISCI COPPE A DESTRA -->
  <button
    id="btn-gestisci-coppe"
    class="delete-btn danger"
    aria-label="Gestisci coppe"
  >
    <svg viewBox="0 0 24 24">
      <path d="M4 7h16"/>
      <path d="M9 4h6"/>
      <rect x="6" y="7" width="12" height="14" rx="2"/>
      <line x1="10" y1="10" x2="10" y2="18"/>
      <line x1="14" y1="10" x2="14" y2="18"/>
    </svg>
  </button>
</div>

<div id="lista-coppe"></div>


<!-- ‚≠ê TUTTO IL TUO JS ORIGINALE (INTATTO) -->
<script>
    /* ----------- TUTTO IL TUO JAVASCRIPT ORIGINALE QUI ----------- */
    /* (lo ricopio completamente) */

let coppe = [];


try {
  const cache = JSON.parse(localStorage.getItem("cronologiaCoppe") || "[]");

  // üî• sicurezza: solo array valido
  coppe = Array.isArray(cache) ? cache : [];

} catch(e) {
  console.warn("Cache corrotta, resetto.");
  coppe = [];
  localStorage.removeItem("cronologiaCoppe");
}

function dedupCoppe(lista) {
    const map = new Map();

    for (let c of lista) {

        // üî• CHIAVE 1: QR TOKEN (PRIORITARIA)
        let key = null;

        if (c.qr_token) {
            key = "qr|" + c.qr_token;
        } else if (c.data) {
            // fallback vecchio
            const timestamp = new Date(c.data).getTime();
            const guest = c.guest_id || c.email || "anon";
            key = "legacy|" + guest + "|" + timestamp;
        } else {
            continue;
        }

        if (map.has(key)) {
            const existing = map.get(key);

            // ‚≠ê FUSIONE STATO LOCALE (NON DEVE ANDARE PERSO)
if (existing.preferito || c.preferito) {
    existing.preferito = true;
}

// ‚úèÔ∏è mantieni nome personalizzato locale
if (!existing.nome && c.nome) {
    existing.nome = c.nome;
}

            // ‚úÖ 1) preferisci SEMPRE quella con immagine
            if (!existing.coppa_img && c.coppa_img) {
                map.set(key, c);
                continue;
            }

            // ‚úÖ 2) se entrambe hanno immagine ‚Üí preferisci Supabase
            if (existing.coppa_img && c.coppa_img) {
                if (!existing.id && c.id) {
                    map.set(key, c);
                }
                continue;
            }

            // altrimenti tieni la prima
        } else {
            map.set(key, c);
        }
    }

    return Array.from(map.values());
}

    // üî• Prezzi EXTRA (uguali alla webapp)
const prezziExtra = {
    "COCCO (3pz)": 0.50,
    "MIX KINDER": 2.50,
    "PANNA EXTRA": 1.80
};
    const lista = document.getElementById("lista-coppe");
// ===============================
// üí§ LAZY LOAD IMMAGINI COPPA (SERIO)
// ===============================
let coppaImgObserver = null;

function setupCoppaLazyObserver() {
  if (coppaImgObserver) return; // gi√† creato

  coppaImgObserver = new IntersectionObserver((entries, obs) => {
    for (const entry of entries) {
      if (!entry.isIntersecting) continue;

      const img = entry.target;
      const src = img.dataset.src;

if (src) {
  img.src = src;
  img.removeAttribute("data-src");
}

      obs.unobserve(img);
    }
  }, {
    root: null,
    threshold: 0.1
  });
}

function observeCoppaImg(img) {
  if (!img) return;
  setupCoppaLazyObserver();
  coppaImgObserver.observe(img);
}

    let coppaDaEliminare = null;
    let animaLista = false;
    let couponDisponibili = 0;
    let mostraSoloPreferiti = false;
    let termineRicerca = "";
    let criterioOrdine = "data_desc";
    const PAGE_SIZE = 5;   // quante coppe per volta
    let visibleCount = 5; // quante ne sto mostrando ora

function salva() {

  const coppeLeggere = coppe.map(c => {
    const copia = { ...c };
    delete copia.coppa_img; // üî• MAI salvare immagini
    return copia;
  });

  try {
    localStorage.setItem("cronologiaCoppe", JSON.stringify(coppeLeggere));
  } catch (e) {
    console.warn("Cache piena, ignoro salvataggio.");
  }
}

    function mostraGustiCompatti(arr) {
        if (!arr || arr.length === 0) return "-";
        const grouped = {};
        arr.forEach(g => grouped[g] = (grouped[g] || 0) + 1);
        return Object.entries(grouped)
            .map(([nome, qty]) => qty === 1 ? nome : `${nome} x${qty}`)
            .join(", ");
    }

function dataRicercabile(iso) {
  if (!iso) return "";
  const d = new Date(iso);

  // formati utili per cercare: 25/01/2026, 25-01-2026, 25 gen 2026, gennaio 2026
  const dd = String(d.getDate()).padStart(2, "0");
  const mm = String(d.getMonth() + 1).padStart(2, "0");
  const yyyy = String(d.getFullYear());

  const meseShort = d
    .toLocaleDateString("it-IT", { month: "short" })
    .replace(".", ""); // "gen." -> "gen"

  const meseLong = d.toLocaleDateString("it-IT", { month: "long" });

  return [
    `${dd}/${mm}/${yyyy}`,
    `${dd}-${mm}-${yyyy}`,
    `${dd} ${meseShort} ${yyyy}`,
    `${meseLong} ${yyyy}`,
    yyyy
  ].join(" ");
}

function testoRicercaPerCoppa(c) {
  const testo = [
    c.nome || "",
    c.data || "",
    dataRicercabile(c.data),
    c.formato || "",
    ...(c.gusti || []),
    ...(c.granelle || []),
    ...(c.topping || []),
    ...(c.ingredienti || []),
    ...(c.extra || [])
  ].join(" ");

  // normalizzo: minuscolo + tolgo punti/virgole doppi spazi
  return testo
    .toLowerCase()
    .replace(/[.,]/g, "")
    .replace(/\s+/g, " ")
    .trim();
}

    function copiaTesto(testo) {
        if (navigator.clipboard) {
            navigator.clipboard.writeText(testo)
                .then(() => showToast("Copiato negli appunti ‚úì"))
                .catch(() => fallbackCopy(testo));
        } else {
            fallbackCopy(testo);
        }
    }

    function fallbackCopy(testo) {
        const win = window.open("", "_blank");
        win.document.write("<pre>" + testo + "</pre>");
        win.document.close();
        alert("Copia manualmente il testo üëç");
    }

    function evidenzia(testo) {
        const q = termineRicerca.trim();
        if (!q) return testo;
        const regex = new RegExp("(" + q.replace(/[.*+?^${}()|[\]\\]/g, "\\$&") + ")", "gi");
        return String(testo).replace(regex, "<mark>$1</mark>");
    }

    function apriPopupConferma({ titolo, testo, onConfirm }) {
  const popup = document.getElementById("popup-confirm");
  const titleEl = document.getElementById("popup-confirm-title");
  const textEl = document.getElementById("popup-confirm-text");
  const okBtn = document.getElementById("popup-confirm-ok");
  const cancelBtn = document.getElementById("popup-confirm-cancel");

  if (!popup) {
    console.error("popup-confirm non trovato");
    return;
  }

  titleEl.textContent = titolo;
  textEl.textContent = testo;

  popup.style.display = "flex";

  const chiudi = () => {
    popup.style.display = "none";
    okBtn.onclick = null;
    cancelBtn.onclick = null;
  };

  okBtn.onclick = async () => {
    chiudi();
    await onConfirm();
  };

  cancelBtn.onclick = chiudi;
}

async function eliminaTutteCoppe() {
  apriPopupConferma({
    titolo: "Eliminare tutte le coppe?",
    testo: "‚ö†Ô∏è L‚Äôoperazione non √® reversibile. Perderai tutti i progressi.",
    onConfirm: async () => {

      coppe = coppe.map(c => ({
        ...c,
        eliminata: true,
        data_eliminazione: new Date().toLocaleString("sv-SE")
      }));

      localStorage.setItem("cronologiaCoppe", JSON.stringify(coppe));

      if (window.supabase) {
        const email = localStorage.getItem("user_email");
        if (email) {
          await supabase
            .from("coppe")
            .update({
              eliminata: true,
              data_eliminazione: new Date().toLocaleString("sv-SE")
            })
            .eq("email", email);
        }
      }

      renderLista();
      await aggiornaFedelta();
    }
  });
}

async function tieniSoloPreferiti() {
  apriPopupConferma({
    titolo: "Eliminare le coppe non preferite?",
    testo: "Verranno eliminate tutte le coppe che non hai contrassegnato con ‚≠ê",
    onConfirm: async () => {

      const now = new Date().toLocaleString("sv-SE");

      coppe = coppe.map(c => {
        if (c.preferito) return c;
        return {
          ...c,
          eliminata: true,
          data_eliminazione: now
        };
      });

      localStorage.setItem("cronologiaCoppe", JSON.stringify(coppe));

if (window.supabase) {
  const email = localStorage.getItem("user_email");

  if (email) {

    const daEliminare = coppe.filter(c =>
      !c.preferito && c.id
    );

    for (const c of daEliminare) {
      await supabase
        .from("coppe")
        .update({
          eliminata: true,
          data_eliminazione: now
        })
        .eq("id", c.id);
    }
  }
}

      renderLista();
      await aggiornaFedelta();
    }
  });
}

async function eliminaCoppa(idx, confermata = false) {
  const c = coppe[idx];
  if (!c) return;

  if (!confermata) {
    apriPopupElimina(idx);
    return;
  }

  // üî• FEDELT√Ä (ok, non tocchiamo)
  if (c.email && window.supabase) {
    try {
      const { data: conferme } = await supabase
        .from("conferme_coppe")
        .select("id")
        .eq("email", c.email)
        .order("id", { ascending: true });

      const { data: coupon } = await supabase
        .from("coupon")
        .select("id")
        .eq("email", c.email);

      const confermeConsumate = (coupon?.length || 0) * 10;
      const confermeValide = conferme.slice(confermeConsumate);

      if (confermeValide.length > 0) {
        await supabase
          .from("conferme_coppe")
          .update({ consumata: true })
          .eq("id", confermeValide[0].id);
      }
    } catch (err) {
      console.error("Errore fedelt√†:", err);
    }
  }

  // üî• SOFT DELETE SUPABASE
  if (c.id && window.supabase) {
    await supabase
      .from("coppe")
      .update({
        eliminata: true,
        data_eliminazione: new Date().toISOString()
      })
      .eq("id", c.id);
  }

// ‚úÖ elimina localmente
c.eliminata = true;
salva();          // ‚¨ÖÔ∏è QUESTA ERA LA CHIAVE
renderLista();

await aggiornaFedelta();
showToast("Coppa eliminata");
}

async function rinominaCoppa(idx, nuovoNome) {
    const c = coppe[idx];
    if (!c) return;
renderLista();
await aggiornaFedelta();
    const nomePulito = nuovoNome.trim();

    // 1Ô∏è‚É£ Aggiorna subito in memoria (lista corrente)
    c.nome = nomePulito;
    salva();

    // 2Ô∏è‚É£ Aggiorna anche nella cronologia salvata in localStorage
    let cronologia = JSON.parse(localStorage.getItem("cronologiaCoppe") || "[]");

    cronologia = cronologia.map(item => {
        // caso ideale: abbiamo l'id sia in item che in c
        if (item.id && c.id && item.id === c.id) {
            item.nome = nomePulito;
            return item;
        }

        // fallback vecchie coppe senza id:
        // uso data + formato + email/guest_id per riconoscerla
        if (!item.id && !c.id &&
            item.data === c.data &&
            item.formato === c.formato &&
            (item.email || null) === (c.email || null) &&
            (item.guest_id || null) === (c.guest_id || null)
        ) {
            item.nome = nomePulito;
        }

        return item;
    });

    localStorage.setItem("cronologiaCoppe", JSON.stringify(cronologia));

// 3Ô∏è‚É£ Aggiorna anche su Supabase (cos√¨ admin vede il nome nuovo)
if (window.supabase) {
    try {
        let error = null;

        if (c.id) {
            // Caso coppe nuove ‚Üí identificazione certa tramite ID
            ({ error } = await supabase
                .from("coppe")
                .update({ nome: nomePulito })
                .eq("id", c.id));
        } else {
            // Coppe vecchie senza id ‚Üí identifico tramite guest_id + data
            ({ error } = await supabase
                .from("coppe")
                .update({ nome: nomePulito })
                .eq("guest_id", c.guest_id || null)
                .eq("data", c.data));
        }

        if (error) {
            console.error("Errore Supabase rename:", error);
            alert("‚ö†Ô∏è Nome aggiornato solo localmente. Errore Supabase.");
        }
    } catch (err) {
        console.error(err);
        alert("‚ö†Ô∏è Errore di rete durante la rinomina (Supabase).");
    }
}

   showToast("Nome coppa aggiornato ‚úì");
}

    function togglePreferito(idx) {
        coppe[idx].preferito = !coppe[idx].preferito;
        salva();
        renderLista();
      
    }

function usaQuestaCoppa(idx) {
    const c = coppe[idx];
    if (!c) return alert("Errore");

    localStorage.setItem("coppaDaUsare", JSON.stringify(c));

    // üî• SKIP POPUP UNA SOLA VOLTA
    localStorage.setItem("skip_popup_coppa", "1");

    window.location.href = "crea-coppa.html?step=gusti";
}

    function getCoppeFiltrateEOrdinate() {
        let arr = coppe.slice();
        if (mostraSoloPreferiti) arr = arr.filter(c => c.preferito);
        if (termineRicerca.trim() !== "") {
            const q = termineRicerca.toLowerCase();
            arr = arr.filter(c => testoRicercaPerCoppa(c).includes(q));
        }

        arr.sort((a, b) => {
            const dataA = a.data || "";
            const dataB = b.data || "";
            const nomeA = (a.nome || "").toLowerCase();
            const nomeB = (b.nome || "").toLowerCase();

            if (criterioOrdine === "data_desc") return dataA < dataB ? 1 : -1;
            if (criterioOrdine === "data_asc") return dataA > dataB ? 1 : -1;
            if (criterioOrdine === "nome_az") return nomeA > nomeB ? 1 : -1;
            if (criterioOrdine === "nome_za") return nomeA < nomeB ? 1 : -1;
            return 0;
        });

        return arr;
    }

    // üî• FORMATO BELLO DATE
function formattaDataBella(iso) {
    if (!iso) return "-";
    const d = new Date(iso);
    return d.toLocaleString("it-IT", {
        day: "2-digit",
        month: "short",
        year: "numeric",
        hour: "2-digit",
        minute: "2-digit"
    }).replace(".", "");
}


async function getCouponNonUsati(email) {
  if (!window.supabase || !email) return [];

 const { data, error } = await window.supabase.from("coupon")
    .from("coupon")
    .select("id")
    .eq("email", email)
    .eq("redento", false);

  if (error) {
    console.error("Errore lettura coupon:", error);
    return [];
  }

  return data || [];
}

window.aggiornaFedelta = async function aggiornaFedelta() {
console.log("üö® aggiornaFedelta chiamata", new Date().toLocaleTimeString());
  const email = localStorage.getItem("user_email");

  const countEl = document.getElementById("fedelta-count");
  const barEl   = document.getElementById("fedelta-bar");
  const msgEl   = document.getElementById("fedelta-msg");
  const btnEl   = document.getElementById("btn-vedi-coupon");

 if (!countEl || !barEl) {
  console.warn("‚õî Fedelt√† DOM non pronto");
  return;
}
  // üîÑ Mostra loader
msgEl.innerHTML = `
  <div class="fedelta-loading">
    <div class="mini-spinner"></div>
    <span>Caricamento...</span>
  </div>
`;
console.log("üü¢ aggiornaFedelta ATTIVA ‚Äì DOM OK");
  // üî¥ non loggato
  if (!email) {
  console.log("üü¢ UTENTE OK, SUPABASE OK");
    countEl.textContent = "0/10";
    barEl.style.width = "0%";
    msgEl.textContent = "Accedi per accumulare punti fedelt√† üéÅ";
    btnEl.style.display = "none";
    return;
  }

  // ‚úÖ 1Ô∏è‚É£ CONTEGGIO REALE DELLE CONFERME
  const { count: confermateTot, error } = await window.supabase
    .from("conferme_coppe")
    .select("*", { count: "exact", head: true })
    .eq("email", email)

  if (error) {
    console.error("Errore conteggio conferme:", error);
    return;
  }

  // ‚úÖ 2Ô∏è‚É£ COUPON
  const { data: coupon } = await window.supabase
    .from("coupon")
    .select("id, redento, nome, tipo, created_at")
    .eq("email", email)

const couponTotali = coupon.length;
const couponDisponibili = coupon.filter(c => !c.redento).length;

// üî• blocchi maturati SOLO dalle conferme
const blocchiMaturati = Math.floor(confermateTot / 10);

// üî• blocchi gi√† trasformati in coupon reali
const blocchiCouponCreati = couponTotali;

// üî• coupon che dovrebbero esserci ma non ancora creati
const couponVirtuali = blocchiMaturati - blocchiCouponCreati;

// üî¢ progress reale
const progress = confermateTot % 10;

countEl.textContent = `${progress}/10`;
barEl.style.width = `${(progress / 10) * 100}%`;

if (couponDisponibili > 0 || couponVirtuali > 0) {

  const tot = couponDisponibili + couponVirtuali;

  const testo =
    tot === 1
      ? "coupon disponibile"
      : "coupon disponibili";

  msgEl.innerHTML = `üéâ <b>Hai ${tot} ${testo}!</b>`;
  btnEl.style.display = "block";
  btnEl.onclick = () => location.href = "profilo.html#coupon";

} else {

  msgEl.textContent =
    couponTotali > 0
      ? `Hai gi√† sbloccato ${couponTotali} coupon üéÅ Continua per il prossimo`
      : `Continua a creare coppe per sbloccare il coupon üéÅ`;

  btnEl.style.display = "none";
}

  console.log("‚úÖ FEDELT√Ä OK:", { confermateTot, progress });
}


async function aggiornaStatoCoupon() {
  const email = localStorage.getItem("user_email");
  if (!email || !window.supabase) return;

  const { data, error } = await supabase
    .from("coupon")
    .select("id")
    .eq("email", email)
    .eq("redento", false);

  if (error) {
    console.error("Errore coupon:", error);
    return;
  }

  couponDisponibili = data.length;

  const btn = document.getElementById("btn-vedi-coupon");
  if (!btn) return;

  btn.style.display = couponDisponibili > 0 ? "block" : "none";
}

function apriCoppaFullscreen(src, coppa) {
  const overlay = document.getElementById("coppa-overlay");
  const img = document.getElementById("coppa-overlay-img");

  if (!overlay || !img) return;

  img.src = src;

  overlay.offsetHeight; // reflow
  overlay.classList.add("open");

  document.body.classList.add("no-scroll"); // ‚úÖ QUI
  window.coppaCorrente = coppa;
}

function chiudiCoppaFullscreen() {
  const overlay = document.getElementById("coppa-overlay");
  const img = document.getElementById("coppa-overlay-img");

  if (!overlay || !img) return;

  overlay.classList.remove("open");
  document.body.classList.remove("no-scroll"); // ‚úÖ QUI

  setTimeout(() => {
    img.src = "";
  }, 350);
}

document.addEventListener("DOMContentLoaded", () => {
  const overlay = document.getElementById("coppa-overlay");
  const closeBtn = document.getElementById("coppa-overlay-close");

  if (closeBtn) {
    closeBtn.addEventListener("click", (e) => {
      e.stopPropagation(); // üî• FONDAMENTALE
      chiudiCoppaFullscreen();
    });
  }

  if (overlay) {
    overlay.addEventListener("click", (e) => {
      if (e.target === overlay) {
        chiudiCoppaFullscreen();
      }
    });
  }
});

function waitImg(img) {
  return new Promise(resolve => {
    if (!img) return resolve();
    if (img.complete && img.naturalWidth > 0) return resolve();
    img.onload = () => resolve();
    img.onerror = () => resolve();
  });
}

async function waitAllImages(container) {
  if (!container) return;
  const imgs = Array.from(container.querySelectorAll("img"));
  await Promise.all(imgs.map(waitImg));
}

window.scaricaImmagine = async function(identifier){

  if (!window.supabase) return;

  const card = document.querySelector(
    `.cup-card[data-coppa-id="${identifier}"]`
  );

  if (!card) return;

  const wrapper = card.querySelector(".coppa-thumb-wrapper");
  const btn = wrapper?.querySelector(".coppa-thumb-btn");
  if (!wrapper || !btn) return;

btn.classList.add("loading");
btn.innerHTML = `<div class="coppa-loading-spinner"></div>`;
btn.disabled = true;

  try {

    let query = supabase
      .from("coppe")
      .select("coppa_img")
      .limit(1);

    query = query.or(
      `id.eq.${identifier},qr_token.eq.${identifier}`
    );

    const { data, error } = await query;

    if (error || !data?.[0]?.coppa_img) {
      btn.textContent = "Errore";
      return;
    }

    const imgUrl = data[0].coppa_img;

    // aggiorno solo quella coppa in memoria
    const coppa = coppe.find(c =>
      c.id == identifier || c.qr_token == identifier
    );
    if (coppa) coppa.coppa_img = imgUrl;

    const img = document.createElement("img");
    img.className = "coppa-thumb";
    img.src = imgUrl;
    img.onclick = () => apriCoppaFullscreen(imgUrl, coppa);

    wrapper.innerHTML = "";
    wrapper.appendChild(img);

  } catch (e) {
    console.error(e);
    btn.textContent = "Errore";
  }
};


async function renderLista() {
const arrCompleto = getCoppeFiltrateEOrdinate()
  .filter(c => !c.eliminata);
                      
  console.log(
    "VISIBLE:",
    visibleCount,
    "TOT:",
    arrCompleto.length
  );
// üî• mostra solo le prime N
const arr = arrCompleto.slice(0, visibleCount);// ‚úÖ NASCONDE LE ELIMINATE


    lista.innerHTML = "";

    if (arr.length === 0) {
        lista.innerHTML = `<p class="empty-msg">Nessuna coppa trovata</p>`;
        return;
    }

    for (const c of arr) {
        const idx = coppe.indexOf(c);
        const nome = c.nome || `Coppa #${idx + 1}`;
        console.log("IMG:", c.nome, !!c.coppa_img);
        const stellina = c.preferito ? "‚≠ê" : "‚òÜ";

        const gustiText = mostraGustiCompatti(c.gusti || []);
        const granelleText = (c.granelle || []).join(", ");
        const toppingText = (c.topping || []).join(", ");
        const ingredientiText = (c.ingredienti || []).join(", ");

        // üî• EXTRA con prezzo corretto
        function formatExtra(lista) {
            if (!lista || lista.length === 0) return "-";

            return lista.map(nome => {
                const prezzo = prezziExtra[nome] || 0;
                const prezzoTxt = prezzo > 0 ? ` (+‚Ç¨${prezzo.toFixed(2)})` : "";
                return `${nome}${prezzoTxt}`;
            }).join(", ");
        }

const extraText = formatExtra(c.extra);

            const testoDaCopiare = [
                `Formato: ${c.formato || "-"}`,
                `Gusti: ${gustiText}`,
                `Granelle: ${granelleText || "-"}`,
                `Topping: ${toppingText || "-"}`,
                `Ingredienti: ${ingredientiText || "-"}`
            ].join("\n");

           const div = document.createElement("div");
div.className = "cup-card";
div.dataset.coppaId = c.id || c.qr_token || idx;
div.innerHTML = `
<div class="cup-title">
  <b 
  class="cup-name"
  data-idx="${idx}"
>
  ${evidenzia(nome)}
</b>


  <div class="cup-actions">
<button class="edit-btn" aria-label="Modifica nome">
<svg viewBox="0 0 24 24" aria-hidden="true">
  <!-- matita -->
  <path d="M16.5 3.5l4 4L8 18.5H4v-4L16.5 3.5z" />

  <!-- linea sotto (staccata) -->
  <path d="M3 21h18" />
</svg>
</button>

<button 
  class="fav-btn ${c.preferito ? 'attiva' : ''}"
  aria-label="Preferito"
  onclick="togglePreferito(${idx})"
>
  <svg viewBox="0 0 24 24" aria-hidden="true">
    <path d="M12 3.5l2.9 5.9 6.6 1-4.8 4.6 1.2 6.6L12 18.8 6.1 21.6l1.2-6.6-4.8-4.6 6.6-1L12 3.5z"/>
  </svg>
</button>

    <button class="delete-btn" aria-label="Elimina">
      <svg viewBox="0 0 24 24">
        <path d="M4 7h16"/>
        <path d="M9 4h6"/>
        <rect x="6" y="7" width="12" height="14" rx="2"/>
        <line x1="10" y1="10" x2="10" y2="18"/>
        <line x1="14" y1="10" x2="14" y2="18"/>
      </svg>
    </button>
  </div>
</div>

${c.coppa_img ? `
  <div class="coppa-thumb-wrapper">
    <img
      data-src="${c.coppa_img}"
      class="coppa-thumb"
      onclick="apriCoppaFullscreen('${c.coppa_img}', coppe[${idx}])"
    >
  </div>
` : `
  <div class="coppa-thumb-wrapper">
    <button class="coppa-thumb-btn" onclick="scaricaImmagine('${c.id || c.qr_token || idx}')">
      Scarica<br>immagine
    </button>
  </div>
`}

<div class="cup-content">
<div class="small">
  ${evidenzia(formattaDataBella(c.data))}
</div>
<div class="small"><b>Formato:</b> ${evidenzia(c.formato || "")}</div>
<div class="small"><b>Gusti:</b> ${evidenzia(gustiText)}</div>
<div class="small"><b>Granelle:</b> ${evidenzia(granelleText)}</div>
<div class="small"><b>Topping:</b> ${evidenzia(toppingText)}</div>
<div class="small"><b>Ingredienti:</b> ${evidenzia(ingredientiText)}</div>
<div class="small"><b>Extra:</b> ${evidenzia(extraText || "-")}</div>
</div>

 <div class="price">
  Prezzo: ‚Ç¨${(c.prezzo || 0).toFixed(2)}
</div>

<div class="qr-row">
  <button class="show-qr-btn">Mostra QR</button>

  ${c.confermate && c.confermate > 0 ? `
    <span class="badge-confermata">
      ‚úî Confermata${c.confermate > 1 ? ` x${c.confermate}` : ``}
    </span>
  ` : ``}
</div>

<div class="qr-box" id="qr-${idx}" style="
    margin-top:12px;
    text-align:center;
"></div>

    <div class="buttons-row">
        <button class="copy-btn" aria-label="Copia">
  <svg viewBox="0 0 24 24" aria-hidden="true">
    <rect x="7" y="7" width="12" height="12" rx="3"/>
    <rect x="3" y="3" width="12" height="12" rx="3"/>
  </svg>
  <span>Copia</span>
</button>
        <button class="use-btn">Usa questa coppa</button>
    </div>
`;
div.querySelector(".fav-btn").onclick = () => togglePreferito(idx);
div.querySelector(".edit-btn").onclick = (e) => {
  e.stopPropagation();
  abilitaRinomina(div, idx);
};
div.querySelector(".delete-btn").onclick = () => eliminaCoppa(idx);
            div.querySelector(".copy-btn").onclick = () => copiaTesto(testoDaCopiare);
            div.querySelector(".use-btn").onclick = () => usaQuestaCoppa(idx);
div.querySelector(".show-qr-btn").onclick = () => {
  const box = document.getElementById(`qr-${idx}`);
  if (!box) return;

  const isOpen = box.classList.contains("open");

  // üîÅ chiusura
  if (isOpen) {
    box.classList.remove("open");
    return;
  }

  // üîΩ apertura
  box.classList.add("open");

  // üî• genera QR SOLO la prima volta
  if (box.dataset.generated !== "1") {
    if (window.QRCode && c.qr_token) {
      new QRCode(box, {
        text: c.qr_token,
        width: 160,
        height: 160
      });
      box.dataset.generated = "1";
    } else {
      box.innerHTML = "<p style='color:red;'>QR non disponibile</p>";
    }
  }
};

lista.appendChild(div);

if (animaLista) {
  const delay = idx * 40;
  setTimeout(() => {
    div.classList.add("visible");
  }, delay);
} else {
  // üî• comparsa immediata, niente animazione
  div.classList.add("visible");
}


// üî• attiva lazy load SOLO per l'immagine di questa card
const img = div.querySelector(".coppa-thumb");
if (img && img.dataset.src) {
  observeCoppaImg(img);
}

// ‚õîÔ∏è questa riga NON serve pi√π con il lazy
// await waitAllImages(div);

            // === QR CODE nella cronologia ===
const btn = div.querySelector(".toggle-qr");
const box = div.querySelector(".qr-wrapper");
const qrDiv = div.querySelector(`.qr-code`);

        if (btn) {
            btn.onclick = () => {
                const visible = box.style.display === "block";

                if (visible) {
                    box.style.display = "none";
                    btn.textContent = "Mostra QR";
                } else {
                    box.style.display = "block";
                    btn.textContent = "Nascondi QR";

                    if (window.QRCode && qrDiv && !qrDiv.dataset.generated) {
                        new QRCode(qrDiv, {
                            text: c.qr_token,
                            width: 140,
                            height: 140
                        });
                        qrDiv.dataset.generated = "1";
                    }
                }
            };
        }

    } // ‚úÖ CHIUDE IL for (const c of arr)

// üîΩ BOTTONE "CARICA ALTRE"
if (arrCompleto.length > visibleCount) {
  const btnMore = document.createElement("button");
  btnMore.textContent = "Carica altre";
  btnMore.className = "load-more-btn";
  btnMore.style.margin = "20px auto";

btnMore.onclick = async () => {

  console.log("üü° Click su Carica altre");

  btnMore.disabled = true;
  btnMore.textContent = "Caricamento‚Ä¶";

  const spinner = document.createElement("div");
  spinner.className = "load-spinner";
  lista.appendChild(spinner);

  const email = localStorage.getItem("user_email");
  console.log("üìß Email:", email);
  console.log("üì¶ Offset prima:", window.supabaseOffset);

  try {
const altre = await getCoppeSupabaseUtente(email, true);

    console.log("üì• Coppe ricevute:", altre.length);

    if (altre.length > 0) {
      coppe = dedupCoppe([...coppe, ...altre]);
      console.log("üìä Totale coppe in memoria:", coppe.length);
    } else {
      console.log("üõë Nessun'altra coppa disponibile");
    }

  } catch (err) {
    console.error("‚ùå Errore Supabase:", err);
  }

  visibleCount += PAGE_SIZE;

  renderLista();
};

  lista.appendChild(btnMore);
}
} // ‚úÖ CHIUDE async function renderLista()

const searchInput = document.getElementById("search");
const clearBtn = document.getElementById("clear-search");

searchInput.addEventListener("input", async e => {
  termineRicerca = e.target.value.trim();
  const email = localStorage.getItem("user_email");

  animaLista = true;

  // 1Ô∏è‚É£ Prova prima con quello che ho gi√† in memoria
  let risultati = getCoppeFiltrateEOrdinate()
    .filter(c => !c.eliminata);

  // 2Ô∏è‚É£ Se sto cercando e non trovo nulla ‚Üí allora carico tutto
  if (termineRicerca !== "" && risultati.length === 0 && email) {

    window.supabaseOffset = 0;
    let tutte = [];
    let batch;

    do {
      batch = await getCoppeSupabaseUtente(email, true);
      tutte = [...tutte, ...batch];
    } while (batch.length === SUPABASE_PAGE_SIZE);

    coppe = dedupCoppe([...coppe, ...tutte]);
  }

  visibleCount = termineRicerca ? coppe.length : PAGE_SIZE;

  renderLista();

  clearBtn.style.display =
    termineRicerca ? "flex" : "none";
});

clearBtn.addEventListener("click", () => {
  searchInput.value = "";
  termineRicerca = "";

  clearBtn.style.display = "none";

  visibleCount = PAGE_SIZE;
  animaLista = true;
  renderLista();

  searchInput.focus();
});

document.getElementById("toggle-preferiti").addEventListener("click", () => {
  mostraSoloPreferiti = !mostraSoloPreferiti;

  const btn = document.getElementById("toggle-preferiti");

  // ‚≠ê stato attivo
  btn.classList.toggle("attivo", mostraSoloPreferiti);

  // reset paginazione
  visibleCount = PAGE_SIZE;
 animaLista = true; 
  renderLista();
});

document.getElementById("ordine-select").addEventListener("change", e => {
  criterioOrdine = e.target.value;

  // reset paginazione
  visibleCount = PAGE_SIZE;
 animaLista = true; 
  renderLista();
});



// üî• PRIMO RENDER
renderLista();
</script>
<script type="module">
import { supabase } from "./supabase.js";
window.supabase = supabase;

/* ------------------------------------------
   üî• 1) LEGGE COPPE UTENTE da SUPABASE
---------------------------------------------*/
window.supabaseOffset = 0;
window.SUPABASE_PAGE_SIZE = 5;

window.getCoppeSupabaseUtente = async function(email, append = false) {

    if (!email) return [];

    let query = supabase
        .from("coppe")
        .select("*")
        .eq("email", email)
        .or("eliminata.is.null,eliminata.eq.false")
        .order("id", { ascending: false })
        .range(
            window.supabaseOffset,
            window.supabaseOffset + SUPABASE_PAGE_SIZE - 1
        );

    const { data, error } = await query;

    if (error) {
        console.error("Errore Supabase:", error);
        return [];
    }

    if (!append) {
        window.supabaseOffset = SUPABASE_PAGE_SIZE;
    } else {
        window.supabaseOffset += SUPABASE_PAGE_SIZE;
    }

    return data || [];
}

/* ------------------------------------------
   üî• 2) UNISCE le coppe locali con quelle Supabase
---------------------------------------------*/
async function caricaCoppeComplete() {
    const email = localStorage.getItem("user_email") || null;

    let coppeLocali = JSON.parse(localStorage.getItem("cronologiaCoppe") || "[]");

// üî• FILTRA ANCHE LE COPPE LOCALI per email
coppeLocali = coppeLocali.filter(c => c.email === email);
    let coppeSupabase = [];

    if (email) {
        coppeSupabase = await getCoppeSupabaseUtente(email);
    }

    // FUSIONE locale + remoto
    let unite = [...coppeSupabase, ...coppeLocali];

    // DEDUPLICA CORRETTA
    let finali = dedupCoppe(unite);

    return finali;
}

/* ------------------------------------------
   üî• 3) SOVRASCRIVE l'array ‚Äúcoppe‚Äù DEL TUO JS
---------------------------------------------*/
caricaCoppeComplete().then(all => {

    coppe = all;

    // üî• salva cache leggera (senza immagini)
    const cacheLeggera = all.map(c => {
        const copia = { ...c };
        delete copia.coppa_img;
        return copia;
    });

    try {
        localStorage.setItem("cronologiaCoppe", JSON.stringify(cacheLeggera));
    } catch(e) {
        console.warn("Cache troppo grande, ignoro.");
    }

    renderLista();

    requestAnimationFrame(() => {
      aggiornaFedelta();
    });
});


// üî¥ REALTIME COPPE ‚Äì UNICO E DEFINITIVO
const emailUtente = localStorage.getItem("user_email");

if (emailUtente) {
  supabase
    .channel("coppe-realtime-cronologia")
    .on(
      "postgres_changes",
      {
        event: "UPDATE",
        schema: "public",
        table: "coppe",
        filter: `email=eq.${emailUtente}`
      },
async payload => {

  const updated = payload.new;

  // aggiorno SOLO la coppa modificata in memoria
  const idx = coppe.findIndex(c => c.id === updated.id);
  if (idx !== -1) {
    coppe[idx] = { ...coppe[idx], ...updated };
  }

  renderLista();
  await aggiornaFedelta();
}
    )
    .subscribe();
}


// üîî REALTIME COUPON ‚Äì MOSTRA SUBITO POPUP
const emailCoupon = localStorage.getItem("user_email");

if (emailCoupon) {
  supabase
    .channel("realtime-coupon")
    .on(
      "postgres_changes",
      {
        event: "INSERT", // üî• SOLO quando nasce un nuovo coupon
        schema: "public",
        table: "coupon",
        filter: `email=eq.${emailCoupon}`
      },
      async payload => {

        console.log("üéâ NUOVO COUPON RILEVATO:", payload);

        await aggiornaFedelta();

        // üî• MOSTRA SUBITO IL BOTTONE E MESSAGGIO
        const btn = document.getElementById("btn-vedi-coupon");
        const msg = document.getElementById("fedelta-msg");

        if (btn) btn.style.display = "block";

        if (msg) {
          msg.innerHTML = `
            üéâ <b>Coupon sbloccato!</b><br>
            Vai nel profilo per usarlo.
          `;
        }

      }
    )
    .subscribe();
}

// üî• REALTIME FEDELT√Ä ‚Äì CONFERME COPPE
const emailFedelta = localStorage.getItem("user_email");

if (emailFedelta) {
  supabase
    .channel("realtime-fedelta")
    .on(
      "postgres_changes",
      {
        event: "*",
        schema: "public",
        table: "conferme_coppe",
        filter: `email=eq.${emailFedelta}`
      },
      async payload => {
        console.log("üéØ FEDELT√Ä realtime:", payload);
        await aggiornaFedelta();
      }
    )
    .subscribe();
}

function vaiAiCoupon() {
    window.location.href = "profilo.html#coupon";
}

</script>



<script>
document.addEventListener("DOMContentLoaded", () => {
    if (typeof aggiornaCarrelloUI === "function") {
        aggiornaCarrelloUI(); // üî• AGGIORNA ORA il carrello nella pagina cronologia
    }
});
</script>
<script type="module">
import { supabase } from "./supabase.js";

let waitInterval = null;
let collapseTimeout = null;

window.abilitaRinomina = function(card, idx){
  if (!card) return;

  const titleEl = card.querySelector(".cup-title b");
  if (!titleEl) return;

  const nomeAttuale = titleEl.textContent.trim();

  const wrapper = document.createElement("div");
  wrapper.className = "rename-wrapper";

  const input = document.createElement("input");
  input.type = "text";
  input.value = nomeAttuale;
  input.className = "rename-input";

  const saveBtn = document.createElement("button");
  saveBtn.className = "rename-save";
  saveBtn.innerHTML = "‚úîÔ∏è";

  wrapper.appendChild(input);
  wrapper.appendChild(saveBtn);

  titleEl.replaceWith(wrapper);
  input.focus();
  input.select();

  saveBtn.onclick = () => {
    salvaRinomina(idx, input.value, wrapper);
  };

  input.addEventListener("keydown", e => {
    if (e.key === "Enter") {
      salvaRinomina(idx, input.value, wrapper);
    }
    if (e.key === "Escape") {
      ripristinaTitolo(wrapper, nomeAttuale);
    }
  });
};

function salvaRinomina(idx, valore, wrapper){
  const nuovoNome = valore.trim();
  if (!nuovoNome) {
    ripristinaTitolo(wrapper, coppe[idx].nome || "");
    return;
  }

  rinominaCoppa(idx, nuovoNome);
}

function ripristinaTitolo(wrapper, testo){
  const b = document.createElement("b");
  b.className = "cup-name";
  b.textContent = testo;
  wrapper.replaceWith(b);
}

function expandWaitBar() {
  const full = document.getElementById("wait-full");
  const compact = document.getElementById("wait-compact");

  if (!full || !compact) return;

  full.style.display = "inline";
  compact.style.display = "none";

  clearTimeout(collapseTimeout);
  collapseTimeout = setTimeout(collapseWaitBar, 5000);
}

function collapseWaitBar() {
  const full = document.getElementById("wait-full");
  const compact = document.getElementById("wait-compact");

  if (!full || !compact) return;

  full.style.display = "none";
  compact.style.display = "inline";
}

async function loadWaitTime() {
  const { data, error } = await supabase
    .from("wait_time")
    .select("*")
    .eq("id", 1)
    .single();

  if (error || !data) return;

  const bar = document.getElementById("wait-bar");
  const txt = document.getElementById("wait-time");

  if (!bar || !txt) return;

  // stop eventuale timer precedente
  if (waitInterval) {
    clearInterval(waitInterval);
    waitInterval = null;
  }

  if (!data.active || data.minutes <= 0) {
    bar.style.display = "none";
    return;
  }

  const startTime = new Date(data.updated_at).getTime();
  const totalSeconds = data.minutes * 60;

function tick() {
  const now = Date.now();
  const elapsed = Math.floor((now - startTime) / 1000);
  const remaining = totalSeconds - elapsed;

  if (remaining <= 0) {
    bar.style.display = "none";
    clearInterval(waitInterval);
    waitInterval = null;
    return;
  }

  const min = Math.floor(remaining / 60);
  const sec = remaining % 60;
  const timeStr = `${min}:${sec.toString().padStart(2, "0")}`;

  // üî¢ aggiorna entrambi i testi
  txt.textContent = timeStr;
  document.getElementById("wait-mmss").textContent = timeStr;

  bar.style.display = "flex";

// ‚è±Ô∏è quando inizia un nuovo minuto ‚Üí riapre la barra
if (sec === 59) {
  expandWaitBar();
}
}
  tick(); // ‚è±Ô∏è avvio immediato
  waitInterval = setInterval(tick, 1000);
}

/*
// üî¥ REALTIME WAIT TIME
supabase
  .channel("coppe-realtime-cronologia")
  .on(
    "postgres_changes",
    {
      event: "*",
      schema: "public",
      table: "coppe",
      filter: `email=eq.${localStorage.getItem("user_email")}`
    },
    async payload => {
      console.log("üîÑ Realtime coppa:", payload);

      // üî• aspetta che Supabase sia consistente
      await new Promise(r => setTimeout(r, 150));

      const all = await caricaCoppeComplete();
      coppe = all;

      renderLista();
      aggiornaFedelta();
    }
  )
  .subscribe();
*/

document.addEventListener("DOMContentLoaded", loadWaitTime);
</script>


<div id="coppa-overlay">
  <img id="coppa-overlay-img">

  <button
    class="overlay-instagram-btn"
    onclick="condividiSuInstagram()"
  >
    üì∏ Condividi su Instagram
  </button>

  <button id="coppa-overlay-close">
    ‚úï
  </button>
</div>

<!-- üóëÔ∏è POPUP ELIMINA COPPE -->
<div id="delete-popup" class="popup-overlay" style="display:none;">
  <div class="popup-card">
    <h3>Azione irreversibile!</h3>
    <p>Eliminando perderai tutti i tuoi progressi</p>

    <button class="popup-btn danger" id="popup-elimina-tutte">
    Elimina tutte
    </button>

    <button class="popup-btn star" id="popup-tieni-preferiti">
    Tieni solo i preferiti
    </button>

    <button class="popup-btn cancel" id="popup-annulla">
      Annulla
    </button>
  </div>
</div>
<script>
document.addEventListener("DOMContentLoaded", () => {
  const popup = document.getElementById("delete-popup");
  const btnOpen = document.getElementById("btn-gestisci-coppe");

  if (!popup || !btnOpen) {
    console.error("Popup o bottone non trovati", { popup, btnOpen });
    return;
  }

  btnOpen.onclick = () => {
    popup.style.display = "flex";
  };

  document.getElementById("popup-annulla").onclick = () => {
    popup.style.display = "none";
  };

  document.getElementById("popup-elimina-tutte").onclick = () => {
    popup.style.display = "none";
    eliminaTutteCoppe();
  };

  document.getElementById("popup-tieni-preferiti").onclick = () => {
    popup.style.display = "none";
    tieniSoloPreferiti();
  };
});
</script>


</body>
</html>



<!-- üç® POPUP INSTAGRAM -->
<div id="popup-instagram" style="
  position: fixed;
  inset: 0;
  background: rgba(0,0,0,0.45);
  display: none;
  align-items: center;
  justify-content: center;
  z-index: 999999;
">
  <div style="
    background: #fff;
    padding: 22px;
    border-radius: 16px;
    max-width: 320px;
    width: 90%;
    text-align: center;
    box-shadow: 0 10px 30px rgba(0,0,0,0.3);
  ">
    <h3 style="margin-bottom:10px;">üì∏ Condividi su Instagram</h3>

    <p style="font-size:14px; line-height:1.4;">
      Condividi la tua coppa su Instagram e tagga  
      <b>@casadelgelato.it</b> üç®
    </p>

    <div style="margin-top:18px; display:flex; gap:10px;">
      <button onclick="chiudiPopupInstagram()"
        style="flex:1; padding:10px; border-radius:10px; border:1px solid #ccc;">
        Annulla
      </button>

      <button onclick="chiudiPopupInstagram(); _eseguiCondivisioneInstagram();"
        style="flex:1; padding:10px; border-radius:10px; border:none;
               background:#ff2d55; color:#fff; font-weight:700;">
        Apri Instagram
      </button>
    </div>
  </div>
</div>



<script>
/* =========================
   üì∏ INSTAGRAM ‚Äì CRONOLOGIA
========================= */

window.condividiSuInstagram = function () {
  const popup = document.getElementById("popup-instagram");
  if (!popup) {
    console.error("popup-instagram non trovato");
    return;
  }
  popup.style.display = "flex";
};

window.chiudiPopupInstagram = function () {
  const popup = document.getElementById("popup-instagram");
  if (popup) popup.style.display = "none";
};


(() => {
  const box = document.getElementById("fedelta-box");
  const spacer = document.getElementById("fedelta-spacer");
  if (!box || !spacer) return;

let compact = false;

window.addEventListener("scroll", () => {
  const y = window.scrollY;

  if (y > 120 && !compact) {
    const rect = box.getBoundingClientRect();
    spacer.style.height = rect.height + "px";
    box.classList.add("compact");
    compact = true;
  }

  if (y < 60 && compact) {
    box.classList.remove("compact");
    spacer.style.height = "0px";
    compact = false;
  }
});
})();
</script>

<script>
async function generaCoppaInstagramStory(stageEl) {
  if (!stageEl) return null;

  const canvas = document.createElement("canvas");
  canvas.width = 1080;
  canvas.height = 1920;
  const ctx = canvas.getContext("2d");

  // sfondo bianco
  ctx.fillStyle = "#ffffff";
  ctx.fillRect(0, 0, canvas.width, canvas.height);

  const coppaCanvas = await html2canvas(stageEl, {
    backgroundColor: null,
    scale: 2,
    useCORS: true
  });

  // üî• NO ZOOM (questa √® la chiave)
  const scale =
    Math.min(
      canvas.width / coppaCanvas.width,
      canvas.height / coppaCanvas.height
    ) * 0.85;

  const w = coppaCanvas.width * scale;
  const h = coppaCanvas.height * scale;

  ctx.drawImage(
    coppaCanvas,
    (canvas.width - w) / 2,
    (canvas.height - h) / 2,
    w,
    h
  );

  // üî• WATERMARK
ctx.textAlign = "right";
ctx.fillStyle = "rgba(0,0,0,0.55)";

ctx.font = "bold 36px -apple-system, sans-serif";
ctx.fillText(

  "¬© iCEcream by Casa del Gelato",
  canvas.width - 60,
  canvas.height - 120
);

ctx.font = "26px -apple-system, sans-serif";
ctx.fillText(
  "www.casa-del-gelato.it",
  canvas.width - 60,
  canvas.height - 70
);

  return new Promise(res =>
    canvas.toBlob(blob => res(blob), "image/png")
  );
}
</script>

<script>
window._eseguiCondivisioneInstagram = async function () {

  const img = document.getElementById("coppa-overlay-img");
  if (!img || !img.src) {
    alert("Coppa non disponibile");
    return;
  }

  // contenitore invisibile
  const temp = document.createElement("div");
  temp.style.position = "fixed";
  temp.style.left = "-9999px";

  const clone = document.createElement("img");
  clone.src = img.src;
  clone.style.maxWidth = "560px";

  temp.appendChild(clone);
  document.body.appendChild(temp);

  await new Promise(r => clone.onload = r);

  const blob = await generaCoppaInstagramStory(temp);
  document.body.removeChild(temp);

  if (!blob) {
    alert("Errore creazione immagine");
    return;
  }

  const file = new File([blob], "coppa-instagram.png", {
    type: "image/png"
  });

  // ‚úÖ SOLO SHARE ‚Äî NO DOWNLOAD
  if (navigator.share && navigator.canShare?.({ files: [file] })) {
    await navigator.share({
      files: [file],
      title: "Guarda la coppa che ho creato da Casa Del Gelato! üç®"
    });
  } else {
    alert("Apri Instagram e carica l‚Äôimmagine manualmente");
  }
};
</script>



<div id="menu-overlay" style="
  position:fixed;
  inset:0;
  background:rgba(0,0,0,0.35);
  opacity:0;
  pointer-events:none;
  transition:.25s;
  z-index:10000;
"></div>

<div id="menu-dropdown" style="
  position:fixed;
  top:60px;
  left:14px;
  width:220px;
  background:#fff;
  border-radius:14px;
  box-shadow:0 12px 30px rgba(0,0,0,0.25);
  padding:10px;
  opacity:0;
  pointer-events:none;
  transform:translateY(-10px);
  transition:.25s;
  z-index:10002;
">
<a href="crea-coppa.html" class="menu-item menu-new-only">
  <span class="badge-new-left">NEW</span>
  <span>Scoopy ice</span>
</a>
<a href="home.html" class="menu-item">
  <svg class="menu-icon" viewBox="0 0 24 24" aria-hidden="true">
    <path d="M3 11.5L12 4l9 7.5" />
    <path d="M5 10.5V20a1 1 0 0 0 1 1h4v-6h4v6h4a1 1 0 0 0 1-1v-9.5" />
  </svg>
  <span>Home</span>
</a>
  <a href="menu.html" class="menu-item">
  <svg class="menu-icon" viewBox="0 0 24 24" aria-hidden="true">
    <rect x="6" y="4" width="12" height="16" rx="2"
          fill="none" stroke="currentColor" stroke-width="2"/>
    <line x1="9" y1="9" x2="15" y2="9"
          stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
    <line x1="9" y1="13" x2="15" y2="13"
          stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
    <line x1="9" y1="17" x2="13" y2="17"
          stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
  </svg>
  <span>Menu</span>
</a>
<a href="profilo.html" class="menu-item">
  <svg class="menu-icon" viewBox="0 0 24 24" aria-hidden="true">
    <path d="M12 12c2.761 0 5-2.239 5-5S14.761 2 12 2 7 4.239 7 7s2.239 5 5 5zm0 2c-4.418 0-8 2.239-8 5v1h16v-1c0-2.761-3.582-5-8-5z"/>
  </svg>
  <span>Profilo</span>
</a>
<a href="info-contatti.html" class="menu-item">
  <svg class="menu-icon" viewBox="0 0 24 24" aria-hidden="true">
    <!-- CERCHIO -->
    <circle
      cx="12"
      cy="12"
      r="9"
      fill="none"
      stroke="currentColor"
      stroke-width="2"
    />

    <!-- PALLINO DELLA i -->
    <circle
      cx="12"
      cy="8"
      r="0.5"
      fill="currentColor"
    />

    <!-- STELO DELLA i -->
    <line
      x1="12"
      y1="11"
      x2="12"
      y2="17"
      stroke="currentColor"
      stroke-width="2.2"
      stroke-linecap="round"
    />
  </svg>
  <span>Info &amp; Contatti</span>
</a>
<a href="lavora-con-noi.html" class="menu-item">
  <svg class="menu-icon" viewBox="0 0 24 24" aria-hidden="true">
    <!-- corpo valigetta -->
    <rect x="3" y="7" width="18" height="13" rx="2"
          fill="none" stroke="currentColor" stroke-width="2"/>
    <!-- manico -->
    <path d="M9 7V5a3 3 0 0 1 6 0v2"
          fill="none" stroke="currentColor" stroke-width="2"
          stroke-linecap="round"/>
  </svg>
  <span>Lavora con noi</span>
</a>
</div>
<script>
  const menuBtn = document.getElementById("menu-btn");
  const menu = document.getElementById("menu-dropdown");
  const overlay = document.getElementById("menu-overlay");

  function openMenu(){
    menu.classList.add("open");
    menu.style.opacity = "1";
    menu.style.pointerEvents = "auto";
    menu.style.transform = "translateY(0)";

    overlay.style.opacity = "1";
    overlay.style.pointerEvents = "auto";
  }

  function closeMenu(){
    menu.classList.remove("open");
    menu.style.opacity = "0";
    menu.style.pointerEvents = "none";
    menu.style.transform = "translateY(-10px)";

    overlay.style.opacity = "0";
    overlay.style.pointerEvents = "none";
  }

  if (menuBtn && menu && overlay) {

    menuBtn.addEventListener("click", () => {
      const isOpen = menu.classList.contains("open");
      isOpen ? closeMenu() : openMenu();
    });

    overlay.addEventListener("click", closeMenu);

    // ESC per chiudere
    document.addEventListener("keydown", (e) => {
      if (e.key === "Escape") closeMenu();
    });

    // chiude quando clicchi un link
    menu.querySelectorAll("a").forEach(a => {
      a.addEventListener("click", closeMenu);
    });
  }
</script>

<div id="toast" class="toast">Copiato negli appunti ‚úì</div>

<script>
/* ========= TOAST ========= */

let toastTimeout = null;

function showToast(text){
  const toast = document.getElementById("toast");
  if (!toast) return;

  toast.textContent = text;
  toast.classList.add("show");

  clearTimeout(toastTimeout);
  toastTimeout = setTimeout(() => {
    toast.classList.remove("show");
  }, 1000);
}
</script>


<!-- üóëÔ∏è POPUP ELIMINA SINGOLA COPPA -->
<div id="popup-delete-single" class="popup-overlay" style="display:none;">
  <div class="popup-card">
    <h3>Eliminare questa coppa?</h3>
    <p>Questa azione non pu√≤ essere annullata.</p>

    <button id="confirm-delete-single" class="popup-btn danger">
      Elimina
    </button>

    <button id="cancel-delete-single" class="popup-btn cancel">
      Annulla
    </button>
  </div>
</div>


<script>
function apriPopupElimina(idx){
  coppaDaEliminare = idx;
  document.getElementById("popup-delete-single").style.display = "flex";
}

function chiudiPopupElimina(){
  coppaDaEliminare = null;
  document.getElementById("popup-delete-single").style.display = "none";
}
</script>

<script>

// === POPUP ELIMINA ‚Äì BIND BOTTONI ===
document.getElementById("cancel-delete-single").onclick =
  chiudiPopupElimina;

document.getElementById("confirm-delete-single").onclick = async () => {
  if (coppaDaEliminare !== null) {
    await eliminaCoppa(coppaDaEliminare, true);
  }
  chiudiPopupElimina();
};
</script>


<div id="popup-confirm" class="popup-overlay" style="display:none;">
  <div class="popup-card">
    <h3 id="popup-confirm-title">Conferma</h3>
    <p id="popup-confirm-text"></p>

    <button class="popup-btn danger" id="popup-confirm-ok">
      Conferma
    </button>

    <button class="popup-btn cancel" id="popup-confirm-cancel">
      Annulla
    </button>
  </div>
</div>

<div id="info-overlay" class="info-overlay">
<div class="info-card">

  <div class="info-header">
    Come funziona
  </div>

  <div class="info-body">

<div class="info-section">
  Qui trovi tutte le <b>coppe che hai creato</b>.
</div>

<div class="info-section">

<div class="info-section info-tip">

  <div class="info-tip-title">Consiglio</div>

Prepara la tua coppa <b>anche da casa</b> e vieni in gelateria gi√† pronto per ordinare.<br>
Cos√¨ <b>riduci i tempi di attesa</b> e ti godi subito il momento.

</div>


    <div class="info-section">
      Con <b>"Usa questa coppa"</b> ritrovi tutto gi√† precompilato.
      Puoi modificarla liberamente prima di confermare.
    </div>

    <div class="info-section">
      Puoi aggiungerle ai <b>Preferiti ‚≠ê</b> e <b>rinominarle</b>.
    </div>

    <div class="info-section">
      Tocca la <b>foto della coppa</b> per ingrandirla o condividerla üì∏
    </div>

<div class="info-section">
  Dopo aver ordinato, chiedi di <b>confermare la coppa</b> 
  per far avanzare la raccolta fedelt√†.
</div>

<div class="info-divider"></div>

<div class="info-section">
<span style="color:#ff3b30; font-weight:600;">
‚ö†Ô∏è Per conferme effettuate in un secondo momento,
√® richiesta la comanda o lo scontrino come verifica dell‚Äôordine. (anche foto)
</span>
</div>

    <div class="info-section info-important">
      Se ordini pi√π volte la stessa coppa pu√≤ essere confermata pi√π volte.
      <br><br>
      Non serve ricrearla: basta mostrare di nuovo il QR code.
    </div>

    <div class="info-section reward">
      üéÅ Ogni <b>10 coppe confermate</b> ricevi un coupon premio.
    </div>

  </div>

  <div class="info-footer">

    <div class="popup-scroll-hint">
  ‚Üì Scorri per leggere tutto ‚Üì
</div>
    <button id="info-close" class="info-close-btn">
      Chiudi
    </button>
  </div>

</div>

</div>




<script>
document.addEventListener("DOMContentLoaded", () => {

  const btn = document.getElementById("info-btn");
  const overlay = document.getElementById("info-overlay");
  const close = document.getElementById("info-close");

  if (!btn || !overlay || !close) return;

  btn.addEventListener("click", () => {
    overlay.classList.add("open");
    document.body.classList.add("info-open");   // üîí blocco scroll
    card.style.transform = '';
card.style.transition = '';
  });

  function chiudiInfo(){
    overlay.classList.remove("open");
    document.body.classList.remove("info-open"); // üîì riattivo scroll
    card.style.transform = '';
card.style.transition = '';
  }

  close.addEventListener("click", chiudiInfo);

  overlay.addEventListener("click", (e) => {
    if (e.target === overlay) {
      chiudiInfo();
    }
  });

});
</script>

<script>
(function(){

  const overlay = document.querySelector('.info-overlay');
  const card = document.querySelector('.info-card');
  const body = document.querySelector('.info-body');

  if(!overlay || !card || !body) return;

  let startY = 0;
  let currentY = 0;
  let dragging = false;

  function startDrag(e){
    if(body.scrollTop > 0) return; // solo se siamo in cima

    dragging = true;
    startY = e.touches ? e.touches[0].clientY : e.clientY;
    card.style.transition = 'none';
  }

  function onDrag(e){
    if(!dragging) return;

    currentY = e.touches ? e.touches[0].clientY : e.clientY;
    const diff = currentY - startY;

    if(diff > 0){
      card.style.transform = `translateY(${diff}px)`;
    }
  }

  function endDrag(){
    if(!dragging) return;
    dragging = false;

    card.style.transition = 'transform .35s cubic-bezier(.22,.61,.36,1)';

    const diff = currentY - startY;

    if(diff > 120){
      closeSheet();
    } else {
      card.style.transform = 'translateY(0)';
    }
  }

function closeSheet(){
  overlay.classList.remove('open');
  document.body.classList.remove('info-open');

  // reset animazione
  card.style.transition = '';
  card.style.transform = '';

  setTimeout(() => {
    card.style.transform = '';
  }, 50);
}

  // Touch
  card.addEventListener('touchstart', startDrag);
  card.addEventListener('touchmove', onDrag);
  card.addEventListener('touchend', endDrag);

  // Mouse
  card.addEventListener('mousedown', startDrag);
  window.addEventListener('mousemove', onDrag);
  window.addEventListener('mouseup', endDrag);

})();
</script>

</body>
</html>