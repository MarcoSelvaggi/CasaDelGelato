<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport"
      content="width=device-width, initial-scale=1, maximum-scale=1">
    <title>Coppe Create</title>
    <link rel="stylesheet" href="bottom-nav.css">
    <script src="global.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
    <style>
        body {
            font-family: system-ui, -apple-system, sans-serif;
            background: #f6f6f7;
            margin: 0;
        }

/* üîù BARRA FISSA + HOME centrato */
#top-fixed-bar {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 55px;
    display: flex;
    justify-content: center; /* CENTRA il contenuto */
    align-items: center;
    background: white;
    z-index: 9999;
    border-bottom: 1px solid #ddd;
}

/* Tasto Home */
.home-btn {
    display: flex;
    align-items: center;
    gap: 6px;
    color: #444;
    text-decoration: none;
    font-size: 16px;
    font-weight: 600;

    /* RIMOSSA la posizione assoluta */
}

.home-btn img {
    width: 28px;
    height: 28px;
}

/* Spazio sotto la barra */
#top-fixed-spacer {
    height: 65px;
}

        /* === CONTENUTO ORIGINALE === */
        h1 {
            text-align: center;
            margin: 10px 0;
        }

/* =========================
   CONTENITORE CONTROLLI
========================= */
.controls{
  max-width: 520px;        /* üî• stessa logica delle card */
  margin: 0 auto 16px;     /* üî• centro perfetto pagina */
  padding: 0 16px;

  display: flex;
  align-items: center;
  justify-content: center; /* üî• CENTRO REALE */
  gap: 8px;
}
/* =========================
   RIGA SUPERIORE
   (Preferiti + Ordine)
========================= */
.controls-top {
  display: flex;
  justify-content: center;
  gap: 10px;
}
/* =========================
   BOTTONE PREFERITI
========================= */
#toggle-preferiti {
  height: 34px;                 /* uguale al select */
  padding: 6px 14px;            /* stesso respiro */

  font-size: 13px;
  font-weight: 600;

  border-radius: 10px;          /* ‚¨ÖÔ∏è stessi bordi smussati */
  border: 1px solid #d1d1d6;

  background: #f2f2f7;
  color: #333;

  cursor: pointer;
}

/* stato attivo */
#toggle-preferiti.attivo {
  background: #ffd60a;
  border-color: #e6c200;
}

/* stato attivo */
#toggle-preferiti.attivo {
  background: #ffd60a;
  border-color: #e6c200;
}

/* =========================
   SELECT ORDINE
========================= */
#ordine-select {
  -webkit-appearance: none;
  appearance: none;

  height: 32px;                /* ‚¨ÖÔ∏è da 34px */
  padding: 5px 30px 5px 10px;  /* ‚¨ÖÔ∏è leggermente pi√π stretto */

  font-size: 12.5px;           /* ‚¨ÖÔ∏è micro riduzione */
  font-weight: 500;

  border-radius: 10px;
  border: 1px solid #d1d1d6;
  background-color: #fff;
  color: #333;

  cursor: pointer;
}
#ordine-select {
  background-image: url("data:image/svg+xml;utf8,\
<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24'>\
<path d='M7 10l5 5 5-5' fill='none' stroke='%23666' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'/>\
</svg>");
  background-repeat: no-repeat;
  background-position: right 10px center; /* ‚¨ÖÔ∏è posizione freccia */
  background-size: 14px;
}


.cup-card {
    background: white;
    padding: 16px;
    border-radius: 14px;
    margin-bottom: 12px;
    box-shadow: 0 2px 6px rgba(0,0,0,0.08);
    max-width: 600px;
    margin-left: auto;
    margin-right: auto;

    position: relative;
    overflow: hidden;

    min-height: 140px; /* üî• RISERVA SPAZIO IMMAGINE */
}

.cup-title{
  position: relative;
  display: block;          /* ‚¨ÖÔ∏è NON flex */
  padding-right: 90px;     /* ‚¨ÖÔ∏è spazio per icone a destra */
}

.cup-title b{
  font-size: 18px;
  display: block;
}
        


        .edit-btn, .delete-btn, .fav-btn {
            background: none;
            border: none;
            cursor: pointer;
            font-size: 20px;
        }

        .small { font-size: 14px; color: #555; margin-top: 6px; }

        .btn {
            display: block;
            width: 200px;
            text-align: center;
            padding: 10px 14px;
            margin: 20px auto;
            background: #ff7a00;
            color: white;
            border-radius: 12px;
            font-size: 17px;
            text-decoration: none;
        }

        .copy-btn, .use-btn {
            margin-top: 10px;
            padding: 8px 12px;
            background: #007aff;
            color: white;
            border-radius: 8px;
            border: none;
            cursor: pointer;
            font-size: 14px;
        }
        .use-btn { background: #34c759; margin-left: 8px; }

        mark {
            background: #ffeb3b;
            padding: 0 2px;
            border-radius: 3px;
        }
        .coppa-thumb-wrapper {
  display: flex;
  justify-content: flex-end;
  margin-top: 34px; 
}

.coppa-thumb {
  width: 80px; /* ‚¨ÖÔ∏è qui la grandezza */
  border-radius: 10px;
  box-shadow: 0 4px 10px rgba(0,0,0,0.15);
  cursor: pointer;
}
.coppa-thumb-wrapper {
    position: absolute;
    top: 30px;
    right: 16px;
    pointer-events: auto;
    /* üîí ISOLAMENTO: solo cronologia */
#lista-coppe .coppa-thumb-wrapper {
    contain: layout paint;
}
}
/* ===== CONTROLLI COMPATTI ===== */
.controls {
  flex-direction: row;
  gap: 8px;
}
/* === POPUP OVERLAY === */
.popup-overlay{
  position: fixed;
  inset: 0;
  background: rgba(0,0,0,0.45);
  backdrop-filter: blur(6px);
  display: flex;
  align-items: center;
  justify-content: center;
  z-index: 99999;
}

/* === CARD === */
.popup-card{
  width: 280px;
  background: white;
  border-radius: 18px;
  padding: 18px;
  text-align: center;
  box-shadow: 0 20px 40px rgba(0,0,0,0.25);
  animation: popupIn 0.2s ease-out;
}

.popup-card h3{
  margin: 0 0 6px;
  font-size: 18px;
}

.popup-card p{
  margin: 0 0 14px;
  font-size: 14px;
  color: #555;
}

/* === BOTTONI === */
.popup-btn{
  width: 100%;
  padding: 12px;
  margin-top: 8px;
  border-radius: 12px;
  border: none;
  font-size: 15px;
  font-weight: 600;
  cursor: pointer;
}

.popup-btn.danger{
  background: #ff3b30;
  color: white;
}

.popup-btn.star{
  background: #ffd60a;
  color: #000;
}

.popup-btn.cancel{
  background: #f2f2f7;
  color: #333;
}

/* animazione */
@keyframes popupIn{
  from { transform: scale(0.9); opacity: 0; }
  to   { transform: scale(1);   opacity: 1; }
}
/* ===============================
   CRONOLOGIA COPPE ‚Äì TESTI COMPATTI (FINALE)
=============================== */

/* Titolo coppa (leggermente ridotto, ma leggibile) */
.cup-card .cup-title b{
  font-size: 15px;
}

/* Testi di dettaglio: gusti, topping, ingredienti, extra */
.cup-card .small,
.cup-card p{
  font-size: 12px;
  line-height: 1.35;
  color: #555;
  margin: 4px 0;
}

/* Bottoni nella card (compatti ma cliccabili) */
.cup-card .copy-btn,
.cup-card .use-btn{
  font-size: 13px;
  padding: 6px 10px;
}
/* ===============================
   CRONOLOGIA COPPE ‚Äì SPAZIO PER MINIATURA
=============================== */

/* Riserva spazio a destra per l'immagine */
.cup-card{
  padding-right: 95px; /* ‚¨ÖÔ∏è spazio dedicato alla coppa */
}
.cup-content{
  padding-right: 20px;   /* üî• spazio orizzontale per immagine */
  min-height: 180px;      /* üî• spazio verticale riservato */
}
/* ===============================
   CRONOLOGIA ‚Äì CESTINO ICONA
=============================== */
.delete-btn{
  background: none;        /* ‚ùå niente cerchio */
  border: none;
  padding: 6px;

  display: flex;
  align-items: center;
  justify-content: center;

  cursor: pointer;
}

/* SVG */
.delete-btn svg{
  width: 26px;             /* dimensione cestino */
  height: 26px;

  fill: none;
  stroke: #000;            /* nero */
  stroke-width: 1.6;       /* ‚¨ÖÔ∏è bordo esterno PI√ô FINE */
  stroke-linecap: round;
  stroke-linejoin: round;
}

/* hover leggero */
.delete-btn:hover svg{
  transform: scale(1.08);
}

/* tap */
.delete-btn:active svg{
  transform: scale(0.95);
}
.cup-actions{
  display: flex;
  align-items: center;   /* üî• allineamento perfetto */
  gap: 10px;

}
/* ===============================
   AZIONI CARD (stella, penna, cestino)
=============================== */

.cup-card{
  position: relative; /* üî• fondamentale */
}

.cup-actions{
  position: absolute;
  top: 12px;
  right: 12px;

  display: flex;
  align-items: center;
  gap: 10px;
}
/* contenitore titolo */
.cup-title{
  position: relative;
  padding-right: 90px;   /* spazio per icone a destra */
}

/* nome coppa */
.cup-title b{
  font-size: 18px;
  display: block;
}

/* azioni in alto a destra */
.cup-actions{
  position: absolute;
  top: -6px;

  right: 16px;          /* üî• riferimento al bordo card */
  transform: translateX(95px); /* üî• supera il padding */

  display: flex;
  align-items: center;
  gap: 10px;
}

/* ===============================
   CRONOLOGIA ‚Äì ICONA MODIFICA
=============================== */
.edit-btn{
  background: none;
  border: none;
  padding: 6px;

  display: flex;
  align-items: center;
  justify-content: center;

  cursor: pointer;
}

/* SVG icona */
.edit-btn svg{
  width: 26px;          /* ‚¨ÖÔ∏è leggermente pi√π leggibile */
  height: 26px;

  fill: none;
  stroke: #000;
  stroke-width: 1.6;    /* ‚¨ÖÔ∏è allineato a cestino */
  stroke-linecap: round;
  stroke-linejoin: round;

  transition: transform 0.15s ease, opacity 0.15s ease;
}

/* hover (desktop) */
.edit-btn:hover svg{
  transform: scale(1.06);
  opacity: 0.85;
}

/* tap (mobile) */
.edit-btn:active svg{
  transform: scale(0.94);
  opacity: 0.7;
}
/* ===============================
   CRONOLOGIA ‚Äì ICONA STELLA
=============================== */
.fav-btn{
  font-size: 26px;        /* ‚¨ÖÔ∏è aumenta la stella */
  line-height: 1;
  padding: 4px;           /* stesso respiro delle altre */
  display: flex;
  align-items: center;
  justify-content: center;
}

/* ===============================
   CRONOLOGIA ‚Äì STELLA SVG
=============================== */
.fav-btn{
  background: none;
  border: none;
  padding: 6px;
  cursor: pointer;

  display: flex;
  align-items: center;
  justify-content: center;
}

.fav-btn svg{
  width: 26px;
  height: 26px;

  fill: none;                 /* ‚≠ê vuota */
  stroke: #000;
  stroke-width: 1.6;
  stroke-linejoin: round;

  transition: fill 0.2s ease, stroke 0.2s ease, transform 0.15s ease;
}

/* ‚≠ê STATO ATTIVO */
.fav-btn.attiva svg{
  fill: #ffd60a;              /* giallo Apple */
  stroke: #e6b800;
}

/* feedback */
.fav-btn:active svg{
  transform: scale(0.92);
}
.cup-name.editing{
  outline: none;
  border-bottom: 2px solid #007aff;
  background: rgba(0,122,255,0.08);
}
.rename-wrapper{
  position: relative;
  display: inline-flex;
  align-items: center;
  max-width: 220px;   /* ‚¨ÖÔ∏è limita larghezza */
}

.rename-input{
  height: 28px;              /* ‚¨ÖÔ∏è CHIAVE */
  padding: 2px 26px 2px 6px; /* ‚¨ÖÔ∏è compatto */
  font-size: 15px;           /* ‚¨ÖÔ∏è come titolo */
  font-weight: 600;
  line-height: 1;
  border-radius: 6px;
  border: 1px solid #ccc;
}

.rename-save{
  position: absolute;
  right: 6px;
  top: 50%;
  transform: translateY(-50%);

  border: none;
  background: none;
  cursor: pointer;

  font-size: 14px;   /* ‚¨ÖÔ∏è pi√π piccola */
  line-height: 1;
  color: #34c759;
}
/* titolo coppa: pu√≤ andare a capo */
.cup-title b.cup-name{
  display: block;
  max-width: calc(100% - 100px); /* spazio riservato alle icone */
  white-space: normal;
  word-break: break-word;
  overflow-wrap: anywhere;
  line-height: 1.2;
  .rename-wrapper{
  max-width: calc(100% - 100px);
}

.rename-input{
  width: 100%;
  box-sizing: border-box;
  white-space: normal;
}
}

/* ===============================
   RINOMINA TITOLO COPPA
=============================== */

.rename-wrapper{
  display: flex;
  align-items: center;
  gap: 6px;

  max-width: calc(100% - 20px); /* spazio icone a destra */
}

.rename-input{
  flex: 1;
  min-width: 0;

  padding: 6px 34px 6px 8px; /* üî• spazio a DESTRA per ‚úîÔ∏è */

  font-size: 15px;
  border-radius: 8px;
  border: 1px solid #ccc;

  box-sizing: border-box; /* üî• fondamentale */
}

/* spunta */
.rename-save{
  flex-shrink: 0;
  width: 26px;
  height: 26px;

  display: flex;
  align-items: center;
  justify-content: center;

  border: none;
  background: none;
  font-size: 16px;
  cursor: pointer;
}
.price{
  text-align: right;
  font-weight: 700;
  font-size: 13px;

  margin-right: -80px;   /* ‚¨ÖÔ∏è spinge il prezzo pi√π a destra */
}
/* ===============================
   QR + CONFERMATA INLINE
=============================== */
.qr-row{
  display: flex;
  align-items: center;
  gap: 10px;
  margin-top: 10px;
}

.badge-confermata{
  background: #34c759;
  color: #fff;
  padding: 4px 10px;
  border-radius: 999px;
  font-size: 12px;
  font-weight: 600;
  white-space: nowrap;
}
/* ===============================
   OVERLAY ‚Äì PULSANTE INSTAGRAM
=============================== */
.overlay-instagram-btn{
  position: absolute;
  bottom: 24px;
  right: 24px;

  height: 32px;          /* ‚¨ÖÔ∏è da 22px ‚Üí 32px */
  padding: 0 14px;       /* ‚¨ÖÔ∏è pi√π respiro */

  font-size: 14px;       /* ‚¨ÖÔ∏è da 10px ‚Üí 14px */
  font-weight: 600;
  line-height: 1;

  border-radius: 12px;   /* ‚¨ÖÔ∏è pi√π Apple-style */
  border: none;

  background: #D6B28A;
  color: #fff;

  display: inline-flex;
  align-items: center;
  gap: 6px;              /* ‚¨ÖÔ∏è icona + testo pi√π separati */

  cursor: pointer;
  z-index: 100000;

  box-shadow: 0 4px 12px rgba(0,0,0,0.25); /* ‚¨ÖÔ∏è pi√π presenza */
  transition: transform 0.15s ease, box-shadow 0.15s ease;
}

/* hover / tap */
.overlay-instagram-btn:hover{
  transform: scale(1.05);
}

.overlay-instagram-btn:active{
  transform: scale(0.95);
}

/* ===============================
   iOS STYLE ‚Äì COPIA
=============================== */
.copy-btn{
  display: inline-flex;
  align-items: center;
  gap: 6px;

  height: 26px;
  padding: 0 10px;

  font-size: 13px;
  font-weight: 500;

  color: #444;
  background: rgba(0,0,0,0.06);

  border: none;
  border-radius: 999px;

  cursor: pointer;
  -webkit-tap-highlight-color: transparent;

  transition: background 0.15s ease, transform 0.1s ease;
}

/* icona */
.copy-btn svg{
  width: 14px;
  height: 14px;

  fill: none;
  stroke: #555;
  stroke-width: 1.6;
}

/* hover / tap */
.copy-btn:hover{
  background: rgba(0,0,0,0.09);
}

.copy-btn:active{
  transform: scale(0.96);
  background: rgba(0,0,0,0.12);
}
.use-btn{
  position: absolute;
  right: 14px;
  bottom: 14px;

  padding: 9px 14px;
  font-size: 13px;
  font-weight: 600;

  border-radius: 12px;
  border: none;

  background: #007aff;          /* üîµ blu iOS */
  color: #fff;

  box-shadow: 0 4px 12px rgba(0,122,255,0.35);
  cursor: pointer;

  transition: transform 0.15s ease, box-shadow 0.15s ease;
}

/* hover (desktop) */
.use-btn:hover{
  transform: scale(1.05);
  box-shadow: 0 6px 16px rgba(0,122,255,0.45);
}

/* tap (mobile) */
.use-btn:active{
  transform: scale(0.95);
  box-shadow: 0 2px 8px rgba(0,122,255,0.35);
}

.empty-msg{
  margin-top: 40px;
  text-align: center;

  font-size: 15px;
  font-weight: 600;
  color: #666;
}
/* üîé SEARCH BAR FISSA IN BASSO ‚Äì CENTRO PERFETTO (NO translate) */
#search-bar-fixed{
  position: fixed;
  bottom: 20px; /* sopra bottom nav */

  /* centratura reale */
  left: max(12px, env(safe-area-inset-left));
  right: max(12px, env(safe-area-inset-right));
  margin: 0 auto;

  max-width: 420px;
  z-index: 10000;
}

/* input */
#search-bar-fixed #search{
  width: 100%;
  box-sizing: border-box; /* üî• importantissimo */

  padding: 11px 14px;
  font-size: 14px;

  border-radius: 14px;
  border: 1px solid #d1d1d6;
  background: #fff;

  box-shadow: 0 6px 18px rgba(0,0,0,0.14);
}

/* ===============================
   FEDELTA ‚Äì BASE
=============================== */
#fedelta-box{
  max-width: 520px;
  width: 88%;
  margin: 12px auto 0;
  padding: 12px 14px;          /* ‚¨ÖÔ∏è ALTEZZA NORMALE */
  background: white;
  border-radius: 14px;
  box-shadow: 0 1px 4px rgba(0,0,0,0.08);

  transition:
    transform 0.35s cubic-bezier(.22,.61,.36,1),
    padding 0.25s ease,
    border-radius 0.25s ease,
    box-shadow 0.25s ease,
    opacity 0.25s ease;

  will-change: transform, opacity;
}

/* ===============================
   FEDELTA ‚Äì STATO COMPATTO
=============================== */
#fedelta-box.compact{
  position: fixed;
  top: 64px;

  left: 12px;
  right: 12px;
  margin: 0 auto;

  max-width: 520px;

  padding: 4px 12px;      /* üî• RIDUZIONE SOLO QUI */
  border-radius: 999px;

  box-shadow: 0 6px 20px rgba(0,0,0,0.18);
  z-index: 9998;
}
#fedelta-box.compact .fedelta-bar-wrapper{
  margin: 0;
  padding: 0;
  line-height: 0;
}
/* ===============================
   CONTENUTO ‚Äì TRANSIZIONI SOFT
=============================== */
#fedelta-box b,
#fedelta-count,
#fedelta-msg,
#btn-vedi-coupon{
  transition:
    opacity 0.25s ease,
    transform 0.25s ease;
}

/* ===============================
   COMPACT ‚Äì NASCONDI TESTI
=============================== */
#fedelta-box.compact b,
#fedelta-box.compact #fedelta-count,
#fedelta-box.compact #fedelta-msg,
#fedelta-box.compact #btn-vedi-coupon{
  opacity: 0;
  transform: translateY(-4px);
  pointer-events: none;
}

/* ===============================
   BARRA ‚Äì SEMPRE VISIBILE
=============================== */
#fedelta-box .fedelta-bar-wrapper{
  margin-top: 10px;
}

#fedelta-box.compact .fedelta-bar-wrapper{
  margin-top: 0;
}

#fedelta-box.compact #fedelta-bar{
  height: 7px;
}
/* BARRA PI√ô SOTTILE IN MODALIT√Ä COMPATTA */
#fedelta-box.compact .fedelta-bar-wrapper > div{
  height: 4px;            /* prima 6px */
}

#fedelta-box.compact #fedelta-bar{
  height: 4px;
}
#fedelta-box.compact{
  padding: 6px 12px;      /* prima 10px 12px */
}
#fedelta-box.compact{
  backdrop-filter: blur(8px);
} 
/* ===============================
   FEDELTA ‚Äì BARRA (BASE)
=============================== */
/* wrapper barra */
.fedelta-bar-wrapper{
  height: 6px;                 /* altezza reale */
  background: #eee;
  border-radius: 999px;
  overflow: hidden;
  margin: 0;                   /* ‚¨ÖÔ∏è NIENTE SPAZIO */
}

/* barra verde */
#fedelta-bar{
  height: 100%;
  width: 0%;
  background: linear-gradient(90deg, #34c759, #30d158);
  border-radius: 999px;
  transition: width 0.4s ease;
}

/* ‚úÖ NON CAMBIARE lo stato normale: resta quello inline */

/* ‚úÖ SOLO COMPACT: override dell'inline con !important */
#fedelta-box.compact{
  position: fixed !important;
  top: 64px !important;

  left: 12px !important;
  right: 12px !important;
  margin: 0 auto !important;

  max-width: 520px !important;

  padding: 12px 12px !important;       /* üî• QUI si stringe il bianco sopra/sotto */
  border-radius: 999px !important;

  box-shadow: 0 6px 20px rgba(0,0,0,0.18) !important;
  z-index: 9998 !important;
}

/* in compatta nascondo header/messaggio/bottone (ma la barra resta) */
#fedelta-box.compact .fedelta-header,
#fedelta-box.compact #fedelta-msg,
#fedelta-box.compact #btn-vedi-coupon{
  display: none !important;
}

/* barra wrapper: nessun margine extra */
#fedelta-box.compact .fedelta-bar-wrapper{
  margin: 0 !important;
  padding: 0 !important;
}

/* ===============================
   FEDELTA ‚Äì STATO COMPLETO (pi√π aria)
=============================== */

/* spazio tra titolo e barra */
#fedelta-box:not(.compact) .fedelta-header{
  margin-bottom: 12px;
}

/* barra un filo pi√π spessa e respirata */
#fedelta-box:not(.compact) .fedelta-bar-wrapper{
  margin: 10px 0;
}

/* messaggio sotto con pi√π distacco */
#fedelta-box:not(.compact) #fedelta-msg{
  margin-top: 12px;
}

/* ===============================
   FEDELTA ‚Äì TESTI PI√ô PICCOLI (solo stato completo)
=============================== */

/* titolo */
#fedelta-box:not(.compact) .fedelta-header b{
  font-size: 13px;   /* prima 14px */
}

/* contatore 0/10 */
#fedelta-box:not(.compact) #fedelta-count{
  font-size: 12px;   /* prima 13px */
}

/* messaggio sotto la barra */
#fedelta-box:not(.compact) #fedelta-msg{
  font-size: 13px;   /* prima 14px */
  line-height: 1.3;
}

/* bottone coupon */
#fedelta-box:not(.compact) #btn-vedi-coupon{
  font-size: 13px;
  padding: 9px 12px;
}
/* ===============================
   FEDELTA ‚Äì SPACER ANTI-SCATTO
=============================== */
#fedelta-spacer{
  height: 0;
}

/* normale */
#fedelta-box{
  max-width: 520px;
  width: 88%;
  margin: 12px auto 0;
  padding: 12px 14px;
  background: #fff;
  border-radius: 14px;
  box-shadow: 0 1px 4px rgba(0,0,0,0.08);
  position: relative;
}

/* compatta */
#fedelta-box.compact{
  position: fixed;
  top: 64px;
  left: 12px;
  right: 12px;
  margin: 0 auto;
  max-width: 520px;
  padding: 6px 12px;
  border-radius: 999px;
  box-shadow: 0 6px 20px rgba(0,0,0,0.18);
  z-index: 9998;
}
#fedelta-box.compact{
  animation: fedeltaFade 0.25s ease;
}

@keyframes fedeltaFade{
  from{
    opacity: 0;
  }
  to{
    opacity: 1;
  }
}
/* ===============================
   GESTISCI COPPE ‚Äì STILE ROSSO (NO CERCHIO)
=============================== */
#btn-gestisci-coppe{
  height: 32px;
  padding: 5px 10px;

  display: flex;
  align-items: center;
  justify-content: center;

  border-radius: 10px;          /* üî• come gli altri */
  border: 1.5px solid #ff3b30;

  background: #fff;
  cursor: pointer;

  transition: background 0.15s ease, transform 0.12s ease;
}

/* icona */
#btn-gestisci-coppe svg{
  width: 18px;
  height: 18px;

  fill: none;
  stroke: #ff3b30;
  stroke-width: 1.6;
}

/* hover */
#btn-gestisci-coppe:hover{
  background: #ffecec;
}

/* tap */
#btn-gestisci-coppe:active{
  transform: scale(0.95);
}

/* =========================
   BOTTONE PREFERITI (ICONA)
========================= */
#toggle-preferiti{
  display: inline-flex;
  align-items: center;
  gap: 6px;

  height: 32px;
  padding: 5px 12px;

  font-size: 12.5px;
  font-weight: 600;

  border-radius: 10px;
  border: 1px solid #d1d1d6;
  background: #f2f2f7;
  color: #333;

  cursor: pointer;
}

/* stella */
#toggle-preferiti svg{
  width: 18px;
  height: 18px;

  fill: none;                 /* ‚≠ê vuota */
  stroke: #000;
  stroke-width: 1.6;
  stroke-linejoin: round;

  transition: fill 0.2s ease, stroke 0.2s ease;
}

/* stato attivo = stessa logica delle card */
/* stella */
#toggle-preferiti svg{
  width: 18px;
  height: 18px;

  fill: #ffd60a;          /* ‚≠ê GIALLA SUBITO */
  stroke: #e6b800;
  stroke-width: 1.6;
  stroke-linejoin: round;
} 
  body{
  padding-bottom: 120px; /* üî• spazio per search + bottom nav */
}

/* ===============================
   CARICA ALTRE ‚Äì PULSANTE PAGINAZIONE
=============================== */
.load-more-btn{
  display: block;
  margin: 24px auto 12px;

  padding: 12px 20px;
  min-width: 180px;

  font-size: 15px;
  font-weight: 700;

  color: #fff;
  background: linear-gradient(180deg, #ff8a1f, #ff7a00);
  border: none;
  border-radius: 14px;

  cursor: pointer;
  -webkit-tap-highlight-color: transparent;

  box-shadow: 0 6px 16px rgba(255,122,0,0.35);
  transition:
    transform 0.15s ease,
    box-shadow 0.15s ease,
    opacity 0.15s ease;
}

/* hover (desktop) */
.load-more-btn:hover{
  transform: scale(1.04);
  box-shadow: 0 8px 20px rgba(255,122,0,0.45);
}

/* tap (mobile) */
.load-more-btn:active{
  transform: scale(0.96);
  box-shadow: 0 4px 12px rgba(255,122,0,0.3);
}

/* stato disabilitato (opzionale) */
.load-more-btn:disabled{
  opacity: 0.6;
  box-shadow: none;
  transform: none;
  cursor: default;
}

.menu-item{
  display:block;
  padding:10px 12px;
  border-radius:10px;
  font-weight:600;
  font-size:14px;
  color:#111;
  text-decoration:none;
}
.menu-item:hover{
  background:#f2f2f7;
}
  .menu-item {
  display: flex !important;
  flex-direction: row !important;
  align-items: center !important;
  gap: 12px;
}

.menu-item svg.menu-icon {
  width: 18px;
  height: 18px;
  flex-shrink: 0;
  stroke: #111;
  stroke-width: 1.8;
  fill: none;
}
.icon-wrapper{
  position: relative;
  display: inline-flex;
  align-items: center;
}

.menu-new-only{
  display: flex;
  align-items: center;
  gap: 12px;
}

.badge-new-left{
  background: #ff3b30;
  color: #fff;
  font-size: 9px;          /* ‚¨ÖÔ∏è pi√π piccolo */
  font-weight: 700;
  padding: 3px 6px;        /* ‚¨ÖÔ∏è meno padding */
  border-radius: 999px;
  line-height: 1;
  letter-spacing: .3px;
}
    </style>
</head>

<body>


<!-- üîù BARRA FISSA -->
<div id="top-fixed-bar">
    <a href="home.html" class="home-btn">
        <img src="tastohome.png" alt="home">
    </a>
</div>

<div id="top-fixed-spacer"></div>

<!-- ‚≠ê TITOLO ORIGINALE (fuori dalla barra) -->
<h1>Coppe Create</h1>


<!-- üéÅ FEDELTA' / COUNTER COPPE CONFERMATE -->
<div id="fedelta-box" style="
  max-width:520px;
  width: 88%;
  margin: 12px auto 16px;
  padding: 10px 12px;
  background: white;
  border-radius: 12px;
  box-shadow: 0 1px 4px rgba(0,0,0,0.08);
">

  <!-- üîΩ CONTENUTO COMPLETO -->
<div class="fedelta-full">

  <!-- titolo + counter -->
  <div class="fedelta-header" style="display:flex; justify-content:space-between; align-items:center;">
    <b style="font-size:14px;">Coppe confermate</b>
    <span id="fedelta-count" style="font-weight:700; font-size:13px;">0/10</span>
  </div>

<!-- üî• BARRA FEDELT√Ä ‚Äì STRUTTURA CORRETTA -->
<div class="fedelta-bar-wrapper">
  <div id="fedelta-bar"></div>
</div>

    <div id="fedelta-msg">
      Caricamento...
    </div>

    <button id="btn-vedi-coupon" style="
      display:none;
      margin-top:10px;
      width:100%;
      padding:10px 12px;
      border:none;
      border-radius:12px;
      background:#007aff;
      color:white;
      font-weight:700;
      cursor:pointer;
    ">
      üéÅ Vedi coupon
    </button>

  </div>
</div>
<div id="fedelta-spacer"></div>

<!-- üîé SEARCH BAR FISSA IN BASSO -->
<div id="search-bar-fixed">
  <input
    id="search"
    type="text"
    placeholder="Cerca per nome, data, gusto..."
    autocomplete="off"
  >
</div>
<!-- ‚≠ê CONTROLLI -->
<!-- ‚≠ê CONTROLLI (TUTTI SULLA STESSA RIGA) -->
<div class="controls">
<button id="toggle-preferiti" aria-label="Preferiti">
  <svg viewBox="0 0 24 24" aria-hidden="true">
    <path d="M12 3.5l2.9 5.9 6.6 1-4.8 4.6 1.2 6.6L12 18.8 6.1 21.6l1.2-6.6-4.8-4.6 6.6-1L12 3.5z"/>
  </svg>
  <span>Preferiti</span>
</button>

  <select id="ordine-select">
    <option value="data_desc">Ordina: pi√π recenti prima</option>
    <option value="data_asc">Ordina: pi√π vecchie prima</option>
    <option value="nome_az">Ordina: nome A‚ÜíZ</option>
    <option value="nome_za">Ordina: nome Z‚ÜíA</option>
  </select>

  <!-- üóë GESTISCI COPPE A DESTRA -->
  <button
    id="btn-gestisci-coppe"
    class="delete-btn danger"
    aria-label="Gestisci coppe"
  >
    <svg viewBox="0 0 24 24">
      <path d="M4 7h16"/>
      <path d="M9 4h6"/>
      <rect x="6" y="7" width="12" height="14" rx="2"/>
      <line x1="10" y1="10" x2="10" y2="18"/>
      <line x1="14" y1="10" x2="14" y2="18"/>
    </svg>
  </button>
</div>

<div id="lista-coppe"></div>


<!-- ‚≠ê TUTTO IL TUO JS ORIGINALE (INTATTO) -->
<script>
    /* ----------- TUTTO IL TUO JAVASCRIPT ORIGINALE QUI ----------- */
    /* (lo ricopio completamente) */

    let coppe = JSON.parse(localStorage.getItem("cronologiaCoppe") || "[]");

function dedupCoppe(lista) {
    const map = new Map();

    for (let c of lista) {

        // üî• CHIAVE 1: QR TOKEN (PRIORITARIA)
        let key = null;

        if (c.qr_token) {
            key = "qr|" + c.qr_token;
        } else if (c.data) {
            // fallback vecchio
            const timestamp = new Date(c.data).getTime();
            const guest = c.guest_id || c.email || "anon";
            key = "legacy|" + guest + "|" + timestamp;
        } else {
            continue;
        }

        if (map.has(key)) {
            const existing = map.get(key);

            // ‚úÖ 1) preferisci SEMPRE quella con immagine
            if (!existing.coppa_img && c.coppa_img) {
                map.set(key, c);
                continue;
            }

            // ‚úÖ 2) se entrambe hanno immagine ‚Üí preferisci Supabase
            if (existing.coppa_img && c.coppa_img) {
                if (!existing.id && c.id) {
                    map.set(key, c);
                }
                continue;
            }

            // altrimenti tieni la prima
        } else {
            map.set(key, c);
        }
    }

    return Array.from(map.values());
}

    // üî• Prezzi EXTRA (uguali alla webapp)
const prezziExtra = {
    "COCCO (3pz)": 0.50,
    "MIX KINDER": 2.50,
    "PANNA EXTRA": 1.80
};
    const lista = document.getElementById("lista-coppe");
// ===============================
// üí§ LAZY LOAD IMMAGINI COPPA (SERIO)
// ===============================
let coppaImgObserver = null;

function setupCoppaLazyObserver() {
  if (coppaImgObserver) return; // gi√† creato

  coppaImgObserver = new IntersectionObserver((entries, obs) => {
    for (const entry of entries) {
      if (!entry.isIntersecting) continue;

      const img = entry.target;
      const src = img.dataset.src;

      if (src) {
        img.src = src; // ‚úÖ SOLO ORA parte il download
        img.removeAttribute("data-src");
      }

      obs.unobserve(img);
    }
  }, {
    root: null,
    threshold: 0.1
  });
}

function observeCoppaImg(img) {
  if (!img) return;
  setupCoppaLazyObserver();
  coppaImgObserver.observe(img);
}
    let mostraSoloPreferiti = false;
    let termineRicerca = "";
    let criterioOrdine = "data_desc";
    let limiteVisibili = 3;   // üî• quante coppe mostrare
const STEP_CARICAMENTO = 3;

    function salva() { localStorage.setItem("cronologiaCoppe", JSON.stringify(coppe)); }

    function mostraGustiCompatti(arr) {
        if (!arr || arr.length === 0) return "-";
        const grouped = {};
        arr.forEach(g => grouped[g] = (grouped[g] || 0) + 1);
        return Object.entries(grouped)
            .map(([nome, qty]) => qty === 1 ? nome : `${nome} x${qty}`)
            .join(", ");
    }

    function testoRicercaPerCoppa(c) {
        return [
            c.nome || "",
            c.data || "",
            c.formato || "",
            ...(c.gusti || []),
            ...(c.granelle || []),
            ...(c.topping || []),
            ...(c.ingredienti || []),
            ...(c.extra || [])
        ].join(" ").toLowerCase();
    }

    function copiaTesto(testo) {
        if (navigator.clipboard) {
            navigator.clipboard.writeText(testo)
                .then(() => alert("Copiato negli appunti!"))
                .catch(() => fallbackCopy(testo));
        } else {
            fallbackCopy(testo);
        }
    }

    function fallbackCopy(testo) {
        const win = window.open("", "_blank");
        win.document.write("<pre>" + testo + "</pre>");
        win.document.close();
        alert("Copia manualmente il testo üëç");
    }

    function evidenzia(testo) {
        const q = termineRicerca.trim();
        if (!q) return testo;
        const regex = new RegExp("(" + q.replace(/[.*+?^${}()|[\]\\]/g, "\\$&") + ")", "gi");
        return String(testo).replace(regex, "<mark>$1</mark>");
    }

    async function eliminaTutteCoppe() {
  if (!confirm("‚ö†Ô∏è Vuoi eliminare TUTTE le coppe?\nL‚Äôoperazione non √® reversibile.")) return;

  // üî• Soft delete locale
  coppe = coppe.map(c => ({
    ...c,
    eliminata: true,
    data_eliminazione: new Date().toISOString()
  }));

  localStorage.setItem("cronologiaCoppe", JSON.stringify(coppe));

  // üî• Soft delete Supabase
  if (window.supabase) {
    const email = localStorage.getItem("user_email");
    if (email) {
      await supabase
        .from("coppe")
        .update({
          eliminata: true,
          data_eliminazione: new Date().toISOString()
        })
        .eq("email", email);
    }
  }

  renderLista();
}

async function tieniSoloPreferiti() {
  if (!confirm("‚ö†Ô∏è Vuoi eliminare tutte le coppe NON preferite?")) return;

  const now = new Date().toISOString();

  coppe = coppe.map(c => {
    if (c.preferito) return c;
    return {
      ...c,
      eliminata: true,
      data_eliminazione: now
    };
  });

  localStorage.setItem("cronologiaCoppe", JSON.stringify(coppe));

  // üî• Supabase
  if (window.supabase) {
    const email = localStorage.getItem("user_email");
    if (email) {
      await supabase
        .from("coppe")
        .update({
          eliminata: true,
          data_eliminazione: now
        })
        .eq("email", email)
        .neq("preferito", true);
    }
  }

  renderLista();
}

async function eliminaCoppa(idx) {
    const c = coppe[idx];
    if (!c) return;

    if (!confirm("Vuoi eliminare questa coppa?")) return;

    // üî• Se la coppa √® su Supabase ‚Üí soft delete
    if (c.id && window.supabase) {
        try {
            await window.supabase
                .from("coppe")
                .update({
                    eliminata: true,
                    data_eliminazione: new Date().toISOString()
                })
                .eq("id", c.id);
        } catch (err) {
            console.error("Errore durante eliminazione su Supabase:", err);
        }
    }

    // üî• Soft delete ANCHE in locale (IMPORTANTE!)
    coppe[idx].eliminata = true;
    coppe[idx].data_eliminazione = new Date().toISOString();

    // üî• NON usare pi√π splice!
    // coppe.splice(idx, 1);  ‚õî ELIMINA DAVVERO ‚Äî non vogliamo questo

    salva();
    renderLista();
}


async function rinominaCoppa(idx, nuovoNome) {
    const c = coppe[idx];
    if (!c) return;


    const nomePulito = nuovoNome.trim();

    // 1Ô∏è‚É£ Aggiorna subito in memoria (lista corrente)
    c.nome = nomePulito;
    salva();
    renderLista();

    // 2Ô∏è‚É£ Aggiorna anche nella cronologia salvata in localStorage
    let cronologia = JSON.parse(localStorage.getItem("cronologiaCoppe") || "[]");

    cronologia = cronologia.map(item => {
        // caso ideale: abbiamo l'id sia in item che in c
        if (item.id && c.id && item.id === c.id) {
            item.nome = nomePulito;
            return item;
        }

        // fallback vecchie coppe senza id:
        // uso data + formato + email/guest_id per riconoscerla
        if (!item.id && !c.id &&
            item.data === c.data &&
            item.formato === c.formato &&
            (item.email || null) === (c.email || null) &&
            (item.guest_id || null) === (c.guest_id || null)
        ) {
            item.nome = nomePulito;
        }

        return item;
    });

    localStorage.setItem("cronologiaCoppe", JSON.stringify(cronologia));

// 3Ô∏è‚É£ Aggiorna anche su Supabase (cos√¨ admin vede il nome nuovo)
if (window.supabase) {
    try {
        let error = null;

        if (c.id) {
            // Caso coppe nuove ‚Üí identificazione certa tramite ID
            ({ error } = await supabase
                .from("coppe")
                .update({ nome: nomePulito })
                .eq("id", c.id));
        } else {
            // Coppe vecchie senza id ‚Üí identifico tramite guest_id + data
            ({ error } = await supabase
                .from("coppe")
                .update({ nome: nomePulito })
                .eq("guest_id", c.guest_id || null)
                .eq("data", c.data));
        }

        if (error) {
            console.error("Errore Supabase rename:", error);
            alert("‚ö†Ô∏è Nome aggiornato solo localmente. Errore Supabase.");
        }
    } catch (err) {
        console.error(err);
        alert("‚ö†Ô∏è Errore di rete durante la rinomina (Supabase).");
    }
}

    alert("Nome coppa aggiornato!");
}

    function togglePreferito(idx) {
        coppe[idx].preferito = !coppe[idx].preferito;
        salva();
        renderLista();
    }

    function usaQuestaCoppa(idx) {
        const c = coppe[idx];
        if (!c) return alert("Errore");
        localStorage.setItem("coppaDaUsare", JSON.stringify(c));
        window.location.href = "crea-coppa.html?from=cronologia";
    }

    function getCoppeFiltrateEOrdinate() {
        let arr = coppe.slice();
        if (mostraSoloPreferiti) arr = arr.filter(c => c.preferito);
        if (termineRicerca.trim() !== "") {
            const q = termineRicerca.toLowerCase();
            arr = arr.filter(c => testoRicercaPerCoppa(c).includes(q));
        }

        arr.sort((a, b) => {
            const dataA = a.data || "";
            const dataB = b.data || "";
            const nomeA = (a.nome || "").toLowerCase();
            const nomeB = (b.nome || "").toLowerCase();

            if (criterioOrdine === "data_desc") return dataA < dataB ? 1 : -1;
            if (criterioOrdine === "data_asc") return dataA > dataB ? 1 : -1;
            if (criterioOrdine === "nome_az") return nomeA > nomeB ? 1 : -1;
            if (criterioOrdine === "nome_za") return nomeA < nomeB ? 1 : -1;
            return 0;
        });

        return arr;
    }

    // üî• FORMATO BELLO DATE
function formattaDataBella(iso) {
    if (!iso) return "-";
    const d = new Date(iso);
    return d.toLocaleString("it-IT", {
        day: "2-digit",
        month: "short",
        year: "numeric",
        hour: "2-digit",
        minute: "2-digit"
    }).replace(".", "");
}


async function getCouponNonUsati(email) {
  if (!window.supabase || !email) return [];

  const { data, error } = await supabase
    .from("coupon")
    .select("id")
    .eq("email", email)
    .eq("redento", false);

  if (error) {
    console.error("Errore lettura coupon:", error);
    return [];
  }

  return data || [];
}

function aggiornaFedelta() {
  const email = localStorage.getItem("user_email");
  getCouponNonUsati(email).then(couponNonUsati => {
  const couponDisponibili = couponNonUsati.length;

  const msgEl = document.getElementById("fedelta-msg");
  const btnEl = document.getElementById("btn-vedi-coupon");

  if (!msgEl || !btnEl) return;

  if (couponDisponibili === 0) {
    // ‚ùå NESSUN COUPON DISPONIBILE ‚Üí messaggio normale
    msgEl.textContent = "Continua a creare coppe per sbloccare il coupon üéÅ";
    btnEl.style.display = "none";
  } else {
    // ‚úÖ CI SONO COUPON NON USATI
    msgEl.innerHTML = `üéâ Hai ${couponDisponibili} coupon disponibili!`;
    btnEl.style.display = "block";
  }
});
  // conta SOLO coppe dell‚Äôutente gi√† filtrate (coppe array) e NON eliminate
  const confermateTot = coppe
  .filter(c => c && !c.eliminata)
  .reduce((tot, c) => tot + (c.confermate || 0), 0);

  // quante volte ho completato 10
  const couponSbloccati = Math.floor(confermateTot / 10);

  // progress attuale (0..9)
  const progress = confermateTot % 10;

  const countEl = document.getElementById("fedelta-count");
  const barEl   = document.getElementById("fedelta-bar");
  const msgEl   = document.getElementById("fedelta-msg");
  const btnEl   = document.getElementById("btn-vedi-coupon");

  if (!countEl || !barEl || !msgEl) return;

  // ‚úÖ REGOLA: quando arrivo a 10 ‚Üí reset visivo a 0/10
  // ma messaggio "coupon sbloccato" resta FINCH√â non arriva un'altra conferma:
  // Questo succede naturalmente perch√©:
  // - a 10,20,30... => progress=0 e confermateTot>0 => sbloccato
  // - a 11 => progress=1 => torna normale
  let justUnlocked = false;

if (confermateTot >= 10 && progress === 0 && email) {
  getCouponNonUsati(email).then(coupon => {
    if (coupon.length > 0) {
      justUnlocked = true;
      document.getElementById("fedelta-msg").innerHTML =
        `üéâ <b>Coupon sbloccato!</b><br>Rivolgiti alla cassa!`;
    }
  });
}

  // aggiorno contatore e barra
  countEl.textContent = `${progress}/10`;
  barEl.style.width = ((progress / 10) * 100) + "%";

if (!justUnlocked) {
  msgEl.textContent = couponSbloccati > 0
    ? `Hai gi√† sbloccato ${couponSbloccati} coupon üéÅ Continua per il prossimo!`
    : `Continua a creare coppe per sbloccare il coupon üéÅ`;
}

  // bottone: lo mostro se ho almeno 1 coupon sbloccato
  if (btnEl) {
    btnEl.style.display = couponSbloccati > 0 ? "block" : "none";
    btnEl.onclick = () => {
      window.location.href = "profilo.html#coupon";
    };
  }
}


function apriCoppaFullscreen(src, coppa) {
  const overlay = document.getElementById("coppa-overlay");
  const img = document.getElementById("coppa-overlay-img");

  if (!overlay || !img) return;

  img.src = src;
  overlay.style.display = "flex";

  // üî• QUESTA √à LA RIGA CHIAVE
  window.coppaCorrente = coppa;
}

function chiudiCoppaFullscreen() {
  const overlay = document.getElementById("coppa-overlay");
  const img = document.getElementById("coppa-overlay-img");

  if (!overlay || !img) return;

  overlay.style.display = "none";
  img.src = "";
}

document.addEventListener("DOMContentLoaded", () => {
  const overlay = document.getElementById("coppa-overlay");
  const closeBtn = document.getElementById("coppa-overlay-close");

  if (closeBtn) {
    closeBtn.addEventListener("click", (e) => {
      e.stopPropagation(); // üî• FONDAMENTALE
      chiudiCoppaFullscreen();
    });
  }

  if (overlay) {
    overlay.addEventListener("click", (e) => {
      if (e.target === overlay) {
        chiudiCoppaFullscreen();
      }
    });
  }
});

function waitImg(img) {
  return new Promise(resolve => {
    if (!img) return resolve();
    if (img.complete && img.naturalWidth > 0) return resolve();
    img.onload = () => resolve();
    img.onerror = () => resolve();
  });
}

async function waitAllImages(container) {
  if (!container) return;
  const imgs = Array.from(container.querySelectorAll("img"));
  await Promise.all(imgs.map(waitImg));
}


async function renderLista() {
const arrCompleto = getCoppeFiltrateEOrdinate()
                      .filter(c => !c.eliminata);

// üî• mostra solo le prime N
const arr = arrCompleto.slice(0, limiteVisibili);  // ‚úÖ NASCONDE LE ELIMINATE

                      aggiornaFedelta(); // üî• aggiorna box fedelt√† in alto


    lista.innerHTML = "";

    if (arr.length === 0) {
        lista.innerHTML = `<p class="empty-msg">Nessuna coppa trovata</p>`;
        return;
    }

    for (const c of arr) {
        const idx = coppe.indexOf(c);
        const nome = c.nome || `Coppa #${idx + 1}`;
        const stellina = c.preferito ? "‚≠ê" : "‚òÜ";

        const gustiText = mostraGustiCompatti(c.gusti || []);
        const granelleText = (c.granelle || []).join(", ");
        const toppingText = (c.topping || []).join(", ");
        const ingredientiText = (c.ingredienti || []).join(", ");

        // üî• EXTRA con prezzo corretto
        function formatExtra(lista) {
            if (!lista || lista.length === 0) return "-";

            return lista.map(nome => {
                const prezzo = prezziExtra[nome] || 0;
                const prezzoTxt = prezzo > 0 ? ` (+‚Ç¨${prezzo.toFixed(2)})` : "";
                return `${nome}${prezzoTxt}`;
            }).join(", ");
        }

const extraText = formatExtra(c.extra);

            const testoDaCopiare = [
                `Formato: ${c.formato || "-"}`,
                `Gusti: ${gustiText}`,
                `Granelle: ${granelleText || "-"}`,
                `Topping: ${toppingText || "-"}`,
                `Ingredienti: ${ingredientiText || "-"}`
            ].join("\n");

            const div = document.createElement("div");
            div.className = "cup-card";
div.innerHTML = `
<div class="cup-title">
  <b 
  class="cup-name"
  data-idx="${idx}"
>
  ${evidenzia(nome)}
</b>


  <div class="cup-actions">
<button class="edit-btn" aria-label="Modifica nome">
<svg viewBox="0 0 24 24" aria-hidden="true">
  <!-- matita -->
  <path d="M16.5 3.5l4 4L8 18.5H4v-4L16.5 3.5z" />

  <!-- linea sotto (staccata) -->
  <path d="M3 21h18" />
</svg>
</button>

<button 
  class="fav-btn ${c.preferito ? 'attiva' : ''}"
  aria-label="Preferito"
  onclick="togglePreferito(${idx})"
>
  <svg viewBox="0 0 24 24" aria-hidden="true">
    <path d="M12 3.5l2.9 5.9 6.6 1-4.8 4.6 1.2 6.6L12 18.8 6.1 21.6l1.2-6.6-4.8-4.6 6.6-1L12 3.5z"/>
  </svg>
</button>

    <button class="delete-btn" aria-label="Elimina">
      <svg viewBox="0 0 24 24">
        <path d="M4 7h16"/>
        <path d="M9 4h6"/>
        <rect x="6" y="7" width="12" height="14" rx="2"/>
        <line x1="10" y1="10" x2="10" y2="18"/>
        <line x1="14" y1="10" x2="14" y2="18"/>
      </svg>
    </button>
  </div>
</div>

${c.coppa_img ? `
  <div class="coppa-thumb-wrapper">
<img
  data-src="${c.coppa_img}"
  class="coppa-thumb"
  onclick="apriCoppaFullscreen('${c.coppa_img}', coppe[${idx}])"
>
  </div>
` : ``}

<div class="cup-content">
<div class="small">${formattaDataBella(c.data)}</div>
<div class="small"><b>Formato:</b> ${evidenzia(c.formato || "")}</div>
<div class="small"><b>Gusti:</b> ${evidenzia(gustiText)}</div>
<div class="small"><b>Granelle:</b> ${evidenzia(granelleText)}</div>
<div class="small"><b>Topping:</b> ${evidenzia(toppingText)}</div>
<div class="small"><b>Ingredienti:</b> ${evidenzia(ingredientiText)}</div>
<div class="small"><b>Extra:</b> ${evidenzia(extraText || "-")}</div>
</div>

 <div class="price">
  Prezzo: ‚Ç¨${(c.prezzo || 0).toFixed(2)}
</div>

<div class="qr-row">
  <button class="show-qr-btn">Mostra QR</button>

  ${c.confermate && c.confermate > 0 ? `
    <span class="badge-confermata">
      ‚úî Confermata${c.confermate > 1 ? ` x${c.confermate}` : ``}
    </span>
  ` : ``}
</div>

<div class="qr-box" id="qr-${idx}" style="
    display:none;
    margin-top:12px;
    text-align:center;
"></div>

    <div class="buttons-row">
        <button class="copy-btn" aria-label="Copia">
  <svg viewBox="0 0 24 24" aria-hidden="true">
    <rect x="7" y="7" width="12" height="12" rx="3"/>
    <rect x="3" y="3" width="12" height="12" rx="3"/>
  </svg>
  <span>Copia</span>
</button>
        <button class="use-btn">Usa questa coppa</button>
    </div>
`;
div.querySelector(".fav-btn").onclick = () => togglePreferito(idx);
div.querySelector(".edit-btn").onclick = () => abilitaRinomina(idx);
div.querySelector(".delete-btn").onclick = () => eliminaCoppa(idx);
            div.querySelector(".copy-btn").onclick = () => copiaTesto(testoDaCopiare);
            div.querySelector(".use-btn").onclick = () => usaQuestaCoppa(idx);
            div.querySelector(".show-qr-btn").onclick = () => {
    const box = document.getElementById(`qr-${idx}`);

    // toggle
    box.style.display = box.style.display === "none" ? "block" : "none";

    // se QR gi√† generato ‚Üí non rigenerare
    if (box.dataset.generated === "1") return;

    if (window.QRCode && c.qr_token) {
        new QRCode(box, {
            text: c.qr_token,
            width: 160,
            height: 160
        });
        box.dataset.generated = "1";
    } else {
        box.innerHTML = "<p style='color:red;'>QR non disponibile</p>";
    }
};

lista.appendChild(div);

// üî• attiva lazy load SOLO per l'immagine di questa card
const img = div.querySelector(".coppa-thumb");
if (img) observeCoppaImg(img);

// ‚õîÔ∏è questa riga NON serve pi√π con il lazy
// await waitAllImages(div);

            // === QR CODE nella cronologia ===
const btn = div.querySelector(".toggle-qr");
const box = div.querySelector(".qr-wrapper");
const qrDiv = div.querySelector(`.qr-code`);

        if (btn) {
            btn.onclick = () => {
                const visible = box.style.display === "block";

                if (visible) {
                    box.style.display = "none";
                    btn.textContent = "Mostra QR";
                } else {
                    box.style.display = "block";
                    btn.textContent = "Nascondi QR";

                    if (window.QRCode && qrDiv && !qrDiv.dataset.generated) {
                        new QRCode(qrDiv, {
                            text: c.qr_token,
                            width: 140,
                            height: 140
                        });
                        qrDiv.dataset.generated = "1";
                    }
                }
            };
        }

    } // ‚úÖ CHIUDE IL for (const c of arr)
// üîΩ BOTTONE "CARICA ALTRE"
if (arrCompleto.length > limiteVisibili) {
  const btnMore = document.createElement("button");
  btnMore.textContent = "Carica altre";
  btnMore.className = "load-more-btn";
  btnMore.style.margin = "20px auto";

  btnMore.onclick = () => {
    limiteVisibili += STEP_CARICAMENTO;
    renderLista();
  };

  lista.appendChild(btnMore);
}
} // ‚úÖ CHIUDE async function renderLista()

document.getElementById("search").addEventListener("input", e => {
  termineRicerca = e.target.value;
  limiteVisibili = STEP_CARICAMENTO; // üî• reset
  renderLista();
});


document.getElementById("toggle-preferiti").addEventListener("click", () => {
  mostraSoloPreferiti = !mostraSoloPreferiti;

  const btn = document.getElementById("toggle-preferiti");

  // ‚≠ê attiva/disattiva SOLO la classe
  btn.classList.toggle("attivo", mostraSoloPreferiti);

  // (opzionale) cambia solo il testo, NON il bottone
  const label = btn.querySelector(".label");
  if (label) {
    label.textContent = mostraSoloPreferiti ? "Mostra tutti" : "Preferiti";
  }
limiteVisibili = STEP_CARICAMENTO;
  renderLista();
});

document.getElementById("ordine-select").addEventListener("change", e => {
    criterioOrdine = e.target.value;
    limiteVisibili = STEP_CARICAMENTO;
    renderLista();
});



// üî• PRIMO RENDER
renderLista();
</script>
<script type="module">
import { supabase } from "./supabase.js";

/* ------------------------------------------
   üî• 1) LEGGE COPPE UTENTE da SUPABASE
---------------------------------------------*/
async function getCoppeSupabaseUtente(email) {
    const guest_id = localStorage.getItem("guest_id");

    let query = supabase
        .from("coppe")
        .select("*")
        .order("id", { ascending: false });

    // (per ora manteniamo la tua or, poi la sistemiamo nel punto 2)
if (email) {
    // üî• Mostra SOLO coppe dell‚Äôemail loggata
    query = query.eq("email", email);
} else {
    // Nessuna email loggata ‚Üí nessuna coppa
    return [];
}

    // üî• filtro: mostra solo coppe NON eliminate
    query = query.or("eliminata.is.null,eliminata.eq.false");

    const { data, error } = await query;

    if (error) {
        console.error("Errore caricamento coppe da Supabase:", error);
        return [];
    }

    return data || [];
}

/* ------------------------------------------
   üî• 2) UNISCE le coppe locali con quelle Supabase
---------------------------------------------*/
async function caricaCoppeComplete() {
    const email = localStorage.getItem("user_email") || null;

    let coppeLocali = JSON.parse(localStorage.getItem("cronologiaCoppe") || "[]");

// üî• FILTRA ANCHE LE COPPE LOCALI per email
coppeLocali = coppeLocali.filter(c => c.email === email);
    let coppeSupabase = [];

    if (email) {
        coppeSupabase = await getCoppeSupabaseUtente(email);
    }

    // FUSIONE locale + remoto
    let unite = [...coppeSupabase, ...coppeLocali];

    // DEDUPLICA CORRETTA
    let finali = dedupCoppe(unite);

    return finali;
}

/* ------------------------------------------
   üî• 3) SOVRASCRIVE l'array ‚Äúcoppe‚Äù DEL TUO JS
---------------------------------------------*/
caricaCoppeComplete().then(all => {
    coppe = all;
    renderLista();
    aggiornaFedelta(); // üî• QUI, SUBITO DOPO renderLista
});

// üî¥ REALTIME: aggiorna cronologia e fedelt√† senza refresh
const emailUtente = localStorage.getItem("user_email");

if (emailUtente) {
    supabase
        .channel("coppe-realtime-cronologia")
        .on(
            "postgres_changes",
            {
                event: "*",
                schema: "public",
                table: "coppe",
                filter: `email=eq.${emailUtente}`
            },
            payload => {
                console.log("üîÑ Coppa aggiornata in realtime:", payload);

                // ricarica dati utente
                caricaCoppeComplete().then(all => {
                    coppe = all;
                    renderLista();
                    aggiornaFedelta();
                });
            }
        )
        .subscribe();
}

function vaiAiCoupon() {
    window.location.href = "profilo.html#coupon";
}

</script>



<script>
document.addEventListener("DOMContentLoaded", () => {
    if (typeof aggiornaCarrelloUI === "function") {
        aggiornaCarrelloUI(); // üî• AGGIORNA ORA il carrello nella pagina cronologia
    }
});
</script>
<script type="module">
import { supabase } from "./supabase.js";

let waitInterval = null;
let collapseTimeout = null;

window.abilitaRinomina = function(idx){
  const card = document.querySelectorAll(".cup-card")[idx];
  if (!card) return;

  const titleEl = card.querySelector(".cup-title b");
  if (!titleEl) return;

  const nomeAttuale = titleEl.textContent.trim();

  // wrapper
  const wrapper = document.createElement("div");
  wrapper.className = "rename-wrapper";

  // input
  const input = document.createElement("input");
  input.type = "text";
  input.value = nomeAttuale;
  input.className = "rename-input";

  // bottone salva ‚úîÔ∏è
  const saveBtn = document.createElement("button");
  saveBtn.className = "rename-save";
  saveBtn.innerHTML = "‚úîÔ∏è";

  wrapper.appendChild(input);
  wrapper.appendChild(saveBtn);

  titleEl.replaceWith(wrapper);
  input.focus();
  input.select();

  // ‚úîÔ∏è salva
  saveBtn.onclick = () => {
    salvaRinomina(idx, input.value, wrapper);
  };

  // ENTER = salva
  input.addEventListener("keydown", e => {
    if (e.key === "Enter") {
      salvaRinomina(idx, input.value, wrapper);
    }
    if (e.key === "Escape") {
      ripristinaTitolo(wrapper, nomeAttuale);
    }
  });
};

function salvaRinomina(idx, valore, wrapper){
  const nuovoNome = valore.trim();
  if (!nuovoNome) {
    ripristinaTitolo(wrapper, coppe[idx].nome || "");
    return;
  }

  rinominaCoppa(idx, nuovoNome);
}

function ripristinaTitolo(wrapper, testo){
  const b = document.createElement("b");
  b.className = "cup-name";
  b.textContent = testo;
  wrapper.replaceWith(b);
}

function expandWaitBar() {
  const full = document.getElementById("wait-full");
  const compact = document.getElementById("wait-compact");

  if (!full || !compact) return;

  full.style.display = "inline";
  compact.style.display = "none";

  clearTimeout(collapseTimeout);
  collapseTimeout = setTimeout(collapseWaitBar, 5000);
}

function collapseWaitBar() {
  const full = document.getElementById("wait-full");
  const compact = document.getElementById("wait-compact");

  if (!full || !compact) return;

  full.style.display = "none";
  compact.style.display = "inline";
}

async function loadWaitTime() {
  const { data, error } = await supabase
    .from("wait_time")
    .select("*")
    .eq("id", 1)
    .single();

  if (error || !data) return;

  const bar = document.getElementById("wait-bar");
  const txt = document.getElementById("wait-time");

  if (!bar || !txt) return;

  // stop eventuale timer precedente
  if (waitInterval) {
    clearInterval(waitInterval);
    waitInterval = null;
  }

  if (!data.active || data.minutes <= 0) {
    bar.style.display = "none";
    return;
  }

  const startTime = new Date(data.updated_at).getTime();
  const totalSeconds = data.minutes * 60;

function tick() {
  const now = Date.now();
  const elapsed = Math.floor((now - startTime) / 1000);
  const remaining = totalSeconds - elapsed;

  if (remaining <= 0) {
    bar.style.display = "none";
    clearInterval(waitInterval);
    waitInterval = null;
    return;
  }

  const min = Math.floor(remaining / 60);
  const sec = remaining % 60;
  const timeStr = `${min}:${sec.toString().padStart(2, "0")}`;

  // üî¢ aggiorna entrambi i testi
  txt.textContent = timeStr;
  document.getElementById("wait-mmss").textContent = timeStr;

  bar.style.display = "flex";

// ‚è±Ô∏è quando inizia un nuovo minuto ‚Üí riapre la barra
if (sec === 59) {
  expandWaitBar();
}
}
  tick(); // ‚è±Ô∏è avvio immediato
  waitInterval = setInterval(tick, 1000);
}

// üî¥ REALTIME WAIT TIME
supabase
  .channel("wait-time-live")
  .on(
    "postgres_changes",
    {
      event: "*",
      schema: "public",
      table: "wait_time"
    },
    payload => {
      console.log("üîÅ wait_time aggiornato realtime:", payload);
      loadWaitTime();
    }
  )
  .subscribe();

document.addEventListener("DOMContentLoaded", loadWaitTime);
</script>


<div id="coppa-overlay" style="
  position: fixed;
  inset: 0;
  background: rgba(0,0,0,0.85);
  display: none;
  align-items: center;
  justify-content: center;
  z-index: 99999;
">
  <img id="coppa-overlay-img" style="
    max-width: 90%;
    max-height: 90%;
    border-radius: 14px;
    box-shadow: 0 10px 40px rgba(0,0,0,0.5);
  ">
<button
  class="overlay-instagram-btn"
  onclick="condividiSuInstagram()"
>
  üì∏ Condividi su Instagram
</button>

  <button id="coppa-overlay-close" style="
    position: absolute;
    top: 20px;
    right: 20px;
    background: rgba(255,255,255,0.15);
    color: white;
    border: none;
    font-size: 22px;
    padding: 8px 14px;
    border-radius: 999px;
    cursor: pointer;
  ">
    ‚úï
  </button>
</div>

<!-- üóëÔ∏è POPUP ELIMINA COPPE -->
<div id="delete-popup" class="popup-overlay" style="display:none;">
  <div class="popup-card">
    <h3>Azione irreversibile!</h3>
    <p>Eliminando perderai tutti i tuoi progressi</p>

    <button class="popup-btn danger" id="popup-elimina-tutte">
      üóë Elimina tutte
    </button>

    <button class="popup-btn star" id="popup-tieni-preferiti">
      ‚≠ê Tieni solo i preferiti
    </button>

    <button class="popup-btn cancel" id="popup-annulla">
      Annulla
    </button>
  </div>
</div>
<script>
document.addEventListener("DOMContentLoaded", () => {
  const popup = document.getElementById("delete-popup");
  const btnOpen = document.getElementById("btn-gestisci-coppe");

  if (!popup || !btnOpen) {
    console.error("Popup o bottone non trovati", { popup, btnOpen });
    return;
  }

  btnOpen.onclick = () => {
    popup.style.display = "flex";
  };

  document.getElementById("popup-annulla").onclick = () => {
    popup.style.display = "none";
  };

  document.getElementById("popup-elimina-tutte").onclick = () => {
    popup.style.display = "none";
    eliminaTutteCoppe();
  };

  document.getElementById("popup-tieni-preferiti").onclick = () => {
    popup.style.display = "none";
    tieniSoloPreferiti();
  };
});
</script>


</body>
</html>



<!-- üç® POPUP INSTAGRAM -->
<div id="popup-instagram" style="
  position: fixed;
  inset: 0;
  background: rgba(0,0,0,0.45);
  display: none;
  align-items: center;
  justify-content: center;
  z-index: 999999;
">
  <div style="
    background: #fff;
    padding: 22px;
    border-radius: 16px;
    max-width: 320px;
    width: 90%;
    text-align: center;
    box-shadow: 0 10px 30px rgba(0,0,0,0.3);
  ">
    <h3 style="margin-bottom:10px;">üì∏ Condividi su Instagram</h3>

    <p style="font-size:14px; line-height:1.4;">
      Condividi la tua coppa su Instagram e tagga  
      <b>@casadelgelato.it</b> üç®
    </p>

    <div style="margin-top:18px; display:flex; gap:10px;">
      <button onclick="chiudiPopupInstagram()"
        style="flex:1; padding:10px; border-radius:10px; border:1px solid #ccc;">
        Annulla
      </button>

      <button onclick="chiudiPopupInstagram(); _eseguiCondivisioneInstagram();"
        style="flex:1; padding:10px; border-radius:10px; border:none;
               background:#ff2d55; color:#fff; font-weight:700;">
        Apri Instagram
      </button>
    </div>
  </div>
</div>



<script>
/* =========================
   üì∏ INSTAGRAM ‚Äì CRONOLOGIA
========================= */

window.condividiSuInstagram = function () {
  const popup = document.getElementById("popup-instagram");
  if (!popup) {
    console.error("popup-instagram non trovato");
    return;
  }
  popup.style.display = "flex";
};

window.chiudiPopupInstagram = function () {
  const popup = document.getElementById("popup-instagram");
  if (popup) popup.style.display = "none";
};


(() => {
  const box = document.getElementById("fedelta-box");
  const spacer = document.getElementById("fedelta-spacer");
  if (!box || !spacer) return;

  let compact = false;

  window.addEventListener("scroll", () => {
    const y = window.scrollY;

    if (y > 120 && !compact) {
const rect = box.getBoundingClientRect();
spacer.style.height = rect.height + "px";
      box.classList.add("compact");
      compact = true;
    }

    if (y < 60 && compact) {
      box.classList.remove("compact");
      spacer.style.height = "0px";
      compact = false;
    }
  }, { passive: true });
})();
</script>

<script>
async function generaCoppaInstagramStory(stageEl) {
  if (!stageEl) return null;

  const canvas = document.createElement("canvas");
  canvas.width = 1080;
  canvas.height = 1920;
  const ctx = canvas.getContext("2d");

  // sfondo bianco
  ctx.fillStyle = "#ffffff";
  ctx.fillRect(0, 0, canvas.width, canvas.height);

  const coppaCanvas = await html2canvas(stageEl, {
    backgroundColor: null,
    scale: 2,
    useCORS: true
  });

  // üî• NO ZOOM (questa √® la chiave)
  const scale =
    Math.min(
      canvas.width / coppaCanvas.width,
      canvas.height / coppaCanvas.height
    ) * 0.85;

  const w = coppaCanvas.width * scale;
  const h = coppaCanvas.height * scale;

  ctx.drawImage(
    coppaCanvas,
    (canvas.width - w) / 2,
    (canvas.height - h) / 2,
    w,
    h
  );

  return new Promise(res =>
    canvas.toBlob(blob => res(blob), "image/png")
  );
}
</script>

<script>
window._eseguiCondivisioneInstagram = async function () {

  const img = document.getElementById("coppa-overlay-img");
  if (!img || !img.src) {
    alert("Coppa non disponibile");
    return;
  }

  // contenitore invisibile
  const temp = document.createElement("div");
  temp.style.position = "fixed";
  temp.style.left = "-9999px";

  const clone = document.createElement("img");
  clone.src = img.src;
  clone.style.maxWidth = "560px";

  temp.appendChild(clone);
  document.body.appendChild(temp);

  await new Promise(r => clone.onload = r);

  const blob = await generaCoppaInstagramStory(temp);
  document.body.removeChild(temp);

  if (!blob) {
    alert("Errore creazione immagine");
    return;
  }

  const file = new File([blob], "coppa-instagram.png", {
    type: "image/png"
  });

  // ‚úÖ SOLO SHARE ‚Äî NO DOWNLOAD
  if (navigator.share && navigator.canShare?.({ files: [file] })) {
    await navigator.share({
      files: [file],
      title: "Guarda la coppa che ho creato da Casa Del Gelato! üç®"
    });
  } else {
    alert("Apri Instagram e carica l‚Äôimmagine manualmente");
  }
};
</script>

<!-- ‚ò∞ MENU -->
<button id="menu-btn" style="
  position:fixed;
  top:14px;
  left:14px;
  width:36px;
  height:36px;
  border:none;
  border-radius:10px;
  background:#f2f2f7;
  font-size:20px;
  z-index:10001;
">
‚ò∞
</button>

<div id="menu-overlay" style="
  position:fixed;
  inset:0;
  background:rgba(0,0,0,0.35);
  opacity:0;
  pointer-events:none;
  transition:.25s;
  z-index:10000;
"></div>

<div id="menu-dropdown" style="
  position:fixed;
  top:60px;
  left:14px;
  width:220px;
  background:#fff;
  border-radius:14px;
  box-shadow:0 12px 30px rgba(0,0,0,0.25);
  padding:10px;
  opacity:0;
  pointer-events:none;
  transform:translateY(-10px);
  transition:.25s;
  z-index:10002;
">
<a href="crea-coppa.html" class="menu-item menu-new-only">
  <span class="badge-new-left">NEW</span>
  <span>Crea Coppa</span>
</a>
<a href="home.html" class="menu-item">
  <svg class="menu-icon" viewBox="0 0 24 24" aria-hidden="true">
    <path d="M3 11.5L12 4l9 7.5" />
    <path d="M5 10.5V20a1 1 0 0 0 1 1h4v-6h4v6h4a1 1 0 0 0 1-1v-9.5" />
  </svg>
  <span>Home</span>
</a>
  <a href="menu.html" class="menu-item">
  <svg class="menu-icon" viewBox="0 0 24 24" aria-hidden="true">
    <rect x="6" y="4" width="12" height="16" rx="2"
          fill="none" stroke="currentColor" stroke-width="2"/>
    <line x1="9" y1="9" x2="15" y2="9"
          stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
    <line x1="9" y1="13" x2="15" y2="13"
          stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
    <line x1="9" y1="17" x2="13" y2="17"
          stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
  </svg>
  <span>Menu</span>
</a>
<a href="profilo.html" class="menu-item">
  <svg class="menu-icon" viewBox="0 0 24 24" aria-hidden="true">
    <path d="M12 12c2.761 0 5-2.239 5-5S14.761 2 12 2 7 4.239 7 7s2.239 5 5 5zm0 2c-4.418 0-8 2.239-8 5v1h16v-1c0-2.761-3.582-5-8-5z"/>
  </svg>
  <span>Profilo</span>
</a>
<a href="info-contatti.html" class="menu-item">
  <svg class="menu-icon" viewBox="0 0 24 24" aria-hidden="true">
    <!-- CERCHIO -->
    <circle
      cx="12"
      cy="12"
      r="9"
      fill="none"
      stroke="currentColor"
      stroke-width="2"
    />

    <!-- PALLINO DELLA i -->
    <circle
      cx="12"
      cy="8"
      r="0.5"
      fill="currentColor"
    />

    <!-- STELO DELLA i -->
    <line
      x1="12"
      y1="11"
      x2="12"
      y2="17"
      stroke="currentColor"
      stroke-width="2.2"
      stroke-linecap="round"
    />
  </svg>
  <span>Info &amp; Contatti</span>
</a>
<a href="lavora-con-noi.html" class="menu-item">
  <svg class="menu-icon" viewBox="0 0 24 24" aria-hidden="true">
    <!-- corpo valigetta -->
    <rect x="3" y="7" width="18" height="13" rx="2"
          fill="none" stroke="currentColor" stroke-width="2"/>
    <!-- manico -->
    <path d="M9 7V5a3 3 0 0 1 6 0v2"
          fill="none" stroke="currentColor" stroke-width="2"
          stroke-linecap="round"/>
  </svg>
  <span>Lavora con noi</span>
</a>
</div>
<script>
  const menuBtn = document.getElementById("menu-btn");
  const menu = document.getElementById("menu-dropdown");
  const overlay = document.getElementById("menu-overlay");

  function openMenu(){
    menu.classList.add("open");
    menu.style.opacity = "1";
    menu.style.pointerEvents = "auto";
    menu.style.transform = "translateY(0)";

    overlay.style.opacity = "1";
    overlay.style.pointerEvents = "auto";
  }

  function closeMenu(){
    menu.classList.remove("open");
    menu.style.opacity = "0";
    menu.style.pointerEvents = "none";
    menu.style.transform = "translateY(-10px)";

    overlay.style.opacity = "0";
    overlay.style.pointerEvents = "none";
  }

  if (menuBtn && menu && overlay) {

    menuBtn.addEventListener("click", () => {
      const isOpen = menu.classList.contains("open");
      isOpen ? closeMenu() : openMenu();
    });

    overlay.addEventListener("click", closeMenu);

    // ESC per chiudere
    document.addEventListener("keydown", (e) => {
      if (e.key === "Escape") closeMenu();
    });

    // chiude quando clicchi un link
    menu.querySelectorAll("a").forEach(a => {
      a.addEventListener("click", closeMenu);
    });
  }
</script>
</body>
</html>