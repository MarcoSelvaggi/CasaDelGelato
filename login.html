<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Accedi - Casa del Gelato</title>
<link rel="stylesheet" href="bottom-nav.css">
<script src="global.js"></script>


<!-- Import Supabase -->
<script type="module">
    import { supabase } from "./supabase.js";
    window.supabase = supabase; // lo rendo disponibile allo script sotto
</script>

<style>
    body {
        font-family: system-ui, -apple-system, sans-serif;
        background: #f6f6f7;
        margin: 0;
        padding: 0;
        text-align: center;
    }

    h1 {
        margin-top: 40px;
        font-size: 28px;
        color: #333;
    }

    .container {
        background: white;
        margin: 20px auto;
        padding: 20px;
        border-radius: 14px;
        max-width: 360px;
        box-shadow: 0 4px 12px rgba(0,0,0,0.08);
    }

    input {
        width: 90%;
        padding: 12px;
        margin: 10px 0;
        border-radius: 10px;
        border: 1px solid #ccc;
        font-size: 16px;
    }

    button {
        width: 94%;
        padding: 12px;
        background: #ff7a00;
        border: none;
        border-radius: 12px;
        color: white;
        font-size: 17px;
        font-weight: 600;
        margin-top: 10px;
        cursor: pointer;
    }
    .checkbox-row{
  display:flex;
  align-items:center;
  gap:10px;
  margin: 14px 0 6px;
  font-size:14px;
  color:#555;
  text-align:left;
}

.checkbox-row input{
  width:18px;
  height:18px;
  accent-color:#ff7a00;
  cursor:pointer;
}
.menu-item{
  display:block;
  padding:10px 12px;
  border-radius:10px;
  font-weight:600;
  font-size:14px;
  color:#111;
  text-decoration:none;
}
.menu-item:hover{
  background:#f2f2f7;
}


/* BACKDROP */
.popup-backdrop{
  position: fixed;
  inset: 0;
  background: rgba(0,0,0,.4);
  display: flex;
  align-items: center;
  justify-content: center;
  opacity: 0;
  pointer-events: none;
  transition: opacity .25s ease;
  z-index: 99999;
}

/* visibile */
.popup-backdrop.show{
  opacity: 1;
  pointer-events: auto;
}

/* CARD */
.popup-card{
  background: #fff;
  border-radius: 18px;
  padding: 22px;
  width: 90%;
  max-width: 360px;
  text-align: center;
  box-shadow: 0 10px 30px rgba(0,0,0,.25);
  animation: popupIn .3s ease;
}

@keyframes popupIn{
  from{
    transform: translateY(20px) scale(.95);
    opacity: 0;
  }
  to{
    transform: translateY(0) scale(1);
    opacity: 1;
  }
}

.popup-card h2{
  margin: 0 0 10px;
  font-size: 20px;
  font-weight: 800;
}

.popup-card p{
  font-size: 15px;
  color: #555;
  line-height: 1.4;
}

.popup-btn{
  margin-top: 16px;
  width: 100%;
  padding: 12px;
  border: none;
  border-radius: 14px;
  background: #007aff;
  color: white;
  font-size: 16px;
  font-weight: 700;
  cursor: pointer;
}
/* üîÅ RESEND EMAIL */
.resend-btn{
  display: block;
  margin: 10px auto 0;      /* üî• centrato */
  padding: 8px 14px;        /* üî• pi√π piccolo */
  width: auto;              /* non full width */
  
  background: #007aff;
  color: #fff;

  border: none;
  border-radius: 999px;     /* pill iOS */
  font-size: 13px;
  font-weight: 700;

  cursor: pointer;
  box-shadow: 0 4px 12px rgba(0,122,255,0.35);
}

.resend-btn:active{
  background: #005fcc;
  transform: scale(0.96);
}

/* ===== PASSWORD IDENTICO AGLI ALTRI INPUT ===== */

.password-wrap{
  position: relative;
  width: 100%;
}

/* INPUT PASSWORD = CLONE PERFETTO */
.password-wrap input{
  width: 97%;
  margin: 10px 0;        /* IDENTICO agli altri */
  padding: 12px;
  border-radius: 10px;
  border: 1px solid #ccc;
  font-size: 16px;
  box-sizing: border-box;
  padding-right: 44px;  /* spazio occhio */
}

/* üëÅÔ∏è OCCHIO */
.toggle-password{
  position: absolute;
  right: 14px;              /* attaccato a destra */
  top: 50%;
  transform: translateY(-95%);
  width: 20px;              /* üî• BLOCCA la larghezza */
  height: 20px;             /* üî• BLOCCA l‚Äôaltezza */
  padding: 0;
  background: none;
  border: none;
  cursor: pointer;
}

.toggle-password svg{
  width: 20px;
  height: 20px;
  stroke: #888;
  fill: none;
  stroke-width: 2;
}
/* üëÅÔ∏è ICONA OCCHIO ‚Äì FIX DEFINITIVO */
.eye-icon{
  width: 20px;
  height: 20px;

  fill: none !important;          /* ‚õî BLOCCA il nero */
  stroke: #888;                   /* colore giusto */
  stroke-width: 2;

  display: block;
  pointer-events: none;           /* click passa al bottone */
}

/* hover leggero */
.toggle-password:hover .eye-icon{
  stroke: #111;
}
.eye-slash{
  stroke: #888;
  stroke-width: 2;
  display: none;
}

/* quando password √® visibile */
.toggle-password.show .eye-slash{
  display: block;
}
/* üîê INPUT POPUP PASSWORD DIMENTICATA */
#forgot-email{
  width: 100%;
  padding: 12px;
  margin: 12px 0 4px;
  border-radius: 10px;
  border: 1px solid #ccc;
  font-size: 16px;
  box-sizing: border-box;
}
#forgot-email:focus{
  outline: none;
  border-color: #007aff;
  box-shadow: 0 0 0 3px rgba(0,122,255,.15);
}
</style>

</head>
<body>

 <a href="profilo.html" 
   style="
       position: absolute;
       top: 15px;
       left: 15px;
       padding: 8px 14px;
       background: #f0f0f0;
       border-radius: 10px;
       color: #333;
       text-decoration: none;
       font-size: 16px;
       display: flex;
       align-items: center;
       gap: 6px;
       box-shadow: 0 1px 4px rgba(0,0,0,0.15);
   ">
    ‚Üê Indietro
</a>   

<h1 id="page-title">Accedi</h1>

<!-- üîê LOGIN -->
<div class="container" id="login-box">
  <input type="email" id="login-email" placeholder="Email" required>

  <!-- üîí Password -->
<div class="password-wrap">
<input
  type="password"
  id="login-password"
  placeholder="Password"
  required
>

  <button
    type="button"
    class="toggle-password"
    onclick="togglePassword('login-password', this)"
    aria-label="Mostra password"
  >
    <!-- üëÅÔ∏è ICONA SVG CLASSICA -->
<svg viewBox="0 0 24 24" class="eye-icon">
  <path d="M1 12s4-7 11-7 11 7 11 7-4 7-11 7S1 12 1 12z"/>
  <circle cx="12" cy="12" r="3"/>
  <!-- linea sbarrata -->
  <line x1="3" y1="3" x2="21" y2="21" class="eye-slash"/>
</svg>
  </button>
</div>

  <button onclick="login()">Continua</button>

  <p style="margin-top:10px;font-size:14px">
  <a
    href="#"
    onclick="openForgotPassword()"
    style="color:#007aff;text-decoration:none;font-weight:600"
  >
    Password dimenticata?
  </a>
</p>

<button
  id="resend-confirm-btn"
  class="resend-btn"
  style="display:none;"
>
  Invia di nuovo email di conferma
</button>

    <p style="margin-top:14px;font-size:14px">
      Non hai un account?
      <a href="login.html?mode=register">Registrati</a>
    </p>
</div>

<!-- üìù REGISTRAZIONE -->
<div class="container" id="register-box" style="display:none">
    <input type="text" id="reg-name" placeholder="Nome" required>
    <input type="text" id="reg-surname" placeholder="Cognome" required>
    <input type="email" id="reg-email" placeholder="Email" required>
<div class="password-wrap">
  <input
    type="password"
    id="reg-password"
    placeholder="Password"
    required
  >

  <button
    type="button"
    class="toggle-password"
    onclick="togglePassword('reg-password', this)"
    aria-label="Mostra password"
  >
    <!-- üëÅÔ∏è ICONA SVG CLASSICA -->
<svg viewBox="0 0 24 24" class="eye-icon">
  <path d="M1 12s4-7 11-7 11 7 11 7-4 7-11 7S1 12 1 12z"/>
  <circle cx="12" cy="12" r="3"/>
  <!-- linea sbarrata -->
  <line x1="3" y1="3" x2="21" y2="21" class="eye-slash"/>
</svg>
  </button>
</div>

<div class="password-wrap">
  <input
    type="password"
    id="reg-password-confirm"
    placeholder="Conferma password"
    required
  >

  <button
    type="button"
    class="toggle-password"
    onclick="togglePassword('reg-password-confirm', this)"
    aria-label="Mostra password"
  >
    <svg viewBox="0 0 24 24" class="eye-icon">
      <path d="M1 12s4-7 11-7 11 7 11 7-4 7-11 7S1 12 1 12z"/>
      <circle cx="12" cy="12" r="3"/>
      <line x1="3" y1="3" x2="21" y2="21" class="eye-slash"/>
    </svg>
  </button>
</div>
    <!-- ‚úÖ CONSENSO PROMO (OPZIONALE) -->
    <label class="checkbox-row">
      <input type="checkbox" id="consenso-promozioni">
      <span>Acconsento a ricevere promozioni e comunicazioni</span>
    </label>
        <!-- üîí PRIVACY (OBBLIGATORIA) -->
    <label class="checkbox-row">
      <input type="checkbox" id="privacy-consent">
      <span>
        Accetto la
        <a href="privacy.html" target="_blank">Privacy Policy</a>
        e il trattamento dei dati personali
      </span>
    </label>
    <button onclick="register()">Registrati</button>

    <p style="margin-top:14px;font-size:14px">
      Hai gi√† un account?
      <a href="login.html">Accedi</a>
    </p>
</div>
<!-- üîÅ SWITCH ACCEDI / REGISTRATI -->
<script>
document.addEventListener("DOMContentLoaded", () => {
  const params = new URLSearchParams(window.location.search);
  const mode = params.get("mode");

  const loginBox = document.getElementById("login-box");
  const registerBox = document.getElementById("register-box");
  const title = document.getElementById("page-title");

  if (!loginBox || !registerBox || !title) return;

  if (mode === "register") {
    loginBox.style.display = "none";
    registerBox.style.display = "block";
    title.textContent = "Registrati";
  } else {
    loginBox.style.display = "block";
    registerBox.style.display = "none";
    title.textContent = "Accedi";
  }
});
</script>
<!-- Script di login con controllo Supabase -->
<script type="module">
import { supabase } from "./supabase.js";


window.mostraPopup = function (titolo, messaggio, redirect = null) {
  document.getElementById("popup-title").textContent = titolo;
  document.getElementById("popup-message").textContent = messaggio;

  const backdrop = document.getElementById("popup-backdrop");
  backdrop.classList.add("show");

  document.body.style.overflow = "hidden";

  // salva redirect opzionale
  backdrop.dataset.redirect = redirect || "";
};

window.chiudiPopup = function () {
  const backdrop = document.getElementById("popup-backdrop");
  backdrop.classList.remove("show");

  document.body.style.overflow = "";

  const redirect = backdrop.dataset.redirect;
  if (redirect) {
    window.location.href = redirect;
  }
};

window.login = async function () {
  const email = document.getElementById("login-email").value.trim();
  const currentEmail = localStorage.getItem("user_email");
  const alreadyLogged = localStorage.getItem("userLogged") === "1";

if (!email) {
  mostraPopup(
    "Email mancante",
    "Inserisci una email valida per poter continuare."
  );
  return;
}

if (alreadyLogged && currentEmail === email) {
  mostraPopup(
    "Sei gi√† connesso",
    "Hai gi√† effettuato l‚Äôaccesso con questa email."
  );
  return;
}

  // 1Ô∏è‚É£ Controllo se l'utente esiste
  const { data, error } = await supabase
    .from("utenti")
    .select("*")
    .eq("email", email)
    .single();

// email non trovata
if (error && error.code === "PGRST116") {
  mostraPopup(
    "Email non registrata",
    "Questa email non risulta registrata.\n\nCrea un account per continuare."
  );
  return;
}

  if (error) {
    alert("Errore Supabase: " + error.message);
    return;
  }

// üîí email NON confermata
if (!data.email_confermata) {

  mostraPopup(
    "Email non confermata",
    "Per accedere devi prima confermare la tua email.\n\nControlla la posta oppure inviala di nuovo."
  );

  // ‚úÖ mostra bottone resend
  const resendBtn = document.getElementById("resend-confirm-btn");
  if (resendBtn) {
    resendBtn.style.display = "block";
    resendBtn.dataset.email = data.email;
    resendBtn.dataset.token = data.conferma_token;
  }

  return;
}

  // utente disiscritto
if (data.disiscritto === true) {
  mostraPopup(
    "Account disiscritto",
    "Questa email √® stata disiscritta.Registrati nuovamente per continuare.",
    "login.html?mode=register"
  );
  return;
}

// üîê VERIFICA PASSWORD
try {
  const res = await fetch(
    "https://casa-del-gelato-mailer-kg7f.vercel.app/api/verify-password",
    {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({
        password: document.getElementById("login-password").value,
        password_hash: data.password_hash
      })
    }
  );

  const result = await res.json();

  if (!result.ok) {
    mostraPopup(
      "Password errata",
      "La password inserita non √® corretta."
    );
    return;
  }

} catch (err) {
  console.error(err);
  mostraPopup(
    "Errore",
    "Errore durante la verifica della password."
  );
  return;
}

  // 2Ô∏è‚É£ LOGIN OK
  localStorage.setItem("user_email", data.email);
localStorage.setItem("user_name", data.nome || "");
localStorage.setItem("user_surname", data.cognome || "");
  localStorage.setItem("userLogged", "1");

  // üîó COLLEGA COPPE CREATE DA OSPITE (DOPO LOGIN OK)
  const guest_id = localStorage.getItem("guest_id");

  if (guest_id) {
    const { error: linkErr } = await supabase
      .from("coppe")
      .update({ email: data.email })
      .eq("guest_id", guest_id)
      .is("email", null);

    if (linkErr) {
      console.error("Errore collegamento coppe guest:", linkErr);
    }
  }

mostraPopup(
  "Accesso effettuato",
  "Ora puoi accedere a coupon, storico e notifiche.",
  "profilo.html"
);
return;
};

window.register = async function () {
  const email = document.getElementById("reg-email").value.trim();
  const name = document.getElementById("reg-name").value.trim();
  const surname = document.getElementById("reg-surname").value.trim();
  const password = document.getElementById("reg-password").value;
  const passwordConfirm = document.getElementById("reg-password-confirm").value;

  const consenso = document.getElementById("consenso-promozioni")?.checked === true;
  const privacyAccepted = document.getElementById("privacy-consent")?.checked;

  /* üîí PRIVACY */
  if (!privacyAccepted) {
    mostraPopup(
      "Privacy obbligatoria",
      "Per registrarti devi accettare la Privacy Policy."
    );
    return;
  }

  /* ‚ùå CAMPI */
  if (!email || !name || !surname || !password || !passwordConfirm) {
    mostraPopup(
      "Campi mancanti",
      "Compila tutti i campi per completare la registrazione."
    );
    return;
  }

  /* üîê PASSWORD */
  if (password !== passwordConfirm) {
    mostraPopup(
      "Password diverse",
      "Le password inserite non coincidono."
    );
    return;
  }

  if (password.length < 6) {
    mostraPopup(
      "Password troppo corta",
      "La password deve contenere almeno 6 caratteri."
    );
    return;
  }

  /* 1Ô∏è‚É£ UTENTE ESISTENTE? */
const { data: existing, error } = await supabase
  .from("utenti")
  .select("email, email_confermata")
  .eq("email", email)
  .maybeSingle();

if (error) {
  mostraPopup("Errore", "Errore durante il controllo email.");
  return;
}

if (existing) {
  if (!existing.email_confermata) {
    mostraPopup(
      "Email gi√† registrata",
      "Questa email √® gi√† registrata ma non confermata.\nControlla la posta."
    );
    return;
  }

  mostraPopup(
    "Email gi√† registrata",
    "Questa email √® gi√† registrata.\nAccedi per continuare.",
    "login.html"
  );
  return;
}

  /* 2Ô∏è‚É£ HASH PASSWORD (API) */
  let password_hash;

  try {
    const res = await fetch(
      "https://casa-del-gelato-mailer-kg7f.vercel.app/api/hash-password",
      {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ password })
      }
    );

    const data = await res.json();
    password_hash = data.password_hash;

    if (!password_hash) throw new Error("Hash non generato");

  } catch (err) {
    console.error(err);
    mostraPopup(
      "Errore sicurezza",
      "Impossibile proteggere la password. Riprova pi√π tardi."
    );
    return;
  }

  /* 3Ô∏è‚É£ CREA UTENTE */
  const token = crypto.randomUUID();

const { error: insErr } = await supabase
  .from("utenti")
  .insert({
    email,
    nome: name,
    cognome: surname,
    password_hash,
    disiscritto: false,
    consenso_promozioni: consenso,
    privacy_accepted: true,
    privacy_accepted_at: new Date().toISOString(),
    email_confermata: false,
    conferma_token: token
  });

if (insErr) {
  if (insErr.message.includes("duplicate")) {
    mostraPopup(
      "Email gi√† registrata",
      "Questa email √® gi√† registrata.\nAccedi per continuare.",
      "login.html"
    );
  } else {
    mostraPopup("Errore", "Errore durante la registrazione.");
  }
  return;
}

  /* 4Ô∏è‚É£ INVIO EMAIL */
  try {
    await fetch(
      "https://casa-del-gelato-mailer-kg7f.vercel.app/api/conferma-email",
      {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ email, token })
      }
    );
  } catch (err) {
    console.error(err);
  }

  mostraPopup(
"üìß Conferma email",
"Ti abbiamo inviato una mail di conferma.\nDopo la conferma potrai accedere.\n(Controlla anche lo Spam)",
"login.html"
);
};
</script>





<!-- üîî POPUP GENERICO -->
<div id="popup-backdrop" class="popup-backdrop">
  <div class="popup-card">
    <h2 id="popup-title">Titolo</h2>
    <p id="popup-message">Messaggio</p>

    <button class="popup-btn" onclick="chiudiPopup()">
      OK
    </button>
  </div>
</div>

<script type="module">
import { supabase } from "./supabase.js";

const resendBtn = document.getElementById("resend-confirm-btn");

if (resendBtn) {
  resendBtn.addEventListener("click", async () => {
    const email = resendBtn.dataset.email;
    let token = resendBtn.dataset.token;

    if (!email) {
      mostraPopup("Errore", "Email non disponibile.");
      return;
    }

    // üîÅ se manca token ‚Üí rigenera
    if (!token) {
      token = crypto.randomUUID();

      await supabase
        .from("utenti")
        .update({ conferma_token: token })
        .eq("email", email);
    }

    try {
      await fetch(
        "https://casa-del-gelato-mailer-kg7f.vercel.app/api/conferma-email",
        {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ email, token })
        }
      );

      mostraPopup(
        "Email inviata",
        "Ti abbiamo inviato nuovamente l‚Äôemail di conferma.\n\nControlla anche lo spam."
      );

      resendBtn.style.display = "none";

    } catch (err) {
      console.error(err);
      mostraPopup(
        "Errore",
        "Non √® stato possibile inviare l‚Äôemail. Riprova pi√π tardi."
      );
    }
  });
}
</script>

<script>
function togglePassword(inputId, btn){
  const input = document.getElementById(inputId);
  if (!input) return;

  const svg = btn.querySelector("svg");
  const slash = svg.querySelector(".eye-slash");

  if (input.type === "password") {
    // üëâ MOSTRO password
    input.type = "text";
    slash.style.display = "none";   // ‚ùå niente barra
  } else {
    // üëâ NASCONDO password
    input.type = "password";
    slash.style.display = "block";  // ‚úÖ barra visibile
  }
}
</script>

<script>
document.addEventListener("DOMContentLoaded", () => {
  document.querySelectorAll(".password-wrap input").forEach(input => {
    if (input.type === "password") {
      const btn = input.closest(".password-wrap")
        ?.querySelector(".toggle-password");
      const slash = btn?.querySelector(".eye-slash");
      if (slash) slash.style.display = "block"; // üëÅÔ∏è SBARRATO DI DEFAULT
    }
  });
});
</script>

<script>
function openForgotPassword(){
  document.getElementById("forgot-backdrop").classList.add("show");
  document.body.style.overflow = "hidden";
}

function closeForgotPassword(){
  document.getElementById("forgot-backdrop").classList.remove("show");
  document.body.style.overflow = "";
}

window.inviaResetPassword = async function () {
  const email = document.getElementById("forgot-email").value.trim();

  if (!email) {
    mostraPopup("Email mancante", "Inserisci una email valida.");
    return;
  }

  // 1Ô∏è‚É£ verifica utente
  const { data, error } = await supabase
    .from("utenti")
    .select("email")
    .eq("email", email)
    .single();

  if (error) {
    mostraPopup(
      "Email non trovata",
      "Questa email non risulta registrata."
    );
    return;
  }

  // 2Ô∏è‚É£ genera token
  const token = crypto.randomUUID();

await supabase
  .from("utenti")
  .update({
    reset_token: token,
    reset_token_expires_at: new Date(Date.now() + 1000 * 60 * 30).toISOString()
  })
  .eq("email", email);

  // 3Ô∏è‚É£ invio email
  await fetch(
    "https://casa-del-gelato-mailer-kg7f.vercel.app/api/reset-password-email",
    {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ email, token })
    }
  );

  closeForgotPassword();

  mostraPopup(
    "Email inviata",
    "Ti abbiamo inviato un link per reimpostare la password."
  );
};
</script>
<!-- üîê PASSWORD DIMENTICATA -->
<div id="forgot-backdrop" class="popup-backdrop">
  <div class="popup-card">
    <h2>Password dimenticata</h2>
    <p>Inserisci la tua email. Ti invieremo un link per reimpostare la password.</p>

    <input
      type="email"
      id="forgot-email"
      placeholder="Email"
    >

   <button class="popup-btn" onclick="inviaResetPassword()">
      Invia link
    </button>

    <button
      class="popup-btn"
      style="background:#f2f2f7;color:#111;margin-top:10px"
      onclick="closeForgotPassword()"
    >
      Annulla
    </button>
  </div>
</div>

</body>
</html>