<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Accedi - Casa del Gelato</title>
<link rel="stylesheet" href="bottom-nav.css">
<script src="global.js"></script>


<!-- Import Supabase -->
<script type="module">
    import { supabase } from "./supabase.js";
    window.supabase = supabase; // lo rendo disponibile allo script sotto
</script>

<style>
    body {
        font-family: system-ui, -apple-system, sans-serif;
        background: #f6f6f7;
        margin: 0;
        padding: 0;
        text-align: center;
    }

    h1 {
        margin-top: 40px;
        font-size: 28px;
        color: #333;
    }

    .container {
        background: white;
        margin: 20px auto;
        padding: 20px;
        border-radius: 14px;
        max-width: 360px;
        box-shadow: 0 4px 12px rgba(0,0,0,0.08);
    }

    input {
        width: 90%;
        padding: 12px;
        margin: 10px 0;
        border-radius: 10px;
        border: 1px solid #ccc;
        font-size: 16px;
    }

    button {
        width: 94%;
        padding: 12px;
        background: #ff7a00;
        border: none;
        border-radius: 12px;
        color: white;
        font-size: 17px;
        font-weight: 600;
        margin-top: 10px;
        cursor: pointer;
    }
    .checkbox-row{
  display:flex;
  align-items:center;
  gap:10px;
  margin: 14px 0 6px;
  font-size:14px;
  color:#555;
  text-align:left;
}

.checkbox-row input{
  width:18px;
  height:18px;
  accent-color:#ff7a00;
  cursor:pointer;
}
.menu-item{
  display:block;
  padding:10px 12px;
  border-radius:10px;
  font-weight:600;
  font-size:14px;
  color:#111;
  text-decoration:none;
}
.menu-item:hover{
  background:#f2f2f7;
}
</style>

</head>
<body>

 <a href="profilo.html" 
   style="
       position: absolute;
       top: 15px;
       left: 15px;
       padding: 8px 14px;
       background: #f0f0f0;
       border-radius: 10px;
       color: #333;
       text-decoration: none;
       font-size: 16px;
       display: flex;
       align-items: center;
       gap: 6px;
       box-shadow: 0 1px 4px rgba(0,0,0,0.15);
   ">
    ‚Üê Indietro
</a>   

<h1 id="page-title">Accedi</h1>

<!-- üîê LOGIN -->
<div class="container" id="login-box">
    <input type="email" id="login-email" placeholder="Email" required>
    <input type="text" id="login-name" placeholder="Nome (opzionale)">
    <input type="text" id="login-surname" placeholder="Cognome (opzionale)">

    <button onclick="login()">Continua</button>

    <p style="margin-top:14px;font-size:14px">
      Non hai un account?
      <a href="login.html?mode=register">Registrati</a>
    </p>
</div>

<!-- üìù REGISTRAZIONE -->
<div class="container" id="register-box" style="display:none">
    <input type="email" id="reg-email" placeholder="Email" required>
    <input type="text" id="reg-name" placeholder="Nome" required>
    <input type="text" id="reg-surname" placeholder="Cognome" required>
    <!-- ‚úÖ CONSENSO PROMO (OPZIONALE) -->
    <label class="checkbox-row">
      <input type="checkbox" id="consenso-promozioni">
      <span>Acconsento a ricevere promozioni e comunicazioni</span>
    </label>
    <button onclick="register()">Registrati</button>

    <p style="margin-top:14px;font-size:14px">
      Hai gi√† un account?
      <a href="login.html">Accedi</a>
    </p>
</div>
<!-- üîÅ SWITCH ACCEDI / REGISTRATI -->
<script>
document.addEventListener("DOMContentLoaded", () => {
  const params = new URLSearchParams(window.location.search);
  const mode = params.get("mode");

  const loginBox = document.getElementById("login-box");
  const registerBox = document.getElementById("register-box");
  const title = document.getElementById("page-title");

  if (!loginBox || !registerBox || !title) return;

  if (mode === "register") {
    loginBox.style.display = "none";
    registerBox.style.display = "block";
    title.textContent = "Registrati";
  } else {
    loginBox.style.display = "block";
    registerBox.style.display = "none";
    title.textContent = "Accedi";
  }
});
</script>
<!-- Script di login con controllo Supabase -->
<script type="module">
import { supabase } from "./supabase.js";

window.login = async function() {
const email = document.getElementById("login-email").value.trim();
const currentEmail = localStorage.getItem("user_email");
const alreadyLogged = localStorage.getItem("userLogged") === "1";

if (alreadyLogged && currentEmail === email) {
    alert("‚úÖ Accesso gi√† effetuato con questa email.");
    return;
}
const name  = document.getElementById("login-name").value.trim();
const surname = document.getElementById("login-surname").value.trim();

    if (!email) {
        alert("Inserisci una email valida.");
        return;
    }

    // 1Ô∏è‚É£ Controllo se l'utente esiste
    const { data, error } = await supabase
        .from("utenti")
        .select("*")
        .eq("email", email)
        .single();

    if (error && error.code === "PGRST116") {
        alert("‚ùå Email non registrata.\nRegistrati per continuare.");
        return;
    }

    if (error) {
        alert("Errore Supabase: " + error.message);
        return;
    }

    // 2Ô∏è‚É£ Controllo se √® disiscritto
    if (data.disiscritto === true) {
        alert("‚ùå Questa email √® stata disiscritta.\nRegistrati nuovamente per continuare.");
        return;
    }

    // 3Ô∏è‚É£ Login accettato
    localStorage.setItem("user_email", data.email);
    localStorage.setItem("user_name", name || data.nome || "");
    localStorage.setItem("user_surname", surname || data.cognome || "");
    localStorage.setItem("userLogged", "1");

    alert("Accesso effettuato!");
    window.location.href = "index.html";
};

window.register = async function() {
  const email = document.getElementById("reg-email").value.trim();
  const name = document.getElementById("reg-name").value.trim();
  const surname = document.getElementById("reg-surname").value.trim();
  const consenso = document.getElementById("consenso-promozioni")?.checked === true;

  if (!email || !name || !surname) {
    alert("Compila tutti i campi.");
    return;
  }

  // 1Ô∏è‚É£ Controlla se esiste gi√†
  const { data: existing, error } = await supabase
    .from("utenti")
    .select("*")
    .eq("email", email)
    .single();

  // errore vero
  if (error && error.code !== "PGRST116") {
    alert("Errore: " + error.message);
    return;
  }

  // 2Ô∏è‚É£ ESISTE ED √à ATTIVO ‚Üí BLOCCA
  if (existing && existing.disiscritto === false) {
    alert("Questa email √® gi√† registrata. Accedi.");
    return;
  }

  // 3Ô∏è‚É£ ESISTE MA ERA DISISCRITTO ‚Üí RIATTIVA + aggiorna consenso
  if (existing && existing.disiscritto === true) {
    const { error: updErr } = await supabase
      .from("utenti")
      .update({
        nome: name,
        cognome: surname,
        disiscritto: false,
        consenso_promozioni: consenso   // ‚úÖ QUI
      })
      .eq("email", email);

    if (updErr) {
      alert("Errore riattivazione account.");
      return;
    }
  }

  // 4Ô∏è‚É£ NON ESISTE ‚Üí CREA
  if (!existing) {
    const { error: insErr } = await supabase
      .from("utenti")
      .insert({
        email,
        nome: name,
        cognome: surname,
        disiscritto: false,
        consenso_promozioni: consenso   // ‚úÖ QUI
      });

    if (insErr) {
      alert("Errore registrazione.");
      return;
    }
  }

  // 5Ô∏è‚É£ LOGIN AUTOMATICO
  localStorage.setItem("user_email", email);
  localStorage.setItem("user_name", name);
  localStorage.setItem("user_surname", surname);
  localStorage.setItem("userLogged", "1");

  alert("Registrazione completata!");
  window.location.href = "index.html";
};

</script>


<!-- ‚≠ê BOTTOM NAV BAR -->
<div id="bottom-nav">
    <a href="crea-coppa.html" class="nav-item">
        <img src="icone/crea.png" alt="">
        <span>Crea Coppa</span>
    </a>

    <a href="profilo.html" class="nav-item">
        <img src="icone/user.png" alt="">
        <span>Profilo</span>
    </a>

    <a href="menu.html" class="nav-item">
        <img src="icone/menu.png" alt="">
        <span>Menu</span>
    </a>

    <a href="lavora-con-noi.html" class="nav-item">
        <img src="icone/job.png" alt="">
        <span>Lavora Con Noi</span>
    </a>
</div>

</div>
utton>


</body>
</html>