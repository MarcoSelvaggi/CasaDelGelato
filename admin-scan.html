<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Scanner QR - Casa del Gelato</title>

<!-- Libreria per scanner QR -->
<script src="https://unpkg.com/html5-qrcode"></script>

<!-- Supabase -->
<script type="module" src="supabase.js"></script>

<style>
    body {
        font-family: -apple-system, BlinkMacSystemFont, sans-serif;
        background:#f7f7f7;
        margin:0;
        padding:20px;
        text-align:center;
    }

    h1 { margin-top: 12px; }

    #reader {
        width: 310px;
        margin: 0 auto;
        border-radius: 12px;
        overflow: hidden;
    }

    #risultato {
        margin-top:20px;
        background:white;
        padding:18px;
        border-radius:12px;
        box-shadow:0 2px 8px rgba(0,0,0,0.15);
        font-size:17px;
    }

    .ok {
        color:green;
        font-weight:bold;
        font-size:18px;
    }
    .error {
        color:#d60000;
        font-weight:bold;
        font-size:18px;
    }

    button {
        margin-top:20px;
        padding:10px 16px;
        background:#007aff;
        border:none;
        color:white;
        font-size:16px;
        border-radius:10px;
        cursor:pointer;
    }
</style>
</head>

<body>


<h1>ğŸ“· Scanner QR Coppe</h1>
<p>Inquadra il QR del cliente per confermare automaticamente la coppa</p>

<div id="reader"></div>

<div id="risultato" style="display:none;"></div>

<a href="admin.html">
    <button>Torna allâ€™Admin</button>
</a>

<script type="module">
import { supabase } from "./supabase.js";

// Funzione che verrÃ  chiamata quando lo scanner legge un QR
window.confermaCoppaDaQR = async function(qrToken) {
Â Â Â Â console.log("ğŸ“¥ QR letto:", qrToken);

Â Â Â Â // 1ï¸âƒ£ Prendo la coppa dal DB
Â Â Â Â const { data, error } = await supabase
Â Â Â Â Â Â Â Â .from("coppe")
Â Â Â Â Â Â Â Â .select("*")
Â Â Â Â Â Â Â Â .eq("qr_token", qrToken)
Â Â Â Â Â Â Â Â .limit(1);

Â Â Â Â if (error || !data || data.length === 0) {
Â Â Â Â Â Â Â Â alert("âŒ Coppa non trovata");
Â Â Â Â Â Â Â Â return;
Â Â Â Â }

Â Â Â Â const coppa = data[0];
Â Â Â Â const confermate = coppa.confermate || 0;

Â Â Â Â // 2ï¸âƒ£ Se giÃ  confermata â†’ chiedo
Â Â Â Â if (confermate >= 1) {
Â Â Â Â Â Â Â Â const ok = confirm(
Â Â Â Â Â Â Â Â Â Â Â Â `âš ï¸ Questa coppa Ã¨ giÃ  stata confermata.\n\n` +
Â Â Â Â Â Â Â Â Â Â Â Â `Ne sono state ordinate piÃ¹ di una uguale?\n\n` +
Â Â Â Â Â Â Â Â Â Â Â Â `Confermate finora: ${confermate}`
Â Â Â Â Â Â Â Â );

Â Â Â Â Â Â Â Â if (!ok) return;
Â Â Â Â }

Â Â Â Â // 3ï¸âƒ£ Incremento contatore
Â Â Â Â const { error: updErr } = await supabase
Â Â Â Â Â Â Â Â .from("coppe")
Â Â Â Â Â Â Â Â .update({ confermate: confermate + 1 })
Â Â Â Â Â Â Â Â .eq("id", coppa.id);

Â Â Â Â if (updErr) {
Â Â Â Â Â Â Â Â alert("âŒ Errore durante la conferma");
Â Â Â Â Â Â Â Â console.error(updErr);
Â Â Â Â Â Â Â Â return;
Â Â Â Â }

Â Â Â Â // 4ï¸âƒ£ Feedback
Â Â Â Â alert(`âœ… Coppa confermata!\nTotale confermate: ${confermate + 1}`);
Â Â Â Â if (navigator.vibrate) navigator.vibrate(150);
};
</script>

<script type="module">
import { supabase } from "./supabase.js";

function mostra(msg, ok = false) {
Â Â const box = document.getElementById("risultato");
Â Â box.style.display = "block";
Â Â box.innerHTML = `<span class="${ok ? 'ok' : 'error'}">${msg}</span>`;
}

async function confermaCoppa(qrToken) {
Â Â const { data, error } = await supabase
Â Â Â Â .from("coppe")
Â Â Â Â .select("*")
Â Â Â Â .eq("qr_token", qrToken)
Â Â Â Â .limit(1);

Â Â if (error || !data || !data.length) {
Â Â Â Â mostra("âŒ QR NON valido!");
Â Â Â Â return;
Â Â }

Â Â const coppa = data[0];

Â Â if (coppa.confermata) {
Â Â Â Â mostra("âš ï¸ Coppa giÃ  confermata!", true);
Â Â Â Â return;
Â Â }

Â Â await supabase
Â Â Â Â .from("coppe")
Â Â Â Â .update({ confermata: true })
Â Â Â Â .eq("id", coppa.id);

Â Â if (navigator.vibrate) navigator.vibrate(150);

Â Â mostra(`âœ… Coppa confermata<br><b>${coppa.nome}</b>`, true);
}

async function confermaCoupon(codice) {

Â Â const { data, error } = await supabase
Â Â Â Â .from("coupon")
Â Â Â Â .select("*")
Â Â Â Â .eq("codice", codice)
Â Â Â Â .single();

Â Â if (error || !data) {
Â Â Â Â mostra("âŒ Coupon NON valido!");
Â Â Â Â return;
Â Â }

Â Â if (data.redento) {
Â Â Â Â mostra("âš ï¸ Coupon giÃ  usato");
Â Â Â Â return;
Â Â }

Â Â await supabase
Â Â Â Â .from("coupon")
Â Â Â Â .update({
  redento: true,
  used_at: new Date().toISOString()
})
Â Â Â Â .eq("codice", codice);

Â Â if (navigator.vibrate) navigator.vibrate(200);

Â Â mostra(`ğŸŸï¸ Coupon riscattato<br><b>${data.titolo}</b>`, true);
}


// ğŸš€ Avvio scanner
function startScanner() {
Â Â const html5QrCode = new Html5Qrcode("reader");

Â Â html5QrCode.start(
Â Â Â Â { facingMode: "environment" },
Â Â Â Â { fps: 10, qrbox: 250 },
Â Â Â Â async qrCodeMessage => {

Â Â Â Â Â Â console.log("QR letto:", qrCodeMessage);

Â Â Â Â Â Â // ğŸŸï¸ COUPON
Â Â Â Â Â Â if (qrCodeMessage.includes("coupon=")) {
Â Â Â Â Â Â Â Â const url = new URL(qrCodeMessage);
Â Â Â Â Â Â Â Â const codice = url.searchParams.get("coupon");

Â Â Â Â Â Â Â Â await confermaCoupon(codice);
Â Â Â Â Â Â } 
Â Â Â Â Â Â // ğŸ¨ COPPA
Â Â Â Â Â Â else {
Â Â Â Â Â Â Â Â await confermaCoppaDaQr(qrCodeMessage);
Â Â Â Â Â Â }

Â Â Â Â Â Â // stop e riavvia dopo 1.5s
Â Â Â Â Â Â html5QrCode.stop().then(() => {
Â Â Â Â Â Â Â Â setTimeout(() => startScanner(), 1500);
Â Â Â Â Â Â });
Â Â Â Â },
Â Â Â Â () => {}
Â Â );
}

startScanner();
</script>

</body>
</html>