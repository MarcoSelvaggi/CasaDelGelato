<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Scanner QR - Casa del Gelato</title>

<!-- Libreria per scanner QR -->
<script src="https://unpkg.com/html5-qrcode"></script>

<!-- Supabase -->
<script type="module" src="supabase.js"></script>

<style>
    body {
        font-family: -apple-system, BlinkMacSystemFont, sans-serif;
        background:#f7f7f7;
        margin:0;
        padding:20px;
        text-align:center;
    }

    h1 { margin-top: 12px; }

    #reader {
        width: 310px;
        margin: 0 auto;
        border-radius: 12px;
        overflow: hidden;
    }

    #risultato {
        margin-top:20px;
        background:white;
        padding:18px;
        border-radius:12px;
        box-shadow:0 2px 8px rgba(0,0,0,0.15);
        font-size:17px;
    }

    .ok {
        color:green;
        font-weight:bold;
        font-size:18px;
    }
    .error {
        color:#d60000;
        font-weight:bold;
        font-size:18px;
    }

    button {
        margin-top:20px;
        padding:10px 16px;
        background:#007aff;
        border:none;
        color:white;
        font-size:16px;
        border-radius:10px;
        cursor:pointer;
    }

    /* ===== OVERLAY ===== */
.pin-overlay{
  position: fixed;
  inset: 0;
  background: rgba(0,0,0,0.35);
  backdrop-filter: blur(6px);
  display: flex;
  align-items: center;
  justify-content: center;
  z-index: 9999;
}

/* ===== BOX ===== */
.pin-box{
  width: 300px;
  background: #fff;
  border-radius: 18px;
  padding: 22px 20px 26px;
  box-shadow: 0 20px 50px rgba(0,0,0,0.25);
  text-align: center;
}

/* ===== TITOLO ===== */
.pin-box h2{
  margin: 0 0 16px;
  font-size: 18px;
  font-weight: 600;
}

/* ===== DOTS ===== */
.pin-dots{
  display: flex;
  justify-content: center;
  gap: 10px;
  margin-bottom: 22px;
}

.pin-dots span{
  width: 10px;
  height: 10px;
  border-radius: 50%;
  background: #d1d1d6;
  transition: background .2s, transform .2s;
}

.pin-dots span.filled{
  background: #111;
  transform: scale(1.15);
}

/* ===== KEYPAD ===== */
.pin-keypad{
  display: grid;
  grid-template-columns: repeat(3, 74px);
  gap: 18px;
  justify-content: center;
}

/* ===== BUTTONS ===== */
.pin-keypad button{
  width: 74px;
  height: 74px;
  border-radius: 50%;
  border: none;
  background: #f2f2f7;
  color: #111;
  font-size: 22px;
  font-weight: 600;
  display: flex;
  align-items: center;
  justify-content: center;
  cursor: pointer;
  transition: transform .1s, background .15s;
}

/* TAP iOS */
.pin-keypad button:active{
  background: #e5e5ea;
  transform: scale(0.92);
}

/* TASTO DELETE */
#pin-del{
  font-size: 20px;
}

/* CELLA VUOTA */
.pin-keypad .empty{
  background: transparent;
  pointer-events: none;
}
/* ===== CONFIRM OVERLAY ===== */
.confirm-overlay{
  position: fixed;
  inset: 0;
  background: rgba(0,0,0,.35);
  backdrop-filter: blur(6px);
  display: flex;
  align-items: center;
  justify-content: center;
  z-index: 9998;
}

/* ===== BOX ===== */
.confirm-box{
  width: 320px;
  background: #fff;
  border-radius: 18px;
  padding: 22px 20px 18px;
  box-shadow: 0 20px 50px rgba(0,0,0,.25);
  text-align: center;
}

/* ICONA */
.confirm-icon{
  font-size: 26px;
  margin-bottom: 6px;
}

/* TITOLO */
.confirm-box h3{
  margin: 0 0 10px;
  font-size: 18px;
  font-weight: 600;
}

/* TESTO */
.confirm-box p{
  font-size: 15px;
  line-height: 1.4;
  color: #333;
  margin: 0 0 18px;
}

/* AZIONI */
.confirm-actions{
  display: flex;
  border-top: 1px solid #e5e5ea;
}

.confirm-actions button{
  flex: 1;
  padding: 14px 0;
  border: none;
  background: none;
  font-size: 16px;
  cursor: pointer;
}

.btn-cancel{
  color: #8e8e93;
  border-right: 1px solid #e5e5ea;
}

.btn-ok{
  color: #007aff;
  font-weight: 600;
}
.badge-confermate{
  display: inline-block;
  margin-left: 6px;
  padding: 2px 8px;
  border-radius: 8px;

  background: #e8ffe8;
  color: #008a00;
  font-weight: 700;
  font-size: 14px;
}
/* üîí Blocca doppio tap zoom solo sul keypad PIN */
.pin-keypad button{
  touch-action: manipulation;
}

/* (opzionale ma consigliato) */
.pin-keypad{
  user-select: none;
  -webkit-user-select: none;
}
</style>
</head>

<body>

<h1>üì∑ Scanner QR Coppe</h1>
<p>Inquadra il QR del cliente per confermare automaticamente la coppa</p>

<div id="reader"></div>

<div id="risultato" style="display:none;"></div>
<div id="lista-scan" style="margin-top:16px;"></div>



<script type="module">
import { supabase } from "./supabase.js";
let scanLock = false;
let html5QrCode = null;
let scannerRunning = false; // üî• FIX
function mostra(msg, ok = false) {
    const box = document.getElementById("risultato");
    box.style.display = "block";
    box.innerHTML = `<span class="${ok ? 'ok' : 'error'}">${msg}</span>`;
}



async function confermaCoppa(raw) {


  const { data, error } = await supabase.functions.invoke(
    "admin-scan",
    {
      body: {
        pin: adminSessionPin,
        raw: raw
      }
    }
  );

  console.log("EDGE RESPONSE:", data);
  console.log("EDGE ERROR:", error);

  // ‚ùå errore vero
  if (error) {
    mostra("‚ùå Errore server");
    return;
  }

  // üîÅ COPPA GI√Ä CONFERMATA
  if (data?.type === "coppa" && data.already_confirmed) {

    const ok = await openConfirm(`
      ‚ö†Ô∏è Questa coppa √® gi√† stata confermata.<br><br>
      <b>Confermate finora:</b> ${data.coppa.confermate}<br><br>
      Vuoi confermare di nuovo?
    `);

    if (!ok) return;

    // üî• RICHIAMO EDGE CON force = true
    const { data: forcedData } = await supabase.functions.invoke(
      "admin-scan",
      {
        body: {
          pin: adminSessionPin,
          raw: raw,
          force: true
        }
      }
    );

    if (!forcedData?.ok) {
      mostra("‚ùå Errore conferma");
      return;
    }


mostra(`
  ‚úÖ Coppa riconfermata!<br><br>

  <b>${forcedData.coppa.nome}</b><br>
  (${forcedData.coppa.formato})<br><br>

  ü™ë <b>Tavolo:</b> ${forcedData.coppa.tavolo || "-"}<br><br>

  üë§ <b>Cliente:</b><br>
  ${
    forcedData.cliente
      ? forcedData.cliente.nome + " " + forcedData.cliente.cognome
      : "Guest"
  }<br><br>

  üîÅ <b>Confermate totali:</b> ${forcedData.coppa.confermate}
`, true);

  // ===== SALVA RICONFERMA =====
const lista = loadLista();

// üîç CERCA SE ESISTE GI√Ä
const index = lista.findIndex(x => x.id === forcedData.coppa.id);

if (index !== -1) {

  // üîÅ AGGIORNA CARD ESISTENTE
  lista[index].confermate = forcedData.coppa.confermate;
  lista[index].scanned_at = new Date().toISOString();
  lista[index].cliente = forcedData.cliente || null;

} else {

  // ‚ûï PRIMA VOLTA ‚Üí CREA NUOVA CARD
  lista.unshift({
    id: forcedData.coppa.id,
    nome: forcedData.coppa.nome,
    formato: forcedData.coppa.formato,
    tavolo: forcedData.coppa.tavolo,
    confermate: forcedData.coppa.confermate,
    scanned_at: new Date().toISOString(),
    data_creazione: forcedData.coppa.data,
    cliente: forcedData.cliente || null
  });

  if (lista.length > 100) lista.length = 100;
}

saveLista(lista);
renderLista();

  return;
  }

  // ‚ùå altro errore
  if (!data?.ok) {
    mostra(data?.message || "‚ùå Errore scan");
    return;
  }

  // ‚úÖ COPPA NORMALE
if (data.type === "coppa") {

  const c = data.coppa;
  const cliente = data.cliente;

  // ===== SALVA IN CRONOLOGIA =====
  const lista = loadLista();

  const index = lista.findIndex(x => x.id === c.id);

  if (index !== -1) {

    // aggiorna card esistente
    lista[index].confermate = c.confermate;
    lista[index].scanned_at = new Date().toISOString();
    lista[index].cliente = cliente || null;

  } else {

    // crea nuova card
    lista.unshift({
      id: c.id,
      nome: c.nome,
      formato: c.formato,
      tavolo: c.tavolo,
      confermate: c.confermate,
      scanned_at: new Date().toISOString(),
      data_creazione: c.data,
      cliente: cliente || null
    });

    if (lista.length > 100) lista.length = 100;
  }

  saveLista(lista);
  renderLista();

  mostra(`
    ‚úÖ Coppa confermata!<br><br>
    <b>${c.nome}</b><br>
    (${c.formato})<br><br>
    ü™ë <b>Tavolo:</b> ${c.tavolo || "-"}<br><br>
    üë§ <b>Cliente:</b><br>
    ${cliente ? cliente.nome + " " + cliente.cognome : "Guest"}
  `, true);
}

// üéüÔ∏è COUPON
if (data.type === "coupon") {

  const c = data.coupon;
  const cliente = data.cliente;

  if (data.already_used) {

    mostra(`
      ‚ö†Ô∏è <b>Coupon gi√† utilizzato</b><br><br>

      üéüÔ∏è <b>Tipo:</b> Coppa ${c.tipo.toUpperCase()}<br><br>

      üë§ <b>Cliente:</b><br>
      ${
        cliente
          ? cliente.nome + " " + cliente.cognome
          : (c.email || "Guest")
      }<br><br>

      üïí <b>Usato il:</b><br>
      ${c.used_at ? new Date(c.used_at).toLocaleString("it-IT") : "-"}
    `, false);

  } else {

    mostra(`
      ‚úÖ <b>Coupon riscattato!</b><br><br>

      üéüÔ∏è <b>Tipo:</b> Coppa ${c.tipo.toUpperCase()} omaggio<br><br>

      üë§ <b>Cliente:</b><br>
      ${
        cliente
          ? cliente.nome + " " + cliente.cognome
          : (c.email || "Guest")
      }
    `, true);
  }
}
}

function aggiornaListaGiornaliera(data) {

  const lista = loadLista();
  const c = data.coppa;

  const esistente = lista.find(x => x.id === c.id);

  if (esistente) {
    esistente.confermate = c.confermate;
    esistente.scanned_at = new Date().toISOString();
  } else {
    lista.unshift({
      id: c.id,
      nome: c.nome,
      formato: c.formato,
      tavolo: c.tavolo,
      confermate: c.confermate,
      scanned_at: new Date().toISOString(),
      data_creazione: c.data,
      cliente: data.cliente || null
    });
  }

  if (lista.length > 100) lista.length = 100;

  saveLista(lista);
  renderLista();
}


// ======= LISTA SCAN (persistente fino alle 02:00) =======
const LS_KEY_LISTA = "adminScan_lista_v1";
const LS_KEY_RESET = "adminScan_resetAt_v1";

function getNextResetAt2AM() {
  const now = new Date();
  const reset = new Date(now);
  reset.setHours(2, 0, 0, 0); // 02:00

  // se sono gi√† passate le 02:00 di oggi -> reset domani alle 02:00
  if (now.getTime() >= reset.getTime()) {
    reset.setDate(reset.getDate() + 1);
  }
  return reset.getTime();
}


let confirmResolve = null;

function openConfirm(message){
  return new Promise(resolve => {
    confirmResolve = resolve;
    document.getElementById("confirm-text").innerHTML = message;
    document.getElementById("confirm-overlay").style.display = "flex";
  });
}

function closeConfirm(result){
  document.getElementById("confirm-overlay").style.display = "none";
  if (confirmResolve) {
    confirmResolve(result);
    confirmResolve = null;
  }
}

async function gestisciScan(raw) {

  console.log("üç® SCAN COPPA:", raw);
  await confermaCoppa(raw);
}

function ensureResetSchedule() {
  const now = Date.now();
  const resetAt = Number(localStorage.getItem(LS_KEY_RESET)) || 0;

  // se non esiste, o √® scaduto -> svuota lista e riprogramma
  if (!resetAt || now >= resetAt) {
    localStorage.setItem(LS_KEY_LISTA, JSON.stringify([]));
    localStorage.setItem(LS_KEY_RESET, String(getNextResetAt2AM()));
  }
}

function loadLista() {
  ensureResetSchedule();
  try {
    return JSON.parse(localStorage.getItem(LS_KEY_LISTA) || "[]") || [];
  } catch {
    return [];
  }
}

function saveLista(arr) {
  localStorage.setItem(LS_KEY_LISTA, JSON.stringify(arr));
}

function formatOra(d) {
  const dt = new Date(d);
  return dt.toLocaleString("it-IT", { day:"2-digit", month:"2-digit", year:"numeric", hour:"2-digit", minute:"2-digit" });
}

function renderLista() {
  const box = document.getElementById("lista-scan");
  if (!box) return;

  const arr = loadLista();
  if (!arr.length) {
    box.innerHTML = `<div style="opacity:.65; font-size:14px;">Nessuna coppa scannerizzata oggi.</div>`;
    return;
  }

  box.innerHTML = `
    <div style="text-align:left; max-width:520px; margin:0 auto;">
      <h3 style="margin:0 0 10px; font-size:16px;">üìå Coppe scannerizzate (oggi)</h3>
      ${arr.map(x => `
        <div style="
          background:#fff;
          border-radius:12px;
          padding:12px 14px;
          margin-bottom:10px;
          box-shadow:0 2px 8px rgba(0,0,0,0.08);
        ">
          <div style="display:flex; justify-content:space-between; gap:10px;">
            <b>${x.nome || "Coppa"}</b>
            <span style="opacity:.7; font-size:13px;">${formatOra(x.scanned_at)}</span>
          </div>
          <div style="margin-top:6px; font-size:14px; line-height:1.35;">
            <div><b>Formato:</b> ${x.formato || "-"}</div>
            <div><b>Tavolo:</b> ${x.tavolo || "-"}</div>
            <div>
  <b>Confermate:</b>
  <span class="badge-confermate">${x.confermate || 0}</span>
</div>
          </div>
          ${x.cliente ? `
            <div style="margin-top:8px; font-size:13px; opacity:.9;">
              <div><b>Cliente:</b> ${x.cliente.nome || "-"} ${x.cliente.cognome || ""}</div>
              <div><b>Email:</b> ${x.cliente.email || "-"}</div>
              <div><b>Creata:</b> ${x.data_creazione ? formatOra(x.data_creazione) : "-"}</div>
            </div>
          ` : ""}
        </div>
      `).join("")}
      <div style="opacity:.6; font-size:12px; margin-top:6px;">
        Reset automatico alle 02:00.
      </div>
    </div>
  `;
}

// chiamala all‚Äôavvio pagina
renderLista();

function startScanner() {

  if (scannerRunning) {
    console.warn("üì∑ Scanner gi√† attivo");
    return;
  }

  if (!html5QrCode) {
    html5QrCode = new Html5Qrcode("reader");
  }

  scannerRunning = true;

  html5QrCode.start(
    { facingMode: "environment" },
    { fps: 10, qrbox: 250 },

    async qrCodeMessage => {
      if (scanLock) return;
      scanLock = true;

      await gestisciScan(qrCodeMessage);

      await html5QrCode.stop();
      scannerRunning = false;

      setTimeout(() => {
        scanLock = false;
        startScanner();
      }, 1200);
    },

    () => {}
  );
}

window.startScanner = startScanner;
window.openConfirm = openConfirm;
window.closeConfirm = closeConfirm;
window.startScanner = startScanner;
 </script>

<script>
document.addEventListener("DOMContentLoaded", () => {

if (isPinValidToday()) {

  adminSessionPin = localStorage.getItem("adminScan_session_pin") || "";

  if (!adminSessionPin) {
    openAdminScanPin();
    return;
  }

  startScanner();

} else {
  openAdminScanPin();
}

});
</script>

<!-- üîê ADMIN SCAN PIN OVERLAY -->
<div id="admin-pin-overlay" class="pin-overlay" style="display:none">
  <div class="pin-box">
    <h2>Inserisci PIN Admin</h2>

    <div class="pin-dots">
      <span></span><span></span><span></span>
      <span></span><span></span><span></span>
    </div>

    <div class="pin-keypad">
      <button data-n="1">1</button>
      <button data-n="2">2</button>
      <button data-n="3">3</button>

      <button data-n="4">4</button>
      <button data-n="5">5</button>
      <button data-n="6">6</button>

      <button data-n="7">7</button>
      <button data-n="8">8</button>
      <button data-n="9">9</button>

      <button class="empty"></button>
      <button data-n="0">0</button>
      <button id="pin-del">‚å´</button>
    </div>
  </div>
</div>

<script>
/* ========= CONFIG ========= */
const PIN_KEY = "adminScan_pin_ok_until";

let enteredPin = "";
let adminSessionPin = ""; // üëà METTILO QUI
adminSessionPin = localStorage.getItem("adminScan_session_pin") || "";

/* ========= VALIDIT√Ä 1 GIORNO ========= */
function getPinExpireToday() {
  const d = new Date();
  d.setHours(23, 59, 59, 999);
  return d.getTime();
}

function isPinValidToday() {
  const until = Number(localStorage.getItem(PIN_KEY) || 0);
  return Date.now() < until;
}

function savePinValid() {
  localStorage.setItem(PIN_KEY, String(getPinExpireToday()));
}

/* ========= UI ========= */
function updatePinDots() {
  const dots = document.querySelectorAll(".pin-dots span");
  dots.forEach((d, i) => {
    d.classList.toggle("filled", i < enteredPin.length);
  });
}

function openAdminScanPin() {
  const overlay = document.getElementById("admin-pin-overlay");
  overlay.style.display = "flex";
  enteredPin = "";
  updatePinDots();
}

/* ========= CHECK PIN ========= */

async function checkAdminScanPin() {

  const { data, error } = await supabase.functions.invoke(
    "admin-scan",
    {
      body: {
        pin: enteredPin,
        action: "auth"
      }
    }
  );

  if (!data?.ok) {
    enteredPin = "";
    updatePinDots();
    navigator.vibrate?.(100);
    return;
  }

  adminSessionPin = enteredPin;
  document.getElementById("admin-pin-overlay").style.display = "none";
  startScanner();
}

/* ========= KEYPAD ========= */
document.addEventListener("DOMContentLoaded", () => {
  const keypad = document.querySelector(".pin-keypad");
  if (!keypad) return;

  keypad.addEventListener("click", e => {
    const btn = e.target.closest("button");
    if (!btn || btn.classList.contains("empty")) return;

    if (btn.id === "pin-del") {
      enteredPin = enteredPin.slice(0, -1);
      updatePinDots();
      return;
    }

    const n = btn.dataset.n;
    if (!n || enteredPin.length >= 6) return;

    enteredPin += n;
    updatePinDots();

    if (enteredPin.length === 6) {
      setTimeout(checkAdminScanPin, 120);
    }
  });

  // üîê controllo iniziale
  if (isPinValidToday()) {
    startScanner();
  } else {
    openAdminScanPin();
  }
});
</script>

<!-- ‚ö†Ô∏è POPUP COPPA GI√Ä CONFERMATA -->
<div id="confirm-overlay" class="confirm-overlay" style="display:none">
  <div class="confirm-box">
    <div class="confirm-icon">‚ö†Ô∏è</div>

    <h3>Coppa gi√† confermata</h3>
    <p id="confirm-text"></p>

    <div class="confirm-actions">
      <button class="btn-cancel" onclick="closeConfirm(false)">Annulla</button>
      <button class="btn-ok" onclick="closeConfirm(true)">Conferma</button>
    </div>
  </div>
</div>

</body>
</html>