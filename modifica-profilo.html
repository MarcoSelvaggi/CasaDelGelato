<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Modifica profilo</title>

<script type="module">
  import { supabase } from "./supabase.js";
  window.supabase = supabase;
</script>

<style>
body{
  font-family: system-ui, -apple-system, sans-serif;
  background:#f6f6f7;
  margin:0;
  min-height:100vh;
  display:flex;
  align-items:center;
  justify-content:center;
}

/* CARD */
.card{
  background:#fff;
  width:90%;
  max-width:380px;
  padding:22px;
  border-radius:18px;
  box-shadow:0 10px 30px rgba(0,0,0,.15);
}

/* HEADER */
.card h1{
  margin:0 0 6px;
  font-size:22px;
  font-weight:800;
}

.card p{
  margin:0 0 18px;
  font-size:14px;
  color:#555;
}

/* INPUT */
.field{
  margin-bottom:14px;
}

.field label{
  display:block;
  font-size:13px;
  font-weight:700;
  margin-bottom:6px;
}

.field input{
  width:100%;
  padding:12px;
  border-radius:12px;
  border:1px solid #ccc;
  font-size:16px;
  box-sizing:border-box;
}

.field input:focus{
  outline:none;
  border-color:#007aff;
  box-shadow:0 0 0 3px rgba(0,122,255,.15);
}

/* EMAIL BLOCCATA */
.field input[disabled]{
  background:#f2f2f7;
  color:#666;
}

/* BUTTON */
button{
  width:100%;
  margin-top:10px;
  padding:12px;
  border:none;
  border-radius:14px;
  background:#007aff;
  color:#fff;
  font-size:16px;
  font-weight:700;
  cursor:pointer;
}

button.secondary{
  background:#e5e5ea;
  color:#111;
}

button:active{
  transform:scale(.97);
}

/* LINK */
.link{
  margin-top:14px;
  text-align:center;
  font-size:14px;
}

.link a{
  color:#007aff;
  text-decoration:none;
  font-weight:600;
}

/* POPUP */
#popup-backdrop{
  position:fixed;
  inset:0;
  background:rgba(0,0,0,.35);
  display:flex;
  align-items:center;
  justify-content:center;
  opacity:0;
  pointer-events:none;
  transition:.25s;
}

#popup-backdrop.show{
  opacity:1;
  pointer-events:auto;
}

#popup{
  background:#fff;
  padding:22px;
  border-radius:18px;
  width:90%;
  max-width:320px;
  text-align:center;
  box-shadow:0 10px 30px rgba(0,0,0,.25);
}

#popup h2{
  margin:0 0 10px;
  font-size:18px;
  font-weight:800;
}

#popup p{
  font-size:14px;
  color:#555;
}

#popup button{
  margin-top:16px;
}
.link-btn{
  background: none;
  border: none;
  padding: 0;
  margin-top: 6px;

  font-size: 14px;
  font-weight: 600;
  color: #007aff;      /* blu iOS */

  cursor: pointer;
  text-align: left;
}

.link-btn:active{
  opacity: .6;
}
</style>
</head>

<body>

<div class="card">
  <h1>Modifica profilo</h1>
  <p>Aggiorna i tuoi dati personali</p>

  <!-- NOME -->
  <div class="field">
    <label>Nome</label>
    <input type="text" id="nome">
  </div>

  <!-- COGNOME -->
  <div class="field">
    <label>Cognome</label>
    <input type="text" id="cognome">
  </div>

  <!-- EMAIL ATTUALE -->
  <div class="field">
    <label>Email attuale</label>
    <input type="email" id="email" disabled>
  </div>

    <!-- AZIONI ACCOUNT -->
<div class="field" style="margin-top:-6px;">
  <button
    type="button"
    class="link-btn"
    onclick="resetPasswordDaProfilo()"
  >
    Hai dimenticato la password?
  </button>
</div>

  <button onclick="salvaProfilo()">
    Salva nome e cognome
  </button>

  <hr style="margin:18px 0; border:none; border-top:1px solid #e5e5ea">

  <!-- NUOVA EMAIL -->
  <div class="field">
    <label>Nuova email</label>
    <input type="email" id="new-email" placeholder="Nuova email">
  </div>

  <button class="secondary" onclick="richiediCambioEmail()">
    Cambia email
  </button>

  <div class="link">
    <a href="profilo.html">← Torna al profilo</a>
  </div>
</div>

<!-- POPUP -->
<div id="popup-backdrop">
  <div id="popup">
    <h2 id="popup-title"></h2>
    <p id="popup-message"></p>
    <button onclick="chiudiPopup()">OK</button>
  </div>
</div>

<script type="module">
import { supabase } from "./supabase.js";

window.resetPasswordDaProfilo = async function(){
  const email = localStorage.getItem("user_email");

  if (!email){
    mostraPopup(
      "Accesso richiesto",
      "Devi essere loggato per reimpostare la password.",
      "login.html"
    );
    return;
  }

  // 1️⃣ verifica utente
  const { data, error } = await supabase
    .from("utenti")
    .select("email")
    .eq("email", email)
    .single();

  if (error){
    mostraPopup(
      "Errore",
      "Impossibile avviare il reset password."
    );
    return;
  }

  // 2️⃣ genera token
  const token = crypto.randomUUID();

  await supabase
    .from("utenti")
    .update({
      reset_token: token,
      reset_token_expires_at: new Date(
        Date.now() + 1000 * 60 * 30 // 30 min
      ).toISOString()
    })
    .eq("email", email);

  // 3️⃣ invio email (STESSA API)
  await fetch(
    "https://casa-del-gelato-mailer-kg7f.vercel.app/api/reset-password-email",
    {
      method:"POST",
      headers:{ "Content-Type":"application/json" },
      body: JSON.stringify({ email, token })
    }
  );

  mostraPopup(
    "Email inviata",
    "Ti abbiamo inviato un link per reimpostare la password.<br><br>Controlla la posta."
  );
};

/* POPUP */
window.mostraPopup = function(t,m,redirect=null){
  document.getElementById("popup-title").textContent = t;
  document.getElementById("popup-message").innerHTML = m;
  const b = document.getElementById("popup-backdrop");
  b.classList.add("show");
  b.dataset.redirect = redirect || "";
};

window.chiudiPopup = function(){
  const b = document.getElementById("popup-backdrop");
  b.classList.remove("show");
  if (b.dataset.redirect){
    location.href = b.dataset.redirect;
  }
};

/* LOAD DATI */
document.addEventListener("DOMContentLoaded", async () => {
  const email = localStorage.getItem("user_email");
  const logged = localStorage.getItem("userLogged") === "1";

  if (!logged || !email){
    mostraPopup(
      "Accesso richiesto",
      "Devi effettuare l’accesso per modificare il profilo.",
      "login.html"
    );
    return;
  }

  document.getElementById("email").value = email;

  const { data } = await supabase
    .from("utenti")
    .select("nome, cognome")
    .eq("email", email)
    .single();

  if (data){
    document.getElementById("nome").value = data.nome || "";
    document.getElementById("cognome").value = data.cognome || "";
  }
});

/* SAVE NOME / COGNOME */
window.salvaProfilo = async function(){
  const nome = document.getElementById("nome").value.trim();
  const cognome = document.getElementById("cognome").value.trim();
  const email = localStorage.getItem("user_email");

  if (!nome || !cognome){
    mostraPopup(
      "Campi mancanti",
      "Nome e cognome sono obbligatori."
    );
    return;
  }

  const { error } = await supabase
    .from("utenti")
    .update({ nome, cognome })
    .eq("email", email);

  if (error){
    mostraPopup("Errore","Non è stato possibile salvare i dati.");
    return;
  }

  localStorage.setItem("user_name", nome);
  localStorage.setItem("user_surname", cognome);

  mostraPopup(
    "Profilo aggiornato",
    "Nome e cognome sono stati aggiornati correttamente."
  );
};

/* CAMBIO EMAIL */
window.richiediCambioEmail = async function(){
  const nuovaEmail   = document.getElementById("new-email").value.trim().toLowerCase();
  const emailAttuale = localStorage.getItem("user_email");

  if (!nuovaEmail){
    mostraPopup("Email mancante","Inserisci una nuova email valida.");
    return;
  }

  if (nuovaEmail === emailAttuale){
    mostraPopup("Email identica","La nuova email è uguale a quella attuale.");
    return;
  }

  // 1️⃣ CONTROLLO EMAIL GIÀ ESISTENTE
  const { data: esistente } = await supabase
    .from("utenti")
    .select("email")
    .eq("email", nuovaEmail)
    .maybeSingle();

  if (esistente){
    mostraPopup(
      "Email già utilizzata",
      "Questa email è già associata a un altro account.<br><br>Usane un’altra."
    );
    return;
  }

  // 2️⃣ genera token
  const token = crypto.randomUUID();
  const expires = new Date(Date.now() + 1000 * 60 * 60).toISOString();

  // 3️⃣ salva richiesta
  const { error } = await supabase
    .from("utenti")
    .update({
      new_email: nuovaEmail,
      email_change_token: token,
      email_change_expires_at: expires
    })
    .eq("email", emailAttuale);

  if (error){
    mostraPopup("Errore","Impossibile avviare il cambio email.");
    return;
  }

  // 4️⃣ invio email
  await fetch(
    "https://casa-del-gelato-mailer-kg7f.vercel.app/api/change-email",
    {
      method:"POST",
      headers:{ "Content-Type":"application/json" },
      body: JSON.stringify({ email: nuovaEmail, token })
    }
  );

  mostraPopup(
    "Conferma email",
    "Abbiamo inviato un link di conferma alla nuova email.<br><br>Controlla la posta."
  );
};
</script>

</body>
</html>