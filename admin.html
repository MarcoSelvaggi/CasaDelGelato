<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Admin - Casa del Gelato</title>

<style>
    body {
        font-family: -apple-system, BlinkMacSystemFont, sans-serif;
        background: #f6f6f7;
        margin: 0;
        padding: 0;
    }

    #top-fixed-bar {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 55px;
        background: white;
        border-bottom: 1px solid #ddd;
        z-index: 999;
        display: flex;
        justify-content: center;
        align-items: center;
    }

    .home-btn {
        position: absolute;
        left: 12px;
        display: flex;
        align-items: center;
        text-decoration: none;
        color: #444;
        font-size: 16px;
        gap: 6px;
    }

    .home-btn img { width: 28px; height: 28px; }

    #spacer { height: 70px; }

    h1 { text-align: center; margin-top: 10px; }

    #search-admin {
        display: block;
        margin: 10px auto 5px;
        width: 90%;
        max-width: 600px;
        padding: 10px;
        font-size: 16px;
        border-radius: 12px;
        border: 1px solid #ccc;
    }

    #admin-list {
        padding: 20px;
        max-width: 700px;
        margin: 0 auto;
    }

    .utente-card {
        background: white;
        padding: 18px;
        margin-bottom: 14px;
        border-radius: 14px;
        box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        cursor: pointer;
    }

    .utente-dis {
        background: #ffe5e5;
        border-left: 6px solid red;
    }

    .utente-info {
        padding: 14px 18px;
        border-left: 4px solid #007aff;
        margin-bottom: 10px;
        background: #fff;
        border-radius: 10px;
    }

    .coppe-container {
        margin-top: 14px;
        padding: 14px;
        background: #fff;
        border-radius: 12px;
        box-shadow: 0 1px 4px rgba(0,0,0,0.1);
    }

    .counter {
        display: inline-block;
        padding: 4px 10px;
        border-radius: 10px;
        font-size: 13px;
        margin-right: 6px;
        font-weight: bold;
    }

    .c-blue { background: #0084ff20; color: #0084ff; }
    .c-green { background: #28b46320; color: #28b463; cursor: pointer; }
    .c-red { background: #ff3b3020; color: #ff3b30; cursor: pointer; }

    .coppa {
        background: #fff;
        padding: 12px;
        margin-top: 10px;
        border-radius: 10px;
        box-shadow: 0 1px 4px rgba(0,0,0,0.08);
    }

    .coppa-confermata { border-left: 6px solid #28b463; }
    .coppa-eliminata { background: #ffe5e5; border-left: 6px solid #ff3b30; }

    .conf-btn {
        display: inline-block;
        margin-top: 6px;
        padding: 6px 12px;
        background: #007aff;
        color: white;
        border-radius: 8px;
        font-size: 14px;
        cursor: pointer;
    }

    .conf-btn.active {
        background: #28b463;
    }

</style>
</head>

<body>

<div id="top-fixed-bar">
    <a class="home-btn" href="index.html">
        <img src="tastohome.png" alt="home">
        <span>Home</span>
    </a>
</div>

<div id="spacer"></div>

<h1>ðŸ“Š Pannello Admin</h1>

<input id="search-admin" type="text" placeholder="Cerca utenti o coppe...">
<div id="admin-list"></div>

<script type="module">
import { supabase } from "./supabase.js";

let UTENTI = [];
let COPPE = [];
let termineRicerca = "";

let filtroConfermate = {};
let filtroEliminate = {};

function evidenzia(txt) {
    if (!termineRicerca.trim()) return txt;
    return txt.replace(new RegExp(termineRicerca, "gi"), m => `<mark>${m}</mark>`);
}

function groupByUser() {
    const map = {};
    COPPE.forEach(c => {
        const email = c.email || "Anonimo";

        if (!map[email]) {
            map[email] = {
                email,
                coppe: [],
                tot: 0,
                conf: 0,
                del: 0
            };
        }

        map[email].coppe.push(c);
        map[email].tot++;

        if (c.confermata) map[email].conf++;
        if (c.eliminata) map[email].del++;
    });
    return map;
}

function renderAdmin() {
    const lista = document.getElementById("admin-list");
    lista.innerHTML = "";

    const filter = termineRicerca.toLowerCase();
    const grouped = groupByUser();

    Object.values(grouped)
        .filter(u => JSON.stringify(u).toLowerCase().includes(filter))
        .forEach(u => {

            const isDis = UTENTI.find(x => x.email === u.email)?.disiscritto;

            lista.innerHTML += `
                <div class="utente-card ${isDis ? "utente-dis" : ""}"
                     onclick="toggleUser('${u.email}')">

                    <b>${u.email}</b><br>

                    <span class="counter c-blue">Coppe: ${u.tot}</span>
                    <span class="counter c-green" onclick="event.stopPropagation(); toggleFiltroConf('${u.email}')">
                        Confermate: ${u.conf}
                    </span>
                    <span class="counter c-red" onclick="event.stopPropagation(); toggleFiltroElim('${u.email}')">
                        Eliminate: ${u.del}
                    </span>

                    <div id="box-${u.email}" style="display:none;"></div>
                </div>
            `;
        });
}

window.toggleUser = function(email) {
    const container = document.getElementById(`box-${email}`);
    if (container.style.display === "none") {
        renderDettagliUtente(email, container);
        renderCoppeUtente(email, container);
        container.style.display = "block";
    } else {
        container.style.display = "none";
    }
}

function renderDettagliUtente(email, ctn) {
    const u = UTENTI.find(x => x.email === email);
    if (!u) return;

    ctn.innerHTML = `
        <div class="utente-info">
            <b>Nome:</b> ${u.nome}<br>
            <b>Cognome:</b> ${u.cognome}<br>
            <b>Registrato:</b> ${u.created_at?.substring(0,16)}<br>
            ${u.disiscritto ? `<b style="color:red;">DISISCRITTO</b><br>` : ""}
        </div>

        <button class="conf-btn" onclick="toggleCoppe('${email}')">
            Coppe create
        </button>

        <div id="coppe-${email}" class="coppe-container" style="display:none;"></div>
    `;
}

window.toggleCoppe = function(email) {
    const el = document.getElementById(`coppe-${email}`);
    if (el.style.display === "none") {
        renderCoppeUtente(email, el);
        el.style.display = "block";
    } else {
        el.style.display = "none";
    }
}

window.toggleFiltroConf = function(email) {
    filtroConfermate[email] = !filtroConfermate[email];
    const el = document.getElementById(`coppe-${email}`);
    if (el.style.display === "block") renderCoppeUtente(email, el);
}

window.toggleFiltroElim = function(email) {
    filtroEliminate[email] = !filtroEliminate[email];
    const el = document.getElementById(`coppe-${email}`);
    if (el.style.display === "block") renderCoppeUtente(email, el);
}

window.toggleConferma = async function(id, email) {
    const coppa = COPPE.find(c => c.id === id);
    const nuovo = !coppa.confermata;

    await supabase.from("coppe").update({ confermata: nuovo }).eq("id", id);
    coppa.confermata = nuovo;

    renderAdmin();
    const el = document.getElementById(`coppe-${email}`);
    renderCoppeUtente(email, el);
}

function renderCoppeUtente(email, ctn) {
    const stats = groupByUser()[email];
    let arr = stats.coppe;

    if (filtroConfermate[email]) arr = arr.filter(c => c.confermata === true);
    if (filtroEliminate[email]) arr = arr.filter(c => c.eliminata === true);

    ctn.innerHTML = "";

    arr.forEach(c => {
        ctn.innerHTML += `
            <div class="coppa ${c.eliminata ? "coppa-eliminata" : c.confermata ? "coppa-confermata" : ""}">
                <b>${c.nome || "Coppa senza nome"}</b><br>
                <b>Data:</b> ${c.data}<br>
                <b>Formato:</b> ${c.formato}<br>
                <b>Prezzo:</b> â‚¬${Number(c.prezzo).toFixed(2)}<br>

                <div class="conf-btn ${c.confermata ? "active" : ""}"
                    onclick="toggleConferma(${c.id}, '${email}')">
                    ${c.confermata ? "âœ“ Confermata" : "Conferma"}
                </div>
            </div>
        `;
    });
}

async function loadAll() {
    let r1 = await supabase.from("utenti").select("*");
    if (!r1.error) UTENTI = r1.data;

    let r2 = await supabase.from("coppe").select("*");
    if (!r2.error) COPPE = r2.data;
}

document.getElementById("search-admin").addEventListener("input", e => {
    termineRicerca = e.target.value;
    renderAdmin();
});

await loadAll();
renderAdmin();

</script>
</body>
</html>