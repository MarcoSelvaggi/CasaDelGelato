<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Admin - Casa del Gelato</title>

<style>
/* ====== STILI ORIGINALI (NON TOCCATI) ====== */
body {
    font-family: -apple-system, BlinkMacSystemFont, sans-serif;
    background: #f6f6f7;
    margin: 0;
    padding: 0;
}

#top-fixed-bar {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 55px;
    background: white;
    border-bottom: 1px solid #ddd;
    z-index: 999;
    display: flex;
    justify-content: center;
    align-items: center;
}

.home-btn {
    position: absolute;
    left: 12px;
    display: flex;
    align-items: center;
    text-decoration: none;
    color: #444;
    font-size: 16px;
    gap: 6px;
}

.home-btn img { width: 28px; height: 28px; }
#spacer { height: 70px; }
h1 { text-align: center; margin-top: 10px; }

#search-admin {
    display:block;
    margin: 10px auto 5px;
    width: 90%;
    max-width: 600px;
    padding: 10px;
    font-size: 16px;
    border-radius: 12px;
    border: 1px solid #ccc;
}

#admin-list {
    padding: 20px;
    max-width: 900px;
    margin: 0 auto;
}

.utente-card {
    background: white;
    border-radius: 14px;
    padding: 15px 18px;
    margin-bottom: 14px;
    box-shadow: 0 2px 6px rgba(0,0,0,0.08);
    cursor: pointer;
    border-left: 8px solid #007aff;
}

.utente-disiscritto {
    border-left-color: #ff3b30 !important;
    background: #ffecec !important;
}

.coppe-container {
    display:none;
    margin-top: 10px;
    padding: 15px;
    background: #ffffff;
    border-radius: 14px;
    border: 1px solid #ddd;
}
</style>
</head>

<body>

<script>
/* ===== PROTEZIONE ADMIN ===== */
const ADMIN_PASSWORD = "115365";
document.addEventListener("DOMContentLoaded", () => {
  const pwd = prompt("üîê Inserisci password admin");
  if (pwd !== ADMIN_PASSWORD) {
    alert("Accesso negato");
    location.href = "index.html";
  }
});
</script>

<div id="top-fixed-bar">
  <a class="home-btn" href="index.html">
    <img src="tastohome.png"><span>Home</span>
  </a>
</div>

<div id="spacer"></div>
<h1>üìä Pannello Admin</h1>

<div style="text-align:center;margin:20px">
  <button onclick="apriDashboard()">Dashboard</button>
  <button onclick="apriDisponibilita()">Disponibilit√† ingredienti</button>
</div>

<div id="sezione-dashboard">
  <div id="admin-list"></div>
</div>

<div id="sezione-disponibilita" style="display:none;padding:20px"></div>

<script type="module">
import { supabase } from "./supabase.js";

let UTENTI = [];
let COPPE = [];
let sezioniAperte = {};

async function load() {
  const u = await supabase.from("utenti").select("*");
  const c = await supabase.from("coppe").select("*");
  UTENTI = u.data || [];
  COPPE = c.data || [];
  render();
}
load();

/* ===== RENDER UTENTI ===== */
function render() {
  const out = document.getElementById("admin-list");
  out.innerHTML = "";

  UTENTI.forEach(u => {
    const email = u.email;
    out.innerHTML += `
      <div class="utente-card"
           onclick="toggleUtente('${email}')">
        <b>${email}</b>
      </div>
      <div id="c-${email}" class="coppe-container"></div>
    `;
  });
}

/* ===== TOGGLE CARD ===== */
window.toggleUtente = function(email) {
  const box = document.getElementById("c-" + email);
  if (!box) return;

  const open = !sezioniAperte[email];
  sezioniAperte[email] = open;
  box.style.display = open ? "block" : "none";

  if (open) renderCoppe(email);
};

/* ===== RENDER COPPE ===== */
window.renderCoppe = function(email) {
  const box = document.getElementById("c-" + email);
  const coppe = COPPE.filter(c => c.email === email);

  box.innerHTML = coppe.map(c => `
    <div style="padding:10px;margin:8px 0;background:#f2f2f2;border-radius:10px">
      <b>${c.nome || "Coppa"}</b><br>
      Confermate: ${c.confermate || 0}
      <br>
      <button onclick="conferma(${c.id});event.stopPropagation()">Conferma</button>
    </div>
  `).join("");
};

/* ===== CONFERMA ===== */
window.conferma = async function(id) {
  const c = COPPE.find(x => x.id === id);
  await supabase.from("coppe")
    .update({ confermate: (c.confermate || 0) + 1 })
    .eq("id", id);
  load();
};

/* ===== TABS ===== */
window.apriDashboard = function() {
  document.getElementById("sezione-dashboard").style.display = "block";
  document.getElementById("sezione-disponibilita").style.display = "none";
};

window.apriDisponibilita = function() {
  document.getElementById("sezione-dashboard").style.display = "none";
  document.getElementById("sezione-disponibilita").style.display = "block";
};
</script>

</body>
</html>