<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin - Casa del Gelato</title>

    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, sans-serif;
            background: #f6f6f7;
            margin: 0;
            padding: 0;
        }

        #top-fixed-bar {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 55px;
            background: white;
            border-bottom: 1px solid #ddd;
            z-index: 999;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .home-btn {
            position: absolute;
            left: 12px;
            display: flex;
            align-items: center;
            text-decoration: none;
            color: #444;
            font-size: 16px;
            gap: 6px;
        }

        .home-btn img { width: 28px; height: 28px; }

        #spacer { height: 70px; }

        h1 { text-align: center; margin-top: 10px; }

        #search-admin {
            display:block;
            margin: 10px auto 5px;
            width: 90%;
            max-width: 600px;
            padding: 10px;
            font-size: 16px;
            border-radius: 12px;
            border: 1px solid #ccc;
        }

        #stats {
            text-align: center;
            margin: 10px 0 20px;
            font-size: 18px;
        }

        #admin-list {
            padding: 20px;
            max-width: 700px;
            margin: 0 auto;
        }

        .utente, .coppa {
            background: white;
            border-radius: 12px;
            padding: 15px;
            margin-bottom: 12px;
            box-shadow: 0 2px 6px rgba(0,0,0,0.08);
        }

        .coppa-eliminata {
    background: #ffe5e5;
    border-left: 6px solid #ff3b30;
}

        .utente { border-left: 6px solid #007aff; }
        .utente-disiscritto { background: #ffe5e5; border-left: 6px solid red; }

        .section-title { margin-top: 30px; font-size: 20px; font-weight: bold; }

        mark {
            background: #ffeb3b;
            padding: 0 2px;
            border-radius: 3px;
        }
    </style>
</head>

<body>

<div id="top-fixed-bar">
    <a class="home-btn" href="index.html">
        <img src="tastohome.png" alt="home">
        <span>Home</span>
    </a>
</div>

<div id="spacer"></div>

<h1>üìä Pannello Admin</h1>

<input id="search-admin" type="text" placeholder="Cerca utenti o coppe...">

<div id="stats"></div>

<div id="admin-list"></div>

<script type="module">
import { supabase } from "./supabase.js";

let UTENTI = [];
let COPPE = [];
let termineRicerca = "";

// ----------------------------------
// Evidenzia testo
// ----------------------------------
function evidenzia(testo) {
    if (!termineRicerca.trim()) return testo;
    const q = termineRicerca.replace(/[.*+?^${}()|[\]\\]/g, "\\$&");
    return testo.replace(new RegExp(q, "gi"), (m) => `<mark>${m}</mark>`);
}

// ----------------------------------
// RENDER ADMIN COMPLETO
// ----------------------------------
function renderAdmin() {
    const lista = document.getElementById("admin-list");
    lista.innerHTML = "";

    // Filtri
    const filtro = termineRicerca.toLowerCase();

    // -------- UTENTI --------
    lista.innerHTML += `<div class="section-title">üßë‚Äçüíª Utenti registrati</div>`;

    UTENTI
        .filter(u =>
            JSON.stringify(u).toLowerCase().includes(filtro)
        )
        .forEach(u => {
            const isDis = u.disiscritto === true;

            lista.innerHTML += `
                <div class="utente ${isDis ? "utente-disiscritto" : ""}">
                    <b>${isDis ? "üö´ DISISCRITTO" : "‚úî REGISTRATO"}</b><br>
                    <b>Nome:</b> ${evidenzia(u.nome)}<br>
                    <b>Cognome:</b> ${evidenzia(u.cognome)}<br>
                    <b>Email:</b> ${evidenzia(u.email)}<br>
                    <b>Registrato il:</b> ${evidenzia(u.created_at?.replace("T"," ").substring(0,16))}<br>
                    ${isDis ? `<b>Disiscritto il:</b> ${evidenzia(u.data_disiscrizione || "-")}` : ""}
                </div>
            `;
        });

// -------- COPPE --------
lista.innerHTML += `<div class="section-title">üç® Coppe create</div>`;

COPPE
    .filter(c =>
        JSON.stringify(c).toLowerCase().includes(filtro)
    )
    .forEach(c => {
        const gusti = Array.isArray(c.gusti) ? c.gusti : JSON.parse(c.gusti || "[]");
        const granelle = Array.isArray(c.granelle) ? c.granelle : JSON.parse(c.granelle || "[]");
        const topping = Array.isArray(c.topping) ? c.topping : JSON.parse(c.topping || "[]");
        const ingredienti = Array.isArray(c.ingredienti) ? c.ingredienti : JSON.parse(c.ingredienti || "[]");
        const extra = Array.isArray(c.extra) ? c.extra : JSON.parse(c.extra || "[]");

        const isEliminata = c.eliminata === true;

        lista.innerHTML += `
            <div class="coppa ${isEliminata ? "coppa-eliminata" : ""}">
                
                ${isEliminata ? `<b style="color:#b00000;">‚ùå ELIMINATA</b><br>` : ""}
                
                <b>Nome coppa:</b> ${evidenzia(c.nome || "Coppa senza nome")}<br>
                <b>Email:</b> ${evidenzia(c.email || "Anonimo")}<br>
                <b>Data:</b> ${evidenzia(c.data)}<br>
                <b>Formato:</b> ${evidenzia(c.formato)}<br>
                <b>Gusti:</b> ${evidenzia(gusti.join(", "))}<br>
                <b>Granelle:</b> ${evidenzia(granelle.join(", "))}<br>
                <b>Topping:</b> ${evidenzia(topping.join(", "))}<br>
                <b>Ingredienti:</b> ${evidenzia(ingredienti.join(", "))}<br>
                <b>Extra:</b> ${evidenzia(extra.join(", "))}<br>
                <b>Prezzo:</b> ‚Ç¨${Number(c.prezzo).toFixed(2)}
            </div>
        `;
    });

}

// ----------------------------------
// CARICA UTENTI
// ----------------------------------
async function loadUtenti() {
    const { data, error } = await supabase
        .from("utenti")
        .select("*")
        .order("created_at", { ascending: false });

    if (!error) UTENTI = data;
}

// ----------------------------------
// CARICA COPPE
// ----------------------------------
async function loadCoppe() {
    const { data, error } = await supabase
        .from("coppe")
        .select("*")
        .order("created_at", { ascending: false });

    if (!error) COPPE = data;
}

// ----------------------------------
// AVVIO
// ----------------------------------
document.addEventListener("DOMContentLoaded", async () => {
    await loadUtenti();
    await loadCoppe();
    renderAdmin();
});

// ----------------------------------
// RICERCA LIVE
// ----------------------------------
document.getElementById("search-admin").addEventListener("input", e => {
    termineRicerca = e.target.value;
    renderAdmin();
});
</script>

</body>
</html>