<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Admin - Casa del Gelato</title>

<style>
    body {
        font-family: -apple-system, BlinkMacSystemFont, sans-serif;
        background: #f6f6f7;
        margin: 0;
        padding: 0;
    }
html, body {
  max-width: 100%;
  overflow-x: hidden;
}
    #top-fixed-bar {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 55px;
        background: white;
        border-bottom: 1px solid #ddd;
        z-index: 999;
        display: flex;
        justify-content: center;
        align-items: center;
    }

    .home-btn {
        position: absolute;
        left: 12px;
        display: flex;
        align-items: center;
        text-decoration: none;
        color: #444;
        font-size: 16px;
        gap: 6px;
    }

    .home-btn img { width: 28px; height: 28px; }

    #spacer { height: 70px; }

    h1 { text-align: center; margin-top: 10px; }

    #search-admin {
        display:block;
        margin: 10px auto 5px;
        width: 90%;
        max-width: 600px;
        padding: 10px;
        font-size: 16px;
        border-radius: 12px;
        border: 1px solid #ccc;
    }

    #admin-list {
        padding: 20px;
        max-width: 900px;
        margin: 0 auto;
    }

    .utente-card {
        background: white;
        border-radius: 14px;
        padding: 15px 18px;
        margin-bottom: 14px;
        box-shadow: 0 2px 6px rgba(0,0,0,0.08);
        cursor: pointer;
        border-left: 8px solid #007aff;
    }

    .utente-disiscritto {
        border-left-color: #ff3b30 !important;
        background: #ffecec !important;
    }

    .utente-details {
        margin-top: 10px;
        padding-left: 5px;
        font-size: 15px;
    }

    .counter-row {
        margin-top: 6px;
        display: flex;
        gap: 18px;
        flex-wrap: wrap;
    }

    .badge {
        padding: 4px 10px;
        border-radius: 8px;
        font-size: 14px;
        font-weight: 600;
    }

    .badge-blue { background: #e4f0ff; color: #0052cc; }
    .badge-green { background: #e8ffe8; color: #008a00; }
    .badge-red  { background: #ffe5e5; color: #b20000; }
    .badge-coupon { background: #fff5cc; color: #a67c00; }

    .coppe-container {
        display:none;
        margin-top: 10px;
        padding: 15px;
        background: #ffffff;
        border-radius: 14px;
        border: 1px solid #ddd;
    }

    .coppa-box {
        padding: 10px 12px;
        margin-bottom: 10px;
        border-radius: 12px;
        background: #fafafa;
        border-left: 6px solid #007aff;
    }

    .coppa-eliminata { border-left-color: #ff3b30 !important; background:#ffecec;}
    .coppa-confermata { border-left-color: #00b341 !important; background:#e7ffe9;}

    .filter-btn {
        margin-right: 8px;
        padding: 6px 12px;
        border-radius: 8px;
        background: #eee;
        cursor: pointer;
        display: inline-block;
    }

    .filter-btn.active {
        background: #007aff;
        color: white;
    }

    .confirm-btn {
        padding: 6px 12px;
        background: #00c851;
        color: white;
        border: none;
        border-radius: 8px;
        cursor: pointer;
        margin-top: 6px;
    }

    .undo-btn {
        padding: 6px 12px;
        background: #ff4444;
        color: white;
        border: none;
        border-radius: 8px;
        cursor: pointer;
        margin-top: 6px;
    }
    .undo-btn{
  pointer-events:auto;
}

.annulla-wrap{
  display:flex;
  align-items:center;
  gap:6px;
  margin-top:8px;
}

.qty-box{
  display:flex;
  align-items:center;
  gap:6px;
  padding:4px 8px;
  border:1px solid #ddd;
  border-radius:8px;
  background:#fff;
}

.qty-box.disabled{
  opacity:.35;
  pointer-events:none; /* non cliccabile */
}

.qty-btn{
  width:22px;
  height:22px;
  border:none;
  border-radius:6px;
  background:#efefef;
  cursor:pointer;
  font-size:14px;
  line-height:22px;
  padding:0;
}

.qty-num{
  min-width:18px;
  text-align:center;
  font-weight:700;
  font-size:14px;
}
.undo-btn,
.confirm-btn{
  padding:3px 8px;
  font-size:13px;
  border-radius:7px;
}

.qty-btn{
  width:20px;
  height:20px;
  font-size:13px;
  line-height:20px;
}


/* SOLO gli elementi interattivi sono cliccabili */
.annulla-wrap button,
.annulla-wrap .undo-btn,
.annulla-wrap .confirm-btn,
.annulla-wrap .qty-btn {
  pointer-events: auto;
  position: relative;
  z-index: 5;
}

/* solo i bottoni che devono stare sopra le card */
.confirm-btn,
.undo-btn,
.qty-btn {
  position: relative;
  z-index: 10;
}

/* üì± Mobile: testo coppa pi√π compatto */
@media (max-width: 480px) {
  .coppa-box {
    font-size: 13px;
    line-height: 1.35;
  }

  .coppa-box b {
    font-size: 13.5px;
  }
}
/* üì± Mobile: annulla conferma SUPER compatto */
@media (max-width: 480px) {

  .annulla-wrap {
    gap: 5px;
    margin-top: 6px;
    align-items: center;
  }

  .undo-btn {
    font-size: 11px;
    padding: 3px 6px;
    height: 24px;
    line-height: 18px;
    border-radius: 6px;
  }

  .qty-box {
    padding: 2px 5px;
    height: 24px;
    gap: 3px;
    border-radius: 6px;
  }

  .qty-btn {
    width: 16px;
    height: 16px;
    font-size: 11px;
    line-height: 16px;
    border-radius: 4px;
  }

  .qty-num {
    min-width: 12px;
    font-size: 11px;
    line-height: 16px;
  }

  .confirm-btn {
    font-size: 11px;
    padding: 3px 6px;
    height: 24px;
    line-height: 18px;
    border-radius: 6px;
  }
}
.coppa-box {
  overflow: hidden;
}

button {
  padding:8px 14px;
  border-radius:10px;
  border:none;
  background:#007aff;
  color:white;
  font-size:15px;
  cursor:pointer;
}

button:hover {
  opacity:0.9;
}

.mail-link{
  color:#007aff;
  font-weight:700;
  text-decoration:none;
}
.mail-link:hover{ text-decoration:underline; }

.mail-disabled{
  color:#9aa0a6;
  font-weight:700;
  cursor:not-allowed;
  user-select:none;
}

.mail-no{
  font-size:12px;
  margin-left:4px;
}

#admin-email-top{
  position: fixed;
  top: 14px;
  right: 14px;
  z-index: 10050;
}

#admin-email-top button{
  background: #007aff;
  color: #fff;
  border: none;
  border-radius: 12px;
  padding: 8px 14px;
  font-size: 14px;
  font-weight: 600;
  cursor: pointer;
  box-shadow: 0 6px 18px rgba(0,0,0,.18);
}

#admin-email-top button:hover{
  opacity:.9;
}

#admin-email-top #email-dropdown{
  display:none;
  position:absolute;
  top:46px;
  right:0;
  background:#fff;
  border-radius:12px;
  box-shadow:0 10px 30px rgba(0,0,0,.18);
  width:260px;
  overflow:hidden;
}
#top-fixed-bar {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 55px;
    background: white;
    border-bottom: 1px solid #ddd;
    z-index: 999;

    display: flex;
    align-items: center;
    justify-content: center;
}

/* Titolo centrato */
.top-title {
    font-size: 17px;
    font-weight: 700;
}
#top-fixed-bar{
  position:fixed;
  top:0;
  left:0;
  width:100%;
  height:55px;
  background:#fff;
  border-bottom:1px solid #ddd;
  z-index:1000;

  display:flex;
  align-items:center;
  justify-content:center;
}

.top-title{
  font-size:17px;
  font-weight:700;
}

.top-actions{
  position:absolute;
  right:12px;
  display:flex;
  align-items:center;
  gap:10px;
}

/* QR */
.qr-btn{
  width:38px;
  height:38px;
  border-radius:10px;
  background:#00c851;
  color:#fff;
  font-size:20px;
  text-decoration:none;
  display:flex;
  align-items:center;
  justify-content:center;
  box-shadow:0 4px 12px rgba(0,0,0,.18);
}

/* EMAIL */
.mail-btn{
  background:#007aff;
  color:#fff;
  border:none;
  border-radius:12px;
  padding:8px 14px;
  font-size:14px;
  font-weight:600;
  cursor:pointer;
}

/* DROPDOWN */
#email-dropdown{
  display:none;
  position:absolute;
  top:52px;
  right:0;

  background:#fff;
  border-radius:14px;
  box-shadow:0 12px 40px rgba(0,0,0,.25);
  width:260px;
  overflow:hidden;

  z-index: 99999;   /* üî• SOPRA A TUTTO */
}
body {
  position: relative;
}
.coppa-toggle{
  cursor:pointer;
  font-size:20px;
  pointer-events:auto;
  z-index:50;
  position:relative;
}
/* üì± FIX annulla conferma su mobile */
@media (max-width: 480px) {

  .annulla-wrap{
    flex-wrap: wrap;          /* üî• va a capo */
    gap: 6px;
  }

  .annulla-wrap .undo-btn{
    flex: 1 1 100%;           /* üî• bottone a tutta larghezza */
  }

  .annulla-wrap .qty-box{
    flex: 0 0 auto;
  }

  .annulla-wrap .confirm-btn{
    flex: 1 1 100%;           /* üî• OK sotto */
  }
}

#email-registrati-box input,
#email-registrati-box textarea {
  width: 100%;
  max-width: 100%;
  box-sizing: border-box;
}
.reload-btn{
  width:38px;
  height:38px;
  border-radius:10px;
  background:#f2f2f7;
  border:none;
  font-size:18px;
  cursor:pointer;
  display:flex;
  align-items:center;
  justify-content:center;
  box-shadow:0 4px 12px rgba(0,0,0,.18);
}

.reload-btn:active{
  transform:scale(.95);
}

.admin-tabs{
  display:grid;
  grid-template-columns: repeat(2, 1fr);
  gap:8px;
  margin:14px 12px;
}

/* terzo pulsante a tutta riga */
.tab-btn.full{
  grid-column: 1 / -1;
}

.tab-btn{
  display:flex;
  align-items:center;
  justify-content:center;

  height:40px;
  padding:0 10px;

  border:none;
  border-radius:10px;

  background:#e5e5ea;
  color:#111;

  font-size:14px;
  font-weight:600;
  white-space:nowrap;
}

.tab-btn.active{
  background:#007aff;
  color:#fff;
  box-shadow:0 3px 8px rgba(0,122,255,.35);
}

/* spazio sotto la sezione coppe quando √® aperta */
.coppe-container {
  margin-bottom: 18px;
}

.alert-btn{
  background:#fff3cd;
  color:#8a6d3b;
  border:1px solid #ffe69c;
}

.alert-btn:active{
  transform: scale(.96);
}
.admin-box textarea,
.admin-box input {
  box-sizing: border-box;
  max-width: 100%;
}

.site-lock-box{
  background:#fff;
  border-radius:14px;
  padding:16px;
  margin:12px 12px 18px;
  box-shadow:0 4px 12px rgba(0,0,0,.08);
}

.site-lock-header{
  display:flex;
  justify-content:space-between;
  align-items:center;
  cursor:pointer;
}

#site-lock-arrow{
  font-size:20px;
  transition:.25s ease;
}

.site-lock-content{
  margin-top:12px;
  overflow:hidden;
  transition:max-height .3s ease, opacity .25s ease;
  max-height:0;
  opacity:0;
}

.site-lock-content.open{
  max-height:400px;
  opacity:1;
}

.site-lock-content input,
.site-lock-content textarea{
  width:100%;
  padding:10px;
  border-radius:10px;
  border:1px solid #ccc;
  margin-bottom:10px;
}


#admin-alert-box input[type="datetime-local"]{
  width:100%;
  min-width:0;
  box-sizing:border-box;
  font-size:16px;
}

.admin-top-bar{
  display:flex;
  align-items:center;
  justify-content:space-between;

  padding:10px 16px;
  margin-bottom:12px;
}

/* üë• Online */
#online-counter{
  font-size:13px;
  font-weight:600;

  color:#34c759;
  background:#eaffea;

  padding:4px 10px;
  border-radius:999px;
}

/* üî¥ Logout */
#admin-logout-btn{
  padding:6px 14px;
  border-radius:999px;
  border:none;

  background:#ff3b30;
  color:#fff;

  font-size:13px;
  font-weight:700;

  cursor:pointer;
  transition:.2s;
}

#admin-logout-btn:active{
  transform:scale(.95);
  opacity:.8;
}


/* wrapper azioni */
.top-actions{
  display:flex;
  align-items:center;
  gap:8px;
  position:absolute;
  right:14px;
  top:10px;
}

/* BOTTONI ICONA */
.reload-btn,
.qr-btn,
.mail-btn{
  width:34px;
  height:34px;

  border-radius:10px;
  border:none;

  background:#f2f2f7;
  color:#111;

  font-size:16px;

  display:flex;
  align-items:center;
  justify-content:center;

  cursor:pointer;
  text-decoration:none;

  transition:.15s ease;
}

/* hover */
.reload-btn:hover,
.qr-btn:hover,
.mail-btn:hover{
  background:#e5e5ea;
}

/* active effetto iOS */
.reload-btn:active,
.qr-btn:active,
.mail-btn:active{
  transform:scale(.92);
  background:#dcdce0;
}
/* üîí Blocca doppio tap zoom solo sul keypad PIN */
.pin-keypad button{
  touch-action: manipulation;
}

/* (opzionale ma consigliato) */
.pin-keypad{
  user-select: none;
  -webkit-user-select: none;
}
.admin-feedback-link{
  max-width: 520px;
  margin: 0 auto 14px auto;
  padding: 0 20px;
}

.admin-feedback-link a{
  color: #007aff;
  font-weight: 600;
  font-size: 15px;
  text-decoration: none;
}

.admin-feedback-link a:active{
  opacity: .6;
}
</style>

</head>

<body>


<div id="top-fixed-bar">


<div class="admin-top-bar">
  <div id="online-counter">
    üë• Online: --
  </div>

  <button id="admin-logout-btn">Logout</button>
</div>

  <div class="top-actions">

    <button class="reload-btn" onclick="reloadAdmin()">
  üîÑ
</button>

    <a href="admin-scan.html" class="qr-btn">üì∑</a>

    <button id="email-dropdown-btn" class="mail-btn">
      ‚úâÔ∏è 
    </button>

    <div id="email-dropdown">
      <div class="dropdown-item" onclick="apriBoxEmailRegistrati()">
        ‚úâÔ∏è A tutti i registrati
      </div>

      <div class="dropdown-item" onclick="inviaEmail_Disiscritti()">
        üö´ A tutti i disiscritti
      </div>

      <div class="dropdown-item" onclick="inviaEmail_10Coppe()">
        üéÅ A chi ha 10+ coppe confermate
      </div>
    </div>
  </div>

</div>
<div id="spacer"></div>

<div class="admin-feedback-link">
  <a href="admin-feedback.html">
    Vai ai feedback utenti ‚Üí
  </a>
</div>

  <!-- üç® TOGGLE CREA COPPA -->
  <div class="admin-setting">
    <div class="admin-setting-text">
      <div class="admin-title">üç® Crea Coppa</div>
      <div class="admin-desc">
        Abilita la creazione delle coppe sul sito
      </div>
    </div>

    <label class="ios-switch">
      <input type="checkbox" id="toggle-crea-coppa">
      <span class="slider"></span>
    </label>
  </div>

  <!-- üç® TESTO CREA COPPA -->
<div class="admin-box site-lock-box">

  <div class="site-lock-header" onclick="toggleCreaCoppaBox()">
    <div style="font-weight:800;">Testo Popup Crea Coppa</div>
    <div id="crea-coppa-arrow">‚åÑ</div>
  </div>

  <div id="crea-coppa-content" class="site-lock-content">

    <input id="crea-coppa-title" type="text"
      placeholder="Titolo popup"
    >

    <textarea id="crea-coppa-message"
      placeholder="Testo popup (puoi andare a capo)"
    ></textarea>

    <button onclick="salvaCreaCoppaTesto()"
      style="margin-top:10px; width:100%;">
      Salva testo popup
    </button>

  </div>

</div>

<!-- üö® SITE LOCK -->
<div class="admin-setting">
  <div class="admin-setting-text">
    <div class="admin-title">üö® Site Lock</div>
    <div class="admin-desc">
      Blocca tutto il sito e mostra un messaggio di emergenza
    </div>
  </div>

  <label class="ios-switch">
    <input type="checkbox" id="toggle-site-lock">
    <span class="slider"></span>
  </label>
</div>

<!-- Box testo Site Lock -->
<div class="admin-box site-lock-box">

  <!-- HEADER CLICCABILE -->
  <div class="site-lock-header" onclick="toggleSiteLockBox()">
    <div style="font-weight:800;">Testo Site Lock</div>
    <div id="site-lock-arrow">‚åÑ</div>
  </div>

  <!-- CONTENUTO -->
  <div id="site-lock-content" class="site-lock-content">

    <input id="site-lock-title" type="text"
      placeholder="Titolo (es. Sito temporaneamente non disponibile)"
    >

    <textarea id="site-lock-message"
      placeholder="Messaggio (es. Stiamo risolvendo un problema tecnico...)"
    ></textarea>

    <button onclick="salvaSiteLock()"
      style="margin-top:10px; width:100%; background:#ff3b30;">
      Salva Site Lock
    </button>

  </div>

</div>


<!-- ‚è≥ TEMPO DI ATTESA -->
<div style="text-align:center; margin:20px 0;">
  <h3>‚è≥ Tempo di attesa clienti</h3>

  <div style="display:flex; gap:10px; justify-content:center; flex-wrap:wrap;">
    <button onclick="setWaitTime(5)">5 min</button>
    <button onclick="setWaitTime(10)">10 min</button>
    <button onclick="setWaitTime(15)">15 min</button>
    <button onclick="setWaitTime(20)">20 min</button>
    <button onclick="disableWaitTime()" style="background:#ff3b30;">
      OFF
    </button>
  </div>
</div>

<input id="search-admin" type="text" placeholder="Cerca utenti o coppe...">


<div class="admin-tabs">

  <button class="tab-btn active"
          onclick="apriSezioneAdmin('sezione-dashboard', this)">
    Dashboard
  </button>

  <button class="tab-btn"
          onclick="apriSezioneAdmin('sezione-disponibilita', this)">
    Disponibilit√†
  </button>

  <button class="tab-btn"
          onclick="apriSezioneAdmin('sezione-statistiche', this)">
    Statistiche
  </button>

  <button class="tab-btn"
          onclick="apriSezioneAdmin('admin-locali', this)">
    üè™ Gestione Locali
  </button>

  <button class="tab-btn alert-btn"
          onclick="apriSezioneAdmin('admin-alert-box', this)">
    üîî Avviso
  </button>

</div>

<!-- üîî AVVISO SITO -->
<div id="admin-alert-box" class="admin-section-content hidden admin-box" style="
  background:#fff;
  border-radius:14px;
  padding:16px;
  margin:16px 12px;
  box-shadow:0 4px 12px rgba(0,0,0,.08);
">
  <h3 style="margin-top:0">üîî Avviso sito</h3>

  <label style="display:flex;align-items:center;gap:10px;margin-bottom:10px">
    <input type="checkbox" id="alert-enabled">
    <span>Avviso attivo</span>
  </label>

  <textarea
    id="alert-text"
    placeholder="Testo avviso..."
    style="width:100%;min-height:70px;padding:10px;border-radius:10px;border:1px solid #ccc"
  ></textarea>

<div style="display:flex; gap:10px; margin-top:10px; flex-wrap:wrap;">
  <div style="flex:1;">
    <label style="font-size:13px; font-weight:600;">Inizio</label>
    <input type="datetime-local" id="alert-start"
      style="width:100%; padding:8px; border-radius:8px; border:1px solid #ccc;">
  </div>

  <div style="flex:1;">
    <label style="font-size:13px; font-weight:600;">Fine</label>
    <input type="datetime-local" id="alert-end"
      style="width:100%; padding:8px; border-radius:8px; border:1px solid #ccc;">
  </div>
</div>

  <button
    onclick="salvaAvviso()"
    style="
      margin-top:10px;
      width:100%;
      background:#007aff;
      color:#fff;
      border:none;
      padding:10px;
      border-radius:10px;
      font-weight:600;
      font-size:15px;
    ">
    Salva avviso
  </button>
</div>

<style>
.tab-btn {
    padding: 10px 20px;
    border-radius: 10px;
    border: none;
    margin: 0 5px;
    background: #007aff;
    color: white;
    font-size: 15px;
    cursor: pointer;
}
.tab-btn.active {
    background: #005ecb;
}
.stat-box{
  background:#fff;
  border-radius:14px;
  padding:16px;
  text-align:center;
  box-shadow:0 4px 12px rgba(0,0,0,.08);
}

.stat-num{
  font-size:28px;
  font-weight:800;
  color:#007aff;
}

.stat-label{
  margin-top:4px;
  font-size:14px;
  color:#555;
  font-weight:600;
}
.stat-list{
  margin-top:18px;
  background:#fff;
  border-radius:14px;
  padding:14px;
  box-shadow:0 4px 12px rgba(0,0,0,.08);
}

.stat-list h4{
  margin:0 0 10px 0;
  font-size:15px;
}

.stat-items{
  display:flex;
  flex-wrap:wrap;
  gap:8px;
}

.stat-item{
  background:#f2f2f7;
  border-radius:999px;
  padding:6px 10px;
  font-size:13px;
  font-weight:600;
  display:flex;
  gap:6px;
}

.stat-item span{
  color:#007aff;
}
.admin-setting{
  display:flex;
  align-items:center;
  justify-content:space-between;
  padding:16px;
  background:#fff;
  border-radius:16px;
  box-shadow:0 6px 18px rgba(0,0,0,0.08);
  margin-bottom:18px;
}

.admin-setting-text{
  display:flex;
  flex-direction:column;
  gap:4px;
}

.admin-title{
  font-size:16px;
  font-weight:700;
  color:#111;
}

.admin-desc{
  font-size:13px;
  color:#666;
}

/* üçé iOS SWITCH */
.ios-switch{
  position:relative;
  width:50px;
  height:30px;
}

.ios-switch input{
  opacity:0;
  width:0;
  height:0;
}

.slider{
  position:absolute;
  inset:0;
  background:#e5e5ea;
  border-radius:999px;
  transition:.25s;
  cursor:pointer;
}

.slider::before{
  content:"";
  position:absolute;
  height:26px;
  width:26px;
  left:2px;
  top:2px;
  background:#fff;
  border-radius:50%;
  box-shadow:0 2px 6px rgba(0,0,0,.25);
  transition:.25s cubic-bezier(.22,.61,.36,1);
}

.ios-switch input:checked + .slider{
  background:#34c759;
}

.ios-switch input:checked + .slider::before{
  transform:translateX(20px);
}

.admin-setting {
  display: flex;
  align-items: center;
  justify-content: space-between;
}

.ios-switch {
  flex-shrink: 0;
}

.pin-overlay{
  position: fixed;
  inset: 0;
  background: rgba(0,0,0,.55);
  backdrop-filter: blur(10px);
  z-index: 99999;

  display: flex;
  align-items: center;
  justify-content: center;
}

.pin-box{
  background: #fff;
  border-radius: 20px;
  width: 320px;
  padding: 22px;
  text-align: center;
}

.pin-box h2{
  font-size: 18px;
  margin-bottom: 18px;
}

.pin-dots{
  display: flex;
  justify-content: center;
  gap: 12px;
  margin-bottom: 22px;
}

.pin-dots span{
  width: 12px;
  height: 12px;
  border-radius: 50%;
  background: #d1d1d6;
  transition: background .15s ease;
}

.pin-dots span.filled{
  background: #007aff;
}

.pin-keypad {
  display: grid;
  grid-template-columns: repeat(3, 78px); /* ‚¨ÖÔ∏è PI√ô LARGHI */
  gap: 28px;                              /* ‚¨ÖÔ∏è aria tra i tasti */
  justify-content: center;
  align-items: center;
  margin: 32px auto 0;                   /* ‚¨ÖÔ∏è pi√π respiro sopra */
}
.pin-keypad button {
  width: 78px;
  height: 78px;
  border-radius: 50%;

  display: flex;
  align-items: center;
  justify-content: center;

  background: #f2f2f7;          /* ‚¨ÖÔ∏è grigio iOS */
  color: #111;                  /* testo scuro */
  font-size: 26px;
  font-weight: 600;

  border: none;
}

.pin-keypad button:active {
  background: #e5e5ea;          /* ‚¨ÖÔ∏è grigio pi√π scuro */
  transform: scale(0.92);
}

.pin-keypad .empty{
  background: transparent;
}

.pin-cancel{
  margin-top: 18px;
  background: none;
  border: none;
  color: #007aff;
  font-size: 15px;
}

.admin-section {
  margin-top: 40px;
}

.admin-section-title {
  font-size: 20px;
  font-weight: 700;
  margin-bottom: 16px;
}
.admin-card {
  background: #fff;
  border-radius: 18px;
  padding: 16px;
  margin-bottom: 20px;   /* üî• spazio tra card */
  box-shadow: 0 4px 18px rgba(0,0,0,0.06);
}

.admin-card h3 {
  margin-top: 0;
  font-size: 16px;
  margin-bottom: 16px;
}

.admin-row {
  display: flex;
  flex-direction: column;
  margin-bottom: 14px;
}

.admin-row label {
  font-size: 13px;
  opacity: 0.6;
  margin-bottom: 4px;
}

.admin-row input {
  padding: 8px 10px;
  border-radius: 8px;
  border: 1px solid #ddd;
}

.admin-save-btn {
  background: #007aff;
  color: white;
  border: none;
  font-weight: 600;
}
.hidden {
  display: none !important;
}

.orari-actions{
  display: flex;
  gap: 10px;
  margin-top: 12px;
}

.reset-btn{
  background: #f2f2f7;
  color: #444;
  border: 1px solid #ddd;
  border-radius: 12px;
  padding: 10px 14px;
  font-size: 14px;
  font-weight: 500;
  cursor: pointer;
  transition: all 0.2s ease;
}

.reset-btn:hover{
  background: #e5e5ea;
}
.orari-actions button {
  flex: 1;              /* üî• stessa larghezza */
  height: 42px;         /* üî• stessa altezza */
  display: flex;
  align-items: center;
  justify-content: center;
  border-radius: 12px;
}
/* üì± FIX ZOOM iOS INPUT */
input,
textarea,
select {
  font-size: 16px !important;
}


#admin-logout-btn{
  position:absolute;
  left:12px;

  padding:8px 14px;
  border-radius:12px;
  border:none;

  background:#ff3b30;
  color:#fff;

  font-size:14px;
  font-weight:600;

  cursor:pointer;

  box-shadow:0 6px 18px rgba(255,59,48,.35);
  transition:.2s ease;
}

#admin-logout-btn:active{
  transform:scale(.95);
}
</style>

<!-- üî• Sezione Dashboard (lista utenti + coppe) -->
<div id="sezione-dashboard" class="admin-section-content">
    <div id="admin-list"></div>
</div>

<!-- üî• Sezione Disponibilit√† (inizialmente nascosta) -->
<div id="sezione-disponibilita" class="admin-section-content" style="display:none; padding:20px;"></div>


<!-- üî• Sezione Statistiche -->
<div id="sezione-statistiche" class="admin-section-content" style="display:none; padding:20px;">

  <h2 style="margin-top:0;">üìä Statistiche</h2>

  <!-- BOX RIASSUNTIVO -->
  <div style="
    display:grid;
    grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
    gap:12px;
    margin-bottom:24px;
  ">

    <div class="stat-box">
      <div class="stat-num" id="stat-coppe">--</div>
      <div class="stat-label">Coppe create</div>
    </div>

    <div class="stat-box">
  <div class="stat-num" id="stat-eliminate">--</div>
  <div class="stat-label">Coppe eliminate</div>
</div>

    <div class="stat-box">
      <div class="stat-num" id="stat-coupon">--</div>
      <div class="stat-label">Coupon sbloccati</div>
    </div>

  </div>

  <!-- UTENTI -->
<h3 style="margin-top:30px;">üë• Utenti</h3>

<div style="
  display:grid;
  grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
  gap:12px;
">
<div class="stat-box" onclick="filtraUtentiStatistiche('registrati')">
  <div class="stat-num" id="stat-utenti">--</div>
  <div class="stat-label">Registrati</div>
</div>

<div class="stat-box" onclick="filtraUtentiStatistiche('disiscritti')">
  <div class="stat-num" id="stat-disiscritti">--</div>
  <div class="stat-label">Disiscritti</div>
</div>

<div class="stat-box" onclick="filtraUtentiStatistiche('coupon')">
  <div class="stat-num" id="stat-utenti-coupon">--</div>
  <div class="stat-label">Con coupon</div>
</div>

</div>

<!-- üë§ Lista utenti statistiche -->
<div id="stat-utenti-lista" style="
  margin-top:30px;
  display:none;
">
  <h3 id="stat-utenti-titolo">üë§ Utenti</h3>

  <div id="stat-utenti-righe"></div>
</div>

  <!-- FORMATI -->
  <h3>üç® Formati pi√π usati</h3>

  <div style="
    display:grid;
    grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
    gap:12px;
  ">

    <div class="stat-box">
      <div class="stat-num" id="stat-piccola">--</div>
      <div class="stat-label">Piccola</div>
    </div>

    <div class="stat-box">
      <div class="stat-num" id="stat-media">--</div>
      <div class="stat-label">Media</div>
    </div>

    <div class="stat-box">
      <div class="stat-num" id="stat-grande">--</div>
      <div class="stat-label">Grande</div>
    </div>

  </div>

  <!-- INGREDIENTI PI√ô USATI -->
<h3 style="margin-top:30px;">üìà Ingredienti pi√π usati</h3>

<div id="stat-gusti" class="stat-list">
  <h4>üç¶ Gusti</h4>
  <div class="stat-items"></div>
</div>

<div id="stat-granelle" class="stat-list">
  <h4>üå∞ Granelle</h4>
  <div class="stat-items"></div>
</div>

<div id="stat-topping" class="stat-list">
  <h4>üç´ Topping</h4>
  <div class="stat-items"></div>
</div>

<div id="stat-ingredienti" class="stat-list">
  <h4>üçì Ingredienti</h4>
  <div class="stat-items"></div>
</div>

<div id="stat-extra" class="stat-list">
  <h4>‚ú® Extra</h4>
  <div class="stat-items"></div>
</div>
</div>


<div id="email-registrati-box" style="
  position: relative;   /* üî• QUESTA ERA LA CHIAVE */

  display:none;

  width: calc(100% - 24px);
  max-width: 500px;

  margin: 20px 12px;

  box-sizing: border-box;

  background:white;
  padding:16px;
  border-radius:14px;
  box-shadow:0 4px 12px rgba(0,0,0,0.15);
">

  <h3 style="margin-top:0;">‚úâÔ∏è Email ai registrati</h3>
<button
  onclick="chiudiBoxEmail()"
  style="
    position:absolute;
    top:12px;
    right:12px;
    background:transparent;
    color:#666;
    border:none;
    width:32px;
    height:32px;
    font-size:22px;
    line-height:32px;
    text-align:center;
    cursor:pointer;
  ">
  ‚úï
</button>
<div style="display:flex; gap:8px; flex-wrap:wrap; margin-bottom:12px;">
  <button onclick="presetEmail('promo')">üéâ Promo</button>
  <button onclick="presetEmail('evento')">üìÖ Evento</button>
  <button onclick="presetEmail('avviso')">‚ÑπÔ∏è Avviso</button>
  <button onclick="presetEmail('vuoto')">‚úèÔ∏è Vuoto</button>
</div>
  <input id="mail-oggetto" type="text"
    value="Novit√† da Casa del Gelato üç®"
    style="width:100%; padding:10px; border-radius:10px; border:1px solid #ccc; margin-bottom:10px;"
  >

  <textarea id="mail-testo"
    style="width:100%; height:120px; padding:10px; border-radius:10px; border:1px solid #ccc;"
  >Ciao! üç¶

Abbiamo delle novit√† pensate per te.
Passa a trovarci in gelateria!

‚Äî Casa del Gelato</textarea>

  <button onclick="inviaEmailRegistratiDaForm()"
    style="margin-top:12px; width:100%;">
    üì® Invia email
  </button>
</div>

<style>
.dropdown-item {
    padding:12px 16px;
    font-size:15px;
    cursor:pointer;
    border-bottom:1px solid #eee;
}
.dropdown-item:hover {
    background:#f2f2f2;
}
</style>


<script type="module">
import { supabase } from "./supabase.js";

document.addEventListener("DOMContentLoaded", async () => {

  const toggle = document.getElementById("toggle-crea-coppa");
  if (!toggle) return;

  const { data, error } = await supabase
    .from("site_settings")
    .select("crea_coppa_enabled")
    .eq("id", 1)
    .single();

  if (!error && data) {
    toggle.checked = data.crea_coppa_enabled === true;
  }

  toggle.addEventListener("change", async () => {
    const value = toggle.checked;

    const { error } = await supabase
      .from("site_settings")
      .update({ crea_coppa_enabled: value })
      .eq("id", 1);

    if (error) {
      alert("Errore salvataggio");
      toggle.checked = !value;
    }
  });

});

window.toggleCreaCoppaBox = function(){
  const content = document.getElementById("crea-coppa-content");
  const arrow = document.getElementById("crea-coppa-arrow");

  content.classList.toggle("open");

  arrow.style.transform =
    content.classList.contains("open")
      ? "rotate(180deg)"
      : "rotate(0deg)";
};

async function caricaCreaCoppaAdmin() {
  const { data, error } = await supabase
    .from("site_settings")
    .select("crea_coppa_title, crea_coppa_message")
    .eq("id", 1)
    .single();

  if (error || !data) return;

  document.getElementById("crea-coppa-title").value =
    data.crea_coppa_title || "";

  document.getElementById("crea-coppa-message").value =
    data.crea_coppa_message || "";
}

window.salvaCreaCoppaTesto = async function () {

  const title = document.getElementById("crea-coppa-title").value.trim();
  const message = document.getElementById("crea-coppa-message").value.trim();

  const { error } = await supabase
    .from("site_settings")
    .update({
      crea_coppa_title: title || null,
      crea_coppa_message: message || null,
      updated_at: new Date().toISOString()
    })
    .eq("id", 1);

  if (error) {
    alert("Errore salvataggio testo");
    return;
  }

  alert("Testo popup aggiornato ‚úÖ");
};

window.toggleSiteLockBox = function(){
  const content = document.getElementById("site-lock-content");
  const arrow = document.getElementById("site-lock-arrow");

  if (!content) return;

  content.classList.toggle("open");

  if (content.classList.contains("open")) {
    arrow.style.transform = "rotate(180deg)";
  } else {
    arrow.style.transform = "rotate(0deg)";
  }
};

// ===============================
// üö® SITE LOCK ADMIN (ON/OFF + TESTO)
// ===============================
async function caricaSiteLockAdmin() {
  const { data, error } = await supabase
    .from("site_lock")
    .select("*")
    .eq("id", 1)
    .single();

  if (error || !data) {
    console.warn("Errore caricaSiteLockAdmin:", error?.message);
    return;
  }

  const toggle = document.getElementById("toggle-site-lock");
  const title  = document.getElementById("site-lock-title");
  const msg    = document.getElementById("site-lock-message");

  if (toggle) toggle.checked = data.active === true;
  if (title)  title.value = data.title || "";
  if (msg)    msg.value = data.message || "";
}

// bottone SALVA
window.salvaSiteLock = async function () {
  const toggle = document.getElementById("toggle-site-lock");
  const title  = document.getElementById("site-lock-title");
  const msg    = document.getElementById("site-lock-message");

  const active   = toggle?.checked === true;
  const newTitle = (title?.value || "").trim();
  const newMsg   = (msg?.value || "").trim();

  try {
    const { data, error } = await supabase.functions.invoke(
      "admin-update-site-lock",
      {
        headers: { "x-admin-pin": window.adminPin },
        body: {
          active,
          title: newTitle || null,
          message: newMsg || null
        }
      }
    );

    console.log("SITE LOCK INVOKE ‚Üí", { data, error });

    // a volte data pu√≤ arrivare come stringa
    let payload = data;
    if (typeof payload === "string") {
      try { payload = JSON.parse(payload); } catch {}
    }

    if (error) {
      console.error("Invoke error:", error);
      alert("Errore salvataggio Site Lock");
      return;
    }

    if (!payload || payload.success !== true) {
      console.error("Bad payload:", payload);
      alert("Errore salvataggio Site Lock");
      return;
    }

    alert(active ? "üö® Site Lock ATTIVO" : "‚úÖ Site Lock DISATTIVATO");
  } catch (e) {
    console.error("Catch:", e);
    alert("Errore salvataggio Site Lock");
  }
};

// opzionale: se cambi toggle, salva subito (stile Crea Coppa)
document.addEventListener("DOMContentLoaded", () => {
  caricaSiteLockAdmin();

  const toggle = document.getElementById("toggle-site-lock");
  if (toggle) {
    toggle.addEventListener("change", () => {
      // salva al volo anche senza premere bottone
      window.salvaSiteLock();
    });
  }
});


window.salvaSeason = async function(location) {

  const dateInput  = document.getElementById("season-date-" + location);
  const textInput  = document.getElementById("season-text-" + location);
  const openInput  = document.getElementById("open-time-" + location);
  const closeInput = document.getElementById("close-time-" + location);

  if (!dateInput || !textInput || !openInput || !closeInput) {
    alert("Campi non trovati");
    return;
  }

  const season_opening = dateInput.value || null;
  const season_text    = textInput.value.trim() || null;
  const open_time      = openInput.value || null;
  const close_time     = closeInput.value || null;

  if ((open_time && !close_time) || (!open_time && close_time)) {
    alert("Inserisci sia apertura che chiusura");
    return;
  }

  try {

    const { data, error } = await supabase.functions.invoke(
      "admin-update-shop-settings",
      {
        headers: {
          "x-admin-pin": window.adminPin
        },
        body: {
          location,
          season_opening,
          season_text,
          open_time,
          close_time
        }
      }
    );

    if (error) {
      console.error("Invoke error:", error);
      alert("Errore salvataggio ‚ùå");
      return;
    }

    // Gestione risposta stringa JSON
    let result = data;

    if (typeof result === "string") {
      try {
        result = JSON.parse(result);
      } catch (e) {
        console.error("Parse error:", e);
      }
    }

    if (!result?.success) {
      console.error("Function response:", result);
      alert("Errore salvataggio ‚ùå");
      return;
    }

    alert("Salvato correttamente ‚úÖ");

  } catch (err) {
    console.error("Unexpected error:", err);
    alert("Errore imprevisto ‚ùå");
  }
};

async function loadSeasonAdmin() {

  const { data, error } = await supabase
    .from("shop_settings")
    .select("location, season_opening, season_text, open_time, close_time");

  if (error) {
    console.error("Errore loadSeasonAdmin:", error);
    return;
  }

  data.forEach(row => {

    const dateInput  = document.getElementById("season-date-" + row.location);
    const textInput  = document.getElementById("season-text-" + row.location);
    const openInput  = document.getElementById("open-time-" + row.location);
    const closeInput = document.getElementById("close-time-" + row.location);

    if (dateInput)  dateInput.value  = row.season_opening || "";
    if (textInput)  textInput.value  = row.season_text || "";
    if (openInput)  openInput.value  = row.open_time || "";
    if (closeInput) closeInput.value = row.close_time || "";

  });
}

document.addEventListener("DOMContentLoaded", loadSeasonAdmin);

document.addEventListener("click", async (e) => {
  if (!e.target.classList.contains("save-season")) return;

  const block = e.target.closest(".admin-shop-block");
  const location = block.dataset.location;
  const season_opening = block.querySelector(".season-date").value;
  const season_text = block.querySelector(".season-text").value;

  const { error } = await supabase
    .from("shop_settings")
    .update({
      season_opening,
      season_text
    })
    .eq("location", location);

  if (error) {
    alert("Errore salvataggio");
    console.error(error);
  } else {
    alert("Salvato correttamente ‚úÖ");
  }
});

let UTENTI = [];
let COPPE = [];
let filtro = "";
let filtroConfermate = {};
let filtroEliminate = {};
let filtroStatisticheUtenti = null;
let coppeCollapsed = {}; // memorizza quali coppe sono chiuse/aperte per id
let sezioniAperte = {};
// valori possibili:
// null | "registrati" | "disiscritti" | "coupon"
let COUPON_PER_EMAIL = {};
let annullaUI = {}; // { [coppaId]: { open: boolean, qty: number } }
let sezioneAttiva = "dashboard"; // oppure "disponibilita"
function getAnnullaState(id){
¬†¬†if (!annullaUI[id]) annullaUI[id] = { open:false, qty:1 };
¬†¬†return annullaUI[id];
}
let aggiungiUI = {}; // { [coppaId]: { open: boolean, qty: number } }

function getAggiungiState(id){
  if (!aggiungiUI[id]) aggiungiUI[id] = { open:false, qty:1 };
  return aggiungiUI[id];
}

window.openAnnullaUI = function(id) {
  const st = getAnnullaState(id);
  st.open = true;
  st.qty = 1;

  const c = COPPE.find(x => Number(x.id) === Number(id));
  if (!c) {
    console.warn("Coppa non trovata in openAnnullaUI", id);
    return;
  }

  const email = c.email || "Anonimo";
  renderCoppe(email);
};

window.qtyMinus = function(id){
¬†¬†const st = getAnnullaState(id);
¬†¬†st.qty = Math.max(1, (st.qty||1) - 1);

¬†¬†const c = COPPE.find(x => x.id === id);
¬†¬†const email = c?.email || "Anonimo";
¬†¬†renderCoppe(email);
};

window.qtyPlus = function(id){
¬†¬†const st = getAnnullaState(id);

¬†¬†const c = COPPE.find(x => x.id === id);
¬†¬†const max = Math.max(1, Number(c?.confermate || 0));
¬†¬†st.qty = Math.min(max, (st.qty||1) + 1);

¬†¬†const email = c?.email || "Anonimo";
¬†¬†renderCoppe(email);
};

window.chiudiBoxEmail = function () {
  const box = document.getElementById("email-registrati-box");
  if (!box) return;

  box.style.display = "none";
};

// ‚ûï AUMENTA quantit√† conferme da aggiungere
window.qtyPlusAdd = function(id){
  const st = getAggiungiState(id);
  st.qty = (st.qty || 1) + 1;

  const c = COPPE.find(x => x.id === id);
  if (!c) return;

  renderCoppe(c.email || "Anonimo");
};

// ‚ûñ DIMINUISCE quantit√† conferme da aggiungere
window.qtyMinusAdd = function(id){
  const st = getAggiungiState(id);
  st.qty = Math.max(1, (st.qty || 1) - 1);

  const c = COPPE.find(x => x.id === id);
  if (!c) return;

  renderCoppe(c.email || "Anonimo");
};

window.reloadAdmin = function(){
  location.reload();
};

// üîì Apre il selettore per aggiungere conferme
window.openAggiungiUI = function(id){
  const st = getAggiungiState(id);
  st.open = true;
  st.qty = 1;

  const c = COPPE.find(x => Number(x.id) === Number(id));
  if (!c) return;

  renderCoppe(c.email || "Anonimo");
};

window.applyAnnulla = async function(id) {
  console.log("APPLY ANNULLA ‚Üí ID", id);

  const st = getAnnullaState(id);

  // 1Ô∏è‚É£ Leggo coppa dal DB
  const { data, error } = await supabase
    .from("coppe")
    .select("confermate, email")
    .eq("id", id)
    .single();

  if (error || !data) {
    console.warn("Coppa non trovata", id);
    return;
  }

  const max = Number(data.confermate) || 0;
  if (max === 0) return;

  // 2Ô∏è‚É£ USO qty selezionata
  const qty = Math.min(max, Math.max(1, Number(st.qty || 1)));

  // üîí BLOCCO se andrei sotto conferme gi√† usate per coupon
  if (data.email) {

    const { count: couponCount, error: cErr } = await supabase
      .from("coupon")
      .select("*", { count: "exact", head: true })
      .eq("email", data.email);

    if (cErr) {
      console.warn("Errore count coupon", cErr);
      alert("Errore controllo coupon, riprova");
      return;
    }

    const locked = (couponCount || 0) * 10;

    if ((max - qty) < locked) {
      alert(`‚õî Non puoi annullare: ${locked} conferme sono gi√† usate per coupon.`);
      return;
    }
  }

  const nuovoValore = max - qty;

  // 3Ô∏è‚É£ Update DB
  await supabase
    .from("coppe")
    .update({ confermate: nuovoValore })
    .eq("id", id);

  // üî• RIMUOVO conferme reali (serve per fedelt√†)
  if (data.email) {

    for (let i = 0; i < qty; i++) {

      // prendo una conferma non consumata
      const { data: conferma } = await supabase
        .from("conferme_coppe")
        .select("id")
        .eq("email", data.email)
        .eq("coppa_id", id)
        .limit(1)
        .single();

      if (!conferma) break;

      await supabase
        .from("conferme_coppe")
        .delete()
        .eq("id", conferma.id);
    }
  }

  // 4Ô∏è‚É£ Reset stato UI
  st.open = false;
  st.qty = 1;

  // 5Ô∏è‚É£ Ricarico solo l‚Äôutente giusto
  renderCoppe(data.email || "Anonimo");
};

// ‚úÖ APPLICA AUMENTO CONFERME
window.applyAggiungi = async function(id) {

  const st = getAggiungiState(id);

  const { data, error } = await supabase
    .from("coppe")
    .select("confermate, email, formato")
    .eq("id", id)
    .single();

  if (error || !data) {
    console.warn("Errore lettura coppa", error);
    return;
  }

  const current = Number(data.confermate) || 0;
  const qty = Math.max(1, Number(st.qty || 1));

  // 1Ô∏è‚É£ aggiorno contatore coppa
  await supabase
    .from("coppe")
    .update({ confermate: current + qty })
    .eq("id", id);

  // 2Ô∏è‚É£ salvo le conferme reali (come fa lo scan)
  if (data.email) {
    for (let i = 0; i < qty; i++) {
      await supabase
        .from("conferme_coppe")
        .insert({
          email: data.email,
          coppa_id: id,
          formato: data.formato
        });
    }
  }

  st.open = false;
  st.qty = 1;

  await load(); // ricarica tutto correttamente
};

window.handleAnnullaClick = function(id, multi) {
  console.log("HANDLE ANNULLA", id, multi);

  if (multi) {
    const st = getAnnullaState(id);
    st.open = true;
    st.qty = 1;

    const c = COPPE.find(x => Number(x.id) === Number(id));
    if (!c) return;

    renderCoppe(c.email || "Anonimo");
  } else {
    applyAnnulla(id);
  }
};

function showPopupSaved() {
    const p = document.getElementById("popup-saved");
    p.style.display = "block";
    p.style.opacity = "1";

    setTimeout(() => {
        p.style.opacity = "0";
        setTimeout(() => p.style.display = "none", 300);
    }, 1000);
}


window.filtraUtentiStatistiche = function(tipo) {
  const box = document.getElementById("stat-utenti-lista");

  // üëâ se clicco lo STESSO filtro ‚Üí chiudi
  if (filtroStatisticheUtenti === tipo) {
    filtroStatisticheUtenti = null;
    box.style.display = "none";
    return;
  }

  // üëâ altrimenti apri / cambia filtro
  filtroStatisticheUtenti = tipo;
  renderListaUtentiStatistiche(tipo);
};

// ‚ú® Evidenziazione ricerca
function highlight(text) {
    if (!filtro || !text) return text;

    const search = filtro.replace(/[.*+?^${}()|[\]\\]/g, "\\$&"); // escape regex
    const regex = new RegExp(search, "gi");

    return String(text).replace(regex, match =>
        `<span style="background:yellow; border-radius:4px;">${match}</span>`
    );
}

function renderListaUtentiStatistiche(tipo) {
  const box = document.getElementById("stat-utenti-lista");
  const righe = document.getElementById("stat-utenti-righe");
  const titolo = document.getElementById("stat-utenti-titolo");

  if (!box || !righe) return;

  righe.innerHTML = "";
  box.style.display = "block";

  if (tipo === "registrati") titolo.textContent = "üë§ Utenti registrati";
  if (tipo === "disiscritti") titolo.textContent = "üö´ Utenti disiscritti";
  if (tipo === "coupon") titolo.textContent = "üéÅ Utenti con coupon";

  UTENTI.forEach(u => {
    const email = u.email;
    if (!email) return;

    const stats = getStats(email);

    // FILTRI
    if (tipo === "disiscritti" && !u.disiscritto) return;
    if (tipo === "coupon" && stats.coupon <= 0) return;
    if (tipo === "registrati" && u.disiscritto) return;

    righe.innerHTML += `
      <div style="
        background:#fff;
        border-radius:12px;
        padding:12px;
        margin-bottom:10px;
        box-shadow:0 4px 12px rgba(0,0,0,.06);
      ">
        <b>${u.nome || "-"} ${u.cognome || ""}</b><br>

        <span style="font-size:13px;">
          üìß ${email}
        </span><br>

        <span style="font-size:13px;">
          üóì Iscritto: ${formatDate(u.created_at)}
        </span><br>

        ${
          u.disiscritto
            ? `<span style="font-size:13px; color:#d60000;">
                üö´ Disiscritto: ${formatDate(u.data_disiscrizione)}
               </span><br>`
            : ""
        }

        <span style="font-size:13px; font-weight:600;">
          üéÅ Coupon: ${stats.coupon}
        </span>
      </div>
    `;
  });

  if (!righe.innerHTML) {
    righe.innerHTML = `<p style="opacity:.6;">Nessun utente trovato</p>`;
  }
}

function formatDate(d) {
    if (!d) return "-";

    // se viene passato un oggetto date, ok
    if (d instanceof Date) {
        return d.toLocaleString("it-IT", {
            day: "2-digit",
            month: "2-digit",
            year: "numeric",
            hour: "2-digit",
            minute: "2-digit"
        });
    }

    // se √® una stringa ‚Üí converto a Date
    const date = new Date(String(d));

    if (isNaN(date.getTime())) {
        console.warn("‚ö†Ô∏è Data non valida:", d);
        return d;
    }

    return date.toLocaleString("it-IT", {
        day: "2-digit",
        month: "2-digit",
        year: "numeric",
        hour: "2-digit",
        minute: "2-digit"
    });
}

// üî• Prezzi base coppe
const prezziBase = {
    PICCOLA: 7.50,
    MEDIA: 9.00,
    GRANDE: 12.00
};

// üî• Prezzi extra (uguali alla webapp)
const prezziExtra = {
    "COCCO (3pz)": 0.50,
    "MIX KINDER": 2.50,
    "PANNA EXTRA": 1.80
};

document.getElementById("search-admin").addEventListener("input", e => {
  filtro = (e.target.value || "").toLowerCase();

  if (sezioneAttiva === "disponibilita") {
    window.caricaDisponibilita();
  } else {
    render();
  }
});

window.load = async function(){
  const u = await supabase.from("utenti").select("*");
  const c = await supabase.from("coppe").select("*");

  if (!u.error) UTENTI = u.data;
  window._UTENTI = UTENTI;
  if (!c.error) COPPE = c.data;

  await caricaCouponPerTutti(); // üî• QUESTA RIGA
  render();
}
// load();  // üîí bloccato finch√© non inserisco PIN corretto

// üî• AGGIORNAMENTO IN TEMPO REALE
supabase
  .channel('coppe-realtime')
  .on(
      'postgres_changes',
      { event: '*', schema: 'public', table: 'coppe' },
      payload => {
          console.log("üîÑ Cambio su COPPE:", payload);
          load();  // üî• ricarica UTENTI + COPPE + aggiorna tutto
      }
  )
  .subscribe();

// Aggiornamento realtime utenti (opzionale ma utile)
supabase
  .channel('utenti-realtime')
  .on(
      'postgres_changes',
      { event: '*', schema: 'public', table: 'utenti' },
      payload => {
          console.log("üîÑ Cambio su UTENTI:", payload);
          load();  
      }
  )
  .subscribe();

  supabase
  .channel('disponibilita-realtime')
  .on(
      'postgres_changes',
      { event: '*', schema: 'public', table: 'disponibilita' },
      payload => {
          console.log("üîÑ Cambio su DISPONIBILITA:", payload);
          window.caricaDisponibilita(); // aggiorna la lista
      }
  )
  .subscribe();

  // üî• AGGIORNAMENTO REALTIME COUPON
supabase
  .channel('coupon-realtime')
  .on(
    'postgres_changes',
    { event: '*', schema: 'public', table: 'coupon' },
    payload => {
      console.log("üéÅ Cambio su COUPON:", payload);

      // ricarica solo la UI (non tutto Supabase)
      render();
    }
  )
  .subscribe();


function matchSearch(user) {
    if (!filtro) return true;

    const search = filtro.toLowerCase();

    // üîç Campi utente
    if (
        (user.nome || "").toLowerCase().includes(search) ||
        (user.cognome || "").toLowerCase().includes(search) ||
        (user.email || "").toLowerCase().includes(search)
    ) return true;

    // üîç Cerchiamo nelle coppe
    const stats = getStats(user.email || "Anonimo");

    for (const c of stats.list) {
        // unisco tutta la coppa in testo unico
        const testo = [
            c.nome,
            c.formato,
            JSON.stringify(c.gusti),
            JSON.stringify(c.granelle),
            JSON.stringify(c.topping),
            JSON.stringify(c.ingredienti),
            JSON.stringify(c.extra),
            c.data
        ].join(" ").toLowerCase();

        if (testo.includes(search)) return true;
    }

    return false;
}

// üîç Controlla se una COPPA contiene il testo cercato
function coppaMatchSearch(c) {
    if (!filtro) return true;

    const search = filtro.toLowerCase();

    const fields = [
        c.nome,
        c.formato,
        c.prezzo,
        c.data,
        JSON.stringify(c.gusti),
        JSON.stringify(c.granelle),
        JSON.stringify(c.topping),
        JSON.stringify(c.ingredienti),
        JSON.stringify(c.extra)
    ]
    .join(" ")
    .toLowerCase();

    return fields.includes(search);
}


function getStats(email){
    const list = COPPE.filter(c => (c.email || "Anonimo") === email);

    const tot = list.length;

    // üî• SOMMA DELLE CONFERME REALI
    const conf = list.reduce((sum, c) => {
        return sum + (Number(c.confermate) || 0);
    }, 0);

    const elim = list.filter(c => c.eliminata).length;
    const coupon = COUPON_PER_EMAIL[email] ?? 0;

    return { tot, conf, elim, coupon, list };
}

async function syncCouponUtente(email) {
    const stats = getStats(email);
    const numeroCouponDovuti = Math.floor(stats.conf / 10);

    // Leggi coupon esistenti da Supabase
    const { data: esistenti } = await supabase
        .from("coupon")
        .select("*")
        .eq("email", email);

    const giaCreati = esistenti?.length || 0;

    // Se siamo gi√† allineati ‚Üí fine
    if (giaCreati >= numeroCouponDovuti) return;

    // Quanti coupon mancano
    const daCreare = numeroCouponDovuti - giaCreati;

    // Crea i coupon mancanti
    for (let i = 0; i < daCreare; i++) {
        await supabase.from("coupon").insert([
            {
                email: email,
                codice: "",        // campo vuoto: lo compili tu
                redento: false
            }
        ]);
    }
}


 window.toggleFilters = function(email){
    sezioniAperte[email] = !sezioniAperte[email];

    const box = document.getElementById("c-" + email);
    if (!box) return;

    box.style.display = sezioniAperte[email] ? "block" : "none";

    // üî• FONDAMENTALE
    if (sezioniAperte[email]) {
        renderCoppe(email);
    }
}

// 1Ô∏è‚É£ FUNZIONE
async function aggiornaOnlineCount() {
  const { count, error } = await supabase
    .from("online_users")
    .select("*", { count: "exact", head: true })
    .gt("last_seen", new Date(Date.now() - 30000).toISOString());

  if (error) {
    console.warn("Errore online count", error.message);
    return;
  }

  const box = document.getElementById("online-counter");
  if (box) {
    box.innerHTML = `üë• Online: ${count}`;
  }
}

// 2Ô∏è‚É£ PRIMA CHIAMATA (SUBITO)
aggiornaOnlineCount();
// üîÅ refresh automatico ogni 5 secondi
setInterval(() => {
  aggiornaOnlineCount();
}, 5000);
// 3Ô∏è‚É£ REALTIME
supabase
  .channel("online-users-realtime")
  .on(
    "postgres_changes",
    { event: "*", schema: "public", table: "online_users" },
    () => {
      aggiornaOnlineCount();
    }
  )
  .subscribe();


window.caricaStatisticheBase = async function() {

  // üî¢ COPPE CREATE (non eliminate)
  const { count: totCoppe } = await supabase
    .from("coppe")
    .select("*", { count: "exact", head: true })
    .or("eliminata.is.null,eliminata.eq.false");

  // ‚ùå COPPE ELIMINATE
  const { count: totEliminate } = await supabase
    .from("coppe")
    .select("*", { count: "exact", head: true })
    .eq("eliminata", true);

  // üéÅ COUPON TOTALI
  const { count: totCoupon } = await supabase
    .from("coupon")
    .select("*", { count: "exact", head: true });

  // üë§ UTENTI REGISTRATI
  const { count: totUtenti } = await supabase
    .from("utenti")
    .select("*", { count: "exact", head: true });

  // üö´ UTENTI DISISCRITTI
  const { count: totDisiscritti } = await supabase
    .from("utenti")
    .select("*", { count: "exact", head: true })
    .eq("disiscritto", true);

  // üéÅ UTENTI CON ALMENO 1 COUPON
  const { data: utentiCoupon } = await supabase
    .from("coupon")
    .select("email");

  const utentiConCoupon = new Set(
    (utentiCoupon || []).map(c => c.email)
  ).size;

  // üß© UI
  document.getElementById("stat-coppe").textContent = totCoppe ?? 0;
  document.getElementById("stat-eliminate").textContent = totEliminate ?? 0;
  document.getElementById("stat-coupon").textContent = totCoupon ?? 0;

  document.getElementById("stat-utenti").textContent = totUtenti ?? 0;
  document.getElementById("stat-disiscritti").textContent = totDisiscritti ?? 0;
  document.getElementById("stat-utenti-coupon").textContent = utentiConCoupon ?? 0;
}


window.caricaStatisticheFormati = async function() {

  const { data, error } = await supabase
    .from("coppe")
    .select("formato");

  if (error) return;

  const stats = { PICCOLA: 0, MEDIA: 0, GRANDE: 0 };

  data.forEach(c => {
    if (stats[c.formato] !== undefined) {
      stats[c.formato]++;
    }
  });

  // UI
  document.getElementById("stat-piccola").textContent = stats.PICCOLA;
  document.getElementById("stat-media").textContent   = stats.MEDIA;
  document.getElementById("stat-grande").textContent  = stats.GRANDE;
}


window.caricaStatisticheIngredienti = async function() {
  console.log("üìä STATISTICHE INGREDIENTI");

  const { data, error } = await supabase
    .from("coppe")
    .select("gusti, granelle, topping, ingredienti, extra");

  if (error) {
    console.error("Errore statistiche ingredienti", error);
    return;
  }

  const conta = {
    gusti: {},
    granelle: {},
    topping: {},
    ingredienti: {},
    extra: {}
  };

  function accumula(lista, bucket) {
    if (!Array.isArray(lista)) return;
    lista.forEach(item => {
      bucket[item] = (bucket[item] || 0) + 1;
    });
  }

  data.forEach(c => {
    accumula(Array.isArray(c.gusti) ? c.gusti : JSON.parse(c.gusti || "[]"), conta.gusti);
    accumula(Array.isArray(c.granelle) ? c.granelle : JSON.parse(c.granelle || "[]"), conta.granelle);
    accumula(Array.isArray(c.topping) ? c.topping : JSON.parse(c.topping || "[]"), conta.topping);
    accumula(Array.isArray(c.ingredienti) ? c.ingredienti : JSON.parse(c.ingredienti || "[]"), conta.ingredienti);
    accumula(Array.isArray(c.extra) ? c.extra : JSON.parse(c.extra || "[]"), conta.extra);
  });
  renderStatList("stat-gusti", conta.gusti);
  renderStatList("stat-granelle", conta.granelle);
  renderStatList("stat-topping", conta.topping);
  renderStatList("stat-ingredienti", conta.ingredienti);
  renderStatList("stat-extra", conta.extra);
}

function renderStatList(containerId, dataObj) {
  const box = document.querySelector(`#${containerId} .stat-items`);
  if (!box) return;

  box.innerHTML = "";

  Object.entries(dataObj)
    .sort((a, b) => b[1] - a[1]) // pi√π usati prima
    .slice(0, 10)
    .forEach(([nome, count]) => {
      box.innerHTML += `
        <div class="stat-item">
          ${nome} <span>${count}</span>
        </div>
      `;
    });
}

window.toggleConferma = async function (id) {

  const c = COPPE.find(x => x.id === id);
  if (!c) return;

  const nuovoValore = (Number(c.confermate) || 0) + 1;

  // 1Ô∏è‚É£ aggiorno contatore coppa
  await supabase
    .from("coppe")
    .update({ confermate: nuovoValore })
    .eq("id", id);

  // 2Ô∏è‚É£ salvo conferma reale per fedelt√†
  if (c.email) {
    await supabase
      .from("conferme_coppe")
      .insert({
        email: c.email,
        coppa_id: c.id,
        formato: c.formato
      });
  }

  await load();

  return false;
};


window.annullaConfermaCoppa = async function (id) {
    const coppa = COPPE.find(c => c.id === id);
    if (!coppa) {
        console.warn("Coppa non trovata", id);
        return;
    }

    const max = Number(coppa.confermate) || 0;

    if (max <= 0) {
        alert("Questa coppa non ha conferme da annullare.");
        return;
    }

    let daAnnullare = 1;

    if (max > 1) {
        const input = prompt(
            `Questa coppa √® stata confermata ${max} volte.\nQuante vuoi annullare? (1-${max})`,
            "1"
        );

        if (input === null) return;

        daAnnullare = parseInt(input, 10);
        if (isNaN(daAnnullare) || daAnnullare < 1 || daAnnullare > max) {
            alert("Numero non valido.");
            return;
        }
    }

    const nuoveConfermate = max - daAnnullare;

    await supabase
        .from("coppe")
        .update({ confermate: nuoveConfermate })
        .eq("id", id);

    await load();
};


window.apriSezioneCoupon = async function(email) {

  // Mostra la sezione utente
  sezioniAperte[email] = true;
  renderCoppe(email);

  const box = document.getElementById("coupon-box-" + email);
  if (!box) return;

  // 1) Sincronizzo i coupon giusti
  await syncCouponUtente(email);

  // 2) Prendo i coupon
  const { data: couponFinali, error: couponErr } = await supabase
    .from("coupon")
    .select("id, codice, tipo, redento, used_at, created_at")
    .eq("email", email)
    .order("created_at", { ascending: true });

  if (couponErr) {
    console.error("‚ùå Errore caricamento coupon:", couponErr);
    alert("Errore caricamento coupon");
    return;
  }


  // üî¢ contatori
  const totali = couponFinali.length;
  const disponibili = couponFinali.filter(c => !c.redento).length;

  // 3) Card principale
  let html = `
    <div style="
      margin-top:15px;
      padding:15px;
      background:#fff7d1;
      border-radius:12px;
      border:1px solid #e0c676;
    ">
      <h3 style="margin:0 0 10px 0;">
        üéÅ Coupon Utente
        <span style="font-weight:600; font-size:14px; opacity:.7;">
          (${disponibili}/${totali})
        </span>
      </h3>
  `;

  // 4) Singoli coupon
couponFinali.forEach(cpn => {

  const stato = cpn.redento
    ? `<span style="color:#d60000;font-weight:800;">üî¥ USATO</span>`
    : `<span style="color:#2e9b4f;font-weight:800;">üü¢ DISPONIBILE</span>`;

  const tipo = (cpn.tipo || "-").toString().toUpperCase();

  const usedAt = cpn.used_at
    ? `<div style="font-size:12px;opacity:.65;margin-top:4px;">
         Usato il: ${new Date(cpn.used_at).toLocaleString("it-IT")}
       </div>`
    : "";

  const codice = (cpn.codice || "").trim();

  html += `
    <div style="
        margin-top:12px;
        padding:10px;
        background:white;
        border-radius:8px;
        border:1px solid #eee;
    ">
      <div style="display:flex; justify-content:space-between; align-items:center;">
        <b>Coupon #${cpn.id}</b>
        ${stato}
      </div>

      <div style="margin-top:6px; font-size:14px;">
        üéÅ Tipo coupon: <b>${tipo}</b>
      </div>

      ${usedAt}

      <!-- CODICE COUPON (BOX COMPATTO) -->
      <div
        style="
          width:100%;
          margin-top:8px;
          padding:6px 8px;
          border-radius:8px;
          background:#f4f4f4;
          border:1px solid #ddd;
          font-size:12px;
          line-height:16px;
          white-space:nowrap;
          overflow:hidden;
          text-overflow:ellipsis;
          box-sizing:border-box;
          user-select:all;
        "
        title="${codice || ""}"
      >
        ${codice || "-"}
      </div>

      <!-- BOTTONE QR -->
      <div style="margin-top:8px;">
        <button
          onclick="toggleCouponQR(${cpn.id})"
          style="
            padding:6px 10px;
            background:#eee;
            color:#333;
            border:none;
            border-radius:8px;
            font-size:13px;
            cursor:pointer;
          ">
          üì± Mostra QR
        </button>
      </div>

      <!-- QR (salvo qui il codice vero!) -->
      <div
        id="coupon-qr-${cpn.id}"
        data-code="${codice}"
        style="
          display:none;
          margin-top:10px;
          padding:10px;
          background:#fff;
          border-radius:10px;
          border:1px dashed #ccc;
          text-align:center;
          font-size:13px;
          color:#777;
        ">
        QR in arrivo‚Ä¶
      </div>
    </div>
  `;
});

  // üîö chiusura card principale
  html += `</div>`;

  // 5) Inserimento DOM
  box.innerHTML = html;
  box.style.display = "block";

  // scroll morbido
  box.scrollIntoView({ behavior: "smooth", block: "center" });
};

async function caricaCouponPerTutti() {
  const { data, error } = await supabase
    .from("coupon")
    .select("email");

  if (error) {
    console.error("Errore caricamento coupon globali", error);
    return;
  }

  COUPON_PER_EMAIL = {};

  data.forEach(c => {
    const email = c.email || "Anonimo";
    COUPON_PER_EMAIL[email] = (COUPON_PER_EMAIL[email] || 0) + 1;
  });
}

// üì± Mostra / nasconde area QR del coupon
window.toggleCouponQR = function(couponId) {
  const box = document.getElementById("coupon-qr-" + couponId);
  if (!box) return;

  // toggle visibilit√†
  if (box.style.display === "block") {
    box.style.display = "none";
    return;
  }

  box.style.display = "block";

  // evita rigenerazioni
  if (box.dataset.qrReady === "1") return;

  // ‚úÖ ORA legge dal dataset corretto
  const codice = (box.dataset.code || "").trim();

  if (!codice || !codice.startsWith("cp_")) {
    box.innerHTML = "‚ö†Ô∏è Codice coupon non valido";
    return;
  }

  const BASE_URL = "https://casa-del-gelato.it";
  const url = `${BASE_URL}/admin-scan.html?coupon=${encodeURIComponent(codice)}`;

  box.innerHTML = "";
  new QRCode(box, {
    text: url,
    width: 180,
    height: 180
  });

  box.dataset.qrReady = "1";
};
window.toggleSezioneCoupon = function(email) {
    const box = document.getElementById("coupon-box-" + email);
    if (!box) return;

    // Se √® visibile ‚Üí nascondi
    if (box.style.display === "block") {
        box.style.display = "none";
        box.innerHTML = ""; // pulizia
        return;
    }

    // Se √® nascosto ‚Üí apri
    apriSezioneCoupon(email);
};



// =========================
// COLLASSA / ESPANDI COPPA
// =========================
window.toggleCoppaCollapse = function (id) {
    // üî• inizializza correttamente
    if (coppeCollapsed[id] === undefined) {
        coppeCollapsed[id] = false; // false = APERTA
    } else {
        coppeCollapsed[id] = !coppeCollapsed[id];
    }

    const c = COPPE.find(x => x.id === id);
    if (!c) return;

    renderCoppe(c.email || "Anonimo");
};




window.caricaDisponibilita = async function () {
    const box = document.getElementById("sezione-disponibilita");
    box.innerHTML = "<h2>üç® Disponibilit√† Ingredienti</h2><p>Caricamento...</p>";

    const { data: righe, error } = await supabase
        .from("disponibilita")
        .select("*")
        .order("tipo", { ascending: true })
        .order("nome", { ascending: true });

    if (error) {
        box.innerHTML = "<p>Errore caricamento: " + error.message + "</p>";
        return;
    }

    // GRUPPIAMO PER TIPO (NON categoria)
    const gruppi = {
        Gusti: [],
        Granelle: [],
        Topping: [],
        Ingredienti: [],
        Extra: []
    };

righe.forEach(r => {
    // üîç FILTRO SEARCH
    if (filtro && !r.nome.toLowerCase().includes(filtro)) return;

    if (!gruppi[r.tipo]) gruppi[r.tipo] = [];
    gruppi[r.tipo].push(r);
});

    let html = "";

    for (const categoria of ["Gusti", "Granelle", "Topping", "Ingredienti", "Extra"]) {

        if (!gruppi[categoria] || gruppi[categoria].length === 0) continue;

        html += `<h3 style="margin-top:25px; font-size:20px;">${categoria}</h3>`;

        gruppi[categoria].forEach(item => {

            html += `
                <div style="
                    padding:10px; 
                    margin:6px 0; 
                    background:${item.disponibile ? '#eaffea' : '#ffe1e1'};
                    border-radius:10px;
                    display:flex; 
                    justify-content:space-between;
                    align-items:center;
                ">
                    <b>${item.nome}</b>

                    <label style="display:flex; align-items:center; gap:8px;">
                        <span style="color:${item.disponibile ? 'green' : 'red'};">
                            ${item.disponibile ? "Disponibile" : "Terminato"}
                        </span>

                        <input 
                            type="checkbox" 
                            ${item.disponibile ? "checked" : ""} 
                            onchange="toggleDisponibilita(${item.id}, this.checked)"
                        >
                    </label>
                </div>
            `;
        });
    }

    box.innerHTML = html;
};

async function inizializzaIngrediti() {
    const categorie = {
        "Gusti": [
            "VANIGLIA","FIOR DI LATTE","CIOCCOLATO","NOCCIOLA","FRAGOLA","PISTACCHIO","LIMONE",
            "MELONE","KIWI","BANANA","COCCO","LAMPONE","MANGO","ANANAS","VARIEGATO AMARENA",
            "STRACCIATELLA","YOGURT","YOGURT FRAGOLINE","CREME CARAMEL","BACIO","CAFF√à",
            "TIRAMIS√ô","CROCCANTINO AL RUM","AMARETTO","MALAGA","CHEESECAKE","COOKIES",
            "CREMA ANDALUSA","CREMINO","CREMINO AL PISTACCHIO","AFTER EIGHT",
            "VARIEGATO FICHI NOCI MIELE"
        ],

        "Granelle": [
            "NOCCIOLA","CROCCANTE","PISTACCHIO","COCCO RAPE'","SCAGLIETTE AL CIOCCOLATO","SMARTIES","ZUCCHERINI COLORATI"
        ],

        "Topping": [
            "ANANAS","ARANCIA","FRAGOLA","FRUTTI DI BOSCO","KIWI","MELONE","MENTA","CARAMELLO","MALAGA","CIOCCOLATO","NOCCIOLA","PISTACCHIO",
            "LIQUORE AMARETTO","LIQUORE AL CAFFE'","LIQUORE AL COCCO","SCIROPPO AMARENA","JOGURT NATURALE","VOV","CAFF√à ESPRESSO","CAFF√à DECA","ORZO"
        ],

        "Ingredienti": [
            "AMARENE(4PZ)","MACEDONIA","ANGURIA","ANANAS","BANANA","FRAGOLE","KIWI","MELONE",
            "MIX BOSCO","MELA","PESCA","UVA","FRUTTI DI BOSCO","AMARETTI","NOCCIOLINE","NOCI","UVETTA",
            "MIKADO","AFTER EIGHT","BOUNTY","KITKAT","DUPLO","CIOCCOLATINI"
        ],

        "Extra": [
            "COCCO (3pz)","MIX KINDER","PANNA EXTRA"
        ]
    };

    const insertRows = [];

    for (const tipo in categorie) {
        categorie[tipo].forEach(nome => {
            insertRows.push({
                tipo: tipo,           // ‚Üê colonna del DB
                nome: nome,
                disponibile: false  // false = disponibile
            });
        });
    }

    await supabase.from("disponibilita").insert(insertRows);
}

window.toggleDisponibilita = async function(id, nuovoValore) {

  const { data, error } = await supabase.functions.invoke(
    "admin-update-disponibilita",
    {
      headers: {
       "x-admin-pin": window.adminPin
      },
      body: {
        id,
        disponibile: nuovoValore
      }
    }
  );

  if (error || !data?.success) {
    alert("Errore aggiornamento disponibilit√†");
    return;
  }

  window.caricaDisponibilita();
};

function render(){
    const out = document.getElementById("admin-list");
    out.innerHTML = "";

    UTENTI.forEach(u => {

        const email = u.email || "Anonimo";
        const stats = getStats(email);
       console.log("EMAIL:", email, "CONFIRM:", u.email_confermata);

// "registrati" = nessun filtro extra

        // Mostra utente solo se la ricerca combacia
// con l'utente OPPURE con almeno una sua coppa
const contieneNelleCoppe = stats.list.some(c => coppaMatchSearch(c));
const matchUtente = matchSearch({...u, ...stats});

if (!matchUtente && !contieneNelleCoppe) return;

        const cardCls = u.disiscritto ? "utente-card utente-disiscritto" : "utente-card";

const isConfermato =
  Boolean(u.email_confermata) ||
  Boolean(u.confermato_manualmente);

out.innerHTML += `
  <div class="${cardCls}"
       onclick="toggleFilters('${email}')"
       style="cursor:pointer;">

    <b>${highlight(email)}</b>

    ${
      isConfermato
        ? `
        <div style="
          margin-top:6px;
          display:inline-block;
          background:#34c759;
          color:white;
          padding:4px 10px;
          border-radius:8px;
          font-size:12px;
          font-weight:700;
        ">
          Email confermata
        </div>
        `
        : `
        <div style="
          margin-top:6px;
          display:flex;
          align-items:center;
          gap:8px;
        ">
          <span style="
            background:#ff3b30;
            color:white;
            padding:4px 8px;
            border-radius:8px;
            font-size:12px;
            font-weight:700;
          ">
            ‚ö† Non confermato
          </span>

          <button
            style="
              background:#007aff;
              color:white;
              border:none;
              padding:4px 8px;
              border-radius:8px;
              font-size:12px;
              cursor:pointer;
            "
            onclick="event.stopPropagation(); confermaUtente('${email}')"
          >
            Conferma
          </button>
        </div>
        `
    }

    <div class="counter-row">
      <span class="badge badge-blue">Coppe: ${stats.tot}</span>
      <span class="badge badge-green">Confermate: ${stats.conf}</span>
      <span class="badge badge-red">Eliminate: ${stats.elim}</span>

      <span class="badge badge-coupon"
            onclick="event.stopPropagation(); toggleSezioneCoupon('${email}')">
        üéÅ ${stats.coupon}
      </span>
    </div>
  </div>

  <div id="c-${email}"
       class="coppe-container"
       style="display:${sezioniAperte[email] ? "block" : "none"}">
  </div>

  <div id="coupon-box-${email}" style="display:none;"></div>
`;
    });

    UTENTI.forEach(u => renderCoppe(u.email));
}

window.filtroConfermate = window.filtroConfermate || {};
window.filtroEliminate = window.filtroEliminate || {};

window.renderCoppe = async function(email){
    const box = document.getElementById("c-" + email);
    if (!box) return;

    const stats = getStats(email);
    let arr = stats.list.slice();

// üîç filtra solo le coppe che matchano
if (filtro) {
    arr = arr.filter(c => coppaMatchSearch(c));
}

   if (window.filtroConfermate[email]) {
    arr = arr.filter(c => Number(c.confermate) > 0);
}
    if (window.filtroEliminate[email]) {
        arr = arr.filter(c => c.eliminata);
    }

    // ORDINAMENTO:
// 1Ô∏è‚É£ prima le non eliminate
// 2Ô∏è‚É£ poi le eliminate
// 3Ô∏è‚É£ all‚Äôinterno di ogni gruppo, dalla pi√π recente alla pi√π vecchia
arr.sort((a, b) => {

    // eliminate vanno in fondo
    if (a.eliminata && !b.eliminata) return 1;
    if (!a.eliminata && b.eliminata) return -1;

    // ordine cronologico inverso (pi√π recente prima)
    return new Date(b.data) - new Date(a.data);
});

    // üîé Recupero utente per mostrare i dati sopra i filtri
    const u = UTENTI.find(u => (u.email || "Anonimo") === email);

box.innerHTML = `
    <div class="utente-details">
        <b>Nome:</b> ${highlight(u?.nome || "-")}<br>
        <b>Cognome:</b> ${highlight(u?.cognome || "-")}<br>
    <b>Email:</b>
${
  u?.consenso_promozioni === true
    ? `
      <a href="mailto:${u.email}"
         class="mail-link"
         onclick="event.stopPropagation()">
         ${highlight(u.email)}
      </a>
    `
    : `
      <span class="mail-disabled"
            title="Il cliente non ha accettato comunicazioni">
        ${highlight(u.email)} <span class="mail-no">üö´</span>
      </span>
    `
}
<br>
        <b>Registrato il:</b> ${highlight(formatDate(u?.created_at))}<br>
        ${
            u?.disiscritto 
            ? `<b style="color:red;">Disiscritto il:</b> ${highlight(formatDate(u.data_disiscrizione))}` 
            : ""
        }
    </div>

    <div style="margin:10px 0;">
        <span class="filter-btn ${!window.filtroConfermate[email] && !window.filtroEliminate[email] ? "active":""}" 
            onclick="window.filtroConfermate['${email}']=false; window.filtroEliminate['${email}']=false; window.renderCoppe('${email}'); event.stopPropagation();">
            Tutte
        </span>

        <span class="filter-btn ${window.filtroConfermate[email] ? 'active' : ''}"
            onclick="window.filtroConfermate['${email}']=!window.filtroConfermate['${email}']; window.filtroEliminate['${email}']=false; window.renderCoppe('${email}'); event.stopPropagation();">
            Confermate
        </span>

        <span class="filter-btn ${window.filtroEliminate[email] ? 'active' : ''}"
            onclick="window.filtroEliminate['${email}']=!window.filtroEliminate['${email}']; window.filtroConfermate['${email}']=false; window.renderCoppe('${email}'); event.stopPropagation();">
            Eliminate
        </span>
    </div>
`;


let primoRisultato = false;

arr.forEach(c => {

    const gusti = Array.isArray(c.gusti) ? c.gusti : JSON.parse(c.gusti||"[]");
    const granelle = Array.isArray(c.granelle) ? c.granelle : JSON.parse(c.granelle||"[]");
    const topping = Array.isArray(c.topping) ? c.topping : JSON.parse(c.topping||"[]");
    const ingr = Array.isArray(c.ingredienti) ? c.ingredienti : JSON.parse(c.ingredienti||"[]");
    const extra = Array.isArray(c.extra) ? c.extra : JSON.parse(c.extra||"[]");

    const collapsed = coppeCollapsed[c.id] !== false;

   const coppaCls =
  c.eliminata ? "coppa-box coppa-eliminata" :
  (Number(c.confermate) || 0) > 0 ? "coppa-box coppa-confermata" :
  "coppa-box";

   const icon = collapsed ? "üëÅÔ∏è" : "‚úñÔ∏è";

// üîç scroll SOLO se sto usando la ricerca
if (filtro && !primoRisultato) {
  setTimeout(() => {
    const el = document.getElementById("coppa-" + c.id);
    if (el) el.scrollIntoView({ behavior: "smooth", block: "center" });
  }, 200);
  primoRisultato = true;
}

    box.innerHTML += `
        <div id="coppa-${c.id}" class="${coppaCls}">
      <div style="display:flex; justify-content:space-between; align-items:center;">
¬†¬†¬†¬†<b>${highlight(c.nome || "Coppa senza nome")}</b>

<span
  class="coppa-toggle"
  onclick="event.stopPropagation(); toggleCoppaCollapse(${c.id}); return false;">
  ${icon}
</span>
</div>

            ${c.confermate > 0 ? `
    <div style="
        margin-top:6px;
        display:inline-block;
        background:#34c759;
        color:white;
        padding:4px 10px;
        border-radius:8px;
        font-size:13px;
        font-weight:700;
    ">
        ‚úî Confermata${c.confermate > 1 ? ` x${c.confermate}` : ""}
    </div>
` : ""}

            ${collapsed ? "" : `
                <div style="margin-top:8px;">
                    <b>Data creazione:</b> ${highlight(formatDate(c.data))}<br>

                    <b>Formato:</b> ${highlight(c.formato)} 
                    ${
                        prezziBase[c.formato] 
                        ? ` (${highlight("‚Ç¨" + prezziBase[c.formato].toFixed(2))})`
                        : ""
                    }<br><br>

                    <b>Tavolo:</b> ${highlight(c.tavolo || "-")}<br><br>
                    <b>Gusti:</b> ${highlight(gusti.join(", ") || "-")}<br>
                    <b>Granelle:</b> ${highlight(granelle.join(", ") || "-")}<br>
                    <b>Topping:</b> ${highlight(topping.join(", ") || "-")}<br>
                    <b>Ingredienti:</b> ${highlight(ingr.join(", ") || "-")}<br>

                    <b>Extra:</b> ${
                        extra.length
                            ? extra
                                .map(e => {
                                    const prezzo = prezziExtra[e] || 0;
                                    const label = prezzo > 0 
                                        ? `${e} (+‚Ç¨${prezzo.toFixed(2)})`
                                        : e;
                                    return highlight(label);
                                })
                                .join(", ")
                            : "-"
                    }<br>

                    <b>Prezzo:</b> ${highlight("‚Ç¨" + Number(c.prezzo).toFixed(2))}<br><br>

${
  (Number(c.confermate) > 0)
  ? (() => {
      const st = annullaUI[c.id] || { open:false, qty:1 };
      const stAdd = aggiungiUI[c.id] || { open:false, qty:1 };
      const multi = Number(c.confermate) > 1;
      const disabledClass = (multi && !st.open) ? "disabled" : "";
      const max = Number(c.confermate) || 1;

      return `
        <div class="annulla-wrap">

          <!-- ‚ûï NUOVO: AUMENTA CONFERME -->
      <button class="confirm-btn"
  onclick="${
    stAdd.open
      ? `applyAggiungi(${c.id})`
      : `openAggiungiUI(${c.id})`
  }">
  ${stAdd.open ? `OK +${stAdd.qty}` : "‚ûï Conferma"}
</button>
${stAdd.open ? `
  <div class="qty-box">
    <button class="qty-btn"
      onclick="qtyMinusAdd(${c.id}); event.stopPropagation()">‚àí</button>

    <div class="qty-num">${stAdd.qty}</div>

    <button class="qty-btn"
      onclick="qtyPlusAdd(${c.id}); event.stopPropagation()">+</button>
  </div>
` : ""}

          <!-- ‚ûñ ESISTENTE: ANNULLA -->
          <button class="undo-btn"
            onclick="handleAnnullaClick(${c.id}, ${multi})">
            Annulla conferma
          </button>

          <!-- SELETTORE ANNULLA -->
          <div class="qty-box ${multi ? disabledClass : "disabled"}"
               title="${multi ? "" : "Disponibile solo se confermata pi√π volte"}">
            <button class="qty-btn"
              onclick="qtyMinus(${c.id}); event.stopPropagation();">‚àí</button>

            <div class="qty-num">
              ${multi ? (st.qty || 1) : 1}
            </div>

            <button class="qty-btn"
              onclick="qtyPlus(${c.id}); event.stopPropagation();">+</button>
          </div>

          <!-- OK ANNULLA -->
          ${multi && st.open ? `
            <button class="confirm-btn"
              onclick="applyAnnulla(${c.id})">
              OK (${st.qty || 1}/${max})
            </button>
          ` : ``}

        </div>
      `;
    })()
  : `<button class="confirm-btn"
      onclick="toggleConferma(${c.id})">
      Conferma
    </button>`
}
                </div>
            `}
        </div>
    `;
});
}

// ------------------------------------------------------------
// ‚úâÔ∏è INVIA EMAIL A TUTTI GLI UTENTI REGISTRATI
// ------------------------------------------------------------

window.presetEmail = function (tipo) {
  const oggetto = document.getElementById("mail-oggetto");
  const testo = document.getElementById("mail-testo");

  if (!oggetto || !testo) return;

  if (tipo === "promo") {
    oggetto.value = "Novit√† da Casa del Gelato üç®";
    testo.value =
`Ciao! üç¶

Abbiamo preparato delle novit√† speciali per te.
Passa a trovarci in gelateria!

‚Äî Casa del Gelato`;
  }

  if (tipo === "evento") {
    oggetto.value = "Evento speciale da Casa del Gelato üéâ";
    testo.value =
`Ciao!

Stiamo preparando un evento speciale in gelateria.
Ti aspettiamo presto per scoprire tutte le novit√†!

‚Äî Casa del Gelato`;
  }

  if (tipo === "avviso") {
    oggetto.value = "Comunicazione importante ‚Äì Casa del Gelato";
    testo.value =
`Ciao,

questa √® una comunicazione informativa da Casa del Gelato.

‚Äî Casa del Gelato`;
  }

  if (tipo === "vuoto") {
    oggetto.value = "";
    testo.value = "";
    testo.focus();
  }
};

window.inviaEmailRegistratiDaForm = async function () {
  if (!confirm("Inviare questa email a tutti i registrati?")) return;

  const subject = document.getElementById("mail-oggetto")?.value.trim();
  const testo = document.getElementById("mail-testo")?.value.trim();

  if (!subject || !testo) {
    alert("Oggetto o testo mancanti");
    return;
  }

  // destinatari (stessa logica di prima)
  const emails = UTENTI
    .filter(u =>
      u.email &&
      !u.disiscritto &&
      u.consenso_promozioni === true
    )
    .map(u => u.email);

  if (!emails.length) {
    alert("Nessun destinatario valido");
    return;
  }

  try {
    const res = await fetch(
      "https://casa-del-gelato-mailer-f7ds.vercel.app/api/admin-mail-registrati",
      {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          emails,
          subject,
          html: testo.replace(/\n/g, "<br>")
        })
      }
    );

    const data = await res.json();

    if (!res.ok) {
      console.error(data);
      alert("‚ùå Errore invio email");
      return;
    }

    alert("‚úÖ Email inviata correttamente");

    // opzionale: chiudi box dopo invio
    document.getElementById("email-registrati-box").style.display = "none";

  } catch (err) {
    console.error(err);
    alert("‚ùå Errore di connessione");
  }
};

window.confermaUtente = async function(email) {

  if (!email) return;

  const ok = confirm(`Confermare manualmente l'utente?\n\n${email}`);
  if (!ok) return;

  const { error } = await supabase
    .from("utenti")
    .update({
      confermato_manualmente: true,
      email_confermata: true   // üî• opzionale ma consigliato
    })
    .eq("email", email);

  if (error) {
    console.error(error);
    alert("Errore conferma utente");
    return;
  }

  alert("Utente confermato manualmente ‚úÖ");

  await load();
};


window.inviaEmail_Registrati = async function () {
  if (!confirm("Inviare una mail a TUTTI gli utenti registrati?")) return;

  // üî• 1. calcolo destinatari QUI (frontend)
  const emails = UTENTI
    .filter(u =>
      u.email &&
      !u.disiscritto &&
      u.consenso_promozioni === true
    )
    .map(u => u.email);

  if (!emails.length) {
    alert("‚ö†Ô∏è Nessun destinatario valido");
    return;
  }

  try {
    // üî• 2. invio DATI al backend
    const res = await fetch(
      "https://casa-del-gelato-mailer-f7ds.vercel.app/api/admin-mail-registrati",
      {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          emails,
          subject: "Novit√† Casa del Gelato üç®",
          html: `
            <h2>Ciao!</h2>
            <p>Abbiamo delle novit√† per te üç¶</p>
            <p>Passa a trovarci da <b>Casa del Gelato</b>!</p>
          `
        })
      }
    );

    const data = await res.json();

    if (!res.ok) {
      console.error(data);
      alert("‚ùå Errore invio email");
      return;
    }

    alert("‚úÖ Email inviate correttamente");

  } catch (err) {
    console.error(err);
    alert("‚ùå Errore di connessione");
  }
};


window.inviaEmail_Disiscritti = async function () {
  if (!confirm("Inviare una mail a TUTTI i disiscritti?")) return;

  const emails = UTENTI
    .filter(u => u.email && u.disiscritto === true)
    .map(u => u.email);

  if (!emails.length) {
    alert("Nessun disiscritto");
    return;
  }

  const res = await fetch(
    "https://casa-del-gelato-mailer-f7ds.vercel.app/api/admin-mail-disiscritti",
    {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({
        emails,
subject: "Comunicazione da Casa del Gelato",
html: `
  <h2>Ciaoüëã</h2>

  <p>
    questa √® una comunicazione di cortesia per confermarti
    che non riceverai pi√π email promozionali da Casa del Gelato.
  </p>

  <p>
    Ti ringraziamo per averci scelto in passato.
  </p>

  <p>
    <b>Casa del Gelato</b>
  </p>
`
      })
    }
  );

  const data = await res.json();

  if (!res.ok) {
    console.error(data);
    alert("Errore invio");
    return;
  }

  alert("‚úÖ Mail disiscritti inviata");
};

window.inviaEmail_10Coppe = async function () {
  if (!confirm("Inviare una mail a chi ha 10 o pi√π coppe confermate?")) return;

  const emails = UTENTI
    .filter(u => {
      if (!u.email) return false;
      if (u.disiscritto) return false;
      if (u.consenso_promozioni !== true) return false;

      const stats = getStats(u.email);
      return stats.conf >= 10;
    })
    .map(u => u.email);

  if (!emails.length) {
    alert("‚ö†Ô∏è Nessun utente con 10+ coppe valido");
    return;
  }

  try {
    const res = await fetch(
      "https://casa-del-gelato-mailer-f7ds.vercel.app/api/admin-mail-10coppe",
      {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          emails,
          subject: "üéÅ Premio Fedelt√† Casa del Gelato",
          html: `
<h2>Complimenti! üéâ</h2>

<p>
  Hai raggiunto <b>10 coppe confermate</b> da Casa del Gelato üç®
</p>

<p>
  Passa a trovarci: ti aspetta una sorpresa!
</p>

<p style="font-size:14px; color:#555;">
  <b>PS:</b> controlla la sezione <b>Coupon</b> nel tuo profilo üòâ
</p>

<p>
  <b>‚Äî Casa del Gelato</b>
</p>
          `
        })
      }
    );

    const data = await res.json();

    if (!res.ok) {
      console.error(data);
      alert("‚ùå Errore invio email premio");
      return;
    }

    alert("‚úÖ Email 10+ coppe inviate");

  } catch (err) {
    console.error(err);
    alert("‚ùå Errore di connessione");
  }
};

document.getElementById("email-dropdown-btn").onclick = function(e) {
    e.stopPropagation();
    const menu = document.getElementById("email-dropdown");
    menu.style.display = (menu.style.display === "block") ? "none" : "block";
};

// chiudi se clicchi fuori
document.addEventListener("click", () => {
    const menu = document.getElementById("email-dropdown");
    if (menu) menu.style.display = "none";
});

window.setWaitTime = async function(minutes) {

  const { data, error } = await supabase.functions.invoke(
    "admin-update-wait-time",
    {
      headers: {
        "x-admin-pin": window.adminPin
      },
      body: {
        minutes: minutes,
        active: true
      }
    }
  );

  if (error || !data?.success) {
    console.error(error);
    alert("Errore aggiornamento tempo attesa");
    return;
  }

  alert(`‚è≥ Tempo di attesa impostato a ${minutes} minuti`);
};

window.disableWaitTime = async function() {

  const { data, error } = await supabase.functions.invoke(
    "admin-update-wait-time",
    {
      headers: {
        "x-admin-pin": window.adminPin
      },
      body: {
        minutes: 0,
        active: false
      }
    }
  );

  if (error || !data?.success) {
    console.error(error);
    alert("Errore aggiornamento tempo attesa");
    return;
  }

  alert("‚õî Tempo di attesa disattivato");
};
document.addEventListener("DOMContentLoaded", () => {
  caricaCreaCoppaAdmin();
  caricaSiteLockAdmin();
});
</script>

<script>
function apriBoxEmailRegistrati() {
  // chiude dropdown
  document.getElementById("email-dropdown").style.display = "none";

  // apre box email
  document.getElementById("email-registrati-box").style.display = "block";

  // scroll automatico
  document
    .getElementById("email-registrati-box")
    .scrollIntoView({ behavior: "smooth", block: "center" });
}
</script>
<script src="https://cdn.jsdelivr.net/npm/qrcodejs/qrcode.min.js"></script>

<script>

async function caricaAvvisoAdmin(){
  const { data, error } = await supabase
    .from("site_alert")
    .select("*")
    .eq("id", 1)
    .single();

  if (error || !data) return;

  document.getElementById("alert-enabled").checked = data.enabled;
  document.getElementById("alert-text").value = data.text || "";
}

window.salvaAvviso = async function () {

  const enabled = document.getElementById("alert-enabled").checked;
  const text = document.getElementById("alert-text").value.trim();

  const start = document.getElementById("alert-start")?.value || null;
  const end   = document.getElementById("alert-end")?.value || null;

  const { data, error } = await supabase.functions.invoke(
    "admin-update-site-alert",
    {
      headers: {
        "x-admin-pin": window.adminPin
      },
      body: {
        enabled,
        text,
        start_at: start ? new Date(start).toISOString() : null,
        end_at: end ? new Date(end).toISOString() : null
      }
    }
  );

console.log(data, error);

if (error) {
  console.error(error);
  alert("Errore salvataggio avviso");
  return;
}

alert("Avviso aggiornato ‚úÖ");
};

document.addEventListener("DOMContentLoaded", caricaAvvisoAdmin);
</script>



<script>
document.addEventListener("DOMContentLoaded", () => {
  const box = document.getElementById("admin-alert-box");
  if (box) box.style.display = "none";
});
</script>



<!-- üîê ADMIN PIN OVERLAY -->
<div id="admin-pin-overlay" class="pin-overlay" hidden>
  <div class="pin-box">
    <h2>Inserisci PIN Admin</h2>

<div class="pin-dots">
  <span></span><span></span><span></span>
  <span></span><span></span><span></span>
</div>

    <div class="pin-keypad">
      <button data-n="1">1</button>
      <button data-n="2">2</button>
      <button data-n="3">3</button>
      <button data-n="4">4</button>
      <button data-n="5">5</button>
      <button data-n="6">6</button>
      <button data-n="7">7</button>
      <button data-n="8">8</button>
      <button data-n="9">9</button>

      <button class="empty"></button>
      <button data-n="0">0</button>
      <button id="pin-del">‚å´</button>
    </div>

  </div>
</div>



<script>

let enteredPin = "";

function openAdminPin() {
  const overlay = document.getElementById("admin-pin-overlay");
  overlay.style.display = "flex";
  enteredPin = "";
  updatePinDots();
}

function closeAdminPin() {
  const overlay = document.getElementById("admin-pin-overlay");
  if (!overlay) return;

  overlay.style.display = "none"; // ‚¨ÖÔ∏è STESSO METODO DI OPEN
  enteredPin = "";
  updatePinDots();
}

function updatePinDots() {
  document.querySelectorAll(".pin-dots span").forEach((d, i) => {
    d.classList.toggle("filled", i < enteredPin.length);
  });
}


async function checkAdminPin() {

  const { data, error } = await supabase.functions.invoke(
    "admin-auth-check",
    {
      headers: {
        "x-admin-pin": enteredPin
      }
    }
  );

  if (error || !data?.success) {
    enteredPin = "";
    updatePinDots();
    return;
  }

  // üî• AGGIUNGI QUESTA RIGA
  window.adminPin = enteredPin;

  localStorage.setItem("isAdmin", "1");

  closeAdminPin();

  await load();
}
document.addEventListener("DOMContentLoaded", () => {
  const keypad = document.querySelector(".pin-keypad");

openAdminPin();

  keypad.addEventListener("click", (e) => {
    const btn = e.target.closest("button");
    if (!btn || btn.classList.contains("empty")) return;

    if (btn.id === "pin-del") {
      enteredPin = enteredPin.slice(0, -1);
      updatePinDots();
      return;
    }

    const n = btn.dataset.n;
    if (!n || enteredPin.length >= 6) return;

    enteredPin += n;
    updatePinDots();

    if (enteredPin.length === 6) {
      setTimeout(checkAdminPin, 150);
    }
  });
});


const logoutBtn = document.getElementById("admin-logout-btn");

if(logoutBtn){
  logoutBtn.addEventListener("click", () => {

    localStorage.removeItem("isAdmin");   // üî• rimuove accesso
    enteredPin = "";                      // reset pin
    updatePinDots();                      // reset pallini

    openAdminPin();                       // riapre schermata PIN

    console.log("Admin disconnesso");
  });
}

function apriSezioneAdmin(idSezione, btn) {

  console.log("CLICK SEZIONE:", idSezione);

  // 1Ô∏è‚É£ Nasconde tutto
  document.querySelectorAll(".admin-section-content")
    .forEach(sec => {
      sec.classList.add("hidden");
      sec.style.display = "none";
    });

  // 2Ô∏è‚É£ Mostra solo la sezione scelta
  const target = document.getElementById(idSezione);
  if (target) {
    target.classList.remove("hidden");
    target.style.display = "block";
  }

  // 3Ô∏è‚É£ Active button
  document.querySelectorAll(".tab-btn")
    .forEach(b => b.classList.remove("active"));

  if (btn) btn.classList.add("active");

  // üî• 4Ô∏è‚É£ CARICAMENTI SPECIFICI PER SEZIONE

  if (idSezione === "sezione-disponibilita") {
    window.caricaDisponibilita();
  }

if (idSezione === "sezione-statistiche") {
  window.caricaStatisticheBase();
  window.caricaStatisticheFormati();
  window.caricaStatisticheIngredienti();
}
}

// üî• DEFAULT ORARI PER OGNI LOCALE
const DEFAULT_HOURS = {
  bibione:   { open: "08:00", close: "00:00" },
  bibione10: { open: "10:00", close: "00:00" },
  lignano:   { open: "10:00", close: "01:00" }
};

window.resetOrari = async function(location){

  const def = DEFAULT_HOURS[location];
  if (!def) return;

  const { error } = await supabase
    .from("shop_settings")
    .update({
      open_time: def.open,
      close_time: def.close,
      updated_at: new Date().toISOString()
    })
    .eq("location", location);

  if (error) {
    console.error(error);
    alert("Errore ripristino orari ‚ùå");
    return;
  }

  // üîÑ aggiorna input nella UI
  document.getElementById("open-time-" + location).value  = def.open;
  document.getElementById("close-time-" + location).value = def.close;

  alert("Orari ripristinati a standard ‚úÖ");
};


</script>

<div id="admin-locali" class="admin-section-content hidden">

  <h2 class="admin-section-title">üè™ Gestione Locali</h2>

  <!-- CARD 1 -->
  <div class="admin-card">
    <h3>Bibione ‚Äì Viale delle Costellazioni 49</h3>

    <div class="admin-row">
      <label>Data apertura stagione</label>
      <input type="date" id="season-date-bibione">
    </div>

    <div class="admin-row">
      <label>Testo personalizzato</label>
      <input type="text" id="season-text-bibione">
    </div>

    <div class="admin-row">
      <label>Orario apertura</label>
      <input type="time" id="open-time-bibione">
    </div>

    <div class="admin-row">
      <label>Orario chiusura</label>
      <input type="time" id="close-time-bibione">
    </div>

    <div class="orari-actions">
      <button class="admin-save-btn" onclick="salvaSeason('bibione')">
        Salva modifiche
      </button>
      <button onclick="resetOrari('bibione')" class="reset-btn">
        Ripristina orari standard
      </button>
    </div>
  </div>

  <!-- CARD 2 -->
  <div class="admin-card">
    <h3>Bibione ‚Äì Costellazioni 10</h3>

    <div class="admin-row">
      <label>Data apertura stagione</label>
      <input type="date" id="season-date-bibione10">
    </div>

    <div class="admin-row">
      <label>Testo personalizzato</label>
      <input type="text" id="season-text-bibione10">
    </div>

    <div class="admin-row">
      <label>Orario apertura</label>
      <input type="time" id="open-time-bibione10">
    </div>

    <div class="admin-row">
      <label>Orario chiusura</label>
      <input type="time" id="close-time-bibione10">
    </div>

    <div class="orari-actions">
      <button class="admin-save-btn" onclick="salvaSeason('bibione10')">
        Salva modifiche
      </button>
      <button onclick="resetOrari('bibione10')" class="reset-btn">
        Ripristina orari standard
      </button>
    </div>
  </div>

  <!-- CARD 3 -->
  <div class="admin-card">
    <h3>Lignano</h3>

    <div class="admin-row">
      <label>Data apertura stagione</label>
      <input type="date" id="season-date-lignano">
    </div>

    <div class="admin-row">
      <label>Testo personalizzato</label>
      <input type="text" id="season-text-lignano">
    </div>

    <div class="admin-row">
      <label>Orario apertura</label>
      <input type="time" id="open-time-lignano">
    </div>

    <div class="admin-row">
      <label>Orario chiusura</label>
      <input type="time" id="close-time-lignano">
    </div>

    <div class="orari-actions">
      <button class="admin-save-btn" onclick="salvaSeason('lignano')">
        Salva modifiche
      </button>
      <button onclick="resetOrari('lignano')" class="reset-btn">
        Ripristina orari standard
      </button>
    </div>
  </div>

</div>





</body>
</html>