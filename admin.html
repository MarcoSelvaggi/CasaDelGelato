<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Admin - Casa del Gelato</title>

<style>
    body {
        font-family: -apple-system, BlinkMacSystemFont, sans-serif;
        background: #f6f6f7;
        margin: 0;
        padding: 0;
    }

    #top-fixed-bar {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 55px;
        background: white;
        border-bottom: 1px solid #ddd;
        z-index: 999;
        display: flex;
        justify-content: center;
        align-items: center;
    }

    .home-btn {
        position: absolute;
        left: 12px;
        display: flex;
        align-items: center;
        text-decoration: none;
        color: #444;
        font-size: 16px;
        gap: 6px;
    }

    .home-btn img { width: 28px; height: 28px; }

    #spacer { height: 70px; }

    h1 { text-align: center; margin-top: 10px; }

    #search-admin {
        display:block;
        margin: 10px auto 5px;
        width: 90%;
        max-width: 600px;
        padding: 10px;
        font-size: 16px;
        border-radius: 12px;
        border: 1px solid #ccc;
    }

    #admin-list {
        padding: 20px;
        max-width: 900px;
        margin: 0 auto;
    }

    .utente-card {
        background: white;
        border-radius: 14px;
        padding: 15px 18px;
        margin-bottom: 14px;
        box-shadow: 0 2px 6px rgba(0,0,0,0.08);
        cursor: pointer;
        border-left: 8px solid #007aff;
    }

    .utente-disiscritto {
        border-left-color: #ff3b30 !important;
        background: #ffecec !important;
    }

    .utente-details {
        margin-top: 10px;
        padding-left: 5px;
        font-size: 15px;
    }

    .counter-row {
        margin-top: 6px;
        display: flex;
        gap: 18px;
        flex-wrap: wrap;
    }

    .badge {
        padding: 4px 10px;
        border-radius: 8px;
        font-size: 14px;
        font-weight: 600;
    }

    .badge-blue { background: #e4f0ff; color: #0052cc; }
    .badge-green { background: #e8ffe8; color: #008a00; }
    .badge-red  { background: #ffe5e5; color: #b20000; }
    .badge-coupon { background: #fff5cc; color: #a67c00; }

    .coppe-container {
        display:none;
        margin-top: 10px;
        padding: 15px;
        background: #ffffff;
        border-radius: 14px;
        border: 1px solid #ddd;
    }

    .coppa-box {
        padding: 10px 12px;
        margin-bottom: 10px;
        border-radius: 12px;
        background: #fafafa;
        border-left: 6px solid #007aff;
    }

    .coppa-eliminata { border-left-color: #ff3b30 !important; background:#ffecec;}
    .coppa-confermata { border-left-color: #00b341 !important; background:#e7ffe9;}

    .filter-btn {
        margin-right: 8px;
        padding: 6px 12px;
        border-radius: 8px;
        background: #eee;
        cursor: pointer;
        display: inline-block;
    }

    .filter-btn.active {
        background: #007aff;
        color: white;
    }

    .confirm-btn {
        padding: 6px 12px;
        background: #00c851;
        color: white;
        border: none;
        border-radius: 8px;
        cursor: pointer;
        margin-top: 6px;
    }

    .undo-btn {
        padding: 6px 12px;
        background: #ff4444;
        color: white;
        border: none;
        border-radius: 8px;
        cursor: pointer;
        margin-top: 6px;
    }
</style>
</head>

<body>

<div id="top-fixed-bar">
    <a class="home-btn" href="index.html">
        <img src="tastohome.png" alt="home">
        <span>Home</span>
    </a>
</div>

<div id="spacer"></div>

<h1>üìä Pannello Admin</h1>

<div style="text-align:center; margin: 20px 0;">
    <button id="btn-dashboard"
            onclick="apriDashboard()" 
            class="tab-btn active">
        Dashboard
    </button>

    <button id="btn-dispo"
            onclick="apriDisponibilita()" 
            class="tab-btn">
        Disponibilit√† ingredienti
    </button>
</div>

<style>
.tab-btn {
    padding: 10px 20px;
    border-radius: 10px;
    border: none;
    margin: 0 5px;
    background: #007aff;
    color: white;
    font-size: 15px;
    cursor: pointer;
}
.tab-btn.active {
    background: #005ecb;
}
</style>
<!-- üî• Sezione Dashboard (lista utenti + coppe) -->
<div id="sezione-dashboard">
    <div id="admin-list"></div>
</div>

<!-- üî• Sezione Disponibilit√† (inizialmente nascosta) -->
<div id="sezione-disponibilita" style="display:none; padding:20px;"></div>


<input id="search-admin" type="text" placeholder="Cerca utenti o coppe...">

<div style="text-align:center; margin-top:10px; position:relative;">
    <button 
        id="email-dropdown-btn"
        style="
            padding:10px 18px;
            background:#007aff;
            color:white;
            font-size:15px;
            border:none;
            border-radius:10px;
            cursor:pointer;
        ">
        ‚úâÔ∏è Invia Email ‚ñº
    </button>

    <div id="popup-saved" 
     style="
        position: fixed;
        bottom: 20px;
        left: 50%;
        transform: translateX(-50%);
        background: rgba(0,0,0,0.85);
        color: white;
        padding: 12px 20px;
        border-radius: 12px;
        font-size: 16px;
        display: none;
        z-index: 9999;
        box-shadow: 0 4px 10px rgba(0,0,0,0.3);
     ">
    üíæ Salvato correttamente
</div>

    <div id="email-dropdown" 
         style="
            display:none;
            position:absolute;
            top:50px;
            left:50%;
            transform:translateX(-50%);
            background:white;
            border-radius:10px;
            box-shadow:0 4px 12px rgba(0,0,0,0.15);
            width:260px;
            z-index:1000;
         ">
         
        <div class="dropdown-item" onclick="inviaEmail_Registrati()">
            ‚úâÔ∏è A tutti i registrati
        </div>

        <div class="dropdown-item" onclick="inviaEmail_Disiscritti()">
            üö´ A tutti i disiscritti
        </div>

        <div class="dropdown-item" onclick="inviaEmail_10Coppe()">
            üéÅ A chi ha 10+ coppe confermate
        </div>

    </div>
</div>

<style>
.dropdown-item {
    padding:12px 16px;
    font-size:15px;
    cursor:pointer;
    border-bottom:1px solid #eee;
}
.dropdown-item:hover {
    background:#f2f2f2;
}
</style>

<div id="admin-list"></div>

<script type="module">
import { supabase } from "./supabase.js";

let UTENTI = [];
let COPPE = [];
let filtro = "";
let filtroConfermate = {};
let filtroEliminate = {};
let coppeCollapsed = {}; // memorizza quali coppe sono chiuse/aperte per id
let sezioniAperte = {};


function showPopupSaved() {
    const p = document.getElementById("popup-saved");
    p.style.display = "block";
    p.style.opacity = "1";

    setTimeout(() => {
        p.style.opacity = "0";
        setTimeout(() => p.style.display = "none", 300);
    }, 1000);
}

// ‚ú® Evidenziazione ricerca
function highlight(text) {
    if (!filtro || !text) return text;

    const search = filtro.replace(/[.*+?^${}()|[\]\\]/g, "\\$&"); // escape regex
    const regex = new RegExp(search, "gi");

    return String(text).replace(regex, match =>
        `<span style="background:yellow; border-radius:4px;">${match}</span>`
    );
}

function formatDate(d) {
    if (!d) return "-";

    // se viene passato un oggetto date, ok
    if (d instanceof Date) {
        return d.toLocaleString("it-IT", {
            day: "2-digit",
            month: "2-digit",
            year: "numeric",
            hour: "2-digit",
            minute: "2-digit"
        });
    }

    // se √® una stringa ‚Üí converto a Date
    const date = new Date(String(d));

    if (isNaN(date.getTime())) {
        console.warn("‚ö†Ô∏è Data non valida:", d);
        return d;
    }

    return date.toLocaleString("it-IT", {
        day: "2-digit",
        month: "2-digit",
        year: "numeric",
        hour: "2-digit",
        minute: "2-digit"
    });
}

// üî• Prezzi base coppe
const prezziBase = {
    PICCOLA: 7.50,
    MEDIA: 9.00,
    GRANDE: 12.00
};

// üî• Prezzi extra (uguali alla webapp)
const prezziExtra = {
    "COCCO (3pz)": 0.50,
    "MIX KINDER": 2.50,
    "PANNA EXTRA": 1.80
};

document.getElementById("search-admin").addEventListener("input", e => {
    filtro = e.target.value.toLowerCase();
    render();
});

async function load(){
    const u = await supabase.from("utenti").select("*");
    const c = await supabase.from("coppe").select("*");

    if (!u.error) UTENTI = u.data;
    if (!c.error) COPPE = c.data;

    render();
}
load();

// üî• AGGIORNAMENTO IN TEMPO REALE
supabase
  .channel('coppe-realtime')
  .on(
      'postgres_changes',
      { event: '*', schema: 'public', table: 'coppe' },
      payload => {
          console.log("üîÑ Cambio su COPPE:", payload);
          load();  // üî• ricarica UTENTI + COPPE + aggiorna tutto
      }
  )
  .subscribe();

// Aggiornamento realtime utenti (opzionale ma utile)
supabase
  .channel('utenti-realtime')
  .on(
      'postgres_changes',
      { event: '*', schema: 'public', table: 'utenti' },
      payload => {
          console.log("üîÑ Cambio su UTENTI:", payload);
          load();  
      }
  )
  .subscribe();

function matchSearch(user) {
    if (!filtro) return true;

    const search = filtro.toLowerCase();

    // üîç Campi utente
    if (
        (user.nome || "").toLowerCase().includes(search) ||
        (user.cognome || "").toLowerCase().includes(search) ||
        (user.email || "").toLowerCase().includes(search)
    ) return true;

    // üîç Cerchiamo nelle coppe
    const stats = getStats(user.email || "Anonimo");

    for (const c of stats.list) {
        // unisco tutta la coppa in testo unico
        const testo = [
            c.nome,
            c.formato,
            JSON.stringify(c.gusti),
            JSON.stringify(c.granelle),
            JSON.stringify(c.topping),
            JSON.stringify(c.ingredienti),
            JSON.stringify(c.extra),
            c.data
        ].join(" ").toLowerCase();

        if (testo.includes(search)) return true;
    }

    return false;
}

// üîç Controlla se una COPPA contiene il testo cercato
function coppaMatchSearch(c) {
    if (!filtro) return true;

    const search = filtro.toLowerCase();

    const fields = [
        c.nome,
        c.formato,
        c.prezzo,
        c.data,
        JSON.stringify(c.gusti),
        JSON.stringify(c.granelle),
        JSON.stringify(c.topping),
        JSON.stringify(c.ingredienti),
        JSON.stringify(c.extra)
    ]
    .join(" ")
    .toLowerCase();

    return fields.includes(search);
}


function getStats(email){
    const list = COPPE.filter(c => (c.email || "Anonimo") === email);
    const tot = list.length;
    const conf = list.filter(c=>c.confermata).length;
    const elim = list.filter(c=>c.eliminata).length;
    const coupon = Math.floor(conf / 10);
    return {tot, conf, elim, coupon, list};
}

async function syncCouponUtente(email) {
    const stats = getStats(email);
    const numeroCouponDovuti = Math.floor(stats.conf / 10);

    // Leggi coupon esistenti da Supabase
    const { data: esistenti } = await supabase
        .from("coupon")
        .select("*")
        .eq("email", email);

    const giaCreati = esistenti?.length || 0;

    // Se siamo gi√† allineati ‚Üí fine
    if (giaCreati >= numeroCouponDovuti) return;

    // Quanti coupon mancano
    const daCreare = numeroCouponDovuti - giaCreati;

    // Crea i coupon mancanti
    for (let i = 0; i < daCreare; i++) {
        await supabase.from("coupon").insert([
            {
                email: email,
                codice: "",        // campo vuoto: lo compili tu
                redento: false
            }
        ]);
    }
}

function toggleFilters(email){
    // inverti stato "aperto/chiuso" in memoria
    sezioniAperte[email] = !sezioniAperte[email];

    const box = document.getElementById("c-" + email);
    if (!box) return;

    box.style.display = sezioniAperte[email] ? "block" : "none";
}

async function toggleConferma(id, current){
    await supabase.from("coppe").update({
        confermata: !current
    }).eq("id", id);

    const coppa = COPPE.find(c => c.id === id);
    if (coppa) coppa.confermata = !current;

    await load(); // ricarica TUTTO ma non chiude nulla
}

// üëâ espongo oggetti e funzioni usati negli onclick HTML
window.toggleFilters = toggleFilters;
window.toggleConferma = toggleConferma;
window.renderCoppe = renderCoppe;
window.filtroConfermate = filtroConfermate;
window.filtroEliminate = filtroEliminate;

window.apriSezioneCoupon = async function(email) {

    // Mostra la sezione utente
    sezioniAperte[email] = true;
    renderCoppe(email);

    const box = document.getElementById("coupon-box-" + email);
    if (!box) return;

    // 1) Sincronizzo i coupon giusti
    await syncCouponUtente(email);

    // 2) Prendo i coupon
    const { data: couponFinali } = await supabase
        .from("coupon")
        .select("*")
        .eq("email", email)
        .order("created_at", { ascending: true });

    // 3) Costruisco l‚ÄôHTML della card coupon
    let html = `
        <div style="
            margin-top:15px;
            padding:15px;
            background:#fff7d1;
            border-radius:12px;
            border:1px solid #e0c676;
        ">
            <h3>üéÅ Coupon Utente (${couponFinali.length})</h3>
    `;

    couponFinali.forEach(cpn => {
        html += `
            <div style="margin-top:12px; padding:10px; background:white; border-radius:8px;">
                <b>Coupon #${cpn.id}</b><br>

                <textarea id="coupon-text-${cpn.id}"
                    style="width:100%; padding:8px; border-radius:8px; margin-top:5px;">${cpn.codice || ""}</textarea>

                <button onclick="salvaCoupon(${cpn.id})"
                    style="margin-top:6px; padding:6px 12px; background:#007aff; color:white; border:none; border-radius:8px;">
                    üíæ Salva
                </button>
            </div>
        `;
    });

    html += `</div>`;

    // 4) Inserisco nel box coupon
    box.innerHTML = html;
    box.style.display = "block";

    // Scroll
    box.scrollIntoView({ behavior: "smooth", block: "center" });
};

window.toggleSezioneCoupon = function(email) {
    const box = document.getElementById("coupon-box-" + email);
    if (!box) return;

    // Se √® visibile ‚Üí nascondi
    if (box.style.display === "block") {
        box.style.display = "none";
        box.innerHTML = ""; // pulizia
        return;
    }

    // Se √® nascosto ‚Üí apri
    apriSezioneCoupon(email);
};

// üíæ SALVA COUPON
window.salvaCoupon = async function(id) {
    const textarea = document.getElementById("coupon-text-" + id);
    const valore = textarea.value.trim();

    const { error } = await supabase
        .from("coupon")
        .update({ codice: valore })
        .eq("id", id);

    if (error) {
        alert("Errore nel salvataggio del coupon: " + error.message);
        return;
    }

    // Effetto verde
    textarea.style.background = "#d8ffd8";
    setTimeout(() => {
        textarea.style.background = "white";
    }, 800);

    // ‚≠ê MOSTRA POPUP SALVATO
    showPopupSaved();
};

// =========================
// COLLASSA / ESPANDI COPPA
// =========================
window.toggleCoppaCollapse = function (id) {
    // inverti stato aperto/chiuso
    coppeCollapsed[id] = !coppeCollapsed[id];

    // trova la coppa per capire di quale utente √®
    const c = COPPE.find(x => x.id === id);
    if (!c) return;

    const email = c.email || "Anonimo";

    // ricarica solo quella sezione (non tutta la pagina)
    renderCoppe(email);
};

window.apriDashboard = function() {
    document.getElementById("sezione-dashboard").style.display = "block";
    document.getElementById("sezione-disponibilita").style.display = "none";

    // aggiorno pulsanti
    document.getElementById("btn-dashboard").classList.add("active");
    document.getElementById("btn-dispo").classList.remove("active");
};

window.apriDisponibilita = function() {
    document.getElementById("sezione-dashboard").style.display = "none";
    document.getElementById("sezione-disponibilita").style.display = "block";

    document.getElementById("btn-dashboard").classList.remove("active");
    document.getElementById("btn-dispo").classList.add("active");

    // carica ingredienti non disponibili
    caricaDisponibilita();
};

window.caricaDisponibilita = async function () {
    const box = document.getElementById("sezione-disponibilita");
    box.innerHTML = "<h2>üç® Disponibilit√† Ingredienti</h2><p>Caricamento...</p>";

    const { data: righe, error } = await supabase
        .from("disponibilita")
        .select("*")
        .order("categoria", { ascending: true })
        .order("nome", { ascending: true });

    if (error) {
        box.innerHTML = "<p>Errore caricamento: " + error.message + "</p>";
        return;
    }

    // GRUPPIAMO PER CATEGORIA
    const gruppi = {
        Gusti: [],
        Granelle: [],
        Topping: [],
        Ingredienti: [],
        Extra: []
    };

    righe.forEach(r => {
        if (!gruppi[r.categoria]) gruppi[r.categoria] = [];
        gruppi[r.categoria].push(r);
    });

    let html = "";

    for (const categoria of ["Gusti", "Granelle", "Topping", "Ingredienti", "Extra"]) {

        if (!gruppi[categoria] || gruppi[categoria].length === 0) continue;

        html += `<h3 style="margin-top:25px; font-size:20px;">${categoria}</h3>`;

        gruppi[categoria].forEach(item => {
            html += `
                <div style="
                    padding:10px; 
                    margin:6px 0; 
                    background:${item.disponibile ? '#eaffea' : '#ffe1e1'};
                    border-radius:10px;
                    display:flex; 
                    justify-content:space-between;
                    align-items:center;
                ">
                    <b>${item.nome}</b>

                    <label style="display:flex; align-items:center; gap:8px;">
                        <span style="color:${item.disponibile ? 'green' : 'red'};">
                            ${item.disponibile ? "Disponibile" : "Terminato"}
                        </span>

                        <input 
                            type="checkbox" 
                            ${item.disponibile ? "checked" : ""} 
                            onchange="toggleDisponibilita(${item.id}, this.checked)"
                        >
                    </label>
                </div>
            `;
        });
    }

    box.innerHTML = html;
};

async function inizializzaIngrediti() {
    const categorie = {
        "Gusti": [
            "VANIGLIA","FIOR DI LATTE","CIOCCOLATO","NOCCIOLA","FRAGOLA","PISTACCHIO","LIMONE",
            "MELONE","KIWI","BANANA","COCCO","LAMPONE","MANGO","ANANAS","VARIEGATO AMARENA",
            "STRACCIATELLA","YOGURT","YOGURT FRAGOLINE","CREME CARAMEL","BACIO","CAFF√à",
            "TIRAMIS√ô","CROCCANTINO AL RUM","AMARETTO","MALAGA","CHEESECAKE","COOKIES",
            "CREMA ANDALUSA","CREMINO","CREMINO AL PISTACCHIO","AFTER EIGHT",
            "VARIEGATO FICHI NOCI MIELE"
        ],

        "Granelle": [
            "NOCCIOLA","CROCCANTE","PISTACCHIO","COCCO RAPE'","SCAGLIETTE AL CIOCCOLATO","SMARTIES","ZUCCHERINI COLORATI"
        ],

        "Topping": [
            "ANANAS","ARANCIA","FRAGOLA","FRUTTI DI BOSCO","KIWI","MELONE","MENTA","CARAMELLO","MALAGA","CIOCCOLATO","NOCCIOLA","PISTACCHIO",
            "LIQUORE AMARETTO","LIQUORE AL CAFFE'","LIQUORE AL COCCO","SCIROPPO AMARENA","JOGURT NATURALE","VOV","CAFF√à ESPRESSO","CAFF√à DECA","ORZO"
        ],

        "Ingredienti": [
            "AMARENE(4PZ)","MACEDONIA","ANGURIA","ANANAS","BANANA","FRAGOLE","KIWI","MELONE",
            "MIX BOSCO","PESCA","UVA","FRUTTI DI BOSCO","AMARETTI","NOCCIOLINE","NOCI","UVETTA",
            "MIKADO","AFTER EIGHT","BOUNTY","KITKAT","DUPLO","CIOCCOLATINI"
        ],

        "Extra": [
            "COCCO (3pz)","MIX KINDER","PANNA EXTRA"
        ]
    };

    const insertRows = [];

    for (const tipo in categorie) {
        categorie[tipo].forEach(nome => {
            insertRows.push({
                tipo: tipo,           // ‚Üê colonna del DB
                nome: nome,
                disponibile: false  // false = disponibile
            });
        });
    }

    await supabase.from("disponibilita").insert(insertRows);
}

window.toggleDisponibilita = async function(id, nuovoValore) {

    await supabase
        .from("disponibilita")
        .update({ disponibile: nuovoValore })
        .eq("id", id);

    caricaDisponibilita();
};

function render(){
    const out = document.getElementById("admin-list");
    out.innerHTML = "";

    UTENTI.forEach(u => {

        const email = u.email || "Anonimo";
        const stats = getStats(email);

        // Mostra utente solo se la ricerca combacia
// con l'utente OPPURE con almeno una sua coppa
const contieneNelleCoppe = stats.list.some(c => coppaMatchSearch(c));
const matchUtente = matchSearch({...u, ...stats});

if (!matchUtente && !contieneNelleCoppe) return;

        const cardCls = u.disiscritto ? "utente-card utente-disiscritto" : "utente-card";

out.innerHTML += `
    <div class="${cardCls}" onclick="toggleFilters('${email}')">
        <b>${highlight(email)}</b>

        <div class="counter-row">
            <span class="badge badge-blue">Coppe: ${stats.tot}</span>
            <span class="badge badge-green">Confermate: ${stats.conf}</span>
            <span class="badge badge-red">Eliminate: ${stats.elim}</span>
<span class="badge badge-coupon"
      onclick="toggleSezioneCoupon('${email}'); event.stopPropagation();">
    üéÅ ${stats.coupon}
</span>
        </div>
    </div>

    <div id="c-${email}" class="coppe-container"
         style="display:${sezioniAperte[email] ? "block" : "none"}"></div>
         <div id="coupon-box-${email}" style="display:none;"></div>
`;
    });

    UTENTI.forEach(u => renderCoppe(u.email));
}

async function renderCoppe(email){
    const box = document.getElementById("c-" + email);
    if (!box) return;

    const stats = getStats(email);
    let arr = stats.list.slice();

// üîç filtra solo le coppe che matchano
if (filtro) {
    arr = arr.filter(c => coppaMatchSearch(c));
}

    if (window.filtroConfermate[email]) {
        arr = arr.filter(c => c.confermata);
    }
    if (window.filtroEliminate[email]) {
        arr = arr.filter(c => c.eliminata);
    }

    // ORDINAMENTO:
// 1Ô∏è‚É£ prima le non eliminate
// 2Ô∏è‚É£ poi le eliminate
// 3Ô∏è‚É£ all‚Äôinterno di ogni gruppo, dalla pi√π recente alla pi√π vecchia
arr.sort((a, b) => {

    // eliminate vanno in fondo
    if (a.eliminata && !b.eliminata) return 1;
    if (!a.eliminata && b.eliminata) return -1;

    // ordine cronologico inverso (pi√π recente prima)
    return new Date(b.data) - new Date(a.data);
});

    // üîé Recupero utente per mostrare i dati sopra i filtri
    const u = UTENTI.find(u => (u.email || "Anonimo") === email);

box.innerHTML = `
    <div class="utente-details">
        <b>Nome:</b> ${highlight(u?.nome || "-")}<br>
        <b>Cognome:</b> ${highlight(u?.cognome || "-")}<br>
        <b>Email:</b> 
        <a href="mailto:${u?.email || email}" 
           style="color:#007aff; text-decoration:none;">
           ${highlight(u?.email || email)}
        </a><br>
        <b>Registrato il:</b> ${highlight(formatDate(u?.created_at))}<br>
        ${
            u?.disiscritto 
            ? `<b style="color:red;">Disiscritto il:</b> ${highlight(formatDate(u.data_disiscrizione))}` 
            : ""
        }
    </div>

    <div style="margin:10px 0;">
        <span class="filter-btn ${!window.filtroConfermate[email] && !window.filtroEliminate[email] ? "active":""}" 
            onclick="window.filtroConfermate['${email}']=false; window.filtroEliminate['${email}']=false; window.renderCoppe('${email}'); event.stopPropagation();">
            Tutte
        </span>

        <span class="filter-btn ${window.filtroConfermate[email] ? 'active' : ''}"
            onclick="window.filtroConfermate['${email}']=!window.filtroConfermate['${email}']; window.filtroEliminate['${email}']=false; window.renderCoppe('${email}'); event.stopPropagation();">
            Confermate
        </span>

        <span class="filter-btn ${window.filtroEliminate[email] ? 'active' : ''}"
            onclick="window.filtroEliminate['${email}']=!window.filtroEliminate['${email}']; window.filtroConfermate['${email}']=false; window.renderCoppe('${email}'); event.stopPropagation();">
            Eliminate
        </span>
    </div>
`;


let primoRisultato = false;

arr.forEach(c => {

    const gusti = Array.isArray(c.gusti) ? c.gusti : JSON.parse(c.gusti||"[]");
    const granelle = Array.isArray(c.granelle) ? c.granelle : JSON.parse(c.granelle||"[]");
    const topping = Array.isArray(c.topping) ? c.topping : JSON.parse(c.topping||"[]");
    const ingr = Array.isArray(c.ingredienti) ? c.ingredienti : JSON.parse(c.ingredienti||"[]");
    const extra = Array.isArray(c.extra) ? c.extra : JSON.parse(c.extra||"[]");

    const collapsed = coppeCollapsed[c.id] === true;

    const coppaCls =
        c.eliminata ? "coppa-box coppa-eliminata" :
        c.confermata ? "coppa-box coppa-confermata" :
        "coppa-box";

    const icon = collapsed ? "üëÅÔ∏è‚Äçüó®Ô∏è" : "‚úñÔ∏è";

    // SCROLL AUTOMATICO sul primo risultato trovato
    if (!primoRisultato) {
        setTimeout(() => {
            const el = document.getElementById("coppa-" + c.id);
            if (el) el.scrollIntoView({ behavior: "smooth", block: "center" });
        }, 200);
        primoRisultato = true;
    }

    box.innerHTML += `
        <div id="coppa-${c.id}" class="${coppaCls}">
            <div style="display:flex; justify-content:space-between; align-items:center;"
                 onclick="toggleCoppaCollapse(${c.id}); event.stopPropagation();">

                <b>${highlight(c.nome || "Coppa senza nome")}</b>
                <span style="font-size:20px; cursor:pointer;">${icon}</span>
            </div>

            ${collapsed ? "" : `
                <div style="margin-top:8px;">
                    <b>Data creazione:</b> ${highlight(formatDate(c.data))}<br>

                    <b>Formato:</b> ${highlight(c.formato)} 
                    ${
                        prezziBase[c.formato] 
                        ? ` (${highlight("‚Ç¨" + prezziBase[c.formato].toFixed(2))})`
                        : ""
                    }<br><br>

                    <b>Gusti:</b> ${highlight(gusti.join(", ") || "-")}<br>
                    <b>Granelle:</b> ${highlight(granelle.join(", ") || "-")}<br>
                    <b>Topping:</b> ${highlight(topping.join(", ") || "-")}<br>
                    <b>Ingredienti:</b> ${highlight(ingr.join(", ") || "-")}<br>

                    <b>Extra:</b> ${
                        extra.length
                            ? extra
                                .map(e => {
                                    const prezzo = prezziExtra[e] || 0;
                                    const label = prezzo > 0 
                                        ? `${e} (+‚Ç¨${prezzo.toFixed(2)})`
                                        : e;
                                    return highlight(label);
                                })
                                .join(", ")
                            : "-"
                    }<br>

                    <b>Prezzo:</b> ${highlight("‚Ç¨" + Number(c.prezzo).toFixed(2))}<br><br>

                    ${
                        c.confermata
                        ? `<button class="undo-btn"
                             onclick="toggleConferma(${c.id}, true); event.stopPropagation();">
                             Annulla conferma
                           </button>`
                        : `<button class="confirm-btn"
                             onclick="toggleConferma(${c.id}, false); event.stopPropagation();">
                             Conferma
                           </button>`
                    }
                </div>
            `}
        </div>
    `;
});
}

// ------------------------------------------------------------
// ‚úâÔ∏è INVIA EMAIL A TUTTI GLI UTENTI REGISTRATI
// ------------------------------------------------------------

window.inviaEmail_Registrati = function() {
    const emails = UTENTI
        .filter(u => u.email && !u.disiscritto)
        .map(u => u.email);

    if (!emails.length) {
        alert("Nessun utente registrato attivo.");
        return;
    }

    const mailto =
        "mailto:?bcc=" + encodeURIComponent(emails.join(",")) +
        "&subject=" + encodeURIComponent("Comunicazione Casa del Gelato");

    window.location.href = mailto;
};

window.inviaEmail_Disiscritti = function() {
    const emails = UTENTI
        .filter(u => u.email && u.disiscritto)
        .map(u => u.email);

    if (!emails.length) {
        alert("Nessun utente disiscritto.");
        return;
    }

    const mailto =
        "mailto:?bcc=" + encodeURIComponent(emails.join(",")) +
        "&subject=" + encodeURIComponent("Informazioni Casa del Gelato");

    window.location.href = mailto;
};

window.inviaEmail_10Coppe = function() {
    const emails = UTENTI
        .filter(u => {
            const stats = getStats(u.email);
            return stats.conf >= 10;
        })
        .map(u => u.email);

    if (!emails.length) {
        alert("Nessun utente con almeno 10 coppe confermate.");
        return;
    }

    const mailto =
        "mailto:?bcc=" + encodeURIComponent(emails.join(",")) +
        "&subject=" + encodeURIComponent("Premio Fedelt√† - Casa del Gelato");

    window.location.href = mailto;
};

document.getElementById("email-dropdown-btn").onclick = function(e) {
    e.stopPropagation();
    const menu = document.getElementById("email-dropdown");
    menu.style.display = (menu.style.display === "block") ? "none" : "block";
};

// chiudi se clicchi fuori
document.addEventListener("click", () => {
    const menu = document.getElementById("email-dropdown");
    if (menu) menu.style.display = "none";
});

</script>

</body>
</html>