<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Scanner QR - Casa del Gelato</title>

<!-- html5-qrcode -->
<script src="https://unpkg.com/html5-qrcode"></script>

<!-- Supabase -->
<script type="module" src="supabase.js"></script>

<style>
html, body {
    width: 100%;
    height: 100%;
    margin: 0;
    overflow: hidden;
    font-family: -apple-system, BlinkMacSystemFont, sans-serif;
    background: #f7f7f7;
}

h1 {
    margin: 12px 0 4px;
    text-align: center;
}

p {
    margin: 0 0 12px;
    text-align: center;
    opacity: .8;
}

/* SCANNER */
#reader {
    width: 100vw;
    height: calc(100vh - 220px);
    background: #000;
    overflow: hidden;
}

#reader video {
    width: 100% !important;
    height: 100% !important;
    object-fit: cover;
}

/* BUTTON */
#switchCamBtn {
    margin: 12px auto;
    padding: 10px 16px;
    background: #007aff;
    color: #fff;
    border: none;
    border-radius: 10px;
    font-size: 16px;
    cursor: pointer;
    display: block;
}

/* RISULTATO */
#risultato {
    display: none;
    margin: 12px auto;
    max-width: 520px;
    background: #fff;
    padding: 16px;
    border-radius: 12px;
    box-shadow: 0 2px 8px rgba(0,0,0,.15);
    font-size: 16px;
}

.ok {
    color: #1e9d3e;
    font-weight: 700;
}

.error {
    color: #d60000;
    font-weight: 700;
}
</style>
</head>

<body>

<h1>üì∑ Scanner QR Coppe</h1>
<p>Inquadra il QR del cliente</p>

<div id="reader"></div>

<button id="switchCamBtn">üîÅ Cambia fotocamera</button>

<div id="risultato"></div>

<script type="module">
import { supabase } from "./supabase.js";

let html5QrCode = null;
let cameras = [];
let currentCameraIndex = 0;
let scanLock = false;

/* ================= UI ================= */
function mostra(msg, ok = false) {
    const box = document.getElementById("risultato");
    box.style.display = "block";
    box.innerHTML = `<div class="${ok ? "ok" : "error"}">${msg}</div>`;
}

/* ================= SCAN LOGIC ================= */
async function gestisciScan(raw) {
    // coupon
    if (raw.includes("coupon=")) {
        mostra("üéüÔ∏è Coupon letto", true);
        return;
    }

    // coppa
    const { data } = await supabase
        .from("coppe")
        .select("*")
        .eq("qr_token", raw)
        .limit(1);

    if (!data || !data.length) {
        mostra("‚ùå QR non valido");
        return;
    }

    const coppa = data[0];
    const confermate = coppa.confermate || 0;

    await supabase
        .from("coppe")
        .update({ confermate: confermate + 1 })
        .eq("id", coppa.id);

    mostra(`‚úÖ Coppa confermata<br><b>${coppa.nome}</b> (${coppa.formato})`, true);
}

/* ================= CAMERA ================= */
async function loadCameras() {
    if (cameras.length) return cameras;

    cameras = await Html5Qrcode.getCameras();
    if (!cameras.length) {
        alert("Nessuna fotocamera trovata");
        return [];
    }

    const backIndex = cameras.findIndex(c =>
        /back|rear|environment/i.test(c.label)
    );
    if (backIndex !== -1) currentCameraIndex = backIndex;

    if (cameras.length <= 1) {
        document.getElementById("switchCamBtn")?.remove();
    }

    return cameras;
}

async function switchCamera() {
    if (!cameras.length) return;

    currentCameraIndex = (currentCameraIndex + 1) % cameras.length;

    try {
        if (html5QrCode?.isScanning) {
            await html5QrCode.stop();
        }
    } catch {}

    scanLock = false;
    startScanner();
}

/* ================= START SCANNER ================= */
async function startScanner() {
    if (!html5QrCode) {
        html5QrCode = new Html5Qrcode("reader");
    }

    const cams = await loadCameras();
    if (!cams.length) return;

    const cameraId = cams[currentCameraIndex].id;

    html5QrCode.start(
        cameraId,
        {
            fps: 10,
            qrbox: (w, h) => {
                const size = Math.min(w, h) * 0.85;
                return { width: size, height: size };
            }
        },
        async msg => {
            if (scanLock) return;
            scanLock = true;

            await gestisciScan(msg);
            await html5QrCode.stop();

            setTimeout(() => {
                scanLock = false;
                startScanner();
            }, 1200);
        }
    );
}

/* ================= INIT ================= */
document.getElementById("switchCamBtn")
    ?.addEventListener("click", switchCamera);

startScanner();
</script>

</body>
</html>