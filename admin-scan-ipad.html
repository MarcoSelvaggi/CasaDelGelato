<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Scanner QR - Casa del Gelato</title>

<!-- html5-qrcode -->
<script src="https://unpkg.com/html5-qrcode"></script>

<!-- Supabase -->
<script type="module" src="supabase.js"></script>

<style>
html, body {
    width: 100%;
    height: 100%;
    margin: 0;
    overflow: hidden;
    font-family: -apple-system, BlinkMacSystemFont, sans-serif;
    background: #f7f7f7;
}

h1 {
    margin: 12px 0 4px;
    text-align: center;
}

p {
    margin: 0 0 12px;
    text-align: center;
    opacity: .8;
}

/* SCANNER */
#reader {
    width: 100vw;
    height: calc(100vh - 220px);
    background: #000;
    overflow: hidden;
}

#reader video {
    width: 100% !important;
    height: 100% !important;
    object-fit: cover;
}

/* BUTTON */
#switchCamBtn {
    margin: 12px auto;
    padding: 10px 16px;
    background: #007aff;
    color: #fff;
    border: none;
    border-radius: 10px;
    font-size: 16px;
    cursor: pointer;
    display: block;
}

/* RISULTATO */
#risultato {
  position: fixed;
  left: 0;
  right: 0;
  bottom: 0;

  max-height: 45vh;
  overflow-y: auto;

  background: #fff;
  padding: 18px 16px 28px;
  border-radius: 18px 18px 0 0;

  box-shadow: 0 -6px 24px rgba(0,0,0,.18);
  font-size: 16px;

  display: none;
  z-index: 9998;
}

.ok {
    color: #1e9d3e;
    font-weight: 700;
}

.error {
    color: #d60000;
    font-weight: 700;
}

/* ===== PIN OVERLAY ===== */
.pin-overlay{
  position: fixed;
  inset: 0;
  background: rgba(0,0,0,.35);
  backdrop-filter: blur(6px);
  display: flex;
  align-items: center;
  justify-content: center;
  z-index: 9999;
}

.pin-box{
  width: 300px;
  background: #fff;
  border-radius: 18px;
  padding: 22px 20px 26px;
  box-shadow: 0 20px 50px rgba(0,0,0,.25);
  text-align: center;
}

.pin-box h2{
  margin: 0 0 16px;
  font-size: 18px;
  font-weight: 600;
}

.pin-dots{
  display: flex;
  justify-content: center;
  gap: 10px;
  margin-bottom: 22px;
}

.pin-dots span{
  width: 10px;
  height: 10px;
  border-radius: 50%;
  background: #d1d1d6;
}

.pin-dots span.filled{
  background: #111;
}

.pin-keypad{
  display: grid;
  grid-template-columns: repeat(3, 74px);
  gap: 18px;
  justify-content: center;
}

.pin-keypad button{
  width: 74px;
  height: 74px;
  border-radius: 50%;
  border: none;
  background: #f2f2f7;
  font-size: 22px;
  font-weight: 600;
}

.pin-keypad button:active{
  background: #e5e5ea;
  transform: scale(.92);
}

.pin-keypad .empty{
  background: transparent;
}
</style>
</head>

<body>

<h1>üì∑ Scanner QR Coppe</h1>
<p>Inquadra il QR del cliente</p>

<div id="reader"></div>

<button id="switchCamBtn">üîÅ Cambia fotocamera</button>

<div id="risultato"></div>

<script type="module">
import { supabase } from "./supabase.js";

let html5QrCode = null;
let cameras = [];
let currentCameraIndex = 0;
let scanLock = false;

/* ================= UI ================= */
function mostra(msg, ok = false) {
    const box = document.getElementById("risultato");
    box.style.display = "block";
    box.innerHTML = `<div class="${ok ? "ok" : "error"}">${msg}</div>`;
}

/* ================= SCAN LOGIC ================= */
async function gestisciScan(raw) {
    // coupon
    if (raw.includes("coupon=")) {
        mostra("üéüÔ∏è Coupon letto", true);
        return;
    }

    // coppa
    const { data } = await supabase
        .from("coppe")
        .select("*")
        .eq("qr_token", raw)
        .limit(1);

    if (!data || !data.length) {
        mostra("‚ùå QR non valido");
        return;
    }

    const coppa = data[0];
    const confermate = coppa.confermate || 0;

    await supabase
        .from("coppe")
        .update({ confermate: confermate + 1 })
        .eq("id", coppa.id);

    mostra(`‚úÖ Coppa confermata<br><b>${coppa.nome}</b> (${coppa.formato})`, true);
}

/* ================= CAMERA ================= */
async function loadCameras() {
    if (cameras.length) return cameras;

    cameras = await Html5Qrcode.getCameras();
    if (!cameras.length) {
        alert("Nessuna fotocamera trovata");
        return [];
    }

    const backIndex = cameras.findIndex(c =>
        /back|rear|environment/i.test(c.label)
    );
    if (backIndex !== -1) currentCameraIndex = backIndex;

    if (cameras.length <= 1) {
        document.getElementById("switchCamBtn")?.remove();
    }

    return cameras;
}

async function switchCamera() {
    if (!cameras.length) return;

    currentCameraIndex = (currentCameraIndex + 1) % cameras.length;

    try {
        if (html5QrCode?.isScanning) {
            await html5QrCode.stop();
        }
    } catch {}

    scanLock = false;
window.openAdminPin = openAdminPin;
window.closeAdminPin = closeAdminPin;
window.updatePinDots = updatePinDots;
window.checkPin = checkPin;
}

/* ================= START SCANNER ================= */
async function startScanner() {
      if (!isPinValidToday()) {
    openAdminPin();
    return;
  }
    if (!html5QrCode) {
        html5QrCode = new Html5Qrcode("reader");
    }

    const cams = await loadCameras();
    if (!cams.length) return;

    const cameraId = cams[currentCameraIndex].id;

    html5QrCode.start(
        cameraId,
        {
            fps: 10,
            qrbox: (w, h) => {
                const size = Math.min(w, h) * 0.85;
                return { width: size, height: size };
            }
        },
        async msg => {
            if (scanLock) return;
            scanLock = true;

            await gestisciScan(msg);
            await html5QrCode.stop();

            setTimeout(() => {
                scanLock = false;
            }, 1200);
        }
    );
}
window.startScanner = startScanner;
/* ================= INIT ================= */
document.getElementById("switchCamBtn")
    ?.addEventListener("click", switchCamera);


</script>

<!-- üîê ADMIN PIN OVERLAY -->
<div id="admin-pin-overlay" class="pin-overlay" style="display:none">
  <div class="pin-box">
    <h2>Inserisci PIN Admin</h2>

    <div class="pin-dots">
      <span></span><span></span><span></span>
      <span></span><span></span><span></span>
    </div>

    <div class="pin-keypad">
      <button data-n="1">1</button>
      <button data-n="2">2</button>
      <button data-n="3">3</button>

      <button data-n="4">4</button>
      <button data-n="5">5</button>
      <button data-n="6">6</button>

      <button data-n="7">7</button>
      <button data-n="8">8</button>
      <button data-n="9">9</button>

      <button class="empty"></button>
      <button data-n="0">0</button>
      <button id="pin-del">‚å´</button>
    </div>
  </div>
</div>

<script>
/* ====== PIN VALIDIT√Ä GIORNALIERA ====== */
const ADMIN_PIN = "000000";
const PIN_KEY = "adminScan_pin_ok_until";

function getPinExpireToday() {
  const d = new Date();
  d.setHours(23, 59, 59, 999);
  return d.getTime();
}

function isPinValidToday() {
  const until = Number(localStorage.getItem(PIN_KEY) || 0);
  return Date.now() < until;
}

function savePinValid() {
  localStorage.setItem(PIN_KEY, String(getPinExpireToday()));
}
</script>

<script>
/* ====== STATO ====== */
let enteredPin = "";

/* ====== UI ====== */
function openAdminPin() {
  enteredPin = "";
  updatePinDots();
  document.getElementById("admin-pin-overlay").style.display = "flex";
}

function closeAdminPin() {
  document.getElementById("admin-pin-overlay").style.display = "none";
}

function updatePinDots() {
  document.querySelectorAll(".pin-dots span").forEach((dot, i) => {
    dot.classList.toggle("filled", i < enteredPin.length);
  });
}

/* ====== CHECK PIN ====== */
function checkPin() {
  if (enteredPin === ADMIN_PIN) {
    savePinValid();
    closeAdminPin();
    window.startScanner(); // ‚úÖ chiama quella esposta dal module
    return;
  }

  // ‚ùå PIN errato
  enteredPin = "";
  updatePinDots();
  navigator.vibrate?.(100);
}
document.addEventListener("DOMContentLoaded", () => {
  if (!isPinValidToday()) {
    openAdminPin();   // üîê MOSTRA PIN
  } else {
    window.startScanner(); // üì∑ parte diretto se gi√† valido
  }
});
document.addEventListener("DOMContentLoaded", () => {
  const keypad = document.querySelector(".pin-keypad");
  if (!keypad) {
    console.error("‚ùå pin-keypad non trovata");
    return;
  }

  keypad.addEventListener("click", (e) => {
    const btn = e.target.closest("button");
    if (!btn || btn.classList.contains("empty")) return;

    // ‚å´ cancella
    if (btn.id === "pin-del") {
      enteredPin = enteredPin.slice(0, -1);
      updatePinDots();
      return;
    }

    // numero
    const n = btn.dataset.n;
    if (!n || enteredPin.length >= 6) return;

    enteredPin += n;
    updatePinDots();

    // se 6 cifre ‚Üí verifica
    if (enteredPin.length === 6) {
      setTimeout(checkPin, 120);
    }
  });
});

window.openAdminPin = openAdminPin;
window.isPinValidToday = isPinValidToday;
</script>


</body>
</html>