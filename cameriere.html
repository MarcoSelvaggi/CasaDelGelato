<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8">
  <title>Cameriere</title>
  <style>
    body { font-family: system-ui; text-align:center; margin-top:40px; }
    .call { padding:20px; margin:10px; background:#ffeb3b; border-radius:12px; }
  </style>
</head>

<body>

<h2>ğŸ“Ÿ Schermata Cameriere</h2>
<p>Riceverai notifiche quando un cliente ti chiama.</p>
<p><strong>âœ… Mantieni questa app aperta oppure installata sulla schermata Home.</strong></p>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.0/firebase-app.js";
  import { getMessaging, getToken, onMessage } from "https://www.gstatic.com/firebasejs/10.7.0/firebase-messaging.js";
  import { getDatabase, ref, onChildAdded } from "https://www.gstatic.com/firebasejs/10.7.0/firebase-database.js";

  const firebaseConfig = {
    apiKey: "AIzaSyCEtjAs4cTJbpji4dXnb_bGxRUaK2D2tsA",
    authDomain: "casadelgelato-e6fbf.firebaseapp.com",
    databaseURL: "https://casadelgelato-e6fbf-default-rtdb.europe-west1.firebasedatabase.app",
    projectId: "casadelgelato-e6fbf",
    storageBucket: "casadelgelato-e6fbf.firebasestorage.app",
    messagingSenderId: "446810619113",
    appId: "1:446810619113:web:1f25c3a16586c81c8a0478"
  };

  const app = initializeApp(firebaseConfig);
  const messaging = getMessaging(app);
  const db = getDatabase(app);

  // âœ… Chiede permesso notifiche appena si apre
  Notification.requestPermission().then((permission) => {
    if (permission === "granted") {
      getToken(messaging, { vapidKey: "BIxxYqAOYyTEXSgH1gawFdcg3P_SWMDW54rv4x8ei9QrsNB-D_LM28cNsP5DnBT-zQu9RgJJQX7LsimNOT1SQTY" })
        .then((token) => {
          localStorage.setItem("waiterToken", token);
          console.log("âœ… Cameriere registrato per notifiche");
        });
    } else {
      alert("âš ï¸ Devi abilitare le notifiche per ricevere le chiamate dei clienti.");
    }
  });

  // âœ… Notifica quando un cliente chiama
  onChildAdded(ref(db, "calls"), () => {
    alert("ğŸ”” Cliente sta chiamando!");
  });

  // âœ… Se l'app Ã¨ aperta in primo piano
  onMessage(messaging, () => {
    alert("ğŸ”” Cliente ha bisogno di te!");
  });
</script>

<script>
if ("serviceWorker" in navigator) {
  navigator.serviceWorker.register("firebase-messaging-sw.js")
    .then(() => console.log("âœ… SW Cameriere registrato"))
    .catch(err => console.log("âŒ Errore SW:", err));
}
</script>

</body>
</html>