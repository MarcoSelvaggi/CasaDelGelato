<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8">
  <title>Cameriere - Notifiche</title>

  <style>
    body { font-family: system-ui; padding:20px; background:#f6f6f7; }
    h1 { text-align:center; }
    .call { 
      padding:18px; 
      margin-top:12px; 
      background:#ff8a5c; 
      color:white; 
      border-radius:14px; 
      font-size:18px;
    }
  </style>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.0/firebase-app.js";
    import { getMessaging, getToken, onMessage } from "https://www.gstatic.com/firebasejs/10.7.0/firebase-messaging.js";
    import { getDatabase, ref, onChildAdded } from "https://www.gstatic.com/firebasejs/10.7.0/firebase-database.js";

    const firebaseConfig = {
      apiKey: "AIzaSyCEtjAs4cTJbpji4dXnb_bGxRUaK2D2tsA",
      authDomain: "casadelgelato-e6fbf.firebaseapp.com",
      databaseURL: "https://casadelgelato-e6fbf-default-rtdb.europe-west1.firebasedatabase.app",
      projectId: "casadelgelato-e6fbf",
      storageBucket: "casadelgelato-e6fbf.firebasestorage.app",
      messagingSenderId: "446810619113",
      appId: "1:446810619113:web:1f25c3a16586c81c8a0478"
    };

    const app = initializeApp(firebaseConfig);
    const messaging = getMessaging(app);
    const db = getDatabase(app);

    // âœ… REGISTRAZIONE TOKEN DEL CAMERIERE
    Notification.requestPermission().then((permission) => {
      if (permission === "granted") {
        getToken(messaging, { vapidKey: "BIxxYqAOYyTEXSgH1gawFdcg3P_SWMDW54rv4x8ei9QrsNB-D_LM28cNsP5DnBT-zQu9RgJJQX7LsimNOT1SQTY" })
        .then((token) => {
            localStorage.setItem("waiterToken", token);
            document.getElementById("status").textContent = "âœ… Cameriere attivo e in ascolto...";
        });
      } else {
        document.getElementById("status").textContent = "âŒ Devi permettere le notifiche";
      }
    });

    // âœ… ARRIVA UNA NOTIFICA CON APP APERTA
    onMessage(messaging, () => {
      playSound();
      alert("ğŸ“£ Cliente ha chiamato il cameriere!");
    });

    // âœ… ASCOLTA LE CHIAMATE SU FIREBASE IN TEMPO REALE
    const callsRef = ref(db, "calls");
    onChildAdded(callsRef, () => {
      playSound();
      const c = document.createElement("div");
      c.className = "call";
      c.textContent = "ğŸ”” Un tavolo ha chiamato!";
      document.getElementById("calls").prepend(c);
    });

    // âœ… SUONO DI AVVISO
    function playSound() {
      const audio = new Audio("https://actions.google.com/sounds/v1/alarms/beep_short.ogg");
      audio.play();
    }

  </script>

  <script>
  // âœ… REGISTRA SERVICE WORKER NECESSARIO PER NOTIFICHE A SCHERMO SPENTO
  if ("serviceWorker" in navigator) {
    navigator.serviceWorker.register("firebase-messaging-sw.js")
      .then(() => console.log("âœ… Service Worker OK"))
      .catch(err => console.log("âŒ Errore SW:", err));
  }
  </script>

</head>

<body>
  <h1>ğŸ‘¨â€ğŸ³ ModalitÃ  Cameriere</h1>
  <p id="status">â³ Attivazione notifiche...</p>

  <h2>ğŸ“£ Chiamate Ricevute</h2>
  <div id="calls"></div>
</body>
</html>